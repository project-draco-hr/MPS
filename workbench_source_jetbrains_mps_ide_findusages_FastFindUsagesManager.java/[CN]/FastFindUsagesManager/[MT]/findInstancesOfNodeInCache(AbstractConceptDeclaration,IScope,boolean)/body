{
  Set<VirtualFile> candidates=new HashSet<VirtualFile>();
  final Set<VirtualFile> scopeFiles=getScopeFiles(scope);
  if (concept != null)   candidates.addAll(getCandidates(scopeFiles,concept.getName()));
  if (!isExact) {
    Set<String> fqNames=LanguageHierarchyCache.getInstance().getAllDescendantsOfConcept(NameUtil.nodeFQName(concept));
    for (    String fqName : fqNames) {
      candidates.addAll(getCandidates(scopeFiles,fqName));
    }
  }
  Set<SNode> result=new HashSet<SNode>();
  for (  VirtualFile file : candidates) {
    SModelDescriptor sm=SModelRepository.getInstance().findModel(VirtualFileUtils.toIFile(file));
    if (sm == null)     continue;
    sm.getSModel();
    if (isExact) {
      result.addAll(new ModelFindOperations(sm).findExactInstances(concept,scope));
    }
 else {
      result.addAll(new ModelFindOperations(sm).findInstances(concept,scope));
    }
  }
  return result;
}
