{
  if (!ModuleLibraryType.isModuleLibrary(library)) {
    return Collections.emptySet();
  }
  final Set<ModuleReference> modules=new HashSet<ModuleReference>();
  final Set<IFile> moduleXmls=new HashSet<IFile>();
  for (  VirtualFile file : library.getFiles(ModuleXmlRootDetector.MPS_MODULE_XML)) {
    moduleXmls.add(VirtualFileUtils.toIFile(file));
  }
  ModelAccess.instance().runReadAction(new Runnable(){
    @Override public void run(){
      Collection<IModule> allModules=new HashSet<IModule>();
      allModules.addAll(ModuleRepositoryFacade.getInstance().getAllModules(Solution.class));
      allModules.addAll(ModuleRepositoryFacade.getInstance().getAllModules(Language.class));
      for (      IModule module : allModules) {
        if (moduleXmls.contains(module.getDescriptorFile())) {
          modules.add(module.getModuleReference());
        }
      }
    }
  }
);
  return modules;
}
