{
  if (!MpsModuleLibraryKindContainer.isModuleLibrary(library)) {
    return Collections.emptySet();
  }
  final Set<ModuleReference> modules=new HashSet<ModuleReference>();
  final Set<IFile> moduleXmls=new HashSet<IFile>();
  for (  VirtualFile file : library.getFiles(ModuleXmlRootDetector.MPS_MODULE_XML)) {
    moduleXmls.add(VirtualFileUtils.toIFile(file));
  }
  ModelAccess.instance().runReadAction(new Runnable(){
    @Override public void run(){
      Collection<Solution> allSolutions=ModuleRepositoryFacade.getInstance().getAllModules(Solution.class);
      for (      Solution solution : allSolutions) {
        if (moduleXmls.contains(solution.getDescriptorFile())) {
          modules.add(solution.getModuleReference());
        }
      }
    }
  }
);
  return modules;
}
