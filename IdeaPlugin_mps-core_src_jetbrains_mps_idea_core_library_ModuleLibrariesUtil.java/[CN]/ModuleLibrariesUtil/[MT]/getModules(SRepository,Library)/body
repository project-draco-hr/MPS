{
  if (!ModuleLibraryType.isModuleLibrary(library)) {
    return Collections.emptySet();
  }
  final Set<SModuleReference> modules=new HashSet<SModuleReference>();
  final Set<IFile> moduleXmls=new HashSet<IFile>();
  for (  VirtualFile file : library.getFiles(ModuleXmlRootDetector.MPS_MODULE_XML)) {
    moduleXmls.add(VirtualFileUtils.toIFile(file));
  }
  repository.getModelAccess().runReadAction(new Runnable(){
    @Override public void run(){
      for (      IFile moduleDescriptor : moduleXmls) {
        SModule moduleByFile=ModuleFileTracker.getInstance().getModuleByFile(moduleDescriptor);
        if (moduleByFile != null) {
          modules.add(moduleByFile.getModuleReference());
        }
      }
    }
  }
);
  return modules;
}
