{
  final SearchResults<SNode> results=new SearchResults<SNode>();
  try {
    monitor.start("filtering references",ListSequence.fromList(references).count());
    for (    final SNode node : ListSequence.fromList(references)) {
      ModelAccess.instance().runReadAction(new Runnable(){
        public void run(){
          for (          SReference ref : SNodeOperations.getReferences(((SNode)node))) {
            SNode targetNode=jetbrains.mps.util.SNodeOperations.getTargetNodeSilently(ref);
            if (targetNode == null || !(targetScope.contains(targetNode)) || sourceScope.contains(targetNode)) {
              continue;
            }
            results.getSearchResults().add(new SearchResult(node,"references"));
            break;
          }
        }
      }
);
      if (monitor.isCanceled()) {
        return results;
      }
      monitor.advance(1);
    }
  }
  finally {
    monitor.done();
  }
  return results;
}
