{
  List<SNode> result=ListSequence.fromList(new ArrayList<SNode>());
  try {
    Iterable<SModel> models=CollectionSequence.fromCollection(scope.getModules()).translate(new ITranslator2<SModule,SModel>(){
      public Iterable<SModel> translate(      SModule it){
        return it.getModels();
      }
    }
).concat(CollectionSequence.fromCollection(scope.getModels()));
    List<SNode> roots=Sequence.fromIterable(models).translate(new ITranslator2<SModel,SNode>(){
      public Iterable<SNode> translate(      SModel it){
        return (Iterable<SNode>)(Iterable)it.getRootNodes();
      }
    }
).concat(CollectionSequence.fromCollection(scope.getRoots())).toListSequence();
    monitor.start("searching references in " + scope.getPresentation(),ListSequence.fromList(roots).count());
    for (    SNode root : ListSequence.fromList(roots)) {
      ListSequence.fromList(result).addSequence(ListSequence.fromList(SNodeOperations.getDescendants(((jetbrains.mps.smodel.SNode)root),null,true,new String[]{})));
      if (monitor.isCanceled()) {
        return result;
      }
      monitor.advance(1);
    }
  }
  finally {
    monitor.done();
  }
  return result;
}
