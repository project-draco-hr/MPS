{
  if (myChooserActivated != b) {
    if (b) {
      myEditorComponent.pushKeyboardHandler(this);
      if (!(MPSCore.getInstance().isTestMode())) {
        getPatternEditor().activate(getEditorWindow(),myPatternEditorLocation,myPatternEditorSize);
        myNodeSubstituteInfo.invalidateActions();
        rebuildMenuEntries();
        getPopupWindow().setVisible(true);
        getPopupWindow().relayout();
        getPopupWindow().setSelectionIndex(0);
      }
 else {
        getPatternEditor().activate(null,myPatternEditorLocation,myPatternEditorSize);
        myNodeSubstituteInfo.invalidateActions();
        rebuildMenuEntries();
        getPopupWindow().initListModel();
        getPopupWindow().setSelectionIndex(0);
      }
      myPopupActivated=true;
    }
 else {
      if (!(MPSCore.getInstance().isTestMode())) {
        getPopupWindow().setVisible(false);
        getPatternEditor().done();
        getPopupWindow().setRelativeCell(null);
      }
      myNodeSubstituteInfo.invalidateActions();
      myPopupActivated=false;
      myEditorComponent.popKeyboardHandler();
      myContextCell=null;
    }
  }
  myChooserActivated=b;
}
