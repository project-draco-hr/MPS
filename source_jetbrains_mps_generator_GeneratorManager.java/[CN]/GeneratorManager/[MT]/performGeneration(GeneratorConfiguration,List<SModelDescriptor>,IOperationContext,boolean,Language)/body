{
  invocationContext.getComponent(ProjectPane.class).disableRebuild();
  IProgressMonitor progress=new ProgressWindowProgressMonitor(invocationContext.getComponent(ProjectFrame.class),false);
  boolean isIdeaPresent=MPSPlugin.getInstance().isIDEAPresent();
  try {
    int modelCount=0;
    for (    GeneratorConfigurationCommand cmd : CollectionUtil.iteratorAsIterable(configuration.commands())) {
      modelCount+=findModelsWithLanguage(modelDescriptors,cmd.getSourceLanguage().getName()).size();
    }
    int ideaCompilations=0;
    if (isIdeaPresent && myCompileOnGeneration) {
      if (generateText) {
        ideaCompilations=1;
      }
 else {
        ideaCompilations=2;
      }
    }
    progress.start("Generating",(modelCount + ideaCompilations) * AMOUNT_PER_MODEL);
    if (myCompileOnGeneration && ideaCompilations == 0) {
      progress.addText("IntelliJ IDEA with installed MPS is not present");
    }
    if (!myCompileOnGeneration) {
      progress.addText("Compilation in IDEA on generation is turned off");
    }
    clearMessages(invocationContext);
    addMessage(new Message(MessageKind.INFORMATION,null,"Generating configuration " + configuration.getName()),invocationContext);
    if (isIdeaPresent && myCompileOnGeneration) {
      progress.addText("Compiling in IntelliJ IDEA...");
      LOG.debug("Compiling in IDE before generation ");
      compileAndReload();
      progress.advance(AMOUNT_PER_MODEL);
    }
    for (    GeneratorConfigurationCommand cmd : CollectionUtil.iteratorAsIterable(configuration.commands())) {
      LOG.debug("Executing command : " + cmd.getSourceLanguage().getName() + " -> "+ cmd.getTargetLanguage().getName());
      Set<SModelDescriptor> modelsWithLanguage=findModelsWithLanguage(modelDescriptors,cmd.getSourceLanguage().getName());
      Generator generator=findGenerator(cmd.getSourceLanguage().getName(),cmd.getTargetLanguage().getName(),invocationContext);
      GeneratorSessionContext generatorContext=new GeneratorSessionContext(generator,invocationContext);
      String generatorClass=findGeneratorClass(generator);
      if (generatorClass == null)       generatorClass=DefaultTemplateGenerator.class.getName();
      boolean generationOK=true;
      SModelDescriptor templatesModel=loadTemplatesModel(generator,generatorContext);
      for (      SModelDescriptor model : modelsWithLanguage) {
        try {
          generationOK=generationOK && generate_internal(model,templatesModel,generatorContext,generatorClass,configuration.getOutputPath(),progress,generateText);
          addMessage(new Message(MessageKind.INFORMATION,model.getModelUID() + " generated"),invocationContext);
        }
 catch (        GenerationCanceledException gce) {
          progress.addText("generation canceled");
          addMessage(new Message(MessageKind.WARNING,"generation canceled"),invocationContext);
          generatorContext.getModule().dispose();
          return;
        }
catch (        GenerationFailedException gfe) {
          LOG.error(model.getModelUID() + " : generation failed",gfe);
          progress.addText("exception during generation " + gfe.getMessage());
          addMessage(new Message(MessageKind.ERROR,model.getModelUID() + " : generation failed"),invocationContext);
          generationOK=false;
          break;
        }
catch (        Exception e) {
          LOG.error(model.getModelUID() + " : generation failed",e);
          progress.addText("exception during generation " + e.getMessage());
          addMessage(new Message(MessageKind.ERROR,model.getModelUID() + " : generation failed"),invocationContext);
          generationOK=false;
          break;
        }
      }
      if (mySaveTransientModels) {
        saveTransientModels(generatorContext);
      }
 else {
        if (generationOK) {
          generatorContext.getModule().dispose();
        }
      }
    }
    if (!generateText && isIdeaPresent && myCompileOnGeneration) {
      LOG.debug("Compiling in IDE after generation");
      progress.addText("Compiling in IntelliJ IDEA...");
      compileAndReload();
      progress.advance(AMOUNT_PER_MODEL);
    }
    addMessage(new Message(MessageKind.INFORMATION,"Generation finished"),invocationContext);
    if (!generateText) {
      showMessageView(invocationContext);
    }
    progress.addText("Finished.");
  }
  finally {
    progress.finish();
    ReflectionClassifierFinder.generationFinished();
    if (language != null)     language.updateLastGenerationTime();
    invocationContext.getComponent(ProjectPane.class).enableRebuild();
  }
}
