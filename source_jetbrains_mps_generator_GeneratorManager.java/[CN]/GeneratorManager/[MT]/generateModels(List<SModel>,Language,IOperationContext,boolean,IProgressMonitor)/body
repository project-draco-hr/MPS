{
  List<SModelDescriptor> sourceModels=new ArrayList<SModelDescriptor>();
  for (  SModel model : _sourceModels) {
    sourceModels.add(model.getModelDescriptor());
  }
  clearMessages();
  addMessage(MessageKind.INFORMATION,"generating " + (generateText ? "text" : "files"));
  addMessage(MessageKind.INFORMATION,"    target language: \"" + targetLanguage.getNamespace() + "\"");
  String outputFolder=invocationContext.getModule().getGeneratorOutputPath();
  if (!generateText) {
    addMessage(MessageKind.INFORMATION,"    target root folder: \"" + outputFolder + "\"");
  }
  double totalJob=sourceModels.size() * AMOUNT_PER_MODEL;
  boolean compile=myCompileOnGeneration && MPSPlugin.getInstance().isIDEAPresent();
  if (compile) {
    if (generateText) {
      totalJob=totalJob + AMOUNT_PER_COMPILATION;
    }
 else {
      totalJob=totalJob + AMOUNT_PER_COMPILATION + AMOUNT_PER_COMPILATION;
    }
  }
 else {
    totalJob=totalJob + AMOUNT_PER_COMPILATION / 2;
  }
  progress.start("generating",totalJob);
  try {
    if (!myCompileOnGeneration) {
      progress.addText("compilation in IntelliJ IDEA on generation is turned off");
    }
 else     if (!compile) {
      progress.addText("IntelliJ IDEA with installed MPS is not present");
    }
 else {
      progress.addText("compiling in IntelliJ IDEA...");
      MPSPlugin.getInstance().refreshFS();
      progress.advance(AMOUNT_PER_COMPILATION / 4);
      MPSPlugin.getInstance().buildProject();
      progress.advance(AMOUNT_PER_COMPILATION / 4);
    }
    progress.addText("reloading MPS classes...");
    ReloadUtils.reloadAll();
    progress.advance(AMOUNT_PER_COMPILATION / 2);
    GenerationSession generationSession=new GenerationSession(targetLanguage,invocationContext,progress);
    generationSession.setSaveTransientModels(isSaveTransientModels());
    GenerationStatus status=null;
    for (    SModelDescriptor sourceModelDescriptor : sourceModels) {
      SModel sourceModel=sourceModelDescriptor.getSModel();
      status=generationSession.generateModel(sourceModel);
      if (status.getOutputModel() != null) {
        if (generateText) {
          progress.addText("generate text to Output view");
          generateText(status.getOutputModel(),invocationContext);
        }
 else {
          addProgressMessage(MessageKind.INFORMATION,"generate files to folder: \"" + getOutputFolderPath(outputFolder,sourceModel) + "\"",progress);
          generateFile(outputFolder,sourceModel,status.getOutputModel());
        }
      }
      if (!status.isOk()) {
        break;
      }
    }
    if (isSaveTransientModels()) {
      addProgressMessage(MessageKind.INFORMATION,"adding module \"" + generationSession.getSessionModuleName() + "\"",progress);
      File sessionDescriptorFile=generationSession.getSessionDescriptorFile();
      myProject.addProjectSolution(sessionDescriptorFile);
    }
    if (status.isOk()) {
      if (compile) {
        progress.addText("compiling in IntelliJ IDEA...");
        MPSPlugin.getInstance().refreshFS();
        progress.advance(AMOUNT_PER_COMPILATION / 4);
        MPSPlugin.getInstance().buildProject();
        progress.advance(AMOUNT_PER_COMPILATION / 4);
        progress.addText("reloading MPS classes...");
        ReloadUtils.reloadAll();
        progress.advance(AMOUNT_PER_COMPILATION / 2);
      }
      addProgressMessage(MessageKind.INFORMATION,"generation completed successfully",progress);
    }
 else     if (status.isError()) {
      addProgressMessage(MessageKind.WARNING,"generation finished with errors",progress);
    }
 else     if (status.isCanceled()) {
      addProgressMessage(MessageKind.WARNING,"generation canceled",progress);
    }
    showMessageView();
  }
 catch (  Throwable t) {
    LOG.error(t);
    addProgressMessage(MessageKind.ERROR,t.toString(),progress);
  }
 finally {
    progress.finish();
  }
}
