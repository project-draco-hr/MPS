{
  Set<Pair<SNode,SReferenceLink>> threadSet=ourSetReferentEventHandlersInProgress.get();
  Pair<SNode,SReferenceLink> pair=new Pair<SNode,SReferenceLink>(node,referenceLink);
  if (threadSet.contains(pair)) {
    node.setReferenceTarget(referenceLink,target);
    return;
  }
  ReferenceConstraintsDescriptor descriptor=getReferenceConstraintsDescriptor(node,referenceLink);
  if (descriptor == null) {
    LOG.error("Can't find reference constraints for reference `" + referenceLink.getRoleName() + "`. Setting directly.",node);
    node.setReferenceTarget(referenceLink,target);
    return;
  }
  threadSet.add(pair);
  try {
    org.jetbrains.mps.openapi.model.SReference r=node.getReference(referenceLink);
    org.jetbrains.mps.openapi.model.SNode oldReferent=r == null ? null : SReference.getTargetNodeSilently(r);
    if (descriptor.validate(node,oldReferent,target)) {
      node.setReferenceTarget(referenceLink,target);
      descriptor.onReferenceSet(node,oldReferent,target);
    }
  }
  finally {
    threadSet.remove(pair);
  }
}
