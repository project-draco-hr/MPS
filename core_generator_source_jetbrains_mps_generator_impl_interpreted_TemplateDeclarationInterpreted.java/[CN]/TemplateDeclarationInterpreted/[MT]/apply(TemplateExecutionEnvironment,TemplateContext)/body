{
  TemplateContext applyContext=myArguments.length == 0 ? context : context.subContext(getArgumentsAsMap());
  if (myTemplateNode.isInstanceOfConcept(jetbrains.mps.lang.generator.structure.TemplateDeclaration.concept)) {
    List<TemplateFragment> fragments=GeneratorUtil.getTemplateFragments(myTemplateNode.getAdapter());
    if (!GeneratorUtil.checkIfOneOrMaryAdjacentFragments(fragments,myTemplateNode,context.getInput(),null,environment.getGenerator())) {
      environment.getGenerator().showErrorMessage(context.getInput(),myTemplateNode,"error processing template declaration");
      return null;
    }
    environment.getTracer().pushTemplateNode(new SNodePointer(myTemplateNode));
    Collection<SNode> outputNodes=new ArrayList<SNode>();
    for (    TemplateFragment fragment : fragments) {
      SNode templateForInclude=fragment.getParent().getNode();
      String mappingName=GeneratorUtil.getMappingName(fragment,null);
      TemplateProcessor p=new TemplateProcessor(environment.getGenerator(),environment.getReductionContext());
      try {
        outputNodes.addAll(p.processTemplateNode(mappingName,templateForInclude,context.subContext(mappingName)));
      }
 catch (      TemplateProcessingFailureException ex) {
      }
    }
    return outputNodes;
  }
 else {
    return new TemplateProcessor(environment.getGenerator(),environment.getReductionContext()).processTemplateNode(null,myTemplateNode,applyContext);
  }
}
