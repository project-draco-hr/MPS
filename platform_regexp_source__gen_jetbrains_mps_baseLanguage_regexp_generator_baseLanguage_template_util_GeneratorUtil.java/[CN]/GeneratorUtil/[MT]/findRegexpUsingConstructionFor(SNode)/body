{
  SNode parens=SLinkOperations.getTarget(ref,"match",false);
  SNode ruc=SNodeOperations.getAncestor(parens,"jetbrains.mps.baseLanguage.regexp.structure.RegexpUsingConstruction",false,false);
  if (ruc != null) {
    return ruc;
  }
 else {
    SNode dcl=SNodeOperations.getAncestor(parens,"jetbrains.mps.baseLanguage.regexp.structure.RegexpDeclaration",false,false);
    for (    SNode parentRuc : SNodeOperations.getAncestors(ref,"jetbrains.mps.baseLanguage.regexp.structure.RegexpUsingConstruction",false)) {
      for (      SNode regref : SNodeOperations.getDescendants(parentRuc,"jetbrains.mps.baseLanguage.regexp.structure.RegexpDeclarationReferenceRegexp",false)) {
        if (SLinkOperations.getTarget(regref,"regexp",false) == dcl) {
          return parentRuc;
        }
      }
    }
    return null;
  }
}
