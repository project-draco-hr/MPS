{
  final Wrappers._T<String> report=new Wrappers._T<String>("");
  final Task.Modal task=new Task.Modal(((Project)MapSequence.fromMap(_params).get("ideaProject")),"Optimizing project imports",true){
    public void run(    @NotNull ProgressIndicator indicator){
      final ProgressMonitorAdapter monitor=new ProgressMonitorAdapter(indicator);
      try {
        monitor.start("Optimizing project imports",2);
        WaitForProgressToShow.runOrInvokeAndWaitAboveProgress(new Runnable(){
          public void run(){
          }
        }
);
        final SRepository repo=((MPSProject)MapSequence.fromMap(_params).get("project")).getRepository();
        final OptimizeImportsHelper helper=new OptimizeImportsHelper(repo);
        ApplicationManager.getApplication().invokeAndWait(new Runnable(){
          public void run(){
            repo.getModelAccess().executeCommand(new Runnable(){
              public void run(){
                report.value+=helper.optimizeProjectImports(((MPSProject)MapSequence.fromMap(_params).get("project")),monitor.subTask(1));
              }
            }
);
          }
        }
,ModalityState.any());
        if (monitor.isCanceled()) {
          return;
        }
        monitor.step("Saving...");
        WaitForProgressToShow.runOrInvokeAndWaitAboveProgress(new Runnable(){
          public void run(){
            repo.getModelAccess().executeCommand(new Runnable(){
              public void run(){
                repo.saveAll();
              }
            }
);
          }
        }
);
        monitor.advance(1);
      }
  finally {
        monitor.done();
      }
    }
  }
;
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    public void run(){
      ProgressManager.getInstance().run(task);
      Messages.showMessageDialog(((Project)MapSequence.fromMap(_params).get("ideaProject")),(report.value.equals("") ? "Nothing to optimize" : report.value),"Optimize Imports",Messages.getInformationIcon());
    }
  }
,ModalityState.defaultModalityState());
}
