{
  if (pack.equals(myModelLongName)) {
    SNode nodeInSameModel=myModel.getNode(targetTopClassifier);
    if (nodeInSameModel != null) {
      return jetbrains.mps.smodel.SReference.create(role,source,myModelReference,targetNodeId,resolveInfo);
    }
  }
  Collection<SModel> possibleModels=findModels(SModelStereotype.withStereotype(pack,SModelStereotype.JAVA_STUB));
  if (possibleModels.isEmpty()) {
    return jetbrains.mps.smodel.SReference.create(role,source,null,targetNodeId,resolveInfo);
  }
  for (  SModel m : possibleModels) {
    final SModelReference modelRef=m.getReference();
    if (myModelReference.equals(modelRef)) {
      continue;
    }
    if (m.getNode(targetTopClassifier) != null) {
      addImport(modelRef);
      return jetbrains.mps.smodel.SReference.create(role,source,modelRef,targetNodeId,resolveInfo);
    }
  }
  if (possibleModels.size() == 1) {
    SModelReference targetModel=possibleModels.iterator().next().getReference();
    addImport(targetModel);
    return jetbrains.mps.smodel.SReference.create(role,source,targetModel,targetNodeId,resolveInfo);
  }
 else {
    for (    org.jetbrains.mps.openapi.model.SModel m : possibleModels) {
      addImport(m.getReference());
    }
    return DynamicReference.createDynamicReference(role,source,pack,resolveInfo);
  }
}
