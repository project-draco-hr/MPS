{
  final MPSTreeNode target=getTargetTreeNode(dtde);
  final List<Pair<SNodeReference,String>> sourceNodes=getSourceNodes(dtde);
  if (!isDropTargetAcceptable(target,sourceNodes)) {
    dtde.rejectDrop();
    return;
  }
  dtde.acceptDrop(dtde.getDropAction());
  Project project=MPSDataKeys.PROJECT.getData(DataManager.getInstance().getDataContext());
  JFrame frame=WindowManager.getInstance().getFrame(project);
  final String targetPackage=(getTargetVirtualPackage(target) == null) ? "" : getTargetVirtualPackage(target);
  String text=getConfirmLabel(sourceNodes.size(),targetPackage);
  int result=JOptionPane.showConfirmDialog(frame,text,"Move Nodes",JOptionPane.YES_NO_OPTION);
  if (result != JOptionPane.YES_OPTION)   return;
  ModelAccess.instance().runWriteActionInCommand(new Runnable(){
    @Override public void run(){
      SModel targetModel=getTargetModel(target);
      if (targetModel == null)       return;
      for (      Pair<SNode,String> sourceNode : getNodesToMove(targetModel,targetPackage,sourceNodes)) {
        String fullTargetPack=getFullTargetPack(targetPackage,sourceNode.o2);
        SNodeAccessUtil.setProperty(sourceNode.o1,SNodeUtil.property_BaseConcept_virtualPackage,fullTargetPack);
        if (SNodeOperations.isInstanceOf(sourceNode.o1,SNodeUtil.concept_AbstractConceptDeclaration)) {
          List<SNode> allAspects=SNodeUtil.findAllAspects(sourceNode.o1);
          for (          SNode aspect : allAspects) {
            SNodeAccessUtil.setProperty(aspect,SNodeUtil.property_BaseConcept_virtualPackage,fullTargetPack);
          }
        }
      }
    }
  }
);
}
