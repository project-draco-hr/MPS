{
  long startTime=System.currentTimeMillis();
  Set<SModule> modulesToLoad=new HashSet<SModule>();
  for (  SModule module : modules) {
    if (ModuleClassLoaderSupport.canCreate(module)) {
      if (getClassLoader(module) != null) {
        LOG.warning("ModuleClassLoader should be unloaded before load for module " + module,new Throwable());
      }
      modulesToLoad.add(module);
    }
  }
  modulesToLoad=Collections.unmodifiableSet(modulesToLoad);
  if (modulesToLoad.isEmpty())   return modulesToLoad;
  for (  SModule module : modules) {
    if (ModuleClassLoaderSupport.canCreate(module)) {
      createClassLoader(module);
    }
  }
  addStat("load:main",startTime);
  monitor.start("Load classes...",1);
  try {
    monitor.step("Rebuilding ui...");
    for (    MPSClassesListener listener : myClassesHandlers) {
      startTime=System.currentTimeMillis();
      try {
        listener.afterClassesLoaded(modulesToLoad);
      }
 catch (      Throwable t) {
        LOG.error(t);
      }
 finally {
        addStat("load:" + listener.getClass().getName(),startTime);
      }
    }
    monitor.advance(1);
  }
  finally {
    monitor.done();
  }
  return modulesToLoad;
}
