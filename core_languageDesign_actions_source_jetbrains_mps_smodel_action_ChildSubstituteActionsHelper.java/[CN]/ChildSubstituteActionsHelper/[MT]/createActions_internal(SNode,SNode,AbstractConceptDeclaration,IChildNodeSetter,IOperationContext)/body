{
  boolean wrapped=!(childSetter instanceof DefaultChildNodeSetter);
  List<INodeSubstituteAction> resultActions=new ArrayList<INodeSubstituteAction>();
  if (childConcept == null) {
    return resultActions;
  }
  if (childConcept == SModelUtil_new.getBaseConcept()) {
    if ((currentChild == null || currentChild.getConceptFqName().equals(BaseConcept.concept))) {
      resultActions=new ArrayList<INodeSubstituteAction>();
      ISearchScope conceptsSearchScope=SModelSearchUtil.createConceptsFromModelLanguagesScope(parentNode.getModel(),true,context.getScope());
      List<SNode> allVisibleConcepts=conceptsSearchScope.getNodes();
      for (      final SNode visibleConcept : allVisibleConcepts) {
        resultActions.add(new DefaultChildNodeSubstituteAction(visibleConcept,parentNode,currentChild,childSetter,context.getScope()){
          public String getMatchingText(          String pattern){
            return getMatchingText(pattern,true,true);
          }
          public String getVisibleMatchingText(          String pattern){
            return getMatchingText(pattern);
          }
          public String getDescriptionText(          String pattern){
            String fqName=NameUtil.nodeFQName(visibleConcept);
            return "lang: " + NameUtil.compactNamespace(NameUtil.namespaceFromConceptFQName(fqName));
          }
          public Icon getIconFor(          String pattern){
            return getIconFor(pattern,true);
          }
        }
);
      }
      return resultActions;
    }
    childConcept=currentChild.getConceptDeclarationAdapter();
    if (childConcept instanceof ConceptDeclaration) {
      ConceptDeclaration baseConcept=SModelUtil_new.getBaseConcept();
      while (((ConceptDeclaration)childConcept).getExtends() != null) {
        ConceptDeclaration extendedConcept=((ConceptDeclaration)childConcept).getExtends();
        if (extendedConcept == baseConcept)         break;
        childConcept=extendedConcept;
      }
    }
  }
  IScope scope=context.getScope();
  Language primaryLanguage=SModelUtil_new.getDeclaringLanguage(childConcept,scope);
  if (primaryLanguage == null) {
    LOG.error("Couldn't build actions : couldn't get declaring language for concept " + childConcept.getDebugText());
    return resultActions;
  }
  List<NodeSubstituteActionsBuilder> allBuilders=new ArrayList<NodeSubstituteActionsBuilder>();
  LinkDeclaration link=null;
  if (childSetter instanceof DefaultChildNodeSetter) {
    link=(LinkDeclaration)BaseAdapter.fromNode(((DefaultChildNodeSetter)childSetter).getLinkDeclaration());
  }
  List<Language> languages=SModelOperations.getLanguages(parentNode.getModel(),scope);
  for (  NodeSubstituteActionsBuilder actionsBuilder : getAllActionsBuilders(languages)) {
    AbstractConceptDeclaration applicableConcept=actionsBuilder.getApplicableConcept();
    if (applicableConcept == null)     continue;
    if (SModelUtil_new.isAssignableConcept(applicableConcept,childConcept) || SModelUtil_new.isAssignableConcept(childConcept,applicableConcept)) {
      if (satisfiesPrecondition(actionsBuilder,parentNode,applicableConcept,BaseAdapter.fromAdapter(link),currentChild,wrapped,context)) {
        allBuilders.add(actionsBuilder);
      }
    }
  }
  if (!containsRemoveDefaults(allBuilders)) {
    resultActions.addAll(createPrimaryChildSubstituteActions(parentNode,currentChild,childConcept,childSetter,context));
  }
  for (  NodeSubstituteActionsBuilder builder : allBuilders) {
    List<INodeSubstituteAction> addActions=invokeActionFactory(builder,parentNode,currentChild,childConcept,childSetter,context);
    resultActions.addAll(addActions);
  }
  for (  NodeSubstituteActionsBuilder builder : allBuilders) {
    resultActions=applyActionFilter(builder,resultActions,parentNode,currentChild,childConcept.getNode(),context);
  }
  if (childSetter instanceof DefaultChildNodeSetter) {
    DefaultChildNodeSetter settter=(DefaultChildNodeSetter)childSetter;
    Iterator<INodeSubstituteAction> it=resultActions.iterator();
    while (it.hasNext()) {
      INodeSubstituteAction action=it.next();
      SNode conceptNode=action.getOutputConcept();
      if (conceptNode == null) {
        continue;
      }
      if (!ModelConstraintsManager.getInstance().canBeParent(parentNode,conceptNode,settter.myLinkDeclaration,context) || !ModelConstraintsManager.getInstance().canBeAncestor(parentNode,conceptNode,context)) {
        it.remove();
      }
    }
  }
  return resultActions;
}
