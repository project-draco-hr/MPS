{
  final boolean needToRegenerate=myRegenerateLanguage.getModel().isSelected();
  final List<File>[] oldModelRootsContainer=new List[]{null};
  boolean renamed=ModelAccess.instance().runWriteActionInCommand(new Computable<Boolean>(){
    public Boolean compute(){
      final String fqName=myLanguageNameField.getText();
      if (MPSModuleRepository.getInstance().getModuleByUID(fqName) != null) {
        setErrorText("Duplicate language name");
        return false;
      }
      if (needToRegenerate) {
        oldModelRootsContainer[0]=getModelOutputRoots();
      }
      new LanguageRenamer(myLanguage,fqName).rename();
      return true;
    }
  }
);
  if (!renamed) {
    return;
  }
  if (needToRegenerate) {
    final MPSProject mpsProject=myProject.getComponent(MPSProjectHolder.class).getMPSProject();
    GenParameters params=ModelAccess.instance().runReadAction(new Computable<GenParameters>(){
      public GenParameters compute(){
        if (oldModelRootsContainer[0] != null) {
          List<File> oldModelRoots=oldModelRootsContainer[0];
          List<File> newModelRoots=getModelOutputRoots();
          MPSVCSManager.getInstance(myProject).deleteFilesAndRemoveFromVcs(getFilesToDelete(oldModelRoots,newModelRoots));
        }
        SModel model=AuxilaryRuntimeModel.getDescriptor().getSModel();
        LanguageGeneratorConfiguration languageConfig=LanguageGeneratorConfiguration.newInstance(model);
        languageConfig.setLanguageNamespace(myLanguage.getNamespace());
        languageConfig.setName("tmp");
        return GeneratorConfigUtil.calculate(mpsProject,languageConfig,true);
      }
    }
);
    myProject.getComponent(GeneratorManager.class).generateModelsFromDifferentModules(new ModuleContext(myLanguage,mpsProject),params.getModels(),IGenerationType.FILES);
  }
  dispose();
}
