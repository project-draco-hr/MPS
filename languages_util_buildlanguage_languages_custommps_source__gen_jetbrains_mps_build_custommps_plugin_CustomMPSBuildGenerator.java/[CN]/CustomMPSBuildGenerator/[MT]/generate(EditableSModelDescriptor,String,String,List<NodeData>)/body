{
  final SNode mpsLayout=this.createMPSLayout(targetModelDescriptor,name,basedir,selectedData);
  SNode zipNode=SNodeOperations.cast(ListSequence.fromList(SLinkOperations.getTargets(mpsLayout,"component",true)).first(),"jetbrains.mps.build.packaging.structure.Zip");
  SNode rootFolder=SNodeOperations.cast(ListSequence.fromList(SLinkOperations.getTargets(zipNode,"entry",true)).first(),"jetbrains.mps.build.packaging.structure.Folder");
  List<SNode> entries=SLinkOperations.getTargets(rootFolder,"entry",true);
  SNode mpsBuild=SConceptOperations.createNewNode("jetbrains.mps.build.custommps.structure.MPSBuild",null);
  ListSequence.fromList(SLinkOperations.getTargets(mpsLayout,"component",true)).addElement(mpsBuild);
  SNode libraryFolder=createLibraryFolder(rootFolder);
  for (  SNode entry : ListSequence.fromList(entries)) {
    if (SNodeOperations.isInstanceOf(entry,"jetbrains.mps.build.packaging.structure.Module")) {
      ListSequence.fromList(SLinkOperations.getTargets(libraryFolder,"entry",true)).addElement(entry);
    }
 else     if (SNodeOperations.isInstanceOf(entry,"jetbrains.mps.build.packaging.structure.Folder")) {
      SNode oldFolder=SNodeOperations.cast(entry,"jetbrains.mps.build.packaging.structure.Folder");
      SNode newFolder=createLibraryFolder(oldFolder);
      ListSequence.fromList(SLinkOperations.getTargets(newFolder,"entry",true)).addSequence(ListSequence.fromList(SLinkOperations.getTargets(oldFolder,"entry",true)));
      ListSequence.fromList(SLinkOperations.getTargets(mpsBuild,"entry",true)).addElement(newFolder);
    }
  }
  if (ListSequence.fromList(SLinkOperations.getTargets(libraryFolder,"entry",true)).isNotEmpty()) {
    ListSequence.fromList(SLinkOperations.getTargets(mpsBuild,"entry",true)).addElement(libraryFolder);
  }
  SNodeOperations.deleteNode(zipNode);
  SNode buildToolsPath=SConceptOperations.createNewNode("jetbrains.mps.build.packaging.structure.Path",null);
  String result=MacrosFactory.mpsHomeMacros().shrinkPath(this.myPathToBuildTools,new File("")).replace("\\",File.separator);
  int index=result.lastIndexOf("}");
  if (index > -1) {
    String macro=result.substring(result.indexOf("{") + 1,index);
    PackagingLanguageGenerator.createPath(buildToolsPath,macro,result.substring(index + 2));
  }
 else {
    PackagingLanguageGenerator.createPath(buildToolsPath,"",this.myPathToBuildTools);
  }
  SLinkOperations.setTarget(mpsBuild,"pathToBuildToolsZip",buildToolsPath,true);
  return new Runnable(){
    public void run(){
      CustomMPSBuildGenerator.this.finishGeneration(targetModelDescriptor,mpsLayout);
    }
  }
;
}
