{
  myMessageBusConnection=ApplicationManager.getApplication().getMessageBus().connect();
  myMessageBusConnection.subscribe(AppTopics.FILE_DOCUMENT_SYNC,new FileDocumentManagerAdapter(){
    public void beforeAllDocumentsSaving(){
      ModelAccess.instance().runWriteActionInCommand(new Runnable(){
        public void run(){
          if (!GeneralSettings.getInstance().isSaveOnFrameDeactivation() && !GeneralSettings.getInstance().isAutoSaveIfInactive() && !SModelRepository.getInstance().getChangedModels().isEmpty()&& !isFromSaveAll()) {
            return;
          }
          SModelRepository.getInstance().saveAll();
        }
      }
);
    }
    private boolean isFromSaveAll(){
      for (      StackTraceElement e : Thread.getAllStackTraces().get(Thread.currentThread())) {
        if (e.getClassName().equals(SaveAllAction.class.getName()) && e.getMethodName().equals("actionPerformed")) {
          return true;
        }
      }
      return false;
    }
  }
);
}
