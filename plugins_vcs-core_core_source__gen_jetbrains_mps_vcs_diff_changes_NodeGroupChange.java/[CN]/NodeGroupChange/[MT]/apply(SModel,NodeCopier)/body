{
  prepare();
  ListSequence.fromList(myPreparedIdsToDelete).visitAll(new IVisitor<SNodeId>(){
    public void visit(    SNodeId id){
      model.getNodeById(id).delete();
    }
  }
);
  myPreparedIdsToDelete=null;
  List<SNode> nodesToAdd=ListSequence.fromList(new ArrayList<SNode>());
  List<jetbrains.mps.smodel.SNode> newChildren=IterableUtil.asList(getChangeSet().getNewModel().getNodeById(myParentNodeId).getChildren(myRole));
  for (int i=myResultBegin; i < myResultEnd; i++) {
    ListSequence.fromList(nodesToAdd).addElement(nodeCopier.copyNode(newChildren.get(i)));
  }
  SNode anchor=(myPreparedAnchorId == null ? null : model.getNodeById(myPreparedAnchorId));
  SNode parent=model.getNodeById(myParentNodeId);
  for (  SNode newNode : ListSequence.fromList(nodesToAdd).reversedList()) {
    parent.insertChild(myRole,newNode,anchor);
  }
}
