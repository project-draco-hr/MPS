{
  final Set<BaseSNodeDescriptor> keys=new HashSet<BaseSNodeDescriptor>();
  final ID<Integer,List<BaseSNodeDescriptor>> indexName=myIndex.getName();
  final FileBasedIndex fileBasedIndex=FileBasedIndex.getInstance();
  Set<SModelDescriptor> findDirectly=new HashSet<SModelDescriptor>();
  for (  SModelDescriptor sm : scope.getModelDescriptors()) {
    if (!SModelStereotype.isUserModel(sm))     continue;
    if (!(sm instanceof DefaultSModelDescriptor)) {
      if (sm.isLoaded()) {
        findDirectly.add(sm);
      }
      continue;
    }
    DefaultSModelDescriptor esm=(DefaultSModelDescriptor)sm;
    if (esm.getLoadingState() == ModelLoadingState.FULLY_LOADED) {
      findDirectly.add(sm);
      continue;
    }
    IFile modelFile=esm.getSource().getFile();
    VirtualFile vf=VirtualFileUtils.getVirtualFile(modelFile);
    if (vf == null)     continue;
    int fileId=FileBasedIndex.getFileId(vf);
    List<List<BaseSNodeDescriptor>> descriptors=fileBasedIndex.getValues(indexName,fileId,GlobalSearchScope.fileScope(getProject(),vf));
    if (descriptors.isEmpty())     continue;
    boolean needToLoad=false;
    for (    BaseSNodeDescriptor snd : descriptors.get(0)) {
      PropertyConstraintsDescriptor descriptor=ConceptRegistry.getInstance().getConstraintsDescriptor(snd.getConceptFqName()).getProperty(SNodeUtil.property_INamedConcept_name);
      if (descriptor instanceof BasePropertyConstraintsDescriptor && !((BasePropertyConstraintsDescriptor)descriptor).isGetterDefault()) {
        needToLoad=true;
        break;
      }
    }
    if (needToLoad) {
      findDirectly.add(sm);
    }
 else {
      keys.addAll(descriptors.get(0));
    }
  }
  for (  SModelDescriptor sm : findDirectly) {
    for (    SNode root : myIndex.getRootsToIterate(sm.getSModel())) {
      String nodeName=(root.getName() == null) ? "null" : root.getName();
      BaseSNodeDescriptor nodeDescriptor=SNodeDescriptor.fromModelReference(nodeName,root.getConcept().getId(),root.getModel().getSModelReference(),root.getSNodeId());
      keys.add(nodeDescriptor);
    }
  }
  for (  SModelDescriptor m : scope.getModelDescriptors()) {
    keys.addAll(StubsNodeDescriptorsCache.getInstance().getSNodeDescriptors(m.getSModelReference()));
  }
  return keys.toArray(new BaseSNodeDescriptor[keys.size()]);
}
