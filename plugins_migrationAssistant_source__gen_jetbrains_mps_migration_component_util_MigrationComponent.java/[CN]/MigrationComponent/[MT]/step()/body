{
  ModelAccess.instance().runWriteAction(new Runnable(){
    public void run(){
      Iterable<ScriptApplied> allStepScripts=fetchScripts();
      Iterable<ScriptApplied> availableScripts=Sequence.fromIterable(allStepScripts).where(new IWhereFilter<ScriptApplied>(){
        public boolean accept(        ScriptApplied it){
          return isAvailable(it);
        }
      }
);
      if (Sequence.fromIterable(availableScripts).isNotEmpty()) {
        boolean success=executeScript(Sequence.fromIterable(availableScripts).first());
        lastState=(success ? MigrationManager.MigrationState.STEP : MigrationManager.MigrationState.ERROR);
      }
 else {
        if (Sequence.fromIterable(allStepScripts).isEmpty()) {
          if (isMigrationRequired()) {
            lastState=MigrationManager.MigrationState.FINISHED;
          }
 else {
            lastState=MigrationManager.MigrationState.ERROR;
          }
        }
 else {
          lastState=MigrationManager.MigrationState.CONFLICT;
        }
      }
    }
  }
);
  return lastState;
}
