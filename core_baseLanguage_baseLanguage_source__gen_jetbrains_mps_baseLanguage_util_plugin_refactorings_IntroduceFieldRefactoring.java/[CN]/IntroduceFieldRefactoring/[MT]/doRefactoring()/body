{
  this.findDuplicates();
  SNode newDeclaration;
  if (this.myFieldInitialization == FieldInitializationPlace.FIELD) {
    newDeclaration=new IntroduceFieldRefactoring.QuotationClass_baxqxe_a0a0a2a1().createNode(myVisibilityLevel.getNode(),SNodeOperations.copyNode(this.getExpressionType()),SNodeOperations.copyNode(this.getExpression()),this.getName());
  }
 else {
    newDeclaration=new IntroduceFieldRefactoring.QuotationClass_baxqxe_a0a0a0c0b().createNode(myVisibilityLevel.getNode(),SNodeOperations.copyNode(this.getExpressionType()),this.getName());
  }
  if (myIsFinal) {
    SPropertyOperations.set(newDeclaration,"isFinal","" + true);
  }
  SNode classConcept=SNodeOperations.getAncestor(this.getExpression(),"jetbrains.mps.baseLanguage.structure.ClassConcept",false,false);
  ListSequence.fromList(SLinkOperations.getTargets(classConcept,"field",true)).addElement(newDeclaration);
  SNode assignStatement=new IntroduceFieldRefactoring.QuotationClass_baxqxe_a0a6a1().createNode(newDeclaration,SNodeOperations.copyNode(this.getExpression()));
  if (this.myFieldInitialization == FieldInitializationPlace.METHOD) {
    SNodeOperations.insertPrevSiblingChild(SNodeOperations.getAncestor(this.getExpression(),"jetbrains.mps.baseLanguage.structure.Statement",false,false),SNodeOperations.copyNode(assignStatement));
  }
  if (this.myFieldInitialization == FieldInitializationPlace.CONSTRUCTOR) {
    SNode declaration=SNodeOperations.getAncestor(this.getExpression(),"jetbrains.mps.baseLanguage.structure.ClassConcept",false,false);
    for (    SNode constructor : ListSequence.fromList(SLinkOperations.getTargets(declaration,"constructor",true))) {
      List<SNode> statement=SLinkOperations.getTargets(SLinkOperations.getTarget(constructor,"body",true),"statement",true);
      if (ListSequence.fromList(statement).isNotEmpty()) {
        SNodeOperations.insertPrevSiblingChild(ListSequence.fromList(statement).first(),SNodeOperations.copyNode(assignStatement));
      }
 else {
        ListSequence.fromList(statement).addElement(SNodeOperations.copyNode(assignStatement));
      }
    }
  }
  replaceNode(this.getExpression(),newDeclaration);
  if (myIsReplacingAll) {
    for (    SNode duplicate : ListSequence.fromList(myDuplicates)) {
      replaceNode(duplicate,newDeclaration);
    }
  }
  return newDeclaration;
}
