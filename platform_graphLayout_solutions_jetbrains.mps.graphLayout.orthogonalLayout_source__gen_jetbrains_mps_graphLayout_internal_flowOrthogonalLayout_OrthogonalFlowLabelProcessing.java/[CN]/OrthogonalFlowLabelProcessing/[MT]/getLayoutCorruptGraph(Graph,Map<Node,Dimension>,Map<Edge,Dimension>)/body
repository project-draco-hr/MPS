{
  Set<Node> initialNodes=SetSequence.fromSet(new HashSet<Node>());
  SetSequence.fromSet(initialNodes).addSequence(ListSequence.fromList(graph.getNodes()));
  Set<Edge> initialEdges=SetSequence.fromSet(new HashSet<Edge>());
  SetSequence.fromSet(initialEdges).addSequence(ListSequence.fromList(graph.getEdges()));
  EdgesHistoryManager historyManager=new EdgesHistoryManager(graph);
  BiconnectAugmentation.smartMakeBiconnected(graph);
  EmbeddedGraph embeddedGraph=new ShortestPathEmbeddingFinder(new PQPlanarizationFinder()).find(graph);
  Map<Edge,List<Edge>> history=MapSequence.fromMap(new HashMap<Edge,List<Edge>>());
  Map<Edge,Edge> labeledEdge=MapSequence.fromMap(new HashMap<Edge,Edge>());
  for (  Edge edge : SetSequence.fromSet(initialEdges)) {
    MapSequence.fromMap(history).put(edge,historyManager.getHistory(edge));
    MapSequence.fromMap(labeledEdge).put(edge,getLabeledEdge(MapSequence.fromMap(history).get(edge)));
  }
  Map<Edge,Dimension> labelSizes=MapSequence.fromMap(new HashMap<Edge,Dimension>());
  for (  Edge edge : SetSequence.fromSet(MapSequence.fromMap(initialLabelSizes).keySet())) {
    MapSequence.fromMap(labelSizes).put(MapSequence.fromMap(labeledEdge).get(edge),MapSequence.fromMap(initialLabelSizes).get(edge));
  }
  GraphLayout layout=getlayoutFromEmbeddedGraph(embeddedGraph,nodeSizes,labelSizes,historyManager);
  GraphLayout initialLayout=new GraphLayout(graph);
  for (  Node node : SetSequence.fromSet(initialNodes)) {
    initialLayout.setLayoutFor(node,layout.getNodeLayout(node));
  }
  for (  Edge edge : SetSequence.fromSet(initialEdges)) {
    List<Point> edgeLayout=ListSequence.fromList(new ArrayList<Point>());
    Node cur=edge.getSource();
    for (    Edge historyEdge : ListSequence.fromList(MapSequence.fromMap(history).get(edge))) {
      List<Point> historyLayout=layout.getEdgeLayout(historyEdge);
      if (historyEdge.getSource() != cur) {
        historyLayout=ListSequence.fromList(historyLayout).reversedList();
      }
      ListSequence.fromList(edgeLayout).addSequence(ListSequence.fromList(historyLayout));
      cur=historyEdge.getOpposite(cur);
    }
    initialLayout.setLayoutFor(edge,edgeLayout);
  }
  for (  Edge edge : SetSequence.fromSet(MapSequence.fromMap(initialLabelSizes).keySet())) {
    initialLayout.setLabelLayout(edge,layout.getLabelLayout(MapSequence.fromMap(labeledEdge).get(edge)));
  }
  return initialLayout;
}
