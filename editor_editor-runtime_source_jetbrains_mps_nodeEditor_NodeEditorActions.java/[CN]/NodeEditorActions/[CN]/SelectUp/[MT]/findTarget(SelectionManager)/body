{
  Selection selection=selectionManager.getSelection();
  if (selection == null) {
    return null;
  }
  jetbrains.mps.openapi.editor.cells.EditorCell cell=selection.getSelectedCells().get(0);
  if (cell instanceof EditorCell_Label && !((EditorCell_Label)cell).isEverythingSelected()) {
    return (EditorCell)cell;
  }
  if (cell.getParent() == null) {
    return null;
  }
  while (cell.getParent() != null && cell.getParent().isTransparentCollection()) {
    cell=cell.getParent();
  }
  jetbrains.mps.openapi.editor.cells.EditorCell_Collection parent=cell.getParent();
  while (parent != null) {
    if (parent.isSelectable()) {
      while (parent.getParent() != null && parent.getParent().isTransparentCollection() && parent.getParent().isSelectable()) {
        parent=parent.getParent();
      }
      return (EditorCell)parent;
    }
    parent=parent.getParent();
  }
  return null;
}
