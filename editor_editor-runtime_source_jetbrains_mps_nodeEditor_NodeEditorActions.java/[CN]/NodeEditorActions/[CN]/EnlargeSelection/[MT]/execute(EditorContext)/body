{
  EditorComponent editorComponent=context.getEditorComponent();
  SelectionManager selectionManager=editorComponent.getSelectionManager();
  Selection selection=selectionManager.getSelection();
  if (selection instanceof SingularSelection) {
    EditorCell selectedCell=((SingularSelection)selection).getEditorCell();
    SNode selectedNode=selectedCell.getSNode();
    SNode topMostNodeInSingularContainment=findTopMostNodeWithSingularContainment(selectedNode);
    if (topMostNodeInSingularContainment != selectedNode) {
      EditorCell nodeCell=editorComponent.findNodeCell(topMostNodeInSingularContainment);
      if (nodeCell != null) {
        ((jetbrains.mps.nodeEditor.EditorComponent)editorComponent).pushSelection(nodeCell);
        editorComponent.scrollToCell(nodeCell);
      }
    }
 else {
      Selection newSelection=selectionManager.createRangeSelection(selectedNode,selectedNode);
      if (newSelection instanceof NodeRangeSelection && selectedCell.isBig()) {
        newSelection=((NodeRangeSelection)newSelection).enlargeSelection(myUp);
      }
      if (newSelection != null) {
        selectionManager.pushSelection(newSelection);
        newSelection.ensureVisible();
      }
    }
  }
 else   if (selection instanceof NodeRangeSelection) {
    Selection newSelection=((NodeRangeSelection)selection).enlargeSelection(myUp);
    if (newSelection != null) {
      selectionManager.pushSelection(newSelection);
      newSelection.ensureVisible();
    }
  }
}
