{
  if (!(queryParameters.getScope() instanceof GlobalSearchScope)) {
    return;
  }
  GlobalSearchScope scope=(GlobalSearchScope)queryParameters.getEffectiveSearchScope();
  final Project project=scope.getProject();
  final MPSPsiProvider psiProvider=MPSPsiProvider.getInstance(project);
  final PsiElement psiTarget=queryParameters.getElementToSearch();
  final SNodeId targetNodeId=MPS2PsiMapperUtil.getNodeId(psiTarget);
  if (targetNodeId == null) {
    return;
  }
  for (  Module module : ModuleManager.getInstance(project).getModules()) {
    if (!scope.isSearchInModuleContent(module))     continue;
    MPSFacet facet=FacetManager.getInstance(module).getFacetByType(MPSFacetType.ID);
    if (facet == null)     continue;
    final Solution facetSolution=facet.getSolution();
    ModelAccess.instance().runReadAction(new Runnable(){
      @Override public void run(){
        for (        SModel model : SModelRepository.getInstance().getModelDescriptors(facetSolution)) {
          Deque<SNode> stack=new ArrayDeque<SNode>();
          for (          SNode node : model.getRootNodes()) {
            stack.addLast(node);
          }
          while (!stack.isEmpty()) {
            SNode node=stack.pop();
            for (            SNode child : node.getChildren()) {
              stack.push(child);
            }
            for (            SReference ref : node.getReferences()) {
              SNodeId refTargetNodeId=ref.getTargetNodeId();
              if (!(refTargetNodeId instanceof Foreign))               continue;
              String s=refTargetNodeId.toString();
              if (s.equals(targetNodeId.toString())) {
                MPSPsiNode psiNode=(MPSPsiNode)psiProvider.getPsi(node);
                String refRole=ref.getRole();
                MPSPsiRef[] refs=psiNode.getReferences(refRole);
                for (                MPSPsiRef r : refs) {
                  if (targetNodeId.equals(r.getNodeId())) {
                    consumer.process(r.getReference());
                  }
                }
              }
 else               if (s.startsWith(targetNodeId.toString())) {
              }
            }
          }
        }
      }
    }
);
  }
}
