{
  Element rootElement=document.getRootElement();
  String modelLongName=rootElement.getAttributeValue(NAME);
  if (modelLongName == null) {
    String modelNamespace=rootElement.getAttributeValue(NAMESPACE,"");
    modelLongName=NameUtil.longNameFromNamespaceAndShortName(modelNamespace,modelName);
  }
 else {
    String shortName=NameUtil.shortNameFromLongName(modelLongName);
    LOG.assertLog(shortName.equals(modelName));
  }
  SModel model=new SModel(new SModelUID(modelLongName,stereotype));
  model.setLoading(true);
  try {
    Element maxImportIndex=rootElement.getChild(MAX_IMPORT_INDEX);
    if (maxImportIndex == null)     maxImportIndex=rootElement.getChild("maxReferenceID");
    model.setMaxImportIndex(readIntAttributeValue(maxImportIndex,VALUE));
  }
 catch (  Throwable e) {
    LOG.error(e);
  }
  String extResolvedString=rootElement.getAttributeValue(IS_EXTERNALLY_RESOLVED);
  if (extResolvedString == null) {
    PersistExternalResolveUtil.loadExternallyResolvedDefaults(model);
  }
 else {
    boolean externallyResolved=Boolean.parseBoolean(extResolvedString);
    model.setExternallyResolved(externallyResolved);
  }
  List languages=rootElement.getChildren(LANGUAGE);
  for (Iterator iterator=languages.iterator(); iterator.hasNext(); ) {
    Element element=(Element)iterator.next();
    String languageNamespace=element.getAttributeValue(NAMESPACE);
    model.addLanguage(languageNamespace);
  }
  Map<Integer,SModelUID> importedUIDtoIndex=new HashMap<Integer,SModelUID>();
  List imports=rootElement.getChildren(IMPORT_ELEMENT);
  for (Iterator iterator=imports.iterator(); iterator.hasNext(); ) {
    Element element=(Element)iterator.next();
    String indexValue=element.getAttributeValue(MODEL_IMPORT_INDEX,element.getAttributeValue("referenceID"));
    int importIndex=Integer.parseInt(indexValue);
    String importedModelUIDString=element.getAttributeValue(MODEL_UID);
    if (importedModelUIDString == null) {
      String importedModelFQName=NameUtil.longNameFromNamespaceAndShortName(element.getAttributeValue(NAMESPACE),element.getAttributeValue(NAME));
      String importedModelStereotype=element.getAttributeValue(STEREOTYPE,"");
      importedModelUIDString=new SModelUID(importedModelFQName,importedModelStereotype).toString();
    }
    if (importedModelUIDString == null) {
      LOG.error("Error loading import element for index " + importIndex + " in "+ model.getUID());
      continue;
    }
    if (importIndex > model.getMaxImportIndex()) {
      LOG.warning("Import element " + importIndex + ":"+ importedModelUIDString+ " greater then max import index ("+ model.getMaxImportIndex()+ ") in "+ model.getUID());
      model.setMaxImportIndex(importIndex);
    }
    SModelUID importedModelUID=SModelUID.fromString(importedModelUIDString);
    model.addImportElement(importedModelUID,importIndex);
    importedUIDtoIndex.put(importIndex,importedModelUID);
  }
  ArrayList<ReferenceDescriptor> referenceDescriptors=new ArrayList<ReferenceDescriptor>();
  List children=rootElement.getChildren(NODE);
  for (Iterator iterator=children.iterator(); iterator.hasNext(); ) {
    Element element=(Element)iterator.next();
    SNode semanticNode=readNode(element,model,referenceDescriptors);
    model.addRoot(semanticNode);
  }
  for (  ReferenceDescriptor referenceDescriptor : referenceDescriptors) {
    SModelUID importedModelUID=model.getUID();
    if (referenceDescriptor.importIndex > -1) {
      importedModelUID=importedUIDtoIndex.get(referenceDescriptor.importIndex);
      if (importedModelUID == null) {
        LOG.error("Couldn't create reference from " + referenceDescriptor.sourceNode.getDebugText() + " : import for index ["+ referenceDescriptor.importIndex+ "] not found");
        continue;
      }
    }
    SReference reference=SReference.newInstance(referenceDescriptor.role,referenceDescriptor.sourceNode,referenceDescriptor.targetId,referenceDescriptor.extResolveInfo,importedModelUID,referenceDescriptor.resolveInfo,referenceDescriptor.targetClassResolveInfo);
    if (reference != null)     referenceDescriptor.sourceNode.addSemanticReference(reference);
  }
  model.setLoading(false);
  return model;
}
