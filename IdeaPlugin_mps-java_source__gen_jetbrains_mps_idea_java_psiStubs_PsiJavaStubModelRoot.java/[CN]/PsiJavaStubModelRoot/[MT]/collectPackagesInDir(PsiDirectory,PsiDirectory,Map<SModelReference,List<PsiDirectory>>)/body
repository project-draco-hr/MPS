{
  if (Sequence.fromIterable(Sequence.fromArray(dir.getFiles())).ofType(PsiJavaFile.class).isNotEmpty()) {
    jetbrains.mps.smodel.SModelReference modelRef=makeModelReference(sourceRoot,dir);
    List<PsiDirectory> dirs=MapSequence.fromMap(result).get(modelRef);
    if (dirs == null) {
      dirs=ListSequence.fromList(new ArrayList<PsiDirectory>());
      MapSequence.fromMap(result).put(modelRef,dirs);
    }
    ListSequence.fromList(dirs).addElement(dir);
  }
  for (  PsiDirectory subDir : dir.getSubdirectories()) {
    collectPackagesInDir(sourceRoot,subDir,result);
  }
}
