{
  try {
    SNode child=mapNode();
    if (child == null) {
      return;
    }
    Language childLang=jetbrains.mps.util.SNodeOperations.getLanguage(child);
    if (!myGenerator.getGeneratorSessionContext().getGenerationPlan().isCountedLanguage(childLang)) {
      if (!childLang.getGenerators().isEmpty()) {
        myLogger.error(child,"language of output node is '" + childLang.getModuleName() + "' - this language did not show up when computing generation steps!",GeneratorUtil.describe(myContext.getInput(),"input"),GeneratorUtil.describe(getMapSrcMacro(),"template"),new ProblemDescription(null,"workaround: add the language '" + childLang.getModuleName() + "' to list of 'Languages Engaged On Generation' in model '"+ myGenerator.getGeneratorSessionContext().getOriginalInputModel().getReference().getModelName()+ "'"));
      }
    }
    if (child.getModel() != null) {
      child=CopyUtil.copy(child);
    }
    validateReferences(child);
    SNode parent=myChildToReplace.getParent();
    if (parent == null) {
      if (myChildToReplace.getModel() != null && myChildToReplace.getParent() == null) {
        myChildToReplace.getModel().addRootNode(child);
        myChildToReplace.getModel().removeRootNode(myChildToReplace);
        myGenerator.rootReplaced(myChildToReplace,child);
      }
    }
 else {
      String childRole=myChildToReplace.getRoleInParent();
      final RoleValidator roleValidator=myGenerator.getChildRoleValidator(parent,childRole);
      RoleValidationStatus status=roleValidator.validate(child);
      if (status != null) {
        status.reportProblem(false,parent,"",GeneratorUtil.describe(myContext.getInput(),"input"),GeneratorUtil.describe(getMapSrcMacro(),"template"));
      }
      org.jetbrains.mps.openapi.model.SNodeUtil.replaceWithAnother(myChildToReplace,child);
    }
    myGenerator.getGenerationTracer().replaceOutputNode(myChildToReplace,child);
    postProcess(child);
  }
 catch (  Throwable t) {
    myGenerator.showErrorMessage(myContext.getInput(),getMapSrcMacro(),"mapping failed: '" + t.getMessage() + "'");
    myLogger.handleException(t);
  }
}
