{
  try {
    SNode child=mapNode();
    if (child == null) {
      return;
    }
    ChildAdopter ca=new ChildAdopter(generator);
    ca.checkIsExpectedLanguage(child,getMapSrcMacro(),myContext);
    child=ca.adopt(child,myContext);
    SNode parent=myChildToReplace.getParent();
    if (parent == null) {
      if (myChildToReplace.getModel() != null && myChildToReplace.getParent() == null) {
        myChildToReplace.getModel().addRootNode(child);
        myChildToReplace.getModel().removeRootNode(myChildToReplace);
        generator.rootReplaced(myChildToReplace,child);
      }
    }
 else {
      String childRole=myChildToReplace.getRoleInParent();
      final Status status=generator.getChildRoleValidator(parent,childRole).validate(child);
      if (status != null) {
        status.reportProblem(false,parent,"",GeneratorUtil.describe(myContext.getInput(),"input"),GeneratorUtil.describe(getMapSrcMacro(),"template"));
      }
      org.jetbrains.mps.openapi.model.SNodeUtil.replaceWithAnother(myChildToReplace,child);
    }
    generator.getGenerationTracer().replaceOutputNode(myChildToReplace,child);
    postProcess(child);
  }
 catch (  Throwable t) {
    IGeneratorLogger log=generator.getLogger();
    log.error(getMapSrcMacro(),String.format("mapping failed: '%s'",t.getMessage()),GeneratorUtil.describe(myContext.getInput(),"input"));
    log.handleException(t);
  }
}
