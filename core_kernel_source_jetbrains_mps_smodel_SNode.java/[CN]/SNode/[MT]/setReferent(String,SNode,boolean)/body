{
  if (ourMemberAccessModifier != null) {
    role=ourMemberAccessModifier.getNewReferentRole(myModel,myConceptFqName,role);
  }
  List<SReference> toDelete=new ArrayList<SReference>();
  if (myReferences != null) {
    for (    SReference reference : myReferences) {
      if (reference.getRole().equals(role)) {
        toDelete.add(reference);
      }
    }
  }
  SNode oldReferent=null;
  if (!toDelete.isEmpty()) {
    oldReferent=toDelete.get(0).getTargetNode();
  }
  if (toDelete.size() > 1) {
    LOG.errorWithTrace("ERROR! " + toDelete.size() + " references found for role '"+ role+ "' in "+ this.getDebugText());
  }
  for (  SReference reference : toDelete) {
    int index=_reference().indexOf(reference);
    removeReferenceAt(index);
  }
  SReference resultReference=null;
  if (newReferent != null) {
    resultReference=SReference.create(role,this,newReferent);
    insertReferenceAt(myReferences == null ? 0 : myReferences.length,resultReference);
  }
  if (useHandler && !getModel().isLoading()) {
    Set<Pair<SNode,String>> threadSet=ourSetReferentEventHandlersInProgress.get();
    Pair<SNode,String> pair=new Pair<SNode,String>(this,role);
    if (!threadSet.contains(pair)) {
      INodeReferentSetEventHandler handler=CONSTRAINTS_MANAGER.getNodeReferentSetEventHandler(this,role);
      if (handler != null) {
        threadSet.add(pair);
        try {
          handler.processReferentSetEvent(this,oldReferent,newReferent,GlobalScope.getInstance());
        }
  finally {
          threadSet.remove(pair);
        }
      }
    }
  }
  return resultReference;
}
