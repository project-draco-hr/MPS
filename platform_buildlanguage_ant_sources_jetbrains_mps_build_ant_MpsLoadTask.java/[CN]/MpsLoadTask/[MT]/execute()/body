{
  checkMpsHome();
  Set<File> classPaths=calculateClassPath();
  if (myUsePropertiesAsMacro) {
    Hashtable properties=getProject().getProperties();
    for (    Object name : properties.keySet()) {
      Object value=properties.get(name);
      myWhatToDo.addMacro((String)name,(String)value);
    }
  }
  if (myFork) {
    String currentClassPathString=System.getProperty("java.class.path");
    List<String> commandLine=new ArrayList<String>();
    commandLine.add(JavaEnvUtils.getJreExecutable("java"));
    if (myJvmArgs.isEmpty()) {
      commandLine.addAll(new JvmArgs().getArgs());
    }
 else {
      commandLine.addAll(myJvmArgs);
    }
    StringBuffer sb=new StringBuffer();
    String pathSeparator=System.getProperty("path.separator");
    for (    File cp : classPaths) {
      sb.append(pathSeparator);
      sb.append(cp.getAbsolutePath());
    }
    commandLine.add("-classpath");
    commandLine.add(currentClassPathString + sb.toString());
    commandLine.add(AntBootstrap.class.getCanonicalName());
    commandLine.add(getWorkerClass().getCanonicalName());
    dumpPropertiesToWhatToDo();
    try {
      commandLine.add(myWhatToDo.dumpToTmpFile().getAbsolutePath());
    }
 catch (    FileNotFoundException e) {
      throw new BuildException(e);
    }
    Execute exe=new Execute(getExecuteStreamHandler());
    exe.setAntRun(this.getProject());
    exe.setWorkingDirectory(this.getProject().getBaseDir());
    exe.setCommandline(commandLine.toArray(new String[commandLine.size()]));
    try {
      int i=exe.execute();
      if (i != 0) {
        processNonZeroExitCode(i);
      }
    }
 catch (    IOException e) {
      log(e,Project.MSG_ERR);
    }
  }
 else {
    List<URL> classPathUrls=new ArrayList<URL>();
    for (    File path : classPaths) {
      try {
        classPathUrls.add(new URL("file:///" + path + (path.isDirectory() ? "/" : "")));
      }
 catch (      MalformedURLException e) {
        throw new BuildException(e);
      }
    }
    URLClassLoader classLoader=new URLClassLoader(classPathUrls.toArray(new URL[classPathUrls.size()]),ProjectComponent.class.getClassLoader());
    try {
      Class<?> whatToGenerateClass=classLoader.loadClass(WhatToDo.class.getCanonicalName());
      Object whatToGenerate=whatToGenerateClass.newInstance();
      myWhatToDo.cloneTo(whatToGenerate);
      Class<?> generatorClass=classLoader.loadClass(getWorkerClass().getCanonicalName());
      Constructor<?> constructor=generatorClass.getConstructor(whatToGenerateClass,ProjectComponent.class);
      Object generator=constructor.newInstance(whatToGenerate,this);
      Method method=generatorClass.getMethod("work");
      method.invoke(generator);
    }
 catch (    ClassNotFoundException e) {
      throw new BuildException(e.getMessage() + "\n" + "Used class path: "+ classPathUrls.toString());
    }
catch (    NoSuchMethodException e) {
      throw new BuildException(e);
    }
catch (    InvocationTargetException e) {
      throw new BuildException(e.getTargetException());
    }
catch (    IllegalAccessException e) {
      throw new BuildException(e);
    }
catch (    InstantiationException e) {
      throw new BuildException(e);
    }
  }
}
