{
  List<SNode> layouts=SModelOperations.getRoots(_context.getModel(),"jetbrains.mps.build.packaging.structure.MPSLayout");
  for (  SNode layout : ListSequence.fromList(layouts)) {
    if (!(SPropertyOperations.getBoolean(layout,"compile"))) {
      continue;
    }
    List<SNode> modules=SNodeOperations.getDescendants(layout,"jetbrains.mps.build.packaging.structure.Module",false,new String[]{});
    Map<IModule,List<SNode>> map=MapSequence.fromMap(new LinkedHashMap<IModule,List<SNode>>(16,(float)0.75,false));
    for (    SNode module : ListSequence.fromList(modules)) {
      IModule imodule=Module_Behavior.call_getModule_1213877515148(module);
      if (imodule == null) {
        _context.showErrorMessage(module,"Missing module " + SPropertyOperations.getString(module,"name") + ".");
        continue;
      }
      if ((imodule instanceof DevKit) || (!(imodule.isCompileInMPS()))) {
        continue;
      }
      List<SNode> modulesForIModule=MapSequence.fromMap(map).get(imodule);
      if (modulesForIModule == null) {
        modulesForIModule=new ArrayList<SNode>();
        MapSequence.fromMap(map).put(imodule,modulesForIModule);
      }
      ListSequence.fromList(modulesForIModule).addElement(module);
    }
    List<Set<IModule>> sm=StronglyConnectedModules.getInstance().getStronglyConnectedComponents(MapSequence.fromMap(map).keySet());
    SNode lastCycle=null;
    for (    Set<IModule> moduleSet : ListSequence.fromList(sm)) {
      SNode cycle=SConceptOperations.createNewNode("jetbrains.mps.build.packaging.structure.ModuleCycle",null);
      SLinkOperations.addChild(layout,"cycle",cycle);
      if (lastCycle != null) {
        SNode ref=SConceptOperations.createNewNode("jetbrains.mps.build.packaging.structure.ModuleCycleReference",null);
        SLinkOperations.setTarget(ref,"cycle",lastCycle,false);
        ListSequence.fromList(SLinkOperations.getTargets(cycle,"dependency",true)).addElement(ref);
      }
      lastCycle=cycle;
      Iterable<IModule> sortedModuleSet=SetSequence.fromSet(moduleSet).sort(new ISelector<IModule,Comparable<?>>(){
        public Comparable<?> select(        IModule it){
          return it.getModuleFqName();
        }
      }
,true);
      for (      IModule imodule : Sequence.fromIterable(sortedModuleSet)) {
        List<SNode> modulesForIModule=MapSequence.fromMap(map).get(imodule);
        for (        SNode module : ListSequence.fromList(modulesForIModule)) {
          SNode ref=SConceptOperations.createNewNode("jetbrains.mps.build.packaging.structure.NewModuleReference",null);
          SLinkOperations.setTarget(ref,"module",module,false);
          SLinkOperations.addChild(cycle,"moduleReference",ref);
        }
      }
    }
  }
}
