{
  List<SNode> layouts=SModelOperations.getRoots(_context.getModel(),"jetbrains.mps.build.packaging.structure.MPSLayout");
  for (  SNode layout : ListSequence.fromList(layouts)) {
    if (!(SPropertyOperations.getBoolean(layout,"compile"))) {
      continue;
    }
    List<SNode> modules=SNodeOperations.getDescendants(layout,"jetbrains.mps.build.packaging.structure.Module",false,new String[]{});
    Map<IModule,List<SNode>> map=MapSequence.fromMap(new LinkedHashMap<IModule,List<SNode>>(16,(float)0.75,false));
    for (    SNode module : ListSequence.fromList(modules)) {
      IModule imodule=Module_Behavior.call_getModule_1213877515148(module);
      if (imodule == null) {
        _context.showErrorMessage(module,"Missing module " + SPropertyOperations.getString(module,"name") + ".");
        continue;
      }
      if ((imodule instanceof DevKit) || (!(imodule.isCompileInMPS()))) {
        continue;
      }
      List<SNode> modulesForIModule=MapSequence.fromMap(map).get(imodule);
      if (modulesForIModule == null) {
        modulesForIModule=new ArrayList<SNode>();
        MapSequence.fromMap(map).put(imodule,modulesForIModule);
      }
      ListSequence.fromList(modulesForIModule).addElement(module);
    }
    Set<IModule> modulesToProcess=MapSequence.fromMap(map).keySet();
    Set<IModule> modulesCopy=SetSequence.fromSet(new LinkedHashSet());
    SetSequence.fromSet(modulesCopy).addSequence(SetSequence.fromSet(modulesToProcess).sort(new ISelector<IModule,Comparable<?>>(){
      public Comparable<?> select(      IModule it){
        return it.getModuleFqName();
      }
    }
,true));
    List<Set<IModule>> sm=(List<Set<IModule>>)StronglyConnectedModules.getInstance().getStronglyConnectedComponents(modulesCopy);
    SNode lastCycle=null;
    List<SNode> result=ListSequence.fromList(new ArrayList<SNode>(ListSequence.fromList(sm).count()));
    for (    Set<IModule> moduleSet : ListSequence.fromList(sm)) {
      SNode cycle=SConceptOperations.createNewNode("jetbrains.mps.build.packaging.structure.ModuleCycle",null);
      ListSequence.fromList(result).addElement(cycle);
      if (lastCycle != null) {
        SNode ref=SConceptOperations.createNewNode("jetbrains.mps.build.packaging.structure.ModuleCycleReference",null);
        SLinkOperations.setTarget(ref,"cycle",lastCycle,false);
        ListSequence.fromList(SLinkOperations.getTargets(cycle,"dependency",true)).addElement(ref);
      }
      lastCycle=cycle;
      Iterable<IModule> sortedModuleSet=SetSequence.fromSet(moduleSet).sort(new ISelector<IModule,Comparable<?>>(){
        public Comparable<?> select(        IModule it){
          return it.getModuleFqName();
        }
      }
,true);
      SPropertyOperations.set(cycle,"name",_context.createUniqueName("cycle." + Sequence.fromIterable(sortedModuleSet).first().getModuleFqName(),layout));
      for (      IModule imodule : Sequence.fromIterable(sortedModuleSet)) {
        List<SNode> modulesForIModule=MapSequence.fromMap(map).get(imodule);
        for (        SNode module : ListSequence.fromList(modulesForIModule)) {
          SNode ref=SConceptOperations.createNewNode("jetbrains.mps.build.packaging.structure.NewModuleReference",null);
          SLinkOperations.setTarget(ref,"module",module,false);
          SLinkOperations.addChild(cycle,"moduleReference",ref);
        }
      }
    }
    ListSequence.fromList(SLinkOperations.getTargets(layout,"cycle",true)).addSequence(ListSequence.fromList(result).sort(new ISelector<SNode,Comparable<?>>(){
      public Comparable<?> select(      SNode it){
        return SPropertyOperations.getString(SLinkOperations.getTarget(ListSequence.fromList(SLinkOperations.getTargets(it,"moduleReference",true)).first(),"module",false),"name");
      }
    }
,true));
  }
}
