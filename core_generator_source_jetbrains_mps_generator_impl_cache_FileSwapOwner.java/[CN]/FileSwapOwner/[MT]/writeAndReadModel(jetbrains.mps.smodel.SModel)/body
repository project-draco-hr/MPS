{
  ByteArrayOutputStream os=new ByteArrayOutputStream();
  ModelOutputStream mos=new ModelOutputStream(os);
  ArrayList<SNode> roots=new ArrayList<SNode>();
  for (  SNode next : model.getRootNodes()) {
    roots.add(next);
  }
  mos.writeInt(44);
  new NodesWriter(model.getReference(),null).writeNodes(roots,mos);
  mos.close();
  final jetbrains.mps.smodel.SModel resultModel=new jetbrains.mps.smodel.SModel(PersistenceFacade.getInstance().createModelReference("smodel.long.name.for.testing"));
  ByteArrayInputStream is=new ByteArrayInputStream(os.toByteArray());
  ModelInputStream mis=new ModelInputStream(is);
  int version=mis.readInt();
  if (version != 44) {
    return null;
  }
  List<Pair<SContainmentLink,jetbrains.mps.smodel.SNode>> resultRoots=new NodesReader(resultModel.getReference(),false).readNodes(mis);
  for (  Pair<SContainmentLink,jetbrains.mps.smodel.SNode> root : resultRoots) {
    resultModel.addRootNode(root.o2);
  }
  SModelBase result=new SModelBase(resultModel.getReference(),new NullDataSource()){
    @Override public jetbrains.mps.smodel.SModel getSModelInternal(){
      return getCurrentModelInternal();
    }
    @Nullable @Override protected jetbrains.mps.smodel.SModel getCurrentModelInternal(){
      return resultModel;
    }
    @Override public boolean isLoaded(){
      return true;
    }
    @Override public void unload(){
    }
  }
;
  resultModel.setModelDescriptor(result);
  SModelOperations.validateLanguagesAndImports(result,false,false);
  return result;
}
