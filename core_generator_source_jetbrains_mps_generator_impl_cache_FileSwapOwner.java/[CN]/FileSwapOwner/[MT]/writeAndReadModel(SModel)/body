{
  ByteArrayOutputStream os=new ByteArrayOutputStream();
  ModelOutputStream mos=new ModelOutputStream(os);
  ArrayList<SNode> roots=new ArrayList<SNode>();
  for (Iterator<SNode> it=model.getRootNodes().iterator(); it.hasNext(); ) {
    roots.add(it.next());
  }
  mos.writeInt(43);
  new NodesWriter(model.getReference()).writeNodes(roots,mos);
  mos.close();
  jetbrains.mps.smodel.SModel resultModel=new jetbrains.mps.smodel.SModel(new SModelReference("smodel.long.name.for.testing",""));
  ByteArrayInputStream is=new ByteArrayInputStream(os.toByteArray());
  ModelInputStream mis=new ModelInputStream(is);
  int version=mis.readInt();
  if (version != 43) {
    return null;
  }
  List<Pair<String,SNode>> resultRoots=new NodesReader(resultModel.getReference()).readNodes(resultModel,mis);
  for (  Pair<String,SNode> root : resultRoots) {
    resultModel.addRootNode(root.o2);
  }
  SModelOperations.validateLanguagesAndImports(resultModel.getModelDescriptor(),false,false);
  return resultModel.getModelDescriptor();
}
