{
  SModel modelDescr;
  try {
    if (myCreateInplace) {
      Tuples._2<ModelRoot,String> place=getRootContainingDir(pkgDir);
      ModelRoot modelRoot=place._0();
      String sourceRoot=place._1();
      if (modelRoot == null) {
        myMessageHandler.handle(new Message(MessageKind.ERROR,"Cannot convert to MPS in-place: java sources not under proper model root"));
        return null;
      }
      Map<String,String> options=MapSequence.fromMap(new HashMap<String,String>());
      String fullPath=pkgDir.getPath().replace('\\','/');
      String sr=sourceRoot.replace('\\','/');
      MapSequence.fromMap(options).put(ModelFactory.OPTION_RELPATH,FileUtil.getRelativePath(pkgDir.getPath(),sourceRoot,"/"));
      modelDescr=((DefaultModelRoot)modelRoot).createModel(pkgFqName,sourceRoot,options,PersistenceRegistry.getInstance().getFolderModelFactory(FilePerRootModelPersistence.FACTORY_ID));
    }
 else {
      ModelRoot modelRoot=getFirstRootToCreateModel(pkgFqName);
      if (modelRoot == null) {
        myMessageHandler.handle(new Message(MessageKind.ERROR,"Failed to find model root to create model in"));
        return null;
      }
      modelDescr=((DefaultModelRoot)modelRoot).createModel(pkgFqName,null,null,PersistenceRegistry.getInstance().getModelFactory(MPSExtentions.MODEL));
    }
    if (modelDescr == null) {
      myMessageHandler.handle(new Message(MessageKind.ERROR,String.format("Failed to create model for package %s",pkgFqName)));
      return null;
    }
  }
 catch (  IOException e) {
    myMessageHandler.handle(new Message(MessageKind.ERROR,"IO error when trying to create model").setException(e));
    return null;
  }
  modelDescr.load();
  ((EditableSModel)modelDescr).setChanged(true);
  ((EditableSModel)modelDescr).save();
  return modelDescr;
}
