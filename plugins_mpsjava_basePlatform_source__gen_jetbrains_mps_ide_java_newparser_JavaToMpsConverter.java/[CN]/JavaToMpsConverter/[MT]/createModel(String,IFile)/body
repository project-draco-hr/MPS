{
  ModelFactory factory=(myCreatePerRoot ? PersistenceRegistry.getInstance().getFolderModelFactory(FilePerRootModelPersistence.FACTORY_ID) : PersistenceRegistry.getInstance().getModelFactory(MPSExtentions.MODEL));
  ModelRoot modelRoot;
  String sourceRoot;
  if (myCreateInplace) {
    Tuples._2<ModelRoot,String> where=getRootContainingDir(pkgDir);
    modelRoot=where._0();
    sourceRoot=where._1();
  }
 else {
    modelRoot=getFirstRootToCreateModel(pkgFqName);
    sourceRoot=null;
  }
  if (modelRoot == null) {
    LOG.error("Failed to get model root to create the model in");
    return null;
  }
  SModel modelDescr;
  try {
    modelDescr=((DefaultModelRoot)modelRoot).createModel(pkgFqName,sourceRoot,factory);
    if (modelDescr == null) {
      LOG.error("Failed to create model: createModel returned null");
      return null;
    }
  }
 catch (  IOException e) {
    LOG.error("Failed to create model",e);
    return null;
  }
  modelDescr.load();
  ((EditableSModel)modelDescr).setChanged(true);
  ((EditableSModel)modelDescr).save();
  return modelDescr;
}
