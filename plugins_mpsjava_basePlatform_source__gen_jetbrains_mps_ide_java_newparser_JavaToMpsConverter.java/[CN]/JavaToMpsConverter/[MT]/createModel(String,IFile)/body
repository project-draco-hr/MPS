{
  SModel modelDescr;
  try {
    if (myCreateInplace) {
      ModelRoot modelRoot=getRootContainingDir(pkgDir);
      if (modelRoot == null) {
        LOG.error("Cannot convert to MPS in-place: java sources not under proper model root");
        return null;
      }
      FilePerRootDataSource ds=new FilePerRootDataSource(pkgDir,modelRoot);
      Map<String,String> options=MapSequence.fromMap(new HashMap<String,String>());
      MapSequence.fromMap(options).put(ModelFactory.OPTION_MODELNAME,pkgFqName);
      MapSequence.fromMap(options).put(ModelFactory.OPTION_MODULEREF,myModule.getModuleReference().toString());
      modelDescr=PersistenceRegistry.getInstance().getFolderModelFactory(FilePerRootModelPersistence.FACTORY_ID).create(ds,options);
      ((SModelBase)modelDescr).setModelRoot(modelRoot);
      ((SModelBase)modelDescr).setModule(myModule);
    }
 else {
      ModelRoot modelRoot=getFirstRootToCreateModel(pkgFqName);
      if (modelRoot == null) {
        LOG.error("Failed to find model root to create model in");
        return null;
      }
      modelDescr=((DefaultModelRoot)modelRoot).createModel(pkgFqName,null,PersistenceRegistry.getInstance().getModelFactory(MPSExtentions.MODEL));
    }
    if (modelDescr == null) {
      LOG.error("Failed to create model: createModel returned null");
      return null;
    }
  }
 catch (  IOException e) {
    LOG.error("Failed to create model",e);
    return null;
  }
  modelDescr.load();
  ((EditableSModel)modelDescr).setChanged(true);
  ((EditableSModel)modelDescr).save();
  return modelDescr;
}
