{
  if (node == null)   return null;
  TypeCheckingContext context;
  Stack<Object> resolve=myResolveStack.get();
  if (resolve == null) {
    resolve=new Stack<Object>();
    myResolveStack.set(resolve);
  }
  if (resolve.size() > 20) {
    throw new TypeSystemException("typechecking failed");
  }
  if (!resolve.isEmpty()) {
    context=generationMode ? null : getContextForEditedRootNode(node.getContainingRoot(),TypeContextManager.DEFAULT_OWNER,false);
    if (context == null || !context.isNonTypesystemComputation()) {
      context=createTypeCheckingContextForResolve(node);
      SNode type=context.getTypeOf(node,myTypeChecker);
      context.dispose();
      return type;
    }
  }
  if (generationMode) {
    if (tracer == null) {
      context=createTypeCheckingContext(node);
    }
 else {
      context=createTracingTypeCheckingContext(node);
    }
  }
 else {
    context=getContextForEditedRootNode(node.getContainingRoot(),TypeContextManager.DEFAULT_OWNER);
  }
  if (context == null)   return null;
  SNode type=context.getTypeOf(node,myTypeChecker);
  if (generationMode) {
    context.dispose();
  }
  return type;
}
