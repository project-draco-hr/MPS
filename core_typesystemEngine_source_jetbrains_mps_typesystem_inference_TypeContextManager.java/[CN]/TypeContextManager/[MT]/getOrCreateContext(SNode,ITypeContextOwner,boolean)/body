{
  ModelAccess.assertLegalRead();
  if (node == null)   return null;
synchronized (myLock) {
    SNodePointer nodePointer=new SNodePointer(node);
    Pair<TypeCheckingContext,List<ITypeContextOwner>> contextWithOwners=myTypeCheckingContexts.get(nodePointer);
    if (contextWithOwners == null) {
      if (createIfAbsent) {
        TypeCheckingContext newTypeCheckingContext=createTypeCheckingContext(node);
        addModelListener(node);
        List<ITypeContextOwner> owners=new ArrayList<ITypeContextOwner>(1);
        contextWithOwners=new Pair<TypeCheckingContext,List<ITypeContextOwner>>(newTypeCheckingContext,owners);
        owners.add(owner);
        if (owners.size() > 100) {
          if (!myReported) {
            myReported=true;
            LOG.warning("Type checking context for node " + node.getPresentation() + " has too much owners");
          }
        }
        myTypeCheckingContexts.put(nodePointer,contextWithOwners);
        return newTypeCheckingContext;
      }
 else {
        return null;
      }
    }
 else {
      TypeCheckingContext context=contextWithOwners.o1;
      if (jetbrains.mps.util.SNodeOperations.isDisposed(context.getNode())) {
        removeContextForNode(nodePointer);
        LOG.error("Type Checking Context had a disposed node inside. Node: " + node + " model: "+ node.getModel());
        return getOrCreateContext(node,owner,createIfAbsent);
      }
      if (!contextWithOwners.o2.contains(owner)) {
        contextWithOwners.o2.add(owner);
      }
      return context;
    }
  }
}
