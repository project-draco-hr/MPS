{
  SNode enclosingMacro=findOuterMacro(contextNode);
  if ((enclosingMacro == null)) {
    return QueriesUtil.getApplicableConcept_fromEnvironment(contextNode);
  }
  if (SNodeOperations.isInstanceOf(enclosingMacro,"jetbrains.mps.lang.generator.structure.SourceSubstituteMacro")) {
    SNode query=QueriesUtil.getQueryFunction_fromSourceSubstituteMacro(SNodeOperations.cast(enclosingMacro,"jetbrains.mps.lang.generator.structure.SourceSubstituteMacro"));
    return getConceptFrom(TypeChecker.getInstance().getTypeOf(query));
  }
  return null;
}
