{
  Map<String,SNode> old=myGenerator.setPreviousInputNodesByMappingName(myInputNodesByMappingName);
  try {
    SNode child=myGenerator.getExecutor().executeMapSrcNodeMacro(myInputNode,myMapSrcMacro,myChildToReplace.getParent());
    if (child != null) {
      Language childLang=child.getNodeLanguage();
      if (!myGenerator.getGeneratorSessionContext().getGenerationPlan().isCountedLanguage(childLang)) {
        if (!childLang.getGenerators().isEmpty()) {
          myLogger.error(child,"language of output node is '" + childLang.getNamespace() + "' - this language did not show up when computing generation steps!");
          myLogger.describeError(myInputNode,"was input: " + myInputNode.getDebugText());
          myLogger.describeError(myMapSrcMacro,"was template: " + myMapSrcMacro.getDebugText());
          myLogger.describeError(null,"workaround: add the language '" + childLang.getNamespace() + "' to list of 'Languages Engaged On Generation' in model '"+ myGenerator.getGeneratorSessionContext().getOriginalInputModel().getSModelFqName()+ "'");
        }
      }
      if (child.isRegistered()) {
        child=CopyUtil.copy(child);
      }
      validateReferences(child);
      SNode parent=myChildToReplace.getParent();
      if (parent == null) {
        if (myChildToReplace.isRoot()) {
          myChildToReplace.getModel().addRoot(child);
          myChildToReplace.getModel().removeRoot(myChildToReplace);
        }
      }
 else {
        String childRole=parent.getRoleOf(myChildToReplace);
        if (!GeneratorUtil.checkChild(parent,childRole,child)) {
          myLogger.describeWarning(myInputNode,"was input: " + myInputNode.getDebugText());
          myLogger.describeWarning(myMapSrcMacro,"was template: " + myMapSrcMacro.getDebugText());
        }
        parent.replaceChild(myChildToReplace,child);
      }
      myGenerator.getGeneratorSessionContext().getGenerationTracer().replaceOutputNode(myChildToReplace,child);
      addExecuteMapSrcNodeMacroPostProcChange((NodeMacro)myMapSrcMacro.getAdapter(),child,myInputNode,myInputNodesByMappingName);
    }
  }
 catch (  Throwable t) {
    myGenerator.showErrorMessage(myInputNode,myMapSrcMacro,"mapping failed: '" + t.getMessage() + "'");
    myLogger.handleException(t);
  }
 finally {
    myGenerator.setPreviousInputNodesByMappingName(old);
  }
}
