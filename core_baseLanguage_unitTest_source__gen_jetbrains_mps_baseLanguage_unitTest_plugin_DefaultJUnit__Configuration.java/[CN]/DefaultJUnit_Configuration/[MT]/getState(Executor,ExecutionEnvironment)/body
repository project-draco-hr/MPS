{
  return new RunProfileState(){
    @Nullable public ExecutionResult execute(    Executor executor,    @NotNull ProgramRunner runner) throws ExecutionException {
      Project project=MPSDataKeys.PROJECT.getData(environment.getDataContext());
      final ConsoleViewImpl consoleView=StacktraceUtil.createConsoleView(project);
      JComponent consoleComponent=null;
      Runnable consoleDispose=null;
      final List<AnAction> actions=ListSequence.fromList(new ArrayList<AnAction>());
      ProcessHandler handler=null;
{
        final MPSProject mpsproject=MPSDataKeys.MPS_PROJECT.getData(environment.getDataContext());
        final List<SNode> all=new ArrayList<SNode>();
        final List<SNode> tests=new ArrayList<SNode>();
        final List<SNode> methods=new ArrayList<SNode>();
        ModelAccess.instance().runReadAction(new Runnable(){
          public void run(){
            if (DefaultJUnit_Configuration.this.getStateObject().type != null) {
              if (DefaultJUnit_Configuration.this.getStateObject().type == JUnitRunTypes.METHOD) {
                if (DefaultJUnit_Configuration.this.getStateObject().node != null) {
                  ListSequence.fromList(methods).addElement(TestRunUtil.getTestMethod(DefaultJUnit_Configuration.this.getStateObject().node,DefaultJUnit_Configuration.this.getStateObject().method));
                }
                if (DefaultJUnit_Configuration.this.getStateObject().nodes != null) {
                  for (int i=0; i < DefaultJUnit_Configuration.this.getStateObject().nodes.size(); i++) {
                    ListSequence.fromList(methods).addElement(TestRunUtil.getTestMethod(DefaultJUnit_Configuration.this.getStateObject().nodes.get(i),DefaultJUnit_Configuration.this.getStateObject().methods.get(i)));
                  }
                }
              }
 else               if (DefaultJUnit_Configuration.this.getStateObject().type == JUnitRunTypes.NODE) {
                if (DefaultJUnit_Configuration.this.getStateObject().node != null) {
                  ListSequence.fromList(tests).addElement(TestRunUtil.getTestNode(DefaultJUnit_Configuration.this.getStateObject().node));
                }
                if (DefaultJUnit_Configuration.this.getStateObject().nodes != null) {
                  for (int i=0; i < DefaultJUnit_Configuration.this.getStateObject().nodes.size(); i++) {
                    ListSequence.fromList(tests).addElement(TestRunUtil.getTestNode(DefaultJUnit_Configuration.this.getStateObject().nodes.get(i)));
                  }
                }
              }
 else               if (DefaultJUnit_Configuration.this.getStateObject().type == JUnitRunTypes.MODEL) {
                ListSequence.fromList(tests).addSequence(ListSequence.fromList(TestRunUtil.getModelTests(TestRunUtil.getModel(DefaultJUnit_Configuration.this.getStateObject().model))));
              }
 else               if (DefaultJUnit_Configuration.this.getStateObject().type == JUnitRunTypes.MODULE) {
                ListSequence.fromList(tests).addSequence(ListSequence.fromList(TestRunUtil.getModuleTests(DefaultJUnit_Configuration.this.getStateObject().module)));
              }
 else               if (DefaultJUnit_Configuration.this.getStateObject().type == JUnitRunTypes.PROJECT) {
                for (                IModule projectModule : mpsproject.getModules()) {
                  ListSequence.fromList(tests).addSequence(ListSequence.fromList(TestRunUtil.getModuleTests(projectModule)));
                }
              }
              ListSequence.fromList(all).addSequence(ListSequence.fromList(tests));
              ListSequence.fromList(all).addSequence(ListSequence.fromList(methods));
            }
          }
        }
);
        if (DefaultJUnit_Configuration.this.getStateObject().myParams == null) {
          DefaultJUnit_Configuration.this.getStateObject().myParams=new ConfigRunParameters(DefaultJUnit_Configuration.this.getStateObject().compileInMPS);
        }
        if (DefaultJUnit_Configuration.this.getStateObject().myParams.getMake()) {
          RunUtil.makeBeforeRun(mpsproject,all);
        }
        IOperationContext context=MPSDataKeys.OPERATION_CONTEXT.getData(environment.getDataContext());
        TestStatisticsModel statisticsModel=new TestStatisticsModel();
        TestRunState runState=new TestRunState(tests,methods,statisticsModel);
        TestRunListener runListener=new TestRunListener(runState);
        final UnitTestViewComponent runComponent=new UnitTestViewComponent(mpsproject,context,consoleView,runState,statisticsModel);
        final Wrappers._T<UnitTestRunner> testRunner=new Wrappers._T<UnitTestRunner>(null);
        try {
          testRunner.value=new UnitTestRunner(runComponent);
        }
 catch (        NullPointerException npe) {
          npe.printStackTrace();
        }
        testRunner.value.setConfigParameters(DefaultJUnit_Configuration.this.getStateObject().myParams);
        if (DefaultJUnit_Configuration.this.getStateObject().myParams != null && DefaultJUnit_Configuration.this.getStateObject().myParams.getUseAlternativeJRE()) {
          testRunner.value.setJavaHomePath(DefaultJUnit_Configuration.this.getStateObject().myParams.getAlternativeJRE());
        }
        consoleComponent=runComponent;
        consoleDispose=new Runnable(){
          public void run(){
            runComponent.dispose();
          }
        }
;
        final Wrappers._T<Process> process=new Wrappers._T<Process>();
        ModelAccess.instance().runReadAction(new Runnable(){
          public void run(){
            process.value=testRunner.value.run(all);
          }
        }
);
        if (process.value != null) {
          UnitTestProcessHandler processHandler=new UnitTestProcessHandler(runListener,process.value,testRunner.value.getCommandString());
          runComponent.start(processHandler);
          handler=processHandler;
        }
      }
      final JComponent finalConsoleComponent=consoleComponent;
      final Runnable finalConsoleDispose=consoleDispose;
      final ProcessHandler finalHandler=handler;
      return new ExecutionResult(){
        public ExecutionConsole getExecutionConsole(){
          return new ExecutionConsole(){
            public void dispose(){
              if (finalConsoleDispose == null) {
                return;
              }
              finalConsoleDispose.run();
            }
            public JComponent getComponent(){
              return finalConsoleComponent;
            }
            public JComponent getPreferredFocusableComponent(){
              return finalConsoleComponent;
            }
          }
;
        }
        public AnAction[] getActions(){
          return ListSequence.fromList(actions).toGenericArray(AnAction.class);
        }
        public ProcessHandler getProcessHandler(){
          return finalHandler;
        }
      }
;
    }
    public RunnerSettings getRunnerSettings(){
      return null;
    }
    public ConfigurationPerRunnerSettings getConfigurationSettings(){
      return null;
    }
  }
;
}
