{
  SModel sourceModel=sourceNode.getModel();
  if (sourceModel.getUID().equals(targetModelUID)) {
    if (targetNodeId == null) {
      if (resolveInfo != null) {
        return new InternalReference(role,sourceNode,resolveInfo,targetClassResolveInfo);
      }
 else {
        LOG.error("resolve info is null, source node is " + sourceNode + ", role is "+ role);
        return null;
      }
    }
    SNode targetNode=sourceModel.getNodeById(targetNodeId);
    if (targetNode == null && resolveInfo == null) {
      LOG.errorWithTrace("SReference.newInstance Couldn't create internal reference: \"" + role + "\" to node id:"+ targetNodeId+ "\nSource node: "+ sourceNode.getDebugText());
      return null;
    }
    SReference internalReference=new InternalReference(role,sourceNode,targetNode);
    internalReference.setResolveInfo(resolveInfo);
    internalReference.setTargetClassResolveInfo(targetClassResolveInfo);
    return internalReference;
  }
  if (targetNodeId != null || extResolveInfo != null) {
    return new ExternalReference(role,sourceNode,targetNodeId,extResolveInfo,targetModelUID);
  }
  return null;
}
