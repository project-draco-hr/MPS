{
  NodeSubstituteInfo info=cell.getSubstituteInfo();
  String smallPattern=pattern.substring(0,pattern.length() - 1);
  String tail="" + pattern.charAt(pattern.length() - 1);
  EditorCell nextCell=cell.getNextLeaf();
  while (nextCell != null && !nextCell.isSelectable()) {
    nextCell=nextCell.getNextLeaf();
  }
  if (canCompleteSmallPatternImmediately(info,pattern,"") || canCompleteSmallPatternImmediately(info,trimLeft(pattern),"")) {
    if (!canCompleteSmallPatternImmediately(info,pattern,"")) {
      pattern=trimLeft(pattern);
    }
    info.getMatchingActions(pattern,true).get(0).substitute(editorContext,pattern);
  }
 else   if (pattern.length() > 0 && (canCompleteSmallPatternImmediately(info,smallPattern,tail) || canCompleteSmallPatternImmediately(info,trimLeft(smallPattern),tail))) {
    if (!canCompleteSmallPatternImmediately(info,smallPattern,tail)) {
      smallPattern=trimLeft(smallPattern);
    }
    List<INodeSubstituteAction> matchingActions=info.getMatchingActions(smallPattern,true);
    INodeSubstituteAction item=matchingActions.get(0);
    SNode newNode=item.substitute(editorContext,smallPattern);
    editorContext.flushEvents();
    EditorCell cellForNewNode=editorContext.getNodeEditorComponent().findNodeCell(newNode);
    EditorCell_Label target=null;
    EditorCell errorOrEditable=cellForNewNode.findChild(CellFinders.or(CellFinders.FIRST_ERROR,CellFinders.LAST_EDITABLE),true);
    if (errorOrEditable instanceof EditorCell_Label) {
      target=(EditorCell_Label)errorOrEditable;
    }
    if (target != null) {
      target.changeText(tail);
      target.end();
      if (target.isErrorState()) {
        target.validate(true,false);
      }
      editorContext.flushEvents();
      if (editorContext.getSelectedCell() instanceof EditorCell_Label) {
        EditorCell_Label label=(EditorCell_Label)editorContext.getSelectedCell();
        label.end();
      }
    }
  }
 else   if (info.getMatchingActions(pattern,false).isEmpty() && info.getMatchingActions(trimLeft(pattern),false).isEmpty() && nextCell != null && nextCell.isErrorState() && nextCell instanceof EditorCell_Label && ((EditorCell_Label)nextCell).isEditable()) {
    SNodeEditorUtil.removeRightTransformHint(cell.getSNode());
    EditorCell_Label label=(EditorCell_Label)nextCell;
    label.changeText(pattern);
    label.end();
    editorContext.getNodeEditorComponent().changeSelection(label);
  }
 else {
    if (isInOneStepAmbigousPosition(info,smallPattern + tail)) {
      editorContext.getNodeEditorComponent().activateNodeSubstituteChooser(cell,info,false);
    }
  }
  return true;
}
