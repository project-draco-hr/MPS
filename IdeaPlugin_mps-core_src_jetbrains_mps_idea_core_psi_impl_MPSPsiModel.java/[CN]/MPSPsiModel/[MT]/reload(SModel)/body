{
synchronized (LOCK) {
    clearChildren();
    for (    SNode root : model.getRootNodes()) {
      String rootName=null;
      rootName=extractName(root);
      MPSPsiRootNode rootNode=null;
      if (model.getSource() instanceof FilePerRootDataSource) {
        final VirtualFile virtualFile=VirtualFileUtils.getVirtualFile(((FilePerRootDataSource)model.getSource()).getFile(rootName + MPSExtentions.DOT_MODEL_ROOT));
        rootNode=new MPSPsiRootNode(root.getNodeId(),rootName,getManager(),virtualFile);
      }
 else {
        rootNode=new MPSPsiRootNode(root.getNodeId(),rootName,getManager());
      }
      rootNode.setModel(this);
      addChildLast(rootNode);
      rootNode.addChildLast(convert(root));
    }
    enumerateNodes();
    DataSource source=model.getSource();
    if (source instanceof FileDataSource) {
      File file=new File(((FileDataSource)source).getFile().getPath());
      VirtualFile vfile=LocalFileSystem.getInstance().findFileByIoFile(file);
      this.mySourceVirtualFile=vfile;
    }
 else     if (source instanceof FilePerRootDataSource) {
      this.mySourceVirtualFile=VirtualFileUtils.getVirtualFile(((FilePerRootDataSource)source).getFolder()).findChild(MPSExtentions.DOT_MODEL_HEADER);
    }
    myPsiDirectory=new PsiDirectoryImpl((PsiManagerImpl)myManager,getSourceVirtualFile().getParent());
  }
}
