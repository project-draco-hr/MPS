{
  if (modules.isEmpty()) {
    return new jetbrains.mps.plugin.CompilationResult(0,0,false);
  }
  IClassPathItem classPathItems=computeDependenciesClassPath(modules);
  JavaCompiler compiler=new JavaCompiler(classPathItems);
  for (  IModule m : modules) {
    for (    String sp : m.getSourcePaths()) {
      addSource(compiler,new File(sp),"",m);
    }
    FileUtil.delete(m.getClassesGen());
  }
  compiler.compile();
  int errorCount=0;
  for (  CompilationResult cr : compiler.getCompilationResults()) {
    if (cr.getErrors() != null) {
      for (      CategorizedProblem cp : cr.getErrors()) {
        String messageStirng=new String(cp.getOriginatingFileName()) + " : " + cp.getMessage();
        if (cp.isWarning()) {
          LOG.warning(messageStirng);
        }
 else {
          LOG.error(messageStirng);
        }
      }
      errorCount+=cr.getErrors().length;
    }
    for (    ClassFile cf : cr.getClassFiles()) {
      String name=getName(cf.getCompoundName());
      String containerClassName=name;
      if (containerClassName.contains("$")) {
        int index=containerClassName.indexOf('$');
        containerClassName=containerClassName.substring(0,index);
      }
      if (myContainingModules.containsKey(containerClassName)) {
        IModule m=myContainingModules.get(containerClassName);
        File classesGen=m.getClassesGen();
        String packageName=NameUtil.namespaceFromLongName(name);
        File outputDir=new File(classesGen + File.separator + packageName.replace('.',File.separatorChar));
        outputDir.mkdirs();
        String className=NameUtil.shortNameFromLongName(name);
        File output=new File(outputDir,className + ".class");
        try {
          FileOutputStream os=new FileOutputStream(output);
          os.write(cf.getBytes());
          os.close();
        }
 catch (        IOException e) {
          throw new RuntimeException(e);
        }
      }
 else {
        LOG.error("I don't know in which module's output path I should place class file for " + name);
      }
    }
  }
  return new jetbrains.mps.plugin.CompilationResult(errorCount,0,false);
}
