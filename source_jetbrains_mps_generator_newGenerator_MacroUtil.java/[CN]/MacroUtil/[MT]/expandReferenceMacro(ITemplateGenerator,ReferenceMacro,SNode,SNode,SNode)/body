{
  String linkRole=referenceMacro.getLink().getRole();
  SNode referentNode;
  ReferenceMacro_GetReferent function=referenceMacro.getReferentFunction();
  if (function != null) {
    SNode templateValue=templateNode.getReferent(linkRole);
    String methodName=TemplateFunctionMethodName.referenceMacro_GetReferent(function.getNode());
    Object[] args=new Object[]{sourceNode,templateValue,templateNode,generator.getSourceModel(),generator,generator.getScope(),generator.getGeneratorSessionContext()};
    try {
      referentNode=(SNode)QueryMethodGenerated.invoke(methodName,args,referenceMacro.getModel());
    }
 catch (    Exception e) {
      generator.showErrorMessage(sourceNode,templateNode,referenceMacro.getNode(),"couldn't evaluate reference macro");
      LOG.error(e);
      return;
    }
  }
 else {
    Object[] args=new Object[]{sourceNode,templateNode,referenceMacro.getLink(),generator};
    try {
      referentNode=(SNode)QueryMethod.invoke("referenceMacro_" + referenceMacro.getAspectMethodName(),args,referenceMacro.getModel());
    }
 catch (    Throwable t) {
      String message=NameUtil.shortNameFromLongName(t.getClass().getName()) + " occured while expanding reference macro with query: \"referenceMacro_" + referenceMacro.getAspectMethodName();
      generator.showErrorMessage(sourceNode,templateNode,message);
      return;
    }
  }
  if (referentNode == null) {
    if (outputNode.isReferentRequired(linkRole,generator.getScope())) {
      generator.showErrorMessage(sourceNode,templateNode,"unresolved reference for role \"" + linkRole + "\" in "+ outputNode.getDebugText());
    }
    return;
  }
  outputNode.setReferent(linkRole,referentNode);
}
