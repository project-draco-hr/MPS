{
{
    List<SNode> nodes=(List<SNode>)refactoringContext.getSelectedNodes();
    SModel model=refactoringContext.getSelectedNode().getModel();
    refactoringContext.setParameter("sourceModel",model.getModelDescriptor());
    Language sourceLanguage=Language.getLanguageFor(((SModelDescriptor)refactoringContext.getParameter("sourceModel")));
    Language targetLanguage=Language.getLanguageFor(((SModelDescriptor)refactoringContext.getParameter("targetModel")));
    List<SNode> editors=ListOperations.<SNode>createList();
    List<SNode> behaviors=ListOperations.<SNode>createList();
    List<SNode> constraints=ListOperations.<SNode>createList();
    List<SNode> dataFlows=ListOperations.<SNode>createList();
    SModelDescriptor editorModelDescriptor=sourceLanguage.getEditorModelDescriptor();
    if (editorModelDescriptor != null) {
      for (      SNode node : nodes) {
        if (SNodeOperations.isInstanceOf(node,"jetbrains.mps.lang.structure.structure.ConceptDeclaration")) {
          ConceptEditorDeclaration conceptEditorDeclaration=SModelUtil_new.findEditorDeclaration(editorModelDescriptor.getSModel(),((ConceptDeclaration)SNodeOperations.getAdapter(node)));
          if (conceptEditorDeclaration != null) {
            SNode editor=(SNode)conceptEditorDeclaration.getNode();
            ListSequence.fromList(editors).addElement(editor);
          }
        }
      }
    }
    SModelDescriptor behaviorModelDescriptor=sourceLanguage.getBehaviorModelDescriptor();
    if (behaviorModelDescriptor != null) {
      for (      SNode node : nodes) {
        ConceptBehavior conceptBehavior=SModelUtil_new.findBehaviorDeclaration(behaviorModelDescriptor.getSModel(),((AbstractConceptDeclaration)SNodeOperations.getAdapter(node)));
        if (conceptBehavior != null) {
          SNode behavior=(SNode)conceptBehavior.getNode();
          ListSequence.fromList(behaviors).addElement(behavior);
        }
      }
    }
    SModelDescriptor constraintsModelDescriptor=sourceLanguage.getConstraintsModelDescriptor();
    if (constraintsModelDescriptor != null) {
      for (      SNode node : nodes) {
        ConceptConstraints conceptConstraints=SModelUtil_new.findConstraintsDeclaration(constraintsModelDescriptor.getSModel(),((AbstractConceptDeclaration)SNodeOperations.getAdapter(node)));
        if (conceptConstraints != null) {
          SNode conceptConstraintsNodes=(SNode)conceptConstraints.getNode();
          ListSequence.fromList(constraints).addElement(conceptConstraintsNodes);
        }
      }
    }
    SModelDescriptor dataflowModelDescriptor=sourceLanguage.getDataFlowModelDescriptor();
    if (dataflowModelDescriptor != null) {
      for (      SNode node : nodes) {
        DataFlowBuilderDeclaration dataFlowBuilderDeclaration=SModelUtil_new.findDataFlowDeclaration(dataflowModelDescriptor.getSModel(),((AbstractConceptDeclaration)SNodeOperations.getAdapter(node)));
        if (dataFlowBuilderDeclaration != null) {
          SNode dataFlow=(SNode)dataFlowBuilderDeclaration.getNode();
          ListSequence.fromList(dataFlows).addElement(dataFlow);
        }
      }
    }
    for (    SNode node : nodes) {
      refactoringContext.changeFeatureName(node,((SModelDescriptor)refactoringContext.getParameter("targetModel")).getSModelFqName().toString() + "." + SPropertyOperations.getString(node,"name"),SPropertyOperations.getString(node,"name"));
    }
    refactoringContext.moveNodesToModel(nodes,((SModelDescriptor)refactoringContext.getParameter("targetModel")).getSModel());
    if (ListSequence.fromList(editors).isNotEmpty()) {
      SModelDescriptor targetEditorModelDescriptor=targetLanguage.getEditorModelDescriptor();
      if (targetEditorModelDescriptor == null) {
        targetEditorModelDescriptor=LanguageAspect.EDITOR.createNew(targetLanguage);
      }
      SModel editorModel=targetEditorModelDescriptor.getSModel();
      refactoringContext.moveNodesToModel(editors,editorModel);
      refactoringContext.computeCaches();
      refactoringContext.updateModelWithMaps(editorModel);
    }
    if (ListSequence.fromList(behaviors).isNotEmpty()) {
      SModelDescriptor targetBehaviorModelDescriptor=targetLanguage.getBehaviorModelDescriptor();
      if (targetBehaviorModelDescriptor == null) {
        targetBehaviorModelDescriptor=LanguageAspect.BEHAVIOR.createNew(targetLanguage);
      }
      SModel behaviorModel=targetBehaviorModelDescriptor.getSModel();
      refactoringContext.moveNodesToModel(behaviors,behaviorModel);
      refactoringContext.computeCaches();
      refactoringContext.updateModelWithMaps(behaviorModel);
    }
    if (ListSequence.fromList(constraints).isNotEmpty()) {
      SModelDescriptor targetConstraintsModelDescriptor=targetLanguage.getConstraintsModelDescriptor();
      if (targetConstraintsModelDescriptor == null) {
        targetConstraintsModelDescriptor=LanguageAspect.CONSTRAINTS.createNew(targetLanguage);
      }
      SModel constraintsModel=targetConstraintsModelDescriptor.getSModel();
      refactoringContext.moveNodesToModel(constraints,constraintsModel);
      refactoringContext.computeCaches();
      refactoringContext.updateModelWithMaps(constraintsModel);
    }
    if (ListSequence.fromList(dataFlows).isNotEmpty()) {
      SModelDescriptor targetDataFlowModelDescriptor=targetLanguage.getDataFlowModelDescriptor();
      if (targetDataFlowModelDescriptor == null) {
        targetDataFlowModelDescriptor=LanguageAspect.DATA_FLOW.createNew(targetLanguage);
      }
      SModel dataFlowModel=targetDataFlowModelDescriptor.getSModel();
      refactoringContext.moveNodesToModel(dataFlows,dataFlowModel);
      refactoringContext.computeCaches();
      refactoringContext.updateModelWithMaps(dataFlowModel);
    }
  }
}
