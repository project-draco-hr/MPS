{
  frameStateManager.addListener(new FrameStateListener(){
    public void onFrameDeactivated(){
    }
    public void onFrameActivated(){
      ModelAccess.instance().runReadInEDT(new Runnable(){
        public void run(){
          Set<SModel> models=SetSequence.fromSet(new HashSet<SModel>());
          for (          Project project : ProjectManager.getInstance().getOpenProjects()) {
            for (            VirtualFile vf : FileEditorManager.getInstance(project).getSelectedFiles()) {
              if (vf instanceof MPSNodeVirtualFile) {
                MPSNodeVirtualFile nvf=((MPSNodeVirtualFile)vf);
                SNode node=MPSEditorUtil.getCurrentEditedNode(project,nvf);
                if (node == null) {
                  node=nvf.getNode();
                }
                if (node != null) {
                  SetSequence.fromSet(models).addElement(node.getModel());
                }
              }
            }
          }
          RefreshSession session=RefreshQueue.getInstance().createSession(true,true,null);
          for (          SModel model : SetSequence.fromSet(models)) {
            SModelDescriptor md=model.getModelDescriptor();
            for (            IFile file : CollectionSequence.fromCollection(ModelUtil.getFilesByModelDescriptor(md))) {
              IFile fileToRefresh=file;
              while (!(fileToRefresh.exists())) {
                fileToRefresh=fileToRefresh.getParent();
              }
              VirtualFile virtualFile=VirtualFileUtils.getVirtualFile(fileToRefresh);
              if (virtualFile != null) {
                session.addFile(virtualFile);
              }
            }
          }
          session.launch();
        }
      }
);
    }
  }
);
}
