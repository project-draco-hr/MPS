{
  myHelper=new VersionUtil(sourceModel);
  Element rootElement=new Element(VCSPersistenceSupport.MODEL);
  rootElement.setAttribute(VCSPersistenceSupport.MODEL_UID,sourceModel.getReference().toString());
  Element persistenceElement=new Element(VCSPersistenceSupport.PERSISTENCE);
  persistenceElement.setAttribute(VCSPersistenceSupport.PERSISTENCE_VERSION,getModelPersistenceVersion() + "");
  rootElement.addContent(persistenceElement);
  for (  SModuleReference languageNamespace : new SModelLegacy(sourceModel).importedLanguages()) {
    Element languageElem=new Element(VCSPersistenceSupport.LANGUAGE);
    languageElem.setAttribute(VCSPersistenceSupport.NAMESPACE,languageNamespace.toString());
    rootElement.addContent(languageElem);
  }
  for (  SModuleReference languageNamespace : sourceModel.engagedOnGenerationLanguages()) {
    Element languageElem=new Element(VCSPersistenceSupport.LANGUAGE_ENGAGED_ON_GENERATION);
    languageElem.setAttribute(VCSPersistenceSupport.NAMESPACE,languageNamespace.toString());
    rootElement.addContent(languageElem);
  }
  for (  SModuleReference devkitNamespace : sourceModel.importedDevkits()) {
    Element devkitElem=new Element(VCSPersistenceSupport.DEVKIT);
    devkitElem.setAttribute(VCSPersistenceSupport.NAMESPACE,devkitNamespace.toString());
    rootElement.addContent(devkitElem);
  }
  for (  SModel.ImportElement importElement : sourceModel.importedModels()) {
    Element importElem=new Element(VCSPersistenceSupport.IMPORT_ELEMENT);
    importElem.setAttribute(VCSPersistenceSupport.MODEL_IMPORT_INDEX,"" + myHelper.genImportIndex(importElement));
    importElem.setAttribute(VCSPersistenceSupport.MODEL_UID,importElement.getModelReference().toString());
    importElem.setAttribute(VCSPersistenceSupport.VERSION,"" + importElement.getUsedVersion());
    rootElement.addContent(importElem);
  }
  for (  SModel.ImportElement importElement : sourceModel.getImplicitImportsSupport().getAdditionalModelVersions()) {
    Element importElem=new Element(VCSPersistenceSupport.IMPORT_ELEMENT);
    importElem.setAttribute(VCSPersistenceSupport.MODEL_IMPORT_INDEX,"" + myHelper.genImportIndex(importElement));
    importElem.setAttribute(VCSPersistenceSupport.MODEL_UID,importElement.getModelReference().toString());
    importElem.setAttribute(VCSPersistenceSupport.VERSION,"" + importElement.getUsedVersion());
    importElem.setAttribute(VCSPersistenceSupport.IMPLICIT,"yes");
    rootElement.addContent(importElem);
  }
  saveRootStubs(rootElement,sourceModel);
  for (  SNode root : sourceModel.getRootNodes()) {
    saveNode(rootElement,root,true);
  }
  return new Document(rootElement);
}
