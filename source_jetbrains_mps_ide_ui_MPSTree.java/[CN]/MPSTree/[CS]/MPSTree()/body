{
  largeModel=true;
  TreeToolTipHandler.install(this);
  setCellRenderer(new NewMPSTreeCellRenderer());
  addTreeWillExpandListener(new TreeWillExpandListener(){
    public void treeWillExpand(    TreeExpansionEvent event) throws ExpandVetoException {
      TreePath path=event.getPath();
      Object node=path.getLastPathComponent();
      MPSTreeNode treeNode=(MPSTreeNode)node;
      if (!treeNode.isInitialized()) {
        doInit(treeNode);
      }
    }
    public void treeWillCollapse(    TreeExpansionEvent event) throws ExpandVetoException {
    }
  }
);
  addTreeExpansionListener(new TreeExpansionListener(){
    public void treeExpanded(    TreeExpansionEvent event){
      if (!myAutoExpandEnabled)       return;
      TreePath eventPath=event.getPath();
      MPSTreeNode node=(MPSTreeNode)eventPath.getLastPathComponent();
      if (node.getChildCount() == 1) {
        List<MPSTreeNode> path=new ArrayList<MPSTreeNode>();
        for (        Object item : eventPath.getPath()) {
          path.add((MPSTreeNode)item);
        }
        MPSTreeNode onlyChild=(MPSTreeNode)node.getChildAt(0);
        if (onlyChild.isAutoExpandable()) {
          path.add(onlyChild);
          expandPath(new TreePath(path.toArray()));
        }
      }
    }
    public void treeCollapsed(    TreeExpansionEvent event){
    }
  }
);
  addMouseListener(new MouseAdapter(){
    public void mousePressed(    MouseEvent e){
      myMousePressed(e);
    }
    public void mouseReleased(    MouseEvent e){
      myMouseReleased(e);
    }
    public void mouseEntered(    MouseEvent e){
      myTooltipManagerRecentInitialDelay=ToolTipManager.sharedInstance().getInitialDelay();
      ToolTipManager.sharedInstance().setInitialDelay(10);
    }
    public void mouseExited(    MouseEvent e){
      ToolTipManager.sharedInstance().setInitialDelay(myTooltipManagerRecentInitialDelay);
    }
  }
);
  addKeyListener(new KeyAdapter(){
    public void keyPressed(    KeyEvent e){
      TreePath[] paths=getSelectionPaths();
      TreePath selPath=getSelectionPath();
      if (selPath == null)       return;
      MPSTreeNode selNode=(MPSTreeNode)selPath.getLastPathComponent();
      if (selNode == null)       return;
      List<MPSTreeNode> nodes=new ArrayList<MPSTreeNode>();
      for (      TreePath path : paths) {
        MPSTreeNode node=(MPSTreeNode)path.getLastPathComponent();
        nodes.add(node);
        node.keyPressed(e);
      }
      final KeyStroke eventKeyStroke=KeyStroke.getKeyStrokeForEvent(e);
      Pair pair=new Pair(eventKeyStroke,selNode.getClass());
      final MPSAction action=myKeyStrokesToActionsMap.get(pair);
      if (action != null) {
        final ActionContext context=getActionContext(selNode,nodes);
        action.execute(context);
      }
 else {
        KeyStroke stroke=KeyStroke.getKeyStrokeForEvent(e);
        if (stroke.getKeyCode() == KeyEvent.VK_CONTROL || stroke.getKeyCode() == KeyEvent.VK_SHIFT || stroke.getKeyCode() == KeyEvent.VK_ALT) {
          return;
        }
        stroke.toString();
        for (        TreePath p : paths) {
          final MPSTreeNode lastNode=(MPSTreeNode)p.getLastPathComponent();
          final JPopupMenu menu=CommandProcessor.instance().executeLightweightCommand(new Calculable<JPopupMenu>(){
            public JPopupMenu calculate(){
              return lastNode.getPopupMenu();
            }
          }
);
          if (menu == null)           return;
          JMenuItem item=CommandProcessor.instance().executeLightweightCommand(new Calculable<JMenuItem>(){
            public JMenuItem calculate(){
              return findMenuItem(eventKeyStroke,menu);
            }
          }
);
          if (item != null) {
            item.getAction().actionPerformed(new ActionEvent(this,0,""));
            e.consume();
          }
        }
      }
    }
    private JMenuItem findMenuItem(    KeyStroke eventKeyStroke,    JPopupMenu menu){
      for (int i=0; i < menu.getComponentCount(); i++) {
        if (menu.getComponent(i) instanceof JMenuItem) {
          JMenuItem item=(JMenuItem)menu.getComponent(i);
          KeyStroke keyStroke=item.getAccelerator();
          if (eventKeyStroke.equals(keyStroke)) {
            return item;
          }
        }
        if (menu.getComponent(i) instanceof JMenu) {
          JMenuItem result=findMenuItem(eventKeyStroke,(JMenu)menu.getComponent(i));
          if (result != null) {
            return result;
          }
        }
      }
      return null;
    }
    private JMenuItem findMenuItem(    KeyStroke eventKeyStroke,    JMenu menu){
      menu.getModel().setSelected(true);
      for (int i=0; i < menu.getItemCount(); i++) {
        JMenuItem item=(JMenuItem)menu.getItem(i);
        if (item == null) {
          continue;
        }
        KeyStroke keyStroke=item.getAccelerator();
        if (eventKeyStroke.equals(keyStroke)) {
          return item;
        }
        if (item instanceof JMenu) {
          JMenuItem result=findMenuItem(eventKeyStroke,(JMenu)menu.getItem(i));
          if (result != null) {
            return result;
          }
        }
      }
      return null;
    }
  }
);
  AbstractAction openNodeAction=new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      TreePath selPath=getSelectionPath();
      if (selPath == null)       return;
      MPSTreeNode selNode=(MPSTreeNode)selPath.getLastPathComponent();
      selNode.doubleClick();
    }
  }
;
  registerKeyboardAction(openNodeAction,KeyStroke.getKeyStroke("ENTER"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  registerKeyboardAction(openNodeAction,KeyStroke.getKeyStroke("F4"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  AbstractAction refreshTreeAction=new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      rebuildNow();
    }
  }
;
  registerKeyboardAction(refreshTreeAction,KeyStroke.getKeyStroke("F5"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  registerKeyboardAction(new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      TreePath path=getSelectionPath();
      if (path == null)       return;
      int rowNum=getRowForPath(path);
      Rectangle r=getRowBounds(rowNum);
      showPopup(r.x,r.y);
    }
  }
,KeyStroke.getKeyStroke("CONTEXT_MENU"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
}
