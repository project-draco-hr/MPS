{
  if (template == null) {
    myGenerator.showErrorMessage(context.getInput(),null,rule.getNode(),"couldn't evaluate weaving rule: no template");
    return;
  }
  List<TemplateFragment> templateFragments=GeneratorUtil.getTemplateFragments(template);
  if (templateFragments.isEmpty()) {
    myGenerator.showErrorMessage(context.getInput(),template.getNode(),rule.getNode(),"nothing to weave: no template fragments found in template");
    return;
  }
  checkTemplateFragmentsForWeaving(template,templateFragments);
  String ruleMappingName=GeneratorUtil.getMappingName(rule,null);
  TemplateProcessor templateProcessor=new TemplateProcessor(myGenerator,reductionContext);
  for (  TemplateFragment templateFragment : templateFragments) {
    SNode templateFragmentNode=BaseAdapter.fromAdapter(templateFragment.getParent());
    SNode contextParentNode=null;
    try {
      contextParentNode=reductionContext.getQueryExecutor().getContextNodeForTemplateFragment(templateFragmentNode,outputContextNode,context);
    }
 catch (    Exception e) {
      myGenerator.getLogger().handleException(e);
    }
    if (contextParentNode != null) {
      try {
        List<SNode> outputNodesToWeave=templateProcessor.processTemplateNode(GeneratorUtil.getMappingName(templateFragment,ruleMappingName),templateFragmentNode,context);
        String childRole=templateFragmentNode.getRole_();
        for (        SNode outputNodeToWeave : outputNodesToWeave) {
          RoleValidationStatus status=myGenerator.validateChild(contextParentNode,childRole,outputNodeToWeave);
          if (status != null) {
            status.reportProblem(false,"",GeneratorUtil.describe(context.getInput(),"input"),GeneratorUtil.describe(templateFragment.getNode(),"template"),GeneratorUtil.describe(rule.getNode(),"rule"));
          }
          LinkDeclaration childLinkDeclaration=contextParentNode.getLinkDeclaration(childRole);
          if (childLinkDeclaration == null) {
            contextParentNode.addChild(childRole,outputNodeToWeave);
          }
 else {
            Cardinality cardinality=childLinkDeclaration.getSourceCardinality();
            if (cardinality == Cardinality._0__1 || cardinality == Cardinality._1) {
              contextParentNode.setChild(childRole,outputNodeToWeave);
            }
 else {
              contextParentNode.addChild(childRole,outputNodeToWeave);
            }
          }
        }
      }
 catch (      DismissTopMappingRuleException e) {
        myGenerator.showErrorMessage(context.getInput(),templateFragment.getNode(),rule.getNode(),"wrong template: dismission of weaving rule is not supported");
      }
catch (      TemplateProcessingFailureException e) {
        myGenerator.showErrorMessage(context.getInput(),templateFragment.getNode(),rule.getNode(),"error processing template fragment");
        myGenerator.getLogger().info(contextParentNode," -- was output context node:");
      }
    }
 else {
      myGenerator.showErrorMessage(context.getInput(),templateFragment.getNode(),rule.getNode(),"couldn't define 'context' for template fragment");
    }
  }
}
