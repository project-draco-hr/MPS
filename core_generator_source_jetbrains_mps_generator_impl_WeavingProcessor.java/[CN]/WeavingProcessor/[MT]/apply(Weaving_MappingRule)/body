{
  AbstractConceptDeclaration applicableConcept=rule.getApplicableConcept();
  if (applicableConcept == null) {
    myGenerator.showErrorMessage(null,null,rule.getNode(),"rule has no applicable concept defined");
    return;
  }
  boolean includeInheritors=rule.getApplyToConceptInheritors();
  Iterable<SNode> nodes=myFastNodeFinder.getNodes(applicableConcept,includeInheritors);
  for (  SNode applicableNode : nodes) {
    QueryExecutionContext executionContext=myGenerator.getExecutionContext(applicableNode);
    if (executionContext == null) {
      continue;
    }
    ReductionContext reductionContext=new ReductionContext(executionContext);
    if (reductionContext.getQueryExecutor().checkCondition(rule.getConditionFunction(),false,applicableNode,rule.getNode())) {
      SNode outputContextNode=reductionContext.getQueryExecutor().getContextNodeForWeavingingRule(applicableNode,rule);
      if (!checkContext(rule,applicableNode,outputContextNode)) {
        continue;
      }
      myGenerator.setChanged();
      boolean someOutputGenerated=true;
      myGenerationTracer.pushInputNode(applicableNode);
      myGenerationTracer.pushRule(new SNodePointer(rule.getNode()));
      try {
        RuleConsequence ruleConsequence=rule.getRuleConsequence();
        if (ruleConsequence == null) {
          myGenerator.showErrorMessage(applicableNode,null,rule.getNode(),"weaving rule: no rule consequence");
        }
 else {
          myGenerationTracer.pushRuleConsequence(new SNodePointer(ruleConsequence.getNode()));
          if (ruleConsequence instanceof TemplateDeclarationReference) {
            TemplateDeclaration template=((TemplateDeclarationReference)ruleConsequence).getTemplate();
            weaveTemplateDeclaration(template,outputContextNode,rule,GeneratorUtil.createTemplateContext(applicableNode,null,reductionContext,ruleConsequence,applicableNode,myGenerator),reductionContext);
          }
 else           if (ruleConsequence instanceof WeaveEach_RuleConsequence) {
            WeaveEach_RuleConsequence weaveEach=(WeaveEach_RuleConsequence)ruleConsequence;
            SourceSubstituteMacro_SourceNodesQuery query=weaveEach.getSourceNodesQuery();
            if (query == null) {
              myGenerator.showErrorMessage(applicableNode,rule.getNode(),"weaving rule: cannot create list of source nodes");
              break;
            }
            TemplateDeclaration template=weaveEach.getTemplate();
            List<SNode> queryNodes=reductionContext.getQueryExecutor().evaluateSourceNodesQuery(applicableNode,rule.getNode(),null,query,new DefaultTemplateContext(applicableNode));
            if (queryNodes.isEmpty()) {
              someOutputGenerated=false;
            }
            for (            SNode queryNode : queryNodes) {
              weaveTemplateDeclaration(template,outputContextNode,rule,GeneratorUtil.createTemplateContext(queryNode,null,reductionContext,ruleConsequence,queryNode,myGenerator),reductionContext);
            }
          }
 else {
            myGenerator.showErrorMessage(applicableNode,null,ruleConsequence.getNode(),"weaving rule: unsupported rule consequence");
          }
        }
      }
  finally {
        if (someOutputGenerated) {
          myGenerationTracer.closeInputNode(applicableNode);
        }
 else {
          myGenerationTracer.popInputNode(applicableNode);
        }
      }
    }
  }
}
