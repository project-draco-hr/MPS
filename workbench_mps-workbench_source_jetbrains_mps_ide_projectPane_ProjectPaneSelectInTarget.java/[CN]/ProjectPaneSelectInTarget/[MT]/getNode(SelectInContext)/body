{
  VirtualFile virtualFile=context.getVirtualFile();
  if (!(virtualFile instanceof MPSNodeVirtualFile)) {
    return null;
  }
  MPSNodeVirtualFile file=(MPSNodeVirtualFile)virtualFile;
  FileEditor[] editors=FileEditorManager.getInstance(myProject.getProject()).getEditors(file);
  if (editors.length != 0) {
    FileEditor editor=editors[0];
    if (!(editor instanceof MPSFileNodeEditor))     return null;
    jetbrains.mps.openapi.editor.EditorComponent editorComponent=((MPSFileNodeEditor)editor).getNodeEditor().getCurrentEditorComponent();
    if (editorComponent == null)     return null;
    return mySelectRoot ? editorComponent.getEditedNode() : editorComponent.getSelectedNode();
  }
 else {
    return file.getNode();
  }
}
