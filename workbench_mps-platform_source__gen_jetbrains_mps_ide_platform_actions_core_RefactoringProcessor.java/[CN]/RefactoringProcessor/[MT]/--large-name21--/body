{
  final Map<RefactoringParticipant,RefactoringParticipant.ParticipantState<?,?,IP,FP,IS,FS>> changes=askParticipantChanges(factory,refactoringUI,repository,scope,participants,initialStates);
  if (changes == null) {
    return;
  }
  SearchResults searchResults=new SearchResults();
  for (  IMapping<RefactoringParticipant,RefactoringParticipant.ParticipantState<?,?,IP,FP,IS,FS>> participantState : MapSequence.fromMap(changes)) {
    List<? extends List<? extends RefactoringParticipant.Change<?,?>>> participantChanges=participantState.value().getChanges();
    for (    List<? extends RefactoringParticipant.Change<?,?>> nodeChanges : ListSequence.fromList(participantChanges)) {
      for (      RefactoringParticipant.Change<?,?> change : ListSequence.fromList(nodeChanges)) {
        searchResults.addAll(change.getSearchResults());
      }
    }
  }
  refactoringUI.runRefactoring(new Runnable(){
    public void run(){
      final _FunctionTypes._return_P1_E0<? extends FS,? super IS> getFinalObject=doRefactor.invoke(changes,refactoringSession);
      if (getFinalObject == null) {
        return;
      }
      for (      IMapping<RefactoringParticipant,RefactoringParticipant.ParticipantState<?,?,IP,FP,IS,FS>> participantChanges : MapSequence.fromMap(changes)) {
        participantChanges.value().doRefactor(ListSequence.fromList(initialStates).select(new ISelector<IS,FS>(){
          public FS select(          IS it){
            return getFinalObject.invoke(it);
          }
        }
).toListSequence(),repository,refactoringSession);
      }
    }
  }
,refactoringName,searchResults);
}
