{
  try {
    File tmp=FileUtil.createTmpDir();
    final Wrappers._T<String> modelData=new Wrappers._T<String>();
    inMemory.getRepository().getModelAccess().runReadAction(new Runnable(){
      public void run(){
        modelData.value=ModelPersistence.modelToString(((SModelBase)inMemory).getSModelInternal());
      }
    }
);
    MergeDriverBackupUtil.writeContentsToFile(modelData.value.getBytes(FileUtil.DEFAULT_CHARSET),modelFile.getName(),tmp,ModelStorageProblemsListener.DiskMemoryConflictVersion.MEMORY.getSuffix());
    if (modelFile.exists()) {
      com.intellij.openapi.util.io.FileUtil.copy(new File(modelFile.getPath()),new File(tmp.getAbsolutePath(),modelFile.getName() + "." + ModelStorageProblemsListener.DiskMemoryConflictVersion.FILE_SYSTEM.getSuffix()));
    }
    File zipfile=MergeBackupUtil.chooseZipFileForModelFile(modelFile);
    zipfile.getParentFile().mkdirs();
    FileUtil.zip(tmp,zipfile);
    FileUtil.delete(tmp);
    return zipfile;
  }
 catch (  IOException e) {
    if (LOG.isEnabledFor(Level.ERROR)) {
      LOG.error("Cannot create backup during resolving disk-memory conflict for " + SNodeOperations.getModelLongName(inMemory),e);
    }
    throw new RuntimeException(e);
  }
}
