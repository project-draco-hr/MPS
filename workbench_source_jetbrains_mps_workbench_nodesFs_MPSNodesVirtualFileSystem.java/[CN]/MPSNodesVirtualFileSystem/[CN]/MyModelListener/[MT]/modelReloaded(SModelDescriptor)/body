{
  for (  SNode root : sm.getSModel().getRoots()) {
    updateModificationStamp(root);
  }
  SwingUtilities.invokeLater(new Runnable(){
    public void run(){
      ModelAccess.instance().runWriteAction(new Runnable(){
        public void run(){
          for (          Entry<SNodePointer,MPSNodeVirtualFile> entry : myVirtualFiles.entrySet()) {
            if (entry.getKey().getModel() != sm)             continue;
            SNode node=entry.getKey().getNode();
            MPSNodeVirtualFile file=entry.getValue();
            if (node == null) {
              fireBeforeFileDeletion(this,file);
              fireFileDeleted(this,file,file.getName(),null);
            }
 else {
              String oldName=file.getName();
              String newName=node.getName();
              if (!oldName.equals(newName)) {
                fireBeforePropertyChange(this,file,VirtualFile.PROP_NAME,oldName,newName);
                ((MPSNodeVirtualFile)file).updateFields();
                firePropertyChanged(this,file,VirtualFile.PROP_NAME,oldName,newName);
              }
            }
          }
        }
      }
);
    }
  }
);
}
