{
  SNode copy=CopyUtil.copyAndPreserveId(sourceNode);
  for (  SNode node : ListSequence.fromList(SNodeOperations.getDescendants(copy,null,true,new String[]{}))) {
    SNodeId nodeId=node.getNodeId();
    SNodeId replacedId=nodeId;
    while (myModel.getNode(replacedId) != null) {
      replacedId=jetbrains.mps.smodel.SModel.generateUniqueId();
    }
    ((jetbrains.mps.smodel.SNode)node).setId(replacedId);
    if (replacedId != nodeId && !(MapSequence.fromMap(myIdReplacementCache).containsKey(nodeId))) {
      MapSequence.fromMap(myIdReplacementCache).put(nodeId,replacedId);
    }
  }
  return copy;
}
