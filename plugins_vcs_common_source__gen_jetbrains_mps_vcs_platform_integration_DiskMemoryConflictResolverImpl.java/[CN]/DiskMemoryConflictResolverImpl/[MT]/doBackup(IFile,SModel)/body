{
  try {
    File tmp=FileUtil.createTmpDir();
    MergeDriverBackupUtil.writeContentsToFile(ModelPersistence.modelToString(inMemory),modelFile.getName(),tmp,DiskMemoryConflictResolverImpl.DiskMemoryConflictVersion.MEMORY.getSuffix());
    if (modelFile.exists()) {
      com.intellij.openapi.util.io.FileUtil.copy(new File(modelFile.getPath()),new File(tmp.getAbsolutePath(),modelFile.getName() + "." + DiskMemoryConflictResolverImpl.DiskMemoryConflictVersion.FILE_SYSTEM.getSuffix()));
    }
    File zipfile=MergeBackupUtil.chooseZipFileForModelFile(modelFile);
    zipfile.getParentFile().mkdirs();
    FileUtil.zip(tmp,zipfile);
    FileUtil.delete(tmp);
    return zipfile;
  }
 catch (  IOException e) {
    if (log.isErrorEnabled()) {
      log.error("Cannot create backup during resolving disk-memory conflict for " + inMemory.getLongName(),e);
    }
    throw new RuntimeException(e);
  }
}
