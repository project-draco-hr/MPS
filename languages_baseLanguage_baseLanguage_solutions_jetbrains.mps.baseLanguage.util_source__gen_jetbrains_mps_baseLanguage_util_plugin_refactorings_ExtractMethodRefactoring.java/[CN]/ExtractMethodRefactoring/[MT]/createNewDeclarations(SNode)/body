{
  Map<SNode,List<SNode>> mapping=MapSequence.fromMap(new HashMap<SNode,List<SNode>>());
  for (  SNode reference : ListSequence.fromList(SNodeOperations.getDescendantsWhereConceptInList(method,new String[]{"jetbrains.mps.baseLanguage.structure.LocalVariableReference","jetbrains.mps.baseLanguage.structure.ParameterReference"},false,new String[]{}))) {
    SNode declaration=SLinkOperations.getTarget(reference,"variableDeclaration",false);
    if (!(ListSequence.fromList(SNodeOperations.getAncestors(declaration,null,false)).contains(method))) {
      if (!(SetSequence.fromSet(MapSequence.fromMap(mapping).keySet()).contains(declaration))) {
        MapSequence.fromMap(mapping).put(declaration,new ArrayList<SNode>());
      }
      ListSequence.fromList(MapSequence.fromMap(mapping).get(declaration)).addElement(reference);
    }
  }
  for (  SNode declaration : SetSequence.fromSet(MapSequence.fromMap(mapping).keySet())) {
    SNode newDeclaration=new ExtractMethodRefactoring.QuotationClass_jq3ovj_a0a0a2a6().createNode(SNodeOperations.copyNode(SLinkOperations.getTarget(declaration,"type",true)),SPropertyOperations.getString(declaration,"name"));
    SNodeOperations.insertPrevSiblingChild(ListSequence.fromList(SLinkOperations.getTargets(SLinkOperations.getTarget(method,"body",true),"statement",true)).first(),new ExtractMethodRefactoring.QuotationClass_jq3ovj_a0a0b0c0g().createNode(newDeclaration));
    for (    SNode reference : ListSequence.fromList(MapSequence.fromMap(mapping).get(declaration))) {
      SNodeOperations.replaceWithAnother(reference,new ExtractMethodRefactoring.QuotationClass_jq3ovj_a0a0a0c0c0g().createNode(newDeclaration));
    }
  }
}
