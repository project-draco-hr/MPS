{
  if (ListSequence.fromList(oldNodes).count() != ListSequence.fromList(shouldKeep).count()) {
    throw new IllegalArgumentException();
  }
  Map<SNode,SNode> localCopyMap=MapSequence.fromMap(new HashMap<SNode,SNode>());
  List<SNode> result=CopyUtil.copyAndPreserveId(oldNodes,localCopyMap);
  MapSequence.fromMap(copyMap).putAll(localCopyMap);
  for (  IMapping<SNode,SNode> mapping : MapSequence.fromMap(copyMap)) {
    CopyUtil.addReferences(mapping.key(),copyMap,false);
  }
{
    Iterator<SNode> oldNode_it=ListSequence.fromList(oldNodes).iterator();
    Iterator<Boolean> sk_it=ListSequence.fromList(shouldKeep).iterator();
    SNode oldNode_var;
    boolean sk_var;
    while (oldNode_it.hasNext() && sk_it.hasNext()) {
      oldNode_var=oldNode_it.next();
      sk_var=sk_it.next();
      for (      SNode desc : ListSequence.fromList(SNodeOperations.getNodeDescendants(oldNode_var,null,true,new SAbstractConcept[]{}))) {
        MapSequence.fromMap(keepOldNodes).put(desc,sk_var);
      }
      if (!(sk_var)) {
        SNodeOperations.detachNode(oldNode_var);
      }
    }
  }
  return result;
}
