{
  if (ListSequence.fromList(oldNodes).count() != ListSequence.fromList(shouldKeep).count()) {
    throw new IllegalArgumentException();
  }
  List<SNode> result=CopyUtil.copyAndPreserveId(oldNodes,copyMap);
  for (  IMapping<SNode,SNode> mapping : MapSequence.fromMap(copyMap)) {
    CopyUtil.addReferences(mapping.key(),copyMap,false);
  }
{
    Iterator<SNode> oldNode_it=ListSequence.fromList(oldNodes).iterator();
    Iterator<Boolean> sk_it=ListSequence.fromList(shouldKeep).iterator();
    SNode oldNode_var;
    boolean sk_var;
    while (oldNode_it.hasNext() && sk_it.hasNext()) {
      oldNode_var=oldNode_it.next();
      sk_var=sk_it.next();
      MapSequence.fromMap(keepOldNodes).put(oldNode_var,sk_var);
      if (!(sk_var)) {
        SNodeOperations.detachNode(oldNode_var);
      }
    }
  }
  return result;
}
