{
  IFile modelFile=getModelFile(dataContext);
  if (modelFile == null)   return;
  SRepository repository=ProjectHelper.getProjectRepository(project);
  SModel descriptor=SModelFileTracker.getInstance(repository).findModel(modelFile);
  if (!(descriptor instanceof EditableSModel))   return;
  final EditableSModel modelDescriptor=(EditableSModel)descriptor;
  final AtomicReference<String> targetFqName=new AtomicReference<String>(null);
  Pair<String,Boolean> result=Messages.showInputDialogWithCheckBox(MPSBundle.message("rename.model.to",SNodeOperations.getModelLongName(modelDescriptor)),MPSBundle.message("rename.model"),MPSBundle.message("update.all.references"),true,true,null,SNodeOperations.getModelLongName(modelDescriptor),new MyInputValidator(){
    @Override protected void doRename(    String fqName){
      targetFqName.set(fqName);
    }
    @Override protected SRepository getRepository(){
      return repository;
    }
  }
);
  if (targetFqName.get() != null) {
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      @Override public void run(){
        deleteGeneratedFiles(modelDescriptor);
      }
    }
);
    final ModelRenamer renamer=new ModelRenamer(modelDescriptor,targetFqName.get(),!(result.getSecond()));
    ProjectHelper.getModelAccess(project).executeCommand(new Runnable(){
      @Override public void run(){
        renamer.rename();
      }
    }
);
    ProgressManager.getInstance().run(new Task.Modal(project,"Updating model usages...",false){
      @Override public void run(      @NotNull ProgressIndicator indicator){
        indicator.pushState();
        indicator.setIndeterminate(true);
        try {
          ProjectHelper.getModelAccess(project).runWriteAction(new Runnable(){
            public void run(){
              renamer.updateReferencesIfNeeded(project);
            }
          }
);
        }
  finally {
          indicator.popState();
        }
      }
    }
);
    final AtomicReference<VirtualFile> psiModelSourceFile=new AtomicReference<VirtualFile>();
    ProjectHelper.getModelAccess(project).runReadAction(new Runnable(){
      @Override public void run(){
        psiModelSourceFile.set(MPSPsiProvider.getInstance(project).getPsi(modelDescriptor.getReference()).getSourceVirtualFile());
      }
    }
);
    ProjectView.getInstance(project).select(modelDescriptor,psiModelSourceFile.get(),true);
  }
}
