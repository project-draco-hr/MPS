{
synchronized (LOCK) {
    if (myInitialized)     return;
    if (myInitializationInProgress)     return;
    myInitializationInProgress=true;
    Set<IModule> visibleModules=new HashSet<IModule>();
    Set<IModule> initialModules=getInitialModules();
    visibleModules.addAll(initialModules);
    for (    IModule module : initialModules) {
      for (      Dependency d : module.getDependOn()) {
        IModule dependency=MPSModuleRepository.getInstance().getModule(d.getModuleRef());
        if (dependency != null) {
          visibleModules.add(dependency);
        }
      }
    }
    Set<Language> usedLanguages=new HashSet<Language>();
    usedLanguages.addAll(getInitialUsedLanguages());
    Set<DevKit> usedDevkits=new HashSet<DevKit>();
    usedDevkits.addAll(LibraryInitializer.getInstance().getBootstrapModules(DevKit.class));
    for (    IModule m : initialModules) {
      if (m instanceof DevKit) {
        DevKit dk=(DevKit)m;
        usedDevkits.add(dk);
      }
      usedDevkits.addAll(ModuleUtil.refsToDevkits(m.getUsedDevkitReferences()));
    }
    for (    DevKit dk : usedDevkits) {
      usedLanguages.addAll(dk.getAllExportedLanguages());
      visibleModules.addAll(dk.getAllExportedSolutions());
    }
    boolean changed=true;
    while (changed) {
      changed=false;
      for (      IModule module : new HashSet<IModule>(visibleModules)) {
        if (module instanceof Language) {
          Language language=(Language)module;
          for (          Language l : language.getExtendedLanguages()) {
            if (!visibleModules.contains(l)) {
              visibleModules.add(l);
              changed=true;
            }
          }
        }
        for (        Dependency dep : module.getDependOn()) {
          if (dep.isReexport()) {
            IModule dependency=MPSModuleRepository.getInstance().getModule(dep.getModuleRef());
            if (dependency != null) {
              if (!visibleModules.contains(dependency)) {
                visibleModules.add(dependency);
                changed=true;
              }
            }
 else {
              LOG.error("Can't find module " + dep.getModuleRef().getModuleFqName() + " in "+ this);
            }
          }
        }
      }
      for (      Language language : new ArrayList<Language>(usedLanguages)) {
        for (        Language extendedLanguage : language.getExtendedLanguages()) {
          if (extendedLanguage == null) {
            LOG.error("One of extended language of " + language.getModuleFqName() + " in "+ this+ " is null.");
          }
 else           if (!usedLanguages.contains(extendedLanguage)) {
            usedLanguages.add(extendedLanguage);
            changed=true;
          }
        }
        for (        Dependency dep : language.getDependOn()) {
          IModule dependency=MPSModuleRepository.getInstance().getModule(dep.getModuleRef());
          if (dependency != null) {
            if (dep.isReexport() && !visibleModules.contains(dependency)) {
              visibleModules.add(dependency);
              changed=true;
            }
          }
        }
      }
    }
    myVisibleModules=visibleModules;
    myUsedDevKitsByFqName=new HashMap<String,DevKit>();
    for (    DevKit dk : usedDevkits) {
      myUsedDevKitsByFqName.put(dk.getModuleFqName(),dk);
      if (dk.getModuleReference().getModuleId() != null) {
        myUsedDevKitsById.put(dk.getModuleReference().getModuleId(),dk);
      }
    }
    myUsedLanguagesByFqName=new HashMap<String,Language>();
    for (    Language l : usedLanguages) {
      myUsedLanguagesByFqName.put(l.getModuleFqName(),l);
      if (l.getModuleReference().getModuleId() != null) {
        myUsedLanguagesById.put(l.getModuleReference().getModuleId(),l);
      }
    }
    myInitializationInProgress=false;
    myInitialized=true;
  }
}
