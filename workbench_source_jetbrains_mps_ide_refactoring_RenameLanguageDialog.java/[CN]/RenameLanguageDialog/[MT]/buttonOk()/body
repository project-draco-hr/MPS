{
  final boolean needToRegenerate=myRegenerateLanguage.getModel().isSelected();
  final String fqName=myLanguageNameField.getText();
  if (MPSModuleRepository.getInstance().getModuleByUID(fqName) != null) {
    setErrorText("Duplicate language name");
    return;
  }
  final LanguageRenamer renamer=new LanguageRenamer(myProject,myLanguage,fqName);
  ModelAccess.instance().runWriteActionInCommand(new Runnable(){
    public void run(){
      renamer.rename(needToRegenerate);
    }
  }
);
  ProgressManager.getInstance().run(new Modal(myProject,"Updating language references...",false){
    @Override public void run(    @NotNull ProgressIndicator indicator){
      indicator.pushState();
      try {
        indicator.setIndeterminate(true);
        ModelAccess.instance().runWriteAction(new Runnable(){
          public void run(){
            renamer.update();
          }
        }
);
      }
  finally {
        indicator.popState();
      }
    }
  }
);
  if (needToRegenerate) {
    final Set<Language> langs=new LinkedHashSet<Language>();
    ModelAccess.instance().runReadAction(new Runnable(){
      public void run(){
        langs.add(myLanguage);
        langs.addAll(MPSModuleRepository.getInstance().getAllExtendingLanguages(myLanguage));
      }
    }
);
    for (    final Language l : langs) {
      GenParameters params=ModelAccess.instance().runReadAction(new Computable<GenParameters>(){
        public GenParameters compute(){
          ModuleTestConfiguration languageConfig=new ModuleTestConfiguration();
          languageConfig.setModuleRef(l.getModuleReference());
          languageConfig.setName("tmp");
          try {
            return languageConfig.getGenParams(myProject,true);
          }
 catch (          IllegalGeneratorConfigurationException e) {
            return null;
          }
        }
      }
);
      if (params == null) {
        setErrorText("Rebuild configuration is invalid");
        return;
      }
      ModuleContext context=new ModuleContext(myLanguage,myProject);
      new WorkbenchMakeService(context,true).make(new ModelsToResources(context,params.getModelDescriptors()).resources(false));
    }
  }
  dispose();
}
