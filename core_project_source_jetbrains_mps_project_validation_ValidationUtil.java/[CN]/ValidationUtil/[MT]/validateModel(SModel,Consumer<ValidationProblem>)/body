{
  final SRepository repository=model.getRepository();
  if (repository != null) {
    repository.getModelAccess().checkReadAccess();
  }
  if (model instanceof TransientSModel) {
    return;
  }
  if (model.getModule() == null)   return;
  if (jetbrains.mps.util.SNodeOperations.isModelDisposed(model))   return;
  if (model instanceof InvalidSModel) {
    Iterable<SModel.Problem> problems=model.getProblems();
    if (!problems.iterator().hasNext()) {
      consumer.consume(new ValidationProblem(Severity.ERROR,"Couldn't read model"));
      return;
    }
    for (    SModel.Problem m : problems) {
      if (!m.isError())       continue;
      consumer.consume(new ValidationProblem(Severity.ERROR,m.getText()));
    }
    return;
  }
  if (!model.isReadOnly() && (model instanceof PersistenceVersionAware) && ((PersistenceVersionAware)model).getPersistenceVersion() < ModelPersistence.LAST_VERSION) {
    consumer.consume(new ValidationProblem(Severity.WARNING,"Outdated model persistence is used: " + ((PersistenceVersionAware)model).getPersistenceVersion() + ". Please run Tools->Migration 3.2->Migrate from Names to Ids"));
  }
  if (repository == null) {
    consumer.consume(new ValidationProblem(Severity.WARNING,"Model is detached from a repository, could not process further"));
    return;
  }
  SModule module=model.getModule();
  final SModelReference modelToValidateRef=model.getReference();
  for (  final SModelReference reference : SModelOperations.getImportedModelUIDs(model)) {
    if (module.resolveInDependencies(reference.getModelId()) == null) {
      String msg="Can't find model: " + SModelStereotype.withoutStereotype(reference.getModelName());
      consumer.consume(new MissingModelError(model,msg,reference));
    }
    if (reference.equals(modelToValidateRef)) {
      consumer.consume(new ImportSelfWarning(model,reference));
    }
  }
  List<SModuleReference> langsToCheck=new ArrayList<SModuleReference>();
  langsToCheck.addAll(SModelOperations.getAllImportedLanguages(model));
  langsToCheck.addAll(((jetbrains.mps.smodel.SModelInternal)model).engagedOnGenerationLanguages());
  for (  final SModuleReference lang : langsToCheck) {
    if (repository.getModule(lang.getModuleId()) == null) {
      consumer.consume(new MissingLanguageError(model,lang));
    }
  }
  for (  SModuleReference devKit : ((jetbrains.mps.smodel.SModelInternal)model).importedDevkits()) {
    if (repository.getModule(devKit.getModuleId()) == null) {
      consumer.consume(new ValidationProblem(Severity.ERROR,"Can't find devkit: " + devKit.getModuleName()){
      }
);
    }
  }
}
