{
  return new Comparator<SNode>(){
    private void check(    int index,    SNode searchedNode,    SNode editorNode){
      if (index == -1) {
        System.err.println("\"" + searchedNode.getRole_() + "\" can't found in "+ editorNode);
      }
    }
    private boolean fromSameCollection(    SNode node1,    SNode node2){
      return EqualUtil.equals(node1.getRole_(),node2.getRole_());
    }
    private int compareWithoutEditor(    SNode ancestor,    SNode node1,    SNode node2){
      int index1=ancestor.getIndexOfChild(node1);
      int index2=ancestor.getIndexOfChild(node2);
      return index1 - index2;
    }
    private int indexInEditor(    SNode editorNode,    String role){
      if (editorNode.toString().startsWith("%" + role + "%")) {
        return editorNode.getParent().getIndexOfChild(editorNode);
      }
      for (      SNode childEditorNode : editorNode.getChildren()) {
        int result=indexInEditor(childEditorNode,role);
        if (result != -1)         return result;
      }
      return -1;
    }
    private int compareWithEditor(    SNode root,    SNode node1,    SNode node2){
      AbstractConceptDeclaration conceptDeclaration=root.getConceptDeclarationAdapter();
      SModel structureModel=conceptDeclaration.getModel();
      Language language=(Language)structureModel.getModelDescriptor().getModule();
      SModel editorModel=language.getEditorModelDescriptor().getSModel();
      ConceptEditorDeclaration conceptEditorDeclaration=GoToEditorDeclarationHelper.findEditorDeclaration(editorModel,conceptDeclaration);
      SNode editorNode=conceptEditorDeclaration.getNode();
      int index1=indexInEditor(editorNode,node1.getRole_());
      check(index1,node1,editorNode);
      int index2=indexInEditor(editorNode,node2.getRole_());
      check(index2,node2,editorNode);
      return index1 - index2;
    }
    public int compare(    SNode o1,    SNode o2){
      if (!EqualUtil.equals(o1.getContainingRoot(),o2.getContainingRoot())) {
        return 0;
      }
      List<SNode> anc1=o1.getAncestors(true);
      List<SNode> anc2=o2.getAncestors(true);
      for (int i1=0; i1 < anc1.size(); i1++) {
        if (i1 == 0)         continue;
        for (int i2=0; i2 < anc2.size(); i2++) {
          if (i2 == 0)           continue;
          if (EqualUtil.equals(anc1.get(i1),anc2.get(i2))) {
            SNode ancestor=anc1.get(i1);
            SNode node1=anc1.get(i1 - 1);
            SNode node2=anc2.get(i2 - 1);
            if (fromSameCollection(node1,node2)) {
              return compareWithoutEditor(ancestor,node1,node2);
            }
 else {
              return compareWithEditor(node1.getContainingRoot(),node1,node2);
            }
          }
        }
      }
      return 0;
    }
  }
;
}
