{
  StringBuffer s=new StringBuffer("Generating:");
  for (  Project p : go.getProjects()) {
    s.append("\n    ");
    s.append(p);
  }
  for (  IModule m : go.getModules()) {
    s.append("\n    ");
    s.append(m);
  }
  for (  SModelDescriptor m : go.getModels()) {
    s.append("\n    ");
    s.append(m);
  }
  info(s.toString());
  final _FunctionTypes._void_P1_E0<? super String> startTestFormat=new _FunctionTypes._void_P1_E0<String>(){
    public void invoke(    String msg){
      myReporter.testStarted(((msg == null ? null : msg.trim())));
    }
  }
;
  final _FunctionTypes._void_P1_E0<? super String> finishTestFormat=new _FunctionTypes._void_P1_E0<String>(){
    public void invoke(    String msg){
      myReporter.testFinished(((msg == null ? null : msg.trim())));
    }
  }
;
  final int[] count=new int[]{1};
  IScriptController ctl=new IScriptController.Stub(new IConfigMonitor.Stub(),new IJobMonitor.Stub(new IProgress.Stub(){
    @Override public void beginWork(    String name,    int estimate,    int ofTotal){
      reportIfStartsWith("Generating ",name,startTestFormat);
    }
    @Override public void finishWork(    String name){
      reportIfStartsWith("Generating ",name,finishTestFormat);
    }
    @Override public void advanceWork(    String name,    int done,    String comment){
      if (comment != null) {
        _FunctionTypes._void_P1_E0<? super String> format=startTestFormat;
        if (done > 1) {
          format=finishTestFormat;
        }
        reportIfStartsWith("Diffing ",name + " " + comment,format);
      }
    }
  }
){
    @Override public void reportFeedback(    IFeedback fdbk){
      if (fdbk.getSeverity() == IFeedback.Severity.ERROR) {
        String test=myReporter.getCurrentTestName();
        if (test == null) {
          test="unknown";
        }
        Throwable thr=fdbk.getException();
        String msg=fdbk.getMessage();
        String details=(thr == null ? "(no details)" : String.valueOf(MpsWorker.extractStackTrace(thr)));
        int eol=msg.indexOf("\n");
        if (eol >= 0) {
          details=msg.substring(eol + 1) + "\n" + details;
          msg=msg.substring(0,eol);
        }
        myReporter.testFailed(test,msg,details);
      }
    }
  }
){
    @Override public void setup(    IPropertiesPool ppool,    Iterable<ITarget> toExecute,    Iterable<? extends IResource> input){
      super.setup(ppool,toExecute,input);
      Tuples._1<_FunctionTypes._return_P1_E0<? extends IFile,? super String>> makeparams=(Tuples._1<_FunctionTypes._return_P1_E0<? extends IFile,? super String>>)ppool.properties(new ITarget.Name("jetbrains.mps.lang.core.Make.make"),Object.class);
      makeparams._0(new _FunctionTypes._return_P1_E0<IFile,String>(){
        public IFile invoke(        String path){
          return tmpFile(path);
        }
      }
);
      Tuples._1<Boolean> tparams=(Tuples._1<Boolean>)ppool.properties(new ITarget.Name("jetbrains.mps.lang.core.TextGen.textGen"),Object.class);
      if (tparams != null) {
        tparams._0(false);
      }
      Tuples._2<_FunctionTypes._return_P1_E0<? extends String,? super IFile>,Set<File>> dparams=(Tuples._2<_FunctionTypes._return_P1_E0<? extends String,? super IFile>,Set<File>>)ppool.properties(new ITarget.Name("jetbrains.mps.build.gentest.Diff.diff"),Object.class);
      if (dparams != null && isShowDiff()) {
        dparams._0(new _FunctionTypes._return_P1_E0<String,IFile>(){
          public String invoke(          IFile f){
            return pathOfTmpFile(f);
          }
        }
);
        dparams._1(myWhatToDo.getExcludedFromDiffFiles());
      }
      if (isInvokeTestsSet()) {
        Tuples._1<UnitTestListener> testParams=(Tuples._1<UnitTestListener>)ppool.properties(new ITarget.Name("jetbrains.mps.build.gentest.Test.runTests"),Object.class);
        testParams._0(new TestGenerationWorker.MyUnitTestAdapter());
      }
      myReporter.finishRun();
      myReporter.startRun("Module cluster " + String.valueOf(count[0]++));
    }
  }
;
  IOperationContext context=new ProjectOperationContext(project);
  try {
    BuildMakeService bms=new BuildMakeService();
    MakeSession ms=new MakeSession(context,myMessageHandler,true){
      @Override public IScript toScript(      ScriptBuilder scriptBuilder){
        if (isInvokeTestsSet()) {
          scriptBuilder.withFacetName(new IFacet.Name("jetbrains.mps.build.gentest.Test"));
        }
        if (isShowDiff()) {
          scriptBuilder.withFacetName(new IFacet.Name("jetbrains.mps.build.gentest.Diff"));
        }
        return scriptBuilder.toScript();
      }
    }
;
    bms.make(ms,collectResources(context,go.getProjects(),go.getModules(),go.getModels()),null,ctl,new ProgressMonitorBase(){
      private String prevTitle;
      protected void update(      double p0){
      }
      protected void startInternal(      String text){
      }
      protected void doneInternal(      String text){
      }
      protected void setTitleInternal(      String text){
        prevTitle=text;
      }
      protected void setStepInternal(      String p0){
      }
      public boolean isCanceled(){
        return false;
      }
      public void cancel(){
      }
      private ProgressMonitorBase.SubProgressMonitor customSubProgress(      ProgressMonitorBase parent,      int work,      SubProgressKind kind){
        if (prevTitle != null && prevTitle.startsWith("Generating :: ")) {
          return new ProgressMonitorBase.SubProgressMonitor(parent,work,kind){
            @Override protected void startInternal(            String text){
              reportIfStartsWith("Generating ","Generating " + text,startTestFormat);
            }
            @Override protected void doneInternal(            String text){
              reportIfStartsWith("Generating ","Generating " + text,finishTestFormat);
            }
          }
;
        }
        return new ProgressMonitorBase.SubProgressMonitor(parent,work,kind){
          @Override protected ProgressMonitorBase.SubProgressMonitor subTaskInternal(          int work,          SubProgressKind kind){
            return customSubProgress(this,work,kind);
          }
        }
;
      }
      @Override protected ProgressMonitorBase.SubProgressMonitor subTaskInternal(      int work,      SubProgressKind kind){
        return customSubProgress(this,work,kind);
      }
    }
).get();
  }
 catch (  InterruptedException ignore) {
  }
catch (  ExecutionException ignore) {
  }
}
