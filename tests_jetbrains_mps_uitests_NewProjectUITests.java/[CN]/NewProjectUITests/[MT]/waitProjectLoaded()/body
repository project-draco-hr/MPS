{
  Project ideaProject=null;
  Project[] projects=ProjectManager.getInstance().getOpenProjects();
  if (projects.length != 0) {
    ideaProject=projects[0];
  }
 else {
    final Project[] project=new Project[]{null};
    final ProjectManager manager=ProjectManager.getInstance();
    manager.addProjectManagerListener(new ProjectManagerAdapter(){
      @Override public void projectOpened(      Project p){
        manager.removeProjectManagerListener(this);
        project[0]=p;
      }
    }
);
    while (project[0] == null)     flushAWT();
    ideaProject=project[0];
  }
  while (ideaProject.getComponent(MPSProjectHolder.class) == null)   flushAWT();
  return ideaProject.getComponent(MPSProjectHolder.class).getMPSProject();
}
