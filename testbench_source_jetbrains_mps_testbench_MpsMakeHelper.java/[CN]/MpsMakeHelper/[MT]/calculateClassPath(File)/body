{
  File[] pathsToLook;
  if (new File(mpsHome.getAbsolutePath() + File.separator + "classes").exists()) {
    pathsToLook=new File[]{new File(mpsHome.getAbsolutePath() + File.separator + "core"),new File(mpsHome.getAbsolutePath() + File.separator + "workbench"+ File.separator+ "classes"),new File(mpsHome.getAbsolutePath() + File.separator + "lib"),new File(mpsHome.getAbsolutePath() + File.separator + "platform"+ File.separator+ "buildlanguage"+ File.separator+ "ant"),new File(mpsHome.getAbsolutePath() + File.separator + "core"+ File.separator+ "kernel"+ File.separator+ "xmlQuery"+ File.separator+ "runtime"),new File(mpsHome.getAbsolutePath() + File.separator + "MPSPlugin"+ File.separator+ "apiclasses")};
  }
 else {
    pathsToLook=new File[]{new File(mpsHome.getAbsolutePath() + File.separator + "lib"),new File(mpsHome.getAbsolutePath() + File.separator + "platform"+ File.separator+ "generate.ant.task.jar"),new File(mpsHome.getAbsolutePath() + File.separator + "plugin")};
  }
  Set<File> classPaths=new LinkedHashSet<File>();
  for (  File path : pathsToLook) {
    if (!path.exists() || (!path.isDirectory() && !path.getAbsolutePath().endsWith(".jar"))) {
      throw new BuildException(mpsHome + " is invalid MPS home path: path " + path+ " does not exist or is not a directory or a jar file.");
    }
 else     if (!path.isDirectory()) {
      classPaths.add(path.getAbsoluteFile());
    }
 else {
      gatherAllClassesAndJarsUnder(path,classPaths);
    }
  }
  File mpsClasses=new File(mpsHome + File.separator + "classes");
  if (mpsClasses.exists()) {
    classPaths.add(mpsClasses);
  }
  return classPaths;
}
