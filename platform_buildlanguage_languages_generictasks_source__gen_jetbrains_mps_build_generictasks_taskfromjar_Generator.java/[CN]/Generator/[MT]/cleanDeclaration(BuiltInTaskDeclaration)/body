{
  Set<NestedDeclaration> toRemoveNestedReference=new HashSet<NestedDeclaration>();
  for (  NestedDeclaration nref : decl.getNesteds()) {
    for (    NestedDeclaration ref : decl.getNesteds()) {
      if (ref.equals(nref)) {
        continue;
      }
      if (ref.getDeclaration().getClassname().equals(nref.getDeclaration().getClassname())) {
        toRemoveNestedReference.add(ref);
      }
    }
  }
  for (  NestedDeclaration nref : toRemoveNestedReference) {
    decl.removeChild(nref);
    for (    TaskReference roleRef : nref.getRoles()) {
      if (((BuiltInTaskDeclaration)roleRef.getDeclaration()).getFake()) {
        decl.removeChild(roleRef.getDeclaration());
      }
    }
  }
  for (  BuiltInTaskDeclaration fakedecl : decl.getFakeDeclarations()) {
    fakedecl.setFake(true);
  }
  Set<BuiltInTaskDeclaration> toRemoveFakeDeclaration=new HashSet<BuiltInTaskDeclaration>();
  toRemoveFakeDeclaration.addAll(decl.getFakeDeclarations());
  for (  NestedDeclaration nref : decl.getNesteds()) {
    for (    TaskReference roleRef : nref.getRoles()) {
      if (((BuiltInTaskDeclaration)roleRef.getDeclaration()).getFake()) {
        toRemoveFakeDeclaration.remove(roleRef.getDeclaration());
      }
    }
  }
  for (  BuiltInTaskDeclaration fakedecl : toRemoveFakeDeclaration) {
    decl.removeChild(fakedecl);
  }
  for (  NestedDeclaration nref : decl.getNesteds()) {
    for (    TaskReference roleRef : nref.getRoles()) {
      if (((BuiltInTaskDeclaration)roleRef.getDeclaration()).getFake() && roleRef.getDeclaration().getName().equals(nref.getDeclaration().getName())) {
        nref.removeChild(roleRef);
        decl.removeChild(roleRef.getDeclaration());
        break;
      }
    }
  }
}
