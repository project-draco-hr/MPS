{
  List<SModelDescriptor> regularModels=new ArrayList<SModelDescriptor>();
  List<SModelDescriptor> tests=new ArrayList<SModelDescriptor>();
  List<SModelDescriptor> stubs=new ArrayList<SModelDescriptor>();
  for (  SModelDescriptor modelDescriptor : models) {
    if (ProjectModels.isProjectModel(modelDescriptor.getReference()))     continue;
    String stereotype=SModelStereotype.getStereotype(modelDescriptor);
    if (stereotype == null || stereotype.length() == 0) {
      stereotype=".";
    }
    if (SModelStereotype.isStubModelStereotype(stereotype)) {
      stubs.add(modelDescriptor);
    }
 else     if (SModelStereotype.TESTS.equals(stereotype)) {
      tests.add(modelDescriptor);
    }
 else {
      regularModels.add(modelDescriptor);
    }
  }
  List<SModelTreeNode> regularModelNodes=getRootModelTreeNodes(regularModels,operationContext,isNeedBuildChildModels(rootTreeNode));
  if (!regularModelNodes.isEmpty()) {
    if (rootTreeNode instanceof jetbrains.mps.ide.projectPane.logicalview.nodes.ProjectSolutionTreeNode) {
      SModelNamespaceTreeBuilder builder=new SModelNamespaceTreeBuilder();
      for (      SModelTreeNode treeNode : regularModelNodes) {
        builder.addNode(treeNode);
      }
      builder.fillNode(rootTreeNode);
    }
 else {
      MPSTreeNode currentRootNode;
      if (!isNeedBuildChildModels(rootTreeNode)) {
        currentRootNode=rootTreeNode;
      }
 else {
        IModule contextModule=operationContext.getModule();
        String namespace=contextModule.getModuleFqName();
        currentRootNode=new NamespaceTextNode((namespace == null) ? "" : namespace,operationContext);
      }
      for (      SModelTreeNode treeNode : regularModelNodes) {
        currentRootNode.add(treeNode);
      }
      if (!currentRootNode.equals(rootTreeNode)) {
        rootTreeNode.add(currentRootNode);
      }
    }
  }
  if (!tests.isEmpty()) {
    SModelNamespaceTreeBuilder builder=new SModelNamespaceTreeBuilder();
    List<SModelTreeNode> testNodes=getRootModelTreeNodes(tests,operationContext,isNeedBuildChildModels(rootTreeNode));
    for (    SModelTreeNode testNode : testNodes) {
      builder.addNode(testNode);
    }
    TestsTreeNode testsNode=new TestsTreeNode(operationContext);
    builder.fillNode(testsNode);
    if (!dropMiddleNodes) {
      rootTreeNode.add(testsNode);
    }
 else {
      Enumeration children=testsNode.children();
      while (children.hasMoreElements()) {
        rootTreeNode.add((MutableTreeNode)children.nextElement());
      }
    }
  }
  if (!stubs.isEmpty()) {
    SModelNamespaceTreeBuilder builder=new SModelNamespaceTreeBuilder();
    List<SModelTreeNode> stubNodes=getRootModelTreeNodes(stubs,operationContext,isNeedBuildChildModels(rootTreeNode));
    for (    SModelTreeNode treeNode : stubNodes) {
      builder.addNode(treeNode);
    }
    StubsTreeNode stubsNode=new StubsTreeNode(operationContext);
    builder.fillNode(stubsNode);
    if (!dropMiddleNodes) {
      rootTreeNode.add(stubsNode);
    }
 else {
      Enumeration children=stubsNode.children();
      List<MutableTreeNode> tmpList=new ArrayList<MutableTreeNode>();
      while (children.hasMoreElements()) {
        tmpList.add((MutableTreeNode)children.nextElement());
      }
      for (      MutableTreeNode child : tmpList) {
        rootTreeNode.add(child);
      }
    }
  }
}
