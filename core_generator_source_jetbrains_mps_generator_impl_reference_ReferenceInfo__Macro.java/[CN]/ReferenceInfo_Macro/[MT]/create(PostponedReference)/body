{
  expandReferenceMacro(ref);
  if (myOutputTargetNode != null) {
    return createStaticReference(ref,myOutputTargetNode);
  }
  if (myResolveInfoForDynamicResolve != null) {
    DynamicReference dr=new DynamicReference(ref.getLink(),ref.getSourceNode(),null,myResolveInfoForDynamicResolve);
    dr.setOrigin(new DynamicReferenceOrigin(getMacroNodeRef(),null));
    return dr;
  }
  if (!ref.getLink().isOptional()) {
    return createInvalidReference(ref,myResolver.getDefaultResolveInfo());
  }
  return null;
}
