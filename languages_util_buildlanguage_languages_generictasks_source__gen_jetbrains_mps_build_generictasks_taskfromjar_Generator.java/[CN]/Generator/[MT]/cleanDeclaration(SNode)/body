{
  Set<SNode> toRemoveNestedReference=SetSequence.<SNode>fromSet(new HashSet());
  for (  SNode nref : SLinkOperations.getTargets(decl,"nested",true)) {
    for (    SNode ref : SLinkOperations.getTargets(decl,"nested",true)) {
      if (eq_ixz87t_a0a0a0b0d(ref,nref)) {
        continue;
      }
      if (eq_ixz87t_a0b0a0b0d(SPropertyOperations.getString(SLinkOperations.getTarget(ref,"declaration",false),"classname"),SPropertyOperations.getString(SLinkOperations.getTarget(nref,"declaration",false),"classname"))) {
        SetSequence.fromSet(toRemoveNestedReference).addElement(ref);
      }
    }
  }
  SetSequence.<SNode>fromSet(toRemoveNestedReference).visitAll(new IVisitor<SNode>(){
    public void visit(    SNode it){
      ListSequence.<SNode>fromList(SNodeOperations.getChildren(decl)).removeElement(it);
      ListSequence.<SNode>fromList(SLinkOperations.getTargets(it,"role",true)).where(new IWhereFilter<SNode>(){
        public boolean accept(        SNode roleRef){
          return SPropertyOperations.getBoolean(SNodeOperations.cast(SLinkOperations.getTarget(roleRef,"declaration",false),"jetbrains.mps.build.generictasks.structure.BuiltInTaskDeclaration"),"fake");
        }
      }
).visitAll(new IVisitor<SNode>(){
        public void visit(        SNode child){
          ListSequence.<SNode>fromList(SNodeOperations.getChildren(decl)).removeElement(SLinkOperations.getTarget(child,"declaration",false));
        }
      }
);
    }
  }
);
  ListSequence.<SNode>fromList(SLinkOperations.getTargets(decl,"fakeDeclaration",true)).visitAll(new IVisitor<SNode>(){
    public void visit(    SNode it){
      SPropertyOperations.set(it,"fake","" + true);
    }
  }
);
  Set<SNode> toRemoveFakeDeclaration=SetSequence.<SNode>fromSet(new HashSet());
  SetSequence.fromSet(toRemoveFakeDeclaration).addSequence(ListSequence.<SNode>fromList(SLinkOperations.getTargets(decl,"fakeDeclaration",true)));
  for (  SNode nref : SLinkOperations.getTargets(decl,"nested",true)) {
    List<SNode> notRemove=ListSequence.<SNode>fromList(SLinkOperations.getTargets(nref,"role",true)).<SNode>select(new ISelector<SNode,SNode>(){
      public SNode select(      SNode it){
        return SNodeOperations.cast(SLinkOperations.getTarget(it,"declaration",false),"jetbrains.mps.build.generictasks.structure.BuiltInTaskDeclaration");
      }
    }
).where(new IWhereFilter<SNode>(){
      public boolean accept(      SNode it){
        return SPropertyOperations.getBoolean(it,"fake");
      }
    }
).toListSequence();
    SetSequence.fromSet(toRemoveFakeDeclaration).removeSequence(ListSequence.<SNode>fromList(notRemove));
  }
  SetSequence.<SNode>fromSet(toRemoveFakeDeclaration).visitAll(new IVisitor<SNode>(){
    public void visit(    SNode it){
      ListSequence.<SNode>fromList(SNodeOperations.getChildren(decl)).removeElement(it);
    }
  }
);
  for (  final SNode nref : SLinkOperations.getTargets(decl,"nested",true)) {
    SNode node=ListSequence.<SNode>fromList(SLinkOperations.getTargets(nref,"role",true)).where(new IWhereFilter<SNode>(){
      public boolean accept(      SNode it){
        SNode biDecl=SNodeOperations.cast(SLinkOperations.getTarget(it,"declaration",false),"jetbrains.mps.build.generictasks.structure.BuiltInTaskDeclaration");
        return SPropertyOperations.getBoolean(biDecl,"fake") && eq_ixz87t_a0a1a0a0a0a0a0a9a3(SPropertyOperations.getString(biDecl,"name"),SPropertyOperations.getString(SLinkOperations.getTarget(nref,"declaration",false),"name"));
      }
    }
).first();
    ListSequence.<SNode>fromList(SNodeOperations.getChildren(nref)).removeElement(node);
    ListSequence.<SNode>fromList(SNodeOperations.getChildren(decl)).removeElement(SLinkOperations.getTarget(node,"declaration",false));
  }
}
