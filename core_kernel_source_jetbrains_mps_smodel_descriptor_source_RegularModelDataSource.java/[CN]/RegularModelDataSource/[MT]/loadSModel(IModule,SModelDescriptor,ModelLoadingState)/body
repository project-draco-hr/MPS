{
  DefaultSModelDescriptor dsm=(DefaultSModelDescriptor)sm;
  SModelReference dsmRef=dsm.getSModelReference();
  if (!dsm.getModelFile().isReadOnly() && !dsm.getModelFile().exists()) {
    SModel model=new SModel(dsmRef,new RegularNodeIdMap());
    return new ModelLoadResult(model,ModelLoadingState.FULLY_LOADED);
  }
  ModelLoadResult result;
  try {
    result=ModelPersistence.readModel(dsm.getDescriptorSModelHeader(),dsm.getModelFile(),state);
    if (result.getState() == ModelLoadingState.NOT_LOADED) {
      if (state != ModelLoadingState.NOT_LOADED) {
        SuspiciousModelHandler.getHandler().handleSuspiciousModel(dsm,false);
      }
      return result;
    }
  }
 catch (  ModelFileReadException t) {
    SuspiciousModelHandler.getHandler().handleSuspiciousModel(dsm,false);
    SModel newModel=new StubModel(dsm.getSModelReference());
    LOG.error(t.getMessage(),newModel);
    return new ModelLoadResult(newModel,ModelLoadingState.NOT_LOADED);
  }
catch (  PersistenceVersionNotFoundException e) {
    LOG.error("Trying to load model " + dsm.getLongName() + " from file "+ dsm.getModelFile().toString(),e);
    SuspiciousModelHandler.getHandler().handleSuspiciousModel(dsm,false);
    StubModel model=new StubModel(dsmRef);
    return new ModelLoadResult(model,ModelLoadingState.NOT_LOADED);
  }
  SModel model=result.getModel();
  if (result.getState() == ModelLoadingState.FULLY_LOADED) {
    boolean needToSave=model.updateSModelReferences() || model.updateModuleReferences();
    if (needToSave && !dsm.getModelFile().isReadOnly()) {
      SModelRepository.getInstance().markChanged(model);
    }
  }
  LOG.assertLog(model.getSModelReference().equals(dsmRef),"\nError loading model from file: \"" + dsm.getModelFile() + "\"\n"+ "expected model UID     : \""+ dsmRef+ "\"\n"+ "but was UID            : \""+ model.getSModelReference()+ "\"\n"+ "the model will not be available.\n"+ "Make sure that all project's roots and/or the model namespace is correct");
  return result;
}
