{
  Map<SNode,NodeBox> initialMap=new HashMap<SNode,NodeBox>();
  for (  SNode node : nodes) {
    initialMap.put(node,new NodeBox(node));
  }
  for (  SNode node : nodes) {
    if (!initialMap.containsKey(node))     continue;
    NodeBox nodeBox=initialMap.get(node);
    SNode parent=node.getParent();
    NodeBox currentNodeBox=nodeBox;
    while (parent != null) {
      if (initialMap.containsKey(node)) {
        NodeBox newNodeBox=initialMap.get(node);
        newNodeBox.last().setNext(currentNodeBox);
        initialMap.remove(currentNodeBox.getNode());
        currentNodeBox=newNodeBox;
      }
      parent=parent.getParent();
    }
  }
  List<NodeBox> result=new ArrayList<NodeBox>();
  for (  SNode node : nodes) {
    if (initialMap.containsKey(node)) {
      result.add(initialMap.get(node));
    }
  }
  return result;
}
