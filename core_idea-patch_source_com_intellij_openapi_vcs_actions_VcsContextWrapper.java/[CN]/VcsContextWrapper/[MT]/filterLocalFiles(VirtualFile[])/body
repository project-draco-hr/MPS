{
  final ArrayList<VirtualFile> result=new ArrayList<VirtualFile>();
  for (  final VirtualFile virtualFile : fileArray) {
    if (isLocal(virtualFile)) {
      result.add(virtualFile);
    }
    if (virtualFile instanceof MPSNodeVirtualFile) {
      ModelAccess.instance().runReadAction(new Runnable(){
        public void run(){
          SNode node=((MPSNodeVirtualFile)virtualFile).getNode();
          if (node == null)           return;
          SModelDescriptor md=node.getModel().getModelDescriptor();
          if (!(md instanceof EditableSModelDescriptor))           return;
          IFile ifile=((EditableSModelDescriptor)md).getModelFile();
          if (ifile == null || !ifile.exists())           return;
          VirtualFile vfile=VirtualFileUtils.getVirtualFile(ifile);
          if (vfile == null)           return;
          result.add(vfile);
        }
      }
);
    }
  }
  return VfsUtil.toVirtualFileArray(result);
}
