{
  try {
    Logger LOG=LogManager.getLogger("jetbrains.mps.ide.migration.UpgradePersistence_Action");
    final MPSProject mpsProject=((Project)MapSequence.fromMap(_params).get("project")).getComponent(MPSProject.class);
    for (    SModule module : mpsProject.getModulesWithGenerators()) {
      for (      SModel model : module.getModels()) {
        if (!(model instanceof EditableSModel)) {
          continue;
        }
        DataSource source=model.getSource();
        if (!(source instanceof FileDataSource)) {
          continue;
        }
        FileDataSource fileSource=(FileDataSource)source;
        if (!(model.getModelRoot() instanceof DefaultModelRoot) || fileSource.isReadOnly()) {
          continue;
        }
        String ext=FileUtil.getExtension(fileSource.getFile().getName());
        ModelFactory factory=PersistenceFacade.getInstance().getModelFactory(ext);
        try {
          if (factory == null || !(factory.needsUpgrade(fileSource))) {
            continue;
          }
          boolean wasInitialized=model.isLoaded();
          if (wasInitialized) {
            ((EditableSModel)model).save();
          }
          factory.upgrade(fileSource);
          ((EditableSModel)model).reloadFromSource();
        }
 catch (        IOException ex) {
          LOG.error(ex);
        }
      }
    }
  }
 catch (  Throwable t) {
    if (LOG.isEnabledFor(Priority.ERROR)) {
      LOG.error("User's action execute method failed. Action:" + "UpgradePersistence",t);
    }
  }
}
