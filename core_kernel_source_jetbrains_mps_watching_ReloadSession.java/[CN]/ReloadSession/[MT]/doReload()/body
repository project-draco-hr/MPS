{
  if (hasAnythingToDo()) {
    ProgressManager.getInstance().run(new Modal(null,"Reloading",false){
      public void run(      @NotNull final ProgressIndicator progressIndicator){
        fireReloadStarted();
        try {
          if (!myNewModuleVFiles.isEmpty()) {
            LOG.info("Reloading libraries.");
            progressIndicator.setText("Reloading libraries... Please wait.");
            ModelAccess.instance().runWriteAction(new Runnable(){
              public void run(){
                LibraryManager.getInstance().update();
              }
            }
);
          }
          preprocess();
          boolean areModulesUpdated=updateModules(progressIndicator);
          updateModels(progressIndicator);
          if (areModulesUpdated || !myNewModuleVFiles.isEmpty()) {
            progressIndicator.setText("Reloading classes... Please wait.");
            ClassLoaderManager.getInstance().reloadAll(new EmptyProgressIndicator());
          }
        }
  finally {
          fireReloadFinished();
        }
      }
    }
);
  }
}
