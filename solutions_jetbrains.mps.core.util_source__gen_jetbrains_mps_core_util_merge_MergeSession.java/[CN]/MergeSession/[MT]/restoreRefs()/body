{
  for (  IMapping<SNode,SNode> m : MapSequence.fromMap(mapping)) {
    SNode input=m.key();
    SNode output=m.value();
    for (    SReference ref : SNodeOperations.getReferences(input)) {
      SNode targetNode=SNodeOperations.getTargetNodeSilently(ref);
      if (targetNode == null) {
        messageHandler.handle(new Message(MessageKind.ERROR,"broken reference `" + ref.getRole() + "' in "+ SNodeOperations.getDebugText(input)));
        continue;
      }
      if (MapSequence.fromMap(mapping).containsKey(targetNode)) {
        SNodeAccessUtil.setReferenceTarget(output,ref.getRole(),MapSequence.fromMap(mapping).get(targetNode));
      }
 else {
        SNodeAccessUtil.setReferenceTarget(output,ref.getRole(),targetNode);
      }
    }
  }
  this.mapping=null;
  this.reverseMapping=null;
}
