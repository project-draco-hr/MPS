{
  DiffModelTree.ModelTreeNode modelNode=new DiffModelTree.ModelTreeNode();
  myRootNodes=Sequence.fromIterable(getAffectedRoots()).where(new IWhereFilter<SNodeId>(){
    public boolean accept(    SNodeId r){
      return r != null;
    }
  }
).select(new ISelector<SNodeId,DiffModelTree.RootTreeNode>(){
    public DiffModelTree.RootTreeNode select(    SNodeId r){
      return new DiffModelTree.RootTreeNode(r);
    }
  }
).sort(new ISelector<DiffModelTree.RootTreeNode,Comparable<?>>(){
    public Comparable<?> select(    DiffModelTree.RootTreeNode rtn){
      return rtn.myVirtualPackage + "|" + rtn.myPresentation;
    }
  }
,true).toListSequence();
  for (  DiffModelTree.RootTreeNode rtn : ListSequence.fromList(myRootNodes)) {
    MPSTreeNode parentNode=modelNode;
    if (StringUtils.isNotEmpty(rtn.myVirtualPackage)) {
      for (      final String sub : Sequence.fromIterable(Sequence.fromArray(rtn.myVirtualPackage.split("\\.")))) {
        Iterable<MPSTreeNode> children=(Iterable<MPSTreeNode>)parentNode;
        MPSTreeNode child=Sequence.fromIterable(children).findFirst(new IWhereFilter<MPSTreeNode>(){
          public boolean accept(          MPSTreeNode c){
            return c instanceof DiffModelTree.PackageTreeNode && sub.equals(c.getText());
          }
        }
);
        if (child == null) {
          child=new DiffModelTree.PackageTreeNode(sub);
          parentNode.add(child);
        }
        parentNode=child;
      }
    }
    parentNode.add(rtn);
  }
  if (Sequence.fromIterable(getAffectedRoots()).any(new IWhereFilter<SNodeId>(){
    public boolean accept(    SNodeId r){
      return r == null;
    }
  }
)) {
    modelNode.add(new DiffModelTree.MetadataTreeNode());
  }
  return modelNode;
}
