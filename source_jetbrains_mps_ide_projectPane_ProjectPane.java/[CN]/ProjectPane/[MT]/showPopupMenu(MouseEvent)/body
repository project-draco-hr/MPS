{
  JPopupMenu popupMenu=new JPopupMenu();
  TreePath selectionPath=myTree.getSelectionPath();
  final Object lastPathComponent=selectionPath.getLastPathComponent();
  MPSTreeNodeEx selectedTreeNode=(MPSTreeNodeEx)lastPathComponent;
  if (selectedTreeNode != null && selectedTreeNode.getSNode() != null) {
    ActionManager.instance().getGroup(PROJECT_PANE_NODE_ACTIONS).add(popupMenu,new ActionContext(myIDE,selectedTreeNode.getSNode()));
  }
  if (selectionPath.getLastPathComponent() == myTree.getModel().getRoot()) {
    popupMenu.add(new AbstractAction("Project Properties",Icons.PROJECT_PROPERTIES_ICON){
      public void actionPerformed(      ActionEvent e){
        new ProjectPropertiesDialog(myIDE.getMainFrame(),myProject).showDialog();
      }
    }
);
  }
  if (selectionPath.getLastPathComponent() instanceof ProjectModelsTreeNode) {
    ActionManager.instance().getGroup(PROJECT_PANE_MODELS_ACTIONS).add(popupMenu,new ActionContext(myIDE));
  }
  if (selectionPath.getLastPathComponent() instanceof ProjectLanguagesTreeNode) {
    popupMenu.add(new AbstractActionWithEmptyIcon("New Language"){
      public void actionPerformed(      ActionEvent e){
        NewLanguageDialog dialog=new NewLanguageDialog(myIDE.getMainFrame(),myProject);
        dialog.showDialog();
      }
    }
);
  }
  if (getSelectedModel() != null) {
    if (selectionPath.getLastPathComponent() instanceof SModelTreeNode) {
      SModelDescriptor model=((SModelTreeNode)selectionPath.getLastPathComponent()).getModelDescriptor();
      ActionContext context=new ActionContext(myIDE);
      context.put(SModelDescriptor.class,model);
      ActionManager.instance().getGroup(PROJECT_PANE_MODEL_ACTIONS).add(popupMenu,context);
    }
  }
  if (lastPathComponent instanceof ProjectLanguageTreeNode) {
    final ProjectLanguageTreeNode languageTreeNode=((ProjectLanguageTreeNode)lastPathComponent);
    final Language language=languageTreeNode.getLanguage();
    ActionContext context=new ActionContext(myIDE);
    context.put(Language.class,language);
    ActionManager.instance().getGroup(PROJECT_PANE_LANGUAGE_ACTIONS).add(popupMenu,context);
  }
  if (popupMenu.getComponentCount() == 0)   return;
  popupMenu.show(myTree,e.getX(),e.getY());
}
