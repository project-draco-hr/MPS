{
  List<Pair<SNode,String>> oldInputHistory=myGenerator.setInputHistory(myInputHistory);
  try {
    SNode child=MacroUtil.executeMapSrcNodeMacro(myInputNode,myMapSrcMacro.getNode(),myChildToReplace.getParent(),myGenerator);
    if (child != null) {
      if (child.isRegistered()) {
        child=CopyUtil.copy(child,child.getModel());
      }
      validateReferences(child);
      myChildToReplace.getParent().replaceChild(myChildToReplace,child);
      myGenerator.getGeneratorSessionContext().getGenerationTracer().replaceOutputNode(myChildToReplace,child);
    }
  }
 catch (  Throwable t) {
    myGenerator.showErrorMessage(myInputNode,myMapSrcMacro.getNode(),"mapping failed: '" + t.getMessage() + "'");
    LOG.error(t,myMapSrcMacro.getNode());
  }
 finally {
    myGenerator.setInputHistory(oldInputHistory);
  }
}
