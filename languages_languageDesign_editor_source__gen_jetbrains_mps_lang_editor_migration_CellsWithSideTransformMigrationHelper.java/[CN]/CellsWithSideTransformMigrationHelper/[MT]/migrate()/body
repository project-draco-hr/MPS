{
{
    final SearchScope scope=CommandUtil.createScope(myModule);
    QueryExecutionContext context=new QueryExecutionContext(){
      public SearchScope getDefaultSearchScope(){
        return scope;
      }
    }
;
    Iterable<SNode> cellsWithTagsOrApplySideTransforms=CollectionSequence.fromCollection(CommandUtil.instances(CommandUtil.createConsoleScope(null,false,context),MetaAdapterFactory.getConcept(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,"jetbrains.mps.lang.editor.structure.EditorCellModel"))).where(new IWhereFilter<SNode>(){
      public boolean accept(      SNode it){
        return Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(it,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x11beb039542L,0x11beb040d06L,"styleItem")),MetaAdapterFactory.getConcept(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x11abb1e8d85L,"jetbrains.mps.lang.editor.structure.SideTransformAnchorTagStyleClassItem"))).isNotEmpty() || (SLinkOperations.getTarget(it,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,0x10f3514bb7cL,"menuDescriptor")) != null) && Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(SLinkOperations.getTarget(it,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,0x10f3514bb7cL,"menuDescriptor")),MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x10f34f6aaacL,0x10f34f82910L,"cellMenuPart")),MetaAdapterFactory.getConcept(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x72449b609d0e77bbL,"jetbrains.mps.lang.editor.structure.CellMenuPart_ApplySideTransforms"))).isNotEmpty();
      }
    }
);
    Map<Pair<SNode,Pair<Set<String>,Set<Pair<String,String>>>>,SNode> conceptAndTagsToAdditionalMenu=MapSequence.fromMap(new HashMap<Pair<SNode,Pair<Set<String>,Set<Pair<String,String>>>>,SNode>());
    Map<SNode,Integer> conceptToCounter=MapSequence.fromMap(new HashMap<SNode,Integer>());
    boolean menuWasFound=false;
    for (    SNode cell : Sequence.fromIterable(cellsWithTagsOrApplySideTransforms)) {
      SNode concept=getConceptDeclaration(cell);
      if (concept == null) {
        continue;
      }
      Pair<SNode,Pair<Set<String>,Set<Pair<String,String>>>> key=createKey(cell);
      SNode cachedReference=MapSequence.fromMap(conceptAndTagsToAdditionalMenu).get(key);
      if (cachedReference != null) {
        SLinkOperations.setTarget(cell,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,0x3a52dff8e5ebd740L,"transformationMenu"),SNodeOperations.copyNode(cachedReference));
        continue;
      }
      Set<String> sideTransformTags=getSideTransformTags(cell);
      boolean containsDefaultTag=false;
      Set<SNode> menusFound=new HashSet<SNode>();
      for (      String tag : sideTransformTags) {
        if (eq_o8m9jz_a0a0a9a6a0a6_0(tag,null) || eq_o8m9jz_a0a0a9a6a0a6(tag,DEFAULT_TAG_NAME)) {
          containsDefaultTag=true;
          menuWasFound=true;
          continue;
        }
        menusFound.addAll(findAllMainNamedMenusForTag(concept,tag));
      }
      List<SNode> menuReferences=new ArrayList<SNode>();
      if (containsDefaultTag) {
        menuReferences.add(createDefaultTransformationMenuReference(concept));
      }
      for (      SNode menu : SetSequence.fromSet(menusFound)) {
        menuWasFound=true;
        menuReferences.add(createNamedTransformationMenuReference(menu));
      }
      if (menuReferences.size() == 1 && ((SLinkOperations.getTarget(cell,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,0x10f3514bb7cL,"menuDescriptor")) == null) || Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(SLinkOperations.getTarget(cell,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,0x10f3514bb7cL,"menuDescriptor")),MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x10f34f6aaacL,0x10f34f82910L,"cellMenuPart")),MetaAdapterFactory.getConcept(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x72449b609d0e77bbL,"jetbrains.mps.lang.editor.structure.CellMenuPart_ApplySideTransforms"))).isEmpty())) {
        SNode reference=menuReferences.get(0);
        SLinkOperations.setTarget(cell,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,0x3a52dff8e5ebd740L,"transformationMenu"),reference);
        MapSequence.fromMap(conceptAndTagsToAdditionalMenu).put(key,reference);
        continue;
      }
      SNode additionalMenu=SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x4e0f93d8a0ac4ee8L,"jetbrains.mps.lang.editor.structure.TransformationMenu_Named"));
      SPropertyOperations.set(additionalMenu,MetaAdapterFactory.getProperty(0xceab519525ea4f22L,0x9b92103b95ca8c0cL,0x110396eaaa4L,0x110396ec041L,"name"),SLinkOperations.getTarget(additionalMenu,MetaAdapterFactory.getReferenceLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x169efbc9a9048c53L,0x5b7b4c4d511049b4L,"conceptDeclaration")) + "_ApplySideTransforms");
      SLinkOperations.setTarget(additionalMenu,MetaAdapterFactory.getReferenceLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x169efbc9a9048c53L,0x5b7b4c4d511049b4L,"conceptDeclaration"),concept);
      if (MapSequence.fromMap(conceptToCounter).get(concept) == null) {
        MapSequence.fromMap(conceptToCounter).put(concept,1);
      }
 else {
        SPropertyOperations.set(additionalMenu,MetaAdapterFactory.getProperty(0xceab519525ea4f22L,0x9b92103b95ca8c0cL,0x110396eaaa4L,0x110396ec041L,"name"),SPropertyOperations.getString_def(additionalMenu,MetaAdapterFactory.getProperty(0xceab519525ea4f22L,0x9b92103b95ca8c0cL,0x110396eaaa4L,0x110396ec041L,"name"),"") + "_" + conceptToCounter);
        MapSequence.fromMap(conceptToCounter).put(concept,MapSequence.fromMap(conceptToCounter).get(concept) + 1);
      }
      SNode includeSection=SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x6ec02d9918b4efbcL,"jetbrains.mps.lang.editor.structure.TransformationMenuSection"));
      if (!(menuReferences.isEmpty())) {
        ListSequence.fromList(SLinkOperations.getChildren(includeSection,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x6ec02d9918b4efbcL,0x6ec02d9918b4efbdL,"locations"))).addElement(_quotation_createNode_o8m9jz_a0a0a02a4a0a6());
        for (        SNode menuReference : ListSequence.fromList(menuReferences)) {
          ListSequence.fromList(SLinkOperations.getChildren(includeSection,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x6ec02d9918b4efbcL,0x6ec02d9918b4efbfL,"parts"))).addElement(_quotation_createNode_o8m9jz_a0a0a1a02a4a0a6(menuReference));
        }
      }
 else {
        ListSequence.fromList(SLinkOperations.getChildren(includeSection,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x6ec02d9918b4efbcL,0x6ec02d9918b4efbfL,"parts"))).addElement(_quotation_createNode_o8m9jz_a0a0a0u0e0a0g());
      }
      ListSequence.fromList(SLinkOperations.getChildren(additionalMenu,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x4e0f93d8a0c11832L,0x16be955f384efffcL,"sections"))).addElement(includeSection);
      SNode section=SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x6ec02d9918b4efbcL,"jetbrains.mps.lang.editor.structure.TransformationMenuSection"));
      ListSequence.fromList(SLinkOperations.getChildren(section,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x6ec02d9918b4efbcL,0x6ec02d9918b4efbdL,"locations"))).addElement(_quotation_createNode_o8m9jz_a0a42a4a0a6());
      ListSequence.fromList(SLinkOperations.getChildren(additionalMenu,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x4e0f93d8a0c11832L,0x16be955f384efffcL,"sections"))).addElement(section);
      Iterable<SNode> applySideTransforms=ListSequence.fromList(new ArrayList<SNode>());
      if ((SLinkOperations.getTarget(cell,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,0x10f3514bb7cL,"menuDescriptor")) != null)) {
        applySideTransforms=SNodeOperations.ofConcept(SLinkOperations.getChildren(SLinkOperations.getTarget(cell,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,0x10f3514bb7cL,"menuDescriptor")),MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x10f34f6aaacL,0x10f34f82910L,"cellMenuPart")),MetaAdapterFactory.getConcept(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x72449b609d0e77bbL,"jetbrains.mps.lang.editor.structure.CellMenuPart_ApplySideTransforms"));
        for (        SNode apply : Sequence.fromIterable(applySideTransforms)) {
          String tag=SPropertyOperations.getString_def(apply,MetaAdapterFactory.getProperty(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x72449b609d0e77bbL,0xc14e9fba94cb682L,"tag"),null);
          SNode location=ActionMigrationHelper.createLocation(SPropertyOperations.getString_def(apply,MetaAdapterFactory.getProperty(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x72449b609d0e77bbL,0x72449b609d0f1475L,"side"),null));
          SNode includeMenu=SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xae2d2fe1c9d6be2L,"jetbrains.mps.lang.editor.structure.TransformationMenuPart_IncludeMenu"));
          SLinkOperations.setTarget(includeMenu,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xae2d2fe1c9d6be2L,0x1a0027b1197f7335L,"location"),location);
          if (tag == null || eq_o8m9jz_a0a4a1a72a6a0a6(tag,DEFAULT_TAG_NAME)) {
            menuWasFound=true;
            SLinkOperations.setTarget(includeMenu,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xae2d2fe1c9d6be2L,0x5d3b34577b3f7ee5L,"menuReference"),createDefaultTransformationMenuReference(concept));
            ListSequence.fromList(SLinkOperations.getChildren(section,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x6ec02d9918b4efbcL,0x6ec02d9918b4efbfL,"parts"))).addElement(includeMenu);
          }
 else {
            for (            SNode menu : SetSequence.fromSet(findAllMainNamedMenusForTag(concept,tag))) {
              if (menu != null) {
                menuWasFound=true;
                SNode transformationMenuReference=createNamedTransformationMenuReference(menu);
                if (transformationMenuReference != null) {
                  SLinkOperations.setTarget(includeMenu,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xae2d2fe1c9d6be2L,0x5d3b34577b3f7ee5L,"menuReference"),transformationMenuReference);
                }
              }
            }
          }
          ListSequence.fromList(SLinkOperations.getChildren(section,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x6ec02d9918b4efbcL,0x6ec02d9918b4efbfL,"parts"))).addElement(includeMenu);
        }
      }
      if (menuWasFound) {
        SNodeOperations.getModel(cell).addRootNode(additionalMenu);
        SLinkOperations.setTarget(cell,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,0x3a52dff8e5ebd740L,"transformationMenu"),SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x5d3b34577b3cff09L,"jetbrains.mps.lang.editor.structure.TransformationMenuReference_Named")));
        SLinkOperations.setTarget(SNodeOperations.cast(SLinkOperations.getTarget(cell,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,0x3a52dff8e5ebd740L,"transformationMenu")),MetaAdapterFactory.getConcept(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x5d3b34577b3cff09L,"jetbrains.mps.lang.editor.structure.TransformationMenuReference_Named")),MetaAdapterFactory.getReferenceLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x5d3b34577b3cff09L,0x5d3b34577b3cff0aL,"menu"),additionalMenu);
        MapSequence.fromMap(conceptAndTagsToAdditionalMenu).put(key,SLinkOperations.getTarget(cell,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,0x3a52dff8e5ebd740L,"transformationMenu")));
      }
      for (      SNode styleItem : Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(cell,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x11beb039542L,0x11beb040d06L,"styleItem")),MetaAdapterFactory.getConcept(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0x11abb1e8d85L,"jetbrains.mps.lang.editor.structure.SideTransformAnchorTagStyleClassItem")))) {
        addMigrationAnnotation(styleItem,SLinkOperations.getTarget(cell,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,0x3a52dff8e5ebd740L,"transformationMenu")));
        CommentUtil.commentOut(styleItem);
      }
      for (      SNode apply : Sequence.fromIterable(applySideTransforms)) {
        addMigrationAnnotation(apply,SLinkOperations.getTarget(cell,MetaAdapterFactory.getContainmentLink(0x18bc659203a64e29L,0xa83a7ff23bde13baL,0xf9eafb9a39L,0x3a52dff8e5ebd740L,"transformationMenu")));
        CommentUtil.commentOut(apply);
      }
    }
  }
}
