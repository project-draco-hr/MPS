{
  SNode referentNode;
  String linkRole=myReferenceMacro.getLink().getRole();
  ReferenceMacro_GetReferent function=myReferenceMacro.getReferentFunction();
  if (function != null) {
    SNode templateValue=myTemplateReferentNode.getReferent(linkRole);
    String methodName=TemplateFunctionMethodName.referenceMacro_GetReferent(function.getNode());
    Object[] args_old=new Object[]{getInputNode(),templateValue,myTemplateReferentNode,generator.getSourceModel(),generator,generator.getScope(),generator.getGeneratorSessionContext()};
    Object[] args_new=new Object[]{getInputNode(),myTemplateReferentNode,getOutputNode(),generator};
    try {
      referentNode=(SNode)QueryMethodGenerated.invoke_GetReferent(methodName,args_old,args_new,myReferenceMacro.getModel());
    }
 catch (    Exception e) {
      generator.showErrorMessage(getInputNode(),myReferenceMacro.getNode(),"couldn't evaluate reference macro");
      return;
    }
  }
 else {
    Object[] args=new Object[]{getInputNode(),myTemplateReferentNode,myReferenceMacro.getLink(),generator};
    try {
      referentNode=(SNode)QueryMethod.invoke("referenceMacro_" + myReferenceMacro.getAspectMethodName(),args,myReferenceMacro.getModel());
    }
 catch (    Throwable t) {
      String message=NameUtil.shortNameFromLongName(t.getClass().getName()) + " occured while expanding reference macro with query: \"referenceMacro_" + myReferenceMacro.getAspectMethodName();
      generator.showErrorMessage(getInputNode(),myTemplateReferentNode,message);
      return;
    }
  }
  if (referentNode == null) {
    if (getOutputNode().isReferentRequired(linkRole,generator.getScope())) {
      generator.showErrorMessage(getInputNode(),myTemplateReferentNode,"unresolved reference for role \"" + linkRole + "\" in "+ getOutputNode().getDebugText());
    }
    return;
  }
  getOutputNode().setReferent(linkRole,referentNode);
}
