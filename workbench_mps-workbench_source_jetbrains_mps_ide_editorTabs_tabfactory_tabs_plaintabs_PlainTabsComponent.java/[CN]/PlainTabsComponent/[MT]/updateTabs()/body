{
  if (isDisposed())   return;
  SNodeReference selNode=null;
  RelationDescriptor selRel=null;
  int selected=myTabs.getTabCount() > 0 ? myTabs.getIndexOf(myTabs.getSelectedInfo()) : -1;
  if (selected != -1) {
    selNode=myRealTabs.get(selected).getNode();
    if (selNode == null) {
      selRel=myRealTabs.get(selected).getTab();
    }
  }
  boolean oldRebuilding=myRebuilding;
  myRebuilding=true;
  try {
    myTabs.removeAllTabs();
    myRealTabs.clear();
    ArrayList<RelationDescriptor> tabs=new ArrayList<RelationDescriptor>(myPossibleTabs);
    Collections.sort(tabs,new RelationComparator());
    TabEditorLayout newContent=updateDocumentsAndNodes();
    for (    RelationDescriptor tab : tabs) {
      if (newContent.covers(tab)) {
        for (        Entry tabDescriptor : newContent.get(tab)) {
          final PlainEditorTab pet=new PlainEditorTab(tabDescriptor);
          myRealTabs.add(pet);
          SNode node=pet.getNode().resolve(MPSModuleRepository.getInstance());
          TabInfo info=new TabInfo(new JLabel("")).setIcon(IconManager.getIconFor(node)).setText(node.getPresentation()).setPreferredFocusableComponent(myEditor);
          myTabs.addTab(info);
        }
      }
 else       if (myShowGrayed) {
        myRealTabs.add(new PlainEditorTab(tab));
        TabInfo info=new TabInfo(new JLabel("")).setText(tab.getTitle()).setDefaultForeground(Color.GRAY).setPreferredFocusableComponent(myEditor);
        myTabs.addTab(info);
      }
    }
    updateTabColors();
  }
  finally {
    myRebuilding=oldRebuilding;
  }
  SNode selNodeResolved;
  if (selNode != null && (selNodeResolved=selNode.resolve(MPSModuleRepository.getInstance())) != null) {
    for (    PlainEditorTab tab : myRealTabs) {
      if (EqualUtil.equals(tab.getNode(),selNode)) {
        myTabs.select(myTabs.getTabAt(myRealTabs.indexOf(tab)),true);
        onNodeChange(selNodeResolved);
        break;
      }
    }
  }
 else   if (selRel != null) {
    for (    PlainEditorTab tab : myRealTabs) {
      if (tab.getTab() == selRel) {
        myTabs.select(myTabs.getTabAt(myRealTabs.indexOf(tab)),true);
        break;
      }
    }
  }
 else {
    if (myTabs.getTabCount() > 0) {
      myTabs.select(myTabs.getTabAt(0),true);
      if (selNode != null) {
        onTabIndexChange();
      }
    }
  }
}
