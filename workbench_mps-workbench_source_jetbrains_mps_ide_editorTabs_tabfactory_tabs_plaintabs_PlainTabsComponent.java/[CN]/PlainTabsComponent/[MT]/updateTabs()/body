{
  if (isDisposed()) {
    return;
  }
  SNodeReference selectedNode=null;
  RelationDescriptor selectedAspect=null;
  int selected=myTabs.getTabCount() > 0 ? myTabs.getIndexOf(myTabs.getSelectedInfo()) : -1;
  if (selected != -1) {
    selectedNode=myRealTabs.get(selected).getNode();
    selectedAspect=myRealTabs.get(selected).getTab();
  }
  boolean oldRebuilding=myRebuilding;
  myRebuilding=true;
  try {
    myTabs.removeAllTabs();
    myRealTabs.clear();
    TabEditorLayout newContent=updateDocumentsAndNodes();
    for (    RelationDescriptor tab : myPossibleTabs) {
      if (newContent.covers(tab)) {
        for (        Entry tabDescriptor : newContent.get(tab)) {
          final PlainEditorTab pet=new PlainEditorTab(tabDescriptor);
          myRealTabs.add(pet);
          SNode node=pet.getNode().resolve(getProject().getRepository());
          TabInfo info=new TabInfo(new JLabel("")).setIcon(IconManager.getIconFor(node)).setText(node.getPresentation()).setPreferredFocusableComponent(myEditor);
          myTabs.addTab(info);
        }
      }
 else       if (myShowGrayed) {
        myRealTabs.add(new PlainEditorTab(tab));
        TabInfo info=new TabInfo(new JLabel("")).setText(tab.getTitle()).setDefaultForeground(Color.GRAY).setPreferredFocusableComponent(myEditor);
        myTabs.addTab(info);
      }
    }
    updateTabColors();
  }
  finally {
    myRebuilding=oldRebuilding;
  }
  boolean selectionRestored=false;
  if (selectedNode != null && selectedNode.resolve(getProject().getRepository()) != null) {
    for (    PlainEditorTab tab : myRealTabs) {
      if (EqualUtil.equals(tab.getNode(),selectedNode)) {
        myTabs.select(myTabs.getTabAt(myRealTabs.indexOf(tab)),true);
        selectionRestored=true;
        break;
      }
    }
  }
  if (!selectionRestored && myTabs.getTabCount() > 0) {
    myTabs.select(myTabs.getTabAt(0),true);
    selectionRestored=true;
  }
  if (selectionRestored) {
    onTabIndexChange();
  }
}
