{
  if (myDisposed)   return;
  SNodeReference selNode=null;
  RelationDescriptor selRel=null;
  int selected=myJbTabs.getTabCount() > 0 ? myJbTabs.getSelectedIndex() : -1;
  if (selected != -1) {
    selNode=myRealTabs.get(selected).getNode();
    if (selNode == null) {
      selRel=myRealTabs.get(selected).getTab();
    }
  }
  boolean oldRebuilding=myRebuilding;
  myRebuilding=true;
  try {
    myJbTabs.removeAll();
    myRealTabs.clear();
    ArrayList<RelationDescriptor> tabs=new ArrayList<RelationDescriptor>(myPossibleTabs);
    Collections.sort(tabs,new RelationComparator());
    TabEditorLayout newContent=updateDocumentsAndNodes();
    for (    RelationDescriptor tab : tabs) {
      if (newContent.covers(tab)) {
        for (        Entry tabDescriptor : newContent.get(tab)) {
          final PlainEditorTab pet=new PlainEditorTab(tabDescriptor);
          myRealTabs.add(pet);
          SNode node=pet.getNode().resolve(MPSModuleRepository.getInstance());
          myJbTabs.addTab(node.getPresentation(),IconManager.getIconFor(node),new JLabel(""),"");
          myJbTabs.getTabs().getTabAt(myJbTabs.getTabs().getTabCount() - 1).setPreferredFocusableComponent(myEditor);
        }
      }
 else       if (myShowGrayed) {
        myRealTabs.add(new PlainEditorTab(tab));
        myJbTabs.addTab(tab.getTitle(),new JLabel(""));
        myJbTabs.getTabs().getTabAt(myJbTabs.getTabs().getTabCount() - 1).setPreferredFocusableComponent(myEditor);
        myJbTabs.setForegroundAt(myJbTabs.getTabCount() - 1,Color.GRAY);
      }
    }
    updateTabColors();
  }
  finally {
    myRebuilding=oldRebuilding;
  }
  if (selNode != null && selNode.resolve(MPSModuleRepository.getInstance()) != null) {
    for (    PlainEditorTab tab : myRealTabs) {
      if (EqualUtil.equals(tab.getNode(),selNode)) {
        myJbTabs.setSelectedIndex(myRealTabs.indexOf(tab));
        break;
      }
    }
  }
 else   if (selRel != null) {
    for (    PlainEditorTab tab : myRealTabs) {
      if (tab.getTab() == selRel) {
        myJbTabs.setSelectedIndex(myRealTabs.indexOf(tab));
        break;
      }
    }
  }
 else {
    if (myJbTabs.getTabCount() > 0) {
      myJbTabs.setSelectedIndex(0);
      if (selNode != null) {
        onTabIndexChange();
      }
    }
  }
}
