{
  String currentTestName=myBuildServerMessageFormat.escapeBuildMessage(new StringBuffer(cycle.toString())).toString();
  System.out.println(myBuildServerMessageFormat.formatTestStart(currentTestName));
  cycle.generate(gm,myGenerationType,myMessageHandler);
  List<String> diffReports;
  if (Boolean.parseBoolean(myWhatToDo.getProperty(TestGenerationOnTeamcity.SHOW_DIFF))) {
    diffReports=ModelAccess.instance().runReadAction(new Computable<List<String>>(){
      public List<String> compute(){
        return DiffReporter.createDiffReports(myGenerationType);
      }
    }
);
  }
 else {
    diffReports=new ArrayList<String>();
  }
  final List<SModel> outputModels=new ArrayList<SModel>();
  outputModels.addAll(myGenerationType.getOutputModels());
  List<CompilationResult> compilationResult;
  if (Boolean.parseBoolean(myWhatToDo.getProperty(GenerateTask.COMPILE))) {
    compilationResult=ModelAccess.instance().runReadAction(new Computable<List<CompilationResult>>(){
      public List<CompilationResult> compute(){
        return myGenerationType.compile(IAdaptiveProgressMonitor.NULL_PROGRESS_MONITOR);
      }
    }
);
  }
 else {
    compilationResult=Collections.EMPTY_LIST;
  }
  StringBuffer sb=createDetailedReport(compilationResult,Collections.<TestFailure>emptyList(),diffReports);
  myMessageHandler.clean();
  if (sb.length() > 0) {
    myTestFailed=true;
    System.out.append(myBuildServerMessageFormat.formatTestFailure(currentTestName,"Generation Errors",sb));
    System.out.println("");
  }
  System.out.println(myBuildServerMessageFormat.formatTestFinish(currentTestName));
  if (invokeTests()) {
    final TestResult testResult=new TestResult();
    testResult.addListener(new TestListener(){
      @Override public void addError(      Test test,      Throwable t){
        System.out.println(myBuildServerMessageFormat.formatTestFailure(myBuildServerMessageFormat.escapeBuildMessage(test + ""),myBuildServerMessageFormat.escapeBuildMessage(t.getMessage()),myBuildServerMessageFormat.escapeBuildMessage(MpsWorker.extractStackTrace(t))));
      }
      @Override public void addFailure(      Test test,      AssertionFailedError t){
        System.out.println(myBuildServerMessageFormat.formatTestFailure(myBuildServerMessageFormat.escapeBuildMessage(test + ""),myBuildServerMessageFormat.escapeBuildMessage(t.getMessage()),myBuildServerMessageFormat.escapeBuildMessage(MpsWorker.extractStackTrace(t))));
      }
      @Override public void endTest(      Test test){
        System.out.println(myBuildServerMessageFormat.formatTestFinish(myBuildServerMessageFormat.escapeBuildMessage(test + "")));
      }
      @Override public void startTest(      Test test){
        System.out.println(myBuildServerMessageFormat.formatTestStart(myBuildServerMessageFormat.escapeBuildMessage(test + "")));
      }
    }
);
    ProjectTester.invokeTests(myGenerationType,outputModels,testResult);
  }
  myGenerationType.clean();
}
