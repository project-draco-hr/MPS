{
  final SNodeReference nodeRef=node.getReference();
  List<TracerNode> rootTracerNodes=getRootsOfInputModel(nodeRef.getModelReference());
  List<TracerNode> tracerNodes=new ArrayList<TracerNode>();
  for (  TracerNode rootTracerNode : rootTracerNodes) {
    rootTracerNode.findAllTopmost(Kind.INPUT,nodeRef,tracerNodes);
  }
  if (!tracerNodes.isEmpty()) {
    TracerNode resultTracerNode=new TracerNode(tracerNodes.get(0));
    for (    TracerNode tracerNode : tracerNodes) {
      List<TracerNode> childrensCopy=tracerNode.getChildrenCopy();
      for (      TracerNode childCopy : childrensCopy) {
        resultTracerNode.addChild(childCopy);
      }
    }
    return resultTracerNode;
  }
  List<TemplateMappingScript> mappingScripts=myModelsProcessedByScripts.getScriptsForInput(node.getModel());
  if (mappingScripts == null)   return null;
  SModelReference reference=myModelsProcessedByScripts.getOutputForInput(node.getModel());
  if (reference == null)   return null;
  SModel outputModel=SModelRepository.getInstance().getModelDescriptor(reference);
  if (outputModel == null)   return null;
  SNode inputNode=node;
  SNode outputNode=null;
  while (inputNode != null) {
    outputNode=outputModel.getNode(inputNode.getNodeId());
    if (outputNode != null)     break;
    inputNode=inputNode.getParent();
  }
  TracerNode inputTracerNode=new TracerNode(Kind.INPUT,new jetbrains.mps.smodel.SNodePointer(node));
  TracerNode tracerNode=inputTracerNode;
  for (  TemplateMappingScript mappingScript : mappingScripts) {
    TracerNode childTracerNode=new TracerNode(Kind.MAPPING_SCRIPT,mappingScript.getScriptNode());
    tracerNode.addChild(childTracerNode);
    tracerNode=childTracerNode;
  }
  if (outputNode != null) {
    if (inputNode == node) {
      tracerNode.addChild(new TracerNode(Kind.OUTPUT,new jetbrains.mps.smodel.SNodePointer(outputNode)));
    }
 else {
      tracerNode.addChild(new TracerNode(Kind.APPROXIMATE_OUTPUT,new jetbrains.mps.smodel.SNodePointer(outputNode)));
    }
  }
  return inputTracerNode;
}
