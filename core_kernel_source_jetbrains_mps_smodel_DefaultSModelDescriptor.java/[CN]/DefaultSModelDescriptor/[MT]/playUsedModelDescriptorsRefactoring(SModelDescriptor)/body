{
  int currentVersion=modelDescriptor.getVersion();
  int usedVersion=mySModel.getUsedVersion(modelDescriptor.getSModelReference());
  if (myIsTestRefactoringMode) {
    System.err.println(this + ": current version of used model " + modelDescriptor.getLongName()+ " is "+ currentVersion+ ", used version is "+ usedVersion);
  }
  if (currentVersion > usedVersion) {
    if (myIsTestRefactoringMode) {
      System.err.println("updating a model " + this);
    }
    SModel importedModel=modelDescriptor.getSModel();
    RefactoringHistory refactoringHistory=importedModel.getRefactoringHistory();
    for (    RefactoringContext refactoringContext : refactoringHistory.getRefactoringContexts()) {
      if (refactoringContext.getModelVersion() <= usedVersion)       continue;
      refactoringContext.getRefactoring().updateModel(mySModel,refactoringContext);
    }
    mySModel.updateImportedModelUsedVersion(modelDescriptor.getSModelReference(),currentVersion);
    SModelRepository.getInstance().markChanged(mySModel);
  }
  if (currentVersion < usedVersion) {
    if (currentVersion == -1) {
      int maxVersion=-1;
      for (      RefactoringContext context : modelDescriptor.getSModel().getRefactoringHistory().getRefactoringContexts()) {
        maxVersion=Math.max(maxVersion,context.getModelVersion());
      }
      if (maxVersion != -1) {
        modelDescriptor.setVersion(maxVersion);
        currentVersion=maxVersion;
      }
      if (currentVersion == usedVersion) {
        return;
      }
    }
    LOG.error("Model version mismatch for import " + modelDescriptor.getSModelFqName() + " in model "+ getSModelFqName());
    LOG.error("Used version = " + usedVersion + ", current version = "+ currentVersion);
    mySModel.updateImportedModelUsedVersion(modelDescriptor.getSModelReference(),currentVersion);
    SModelRepository.getInstance().markChanged(mySModel);
    LOG.error("Mismatch fixed");
  }
}
