{
  if (!isProjectOpened(project))   return true;
  if (!canClose(project))   return false;
  final ShutDownTracker shutDownTracker=ShutDownTracker.getInstance();
  shutDownTracker.registerStopperThread(Thread.currentThread());
  try {
    if (save) {
      Application application=ApplicationManager.getApplication();
      if (application instanceof ApplicationImpl) {
        ((ApplicationImpl)application).saveAllDocumentsIfNeeded();
      }
 else {
        FileDocumentManager.getInstance().saveAllDocuments();
      }
      project.save();
    }
    fireProjectClosing(project);
    myOpenProjects.remove(project);
    myChangedProjectFiles.remove(project);
    fireProjectClosed(project);
  }
  finally {
    shutDownTracker.unregisterStopperThread(Thread.currentThread());
  }
  return true;
}
