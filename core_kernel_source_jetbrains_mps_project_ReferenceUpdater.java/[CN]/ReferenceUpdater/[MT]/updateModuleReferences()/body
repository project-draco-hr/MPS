{
  ModelAccess.assertLegalWrite();
  for (  IModule m : MPSModuleRepository.getInstance().getAllModules()) {
    final AbstractModule module=(AbstractModule)m;
    boolean needSaving=false;
    if (module.updateSModelReferences()) {
      needSaving=true;
    }
    if (module.updateModuleReferences()) {
      needSaving=true;
    }
    if (needSaving && !module.isPackaged()) {
      ModelAccess.instance().runWriteInEDT(new Runnable(){
        @Override public void run(){
          module.save();
        }
      }
);
    }
  }
}
