{
  ModelAccess.assertLegalWrite();
  final SModel oldSModel=getCurrentModelInternal();
  if (oldSModel != null) {
    ((jetbrains.mps.smodel.SModelInternal)oldSModel).setModelDescriptor(null);
  }
  replacer.run();
  SModel newModel=getCurrentModelInternal();
  if (newModel != null) {
    ((jetbrains.mps.smodel.SModelInternal)newModel).setModelDescriptor(this);
  }
  notifyModelReplaced(oldSModel);
  MPSModuleRepository.getInstance().invalidateCaches();
}
