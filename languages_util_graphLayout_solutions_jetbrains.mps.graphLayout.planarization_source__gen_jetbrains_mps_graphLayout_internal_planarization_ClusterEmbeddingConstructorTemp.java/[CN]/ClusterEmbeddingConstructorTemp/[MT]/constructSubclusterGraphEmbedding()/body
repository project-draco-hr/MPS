{
  mySubclustersGraph=new Graph();
  Map<Node,Node> nodeMap=MapSequence.<Node,Node>fromMap(new HashMap<Node,Node>());
  mySubclustersMap=MapSequence.<INode,Node>fromMap(new HashMap<INode,Node>());
  List<Node> subclusters=myGraph.getSubclusters(myCluster);
  for (  Node subcluster : ListSequence.<Node>fromList(subclusters)) {
    Node clusterNode=mySubclustersGraph.createNode();
    for (    Node node : myGraph.getNodesInCluster(subcluster)) {
      MapSequence.<Node,Node>fromMap(nodeMap).put(node,clusterNode);
    }
    MapSequence.<INode,Node>fromMap(mySubclustersMap).put(subcluster,clusterNode);
  }
  Map<Edge,Edge> invEdgeMap=MapSequence.<Edge,Edge>fromMap(new HashMap<Edge,Edge>());
  for (  Node source : SetSequence.<Node>fromSet(myClusterNodes)) {
    for (    Edge edge : source.getOutEdges()) {
      Node target=edge.getTarget();
      if (SetSequence.<Node>fromSet(myClusterNodes).contains(target) && MapSequence.<Node,Node>fromMap(nodeMap).get(source) != MapSequence.<Node,Node>fromMap(nodeMap).get(target)) {
        Edge newEdge=mySubclustersGraph.connect(MapSequence.<Node,Node>fromMap(nodeMap).get(source),MapSequence.<Node,Node>fromMap(nodeMap).get(target));
        MapSequence.<Edge,Edge>fromMap(invEdgeMap).put(newEdge,edge);
      }
    }
  }
  Set<Edge> connectingEdges=ConnectivityComponents.makeConnected(mySubclustersGraph);
  for (  Edge edge : SetSequence.<Edge>fromSet(connectingEdges)) {
    Node source=this.getRealNode(edge.getSource(),nodeMap);
    Node target=getRealNode(edge.getTarget(),nodeMap);
    Edge realEdge=myGraph.connect(source,target);
    MapSequence.<Edge,Edge>fromMap(invEdgeMap).put(edge,realEdge);
  }
  GroupedGraphModificationSynchronizer synchronizer=new GroupedGraphModificationSynchronizer(mySubclustersGraph,myGraph,invEdgeMap);
  mySubEmbeddedGraph=EmbeddingFinderFactory.getFinder().find(mySubclustersGraph);
  if (ListSequence.<Edge>fromList(myOuterEdgesOrder).count() > 0) {
    mySubclustersGraph.removeListener(synchronizer);
    List<Edge> subClusterBorder=ListSequence.<Edge>fromList(new ArrayList<Edge>(ListSequence.<Edge>fromList(myOuterEdgesOrder).count()));
    mySubClusterBorder=ListSequence.<Edge>fromList(new ArrayList<Edge>(ListSequence.<Edge>fromList(myOuterEdgesOrder).count()));
    List<Edge> subOuterEdges=ListSequence.<Edge>fromList(new ArrayList<Edge>(ListSequence.<Edge>fromList(myOuterEdgesOrder).count()));
    List<Node> realBorderNodes=ListSequence.<Node>fromList(new ArrayList<Node>(ListSequence.<Edge>fromList(myOuterEdgesOrder).count()));
    List<Node> subBorderNodes=ListSequence.<Node>fromList(new ArrayList<Node>(ListSequence.<Edge>fromList(myOuterEdgesOrder).count()));
    for (    Edge outerEdge : ListSequence.<Edge>fromList(myOuterEdgesOrder)) {
      final Node realClusterNode=getClusterNode(outerEdge);
      boolean isSource=realClusterNode == outerEdge.getSource();
      Node subBorderNode=mySubclustersGraph.createNode();
      ListSequence.<Node>fromList(subBorderNodes).addElement(subBorderNode);
      Edge subOuterEdge;
      if (isSource) {
        subOuterEdge=mySubclustersGraph.connect(MapSequence.<Node,Node>fromMap(nodeMap).get(realClusterNode),subBorderNode);
      }
 else {
        subOuterEdge=mySubclustersGraph.connect(subBorderNode,MapSequence.<Node,Node>fromMap(nodeMap).get(realClusterNode));
      }
      MapSequence.<Edge,Edge>fromMap(invEdgeMap).put(subOuterEdge,outerEdge);
      ListSequence.<Edge>fromList(subOuterEdges).addElement(subOuterEdge);
    }
    Face outerFace=new Face(mySubclustersGraph);
    for (int i=0; i < ListSequence.<Edge>fromList(myOuterEdgesOrder).count(); i++) {
      int next=i + 1;
      if (next == ListSequence.<Edge>fromList(myOuterEdgesOrder).count()) {
        next=0;
      }
      Edge subBorderEdge=mySubclustersGraph.connect(ListSequence.<Node>fromList(subBorderNodes).getElement(i),ListSequence.<Node>fromList(subBorderNodes).getElement(next));
      ListSequence.<Edge>fromList(subClusterBorder).addElement(subBorderEdge);
      ListSequence.<Edge>fromList(mySubClusterBorder).addElement(subBorderEdge);
      outerFace.addLast(new Dart(subBorderEdge,ListSequence.<Node>fromList(subBorderNodes).getElement(next)));
    }
    Node borderFirstNode=ListSequence.<Node>fromList(subBorderNodes).first();
    Edge bridge=ListSequence.<Edge>fromList(subOuterEdges).first();
    Node clusterFirstNode=bridge.getOpposite(borderFirstNode);
    Face clusterOuterFace=mySubEmbeddedGraph.findContainingFace(ListSequence.<Node>fromListAndArray(new ArrayList<Node>(),clusterFirstNode));
    Face ringFace=new Face(mySubclustersGraph);
    ringFace.addLast(new Dart(bridge,clusterFirstNode));
    for (    Edge edge : ListSequence.<Edge>fromList(subClusterBorder)) {
      ringFace.addLast(new Dart(edge,edge.getSource()));
    }
    ringFace.addLast(new Dart(bridge,borderFirstNode));
    for (    Dart dart : ListSequence.<Dart>fromList(clusterOuterFace.getDarts())) {
      ringFace.addLast(dart);
    }
    mySubEmbeddedGraph.removeFace(clusterOuterFace);
    mySubEmbeddedGraph.addFace(ringFace);
    mySubEmbeddedGraph.addFace(outerFace);
    mySubEmbeddedGraph.setOuterFace(outerFace);
    if (ClusterEmbeddingConstructorTemp.debugMode > 0) {
      CheckEmbeddedGraph.checkEmbeddedGraph(mySubEmbeddedGraph,false);
    }
    synchronizer=new GroupedGraphModificationSynchronizer(mySubclustersGraph,myGraph,invEdgeMap);
    for (    Edge edge : ListSequence.<Edge>fromList(subOuterEdges)) {
      if (edge == ListSequence.<Edge>fromList(subOuterEdges).first()) {
        continue;
      }
      mySubclustersGraph.removeEdge(edge);
      ShortestPathEmbeddingFinder.restoreEdge(mySubEmbeddedGraph,edge,true);
    }
  }
  myNodeMap=nodeMap;
  return invEdgeMap;
}
