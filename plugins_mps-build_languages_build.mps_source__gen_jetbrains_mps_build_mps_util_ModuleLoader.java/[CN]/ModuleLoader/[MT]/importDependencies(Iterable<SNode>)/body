{
  SNode module=SNodeOperations.cast(myModule,"jetbrains.mps.build.mps.structure.BuildMps_Module");
  Iterable<Dependency> dependencies=myModuleDescriptor.getDependencies();
  if (myModuleDescriptor instanceof LanguageDescriptor) {
    Iterable<GeneratorDescriptor> generators=((LanguageDescriptor)myModuleDescriptor).getGenerators();
    dependencies=Sequence.fromIterable(dependencies).union(Sequence.fromIterable(generators).translate(new ITranslator2<GeneratorDescriptor,Dependency>(){
      public Iterable<Dependency> translate(      GeneratorDescriptor it){
        return it.getDependencies();
      }
    }
));
  }
  Map<SNode,SNode> seen=new HashMap<SNode,SNode>();
  for (  Dependency dep : dependencies) {
    boolean reexport=dep.isReexport();
    ModuleReference moduleRef=dep.getModuleRef();
    SNode resolved;
    String targetName=moduleRef.getModuleFqName();
    int sharpIndex=targetName.indexOf("#");
    if (sharpIndex >= 0) {
      resolved=SNodeOperations.as(visible.resolve(targetName.substring(0,sharpIndex),null),"jetbrains.mps.build.mps.structure.BuildMps_Module");
      if (resolved == null) {
        report("cannot resolve reference on generator's containing language by module name: " + targetName,myOriginalModule);
        continue;
      }
    }
 else {
      resolved=SNodeOperations.as(visible.resolve(targetName,moduleRef.getModuleId().toString()),"jetbrains.mps.build.mps.structure.BuildMps_Module");
      if (resolved == null) {
        report("unsatisfied dependency: " + dep.getModuleRef().toString(),myOriginalModule);
        continue;
      }
    }
    SNode prev=seen.get(resolved);
    if (prev != null) {
      if (reexport) {
        SPropertyOperations.set(prev,"reexport","" + (true));
      }
      continue;
    }
    SNode res=SConceptOperations.createNewNode("jetbrains.mps.build.mps.structure.BuildMps_ModuleDependencyOnModule",null);
    seen.put(resolved,res);
    SLinkOperations.setTarget(res,"module",resolved,false);
    SPropertyOperations.set(res,"reexport","" + (reexport));
    SNode extr=SConceptOperations.createNewNode("jetbrains.mps.build.mps.structure.BuildMps_ExtractedModuleDependency",null);
    SLinkOperations.setTarget(extr,"dependency",res,true);
    ListSequence.fromList(SLinkOperations.getTargets(module,"dependencies",true)).addElement(extr);
  }
  for (  String path : myModuleDescriptor.getAdditionalJavaStubPaths()) {
    final SNode p=ListSequence.fromList(convertPath(path,myOriginalModule)).first();
    if (p == null) {
      continue;
    }
    if (path.endsWith(".jar")) {
      SNode jar=SConceptOperations.createNewNode("jetbrains.mps.build.mps.structure.BuildMps_ModuleDependencyJar",null);
      SLinkOperations.setTarget(jar,"path",p,true);
      SNode oldJarRef=Sequence.fromIterable(previous).where(new IWhereFilter<SNode>(){
        public boolean accept(        SNode it){
          return SNodeOperations.isInstanceOf(it,"jetbrains.mps.build.mps.structure.BuildMps_ModuleDependencyJar") && eq_a6ewnz_a0a0a0a0a0a0a0c0d0j0z(BehaviorReflection.invokeVirtual(String.class,SLinkOperations.getTarget(SNodeOperations.cast(it,"jetbrains.mps.build.mps.structure.BuildMps_ModuleDependencyJar"),"path",true),"virtual_getRelativePath_5481553824944787371",new Object[]{}),BehaviorReflection.invokeVirtual(String.class,p,"virtual_getRelativePath_5481553824944787371",new Object[]{}));
        }
      }
).select(new ISelector<SNode,SNode>(){
        public SNode select(        SNode it){
          return SLinkOperations.getTarget(SNodeOperations.cast(it,"jetbrains.mps.build.mps.structure.BuildMps_ModuleDependencyJar"),"customLocation",true);
        }
      }
).first();
      if (oldJarRef != null) {
        SLinkOperations.setTarget(jar,"customLocation",SConceptOperations.createNewNode("jetbrains.mps.build.structure.BuildSource_JavaExternalJarRef",null),true);
        SLinkOperations.setTarget(SLinkOperations.getTarget(jar,"customLocation",true),"jar",SLinkOperations.getTarget(oldJarRef,"jar",false),false);
      }
      SNode extr=SConceptOperations.createNewNode("jetbrains.mps.build.mps.structure.BuildMps_ExtractedModuleDependency",null);
      SLinkOperations.setTarget(extr,"dependency",jar,true);
      ListSequence.fromList(SLinkOperations.getTargets(module,"dependencies",true)).addElement(extr);
    }
 else {
      report("only jar stub libraries are supported, found: " + path,myOriginalModule);
    }
  }
}
