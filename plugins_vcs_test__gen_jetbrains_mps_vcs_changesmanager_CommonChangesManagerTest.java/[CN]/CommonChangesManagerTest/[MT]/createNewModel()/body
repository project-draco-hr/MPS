{
  final Wrappers._T<CurrentDifference> newModelDiff=new Wrappers._T<CurrentDifference>();
  ModelAccess.instance().runReadAction(new Runnable(){
    public void run(){
      String modelName="newmodel";
      IModule module=myUiDiff.getModelDescriptor().getModule();
      module.createModel(SModelFqName.fromString(MODEL_PREFIX + modelName),module.getSModelRoots().get(0),null);
      newModelDiff.value=getCurrentDifference(modelName);
    }
  }
);
  final EditableSModelDescriptor md=newModelDiff.value.getModelDescriptor();
  ModelAccess.instance().runWriteInEDT(new Runnable(){
    public void run(){
      md.getSModel();
      md.save();
    }
  }
);
  ModelAccess.instance().flushEventQueue();
  VirtualFile vf=VirtualFileUtils.getVirtualFile(md.getModelFile());
  VcsDirtyScopeManager.getInstance(myIdeaProject).fileDirty(vf);
  myChangeListManager.ensureUpToDate(false);
  FileStatusManager.getInstance(myIdeaProject).fileStatusChanged(vf);
  newModelDiff.value.setEnabled(true);
  waitForChangesManager();
  Assert.assertTrue((int)ListSequence.fromList(newModelDiff.value.getChangeSet().getModelChanges()).count() == 0);
  checkRootStatuses();
  runCommandAndWait(new Runnable(){
    public void run(){
      SModel m=md.getSModel();
      m.addLanguage(ModuleReference.fromString("f3061a53-9226-4cc5-a443-f952ceaf5816(jetbrains.mps.baseLanguage)"));
      createNewRoot(m);
    }
  }
);
  checkOneAddedRoot(newModelDiff.value);
  MapSequence.fromMap(myExpectedFileStatuses).put("newmodel.NewRoot",FileStatus.UNKNOWN);
  checkRootStatuses();
  myChangeListManager.addUnversionedFiles(myChangeListManager.getDefaultChangeList(),Arrays.asList(vf));
  myChangeListManager.ensureUpToDate(false);
  checkOneAddedRoot(newModelDiff.value);
  MapSequence.fromMap(myExpectedFileStatuses).put("newmodel.NewRoot",FileStatus.ADDED);
  checkRootStatuses();
}
