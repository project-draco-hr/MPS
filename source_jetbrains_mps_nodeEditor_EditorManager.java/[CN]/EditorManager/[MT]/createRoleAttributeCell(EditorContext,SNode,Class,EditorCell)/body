{
  Stack<EditorCell> stack=myAttributedClassesToAttributedCellStacksMap.get(attributeClass);
  if (stack == null) {
    stack=new Stack<EditorCell>();
    myAttributedClassesToAttributedCellStacksMap.put(attributeClass,stack);
  }
  stack.push(cellWithRole);
  EditorCell result=createEditorCell(context,null,ReferencedNodeContext.createNodeContext(roleAttribute));
  EditorCell cellWithRolePopped=stack.pop();
  LOG.assertLog(cellWithRolePopped == cellWithRole);
  AnnotationLinkDeclaration linkDeclaration=SModelUtil.findAnnotationLinkDeclaration(roleAttribute,context.getOperationContext().getScope());
  if (linkDeclaration != null) {
    DefaultAttributeSubstituteInfo substituteInfo=new DefaultAttributeSubstituteInfo(cellWithRole.getSNode(),roleAttribute,linkDeclaration,context);
    result.setSubstituteInfo(substituteInfo);
    if (result instanceof EditorCell_Collection) {
      if (((EditorCell_Collection)result).containsCell(cellWithRole)) {
        for (        EditorCell cell : ((EditorCell_Collection)result).contentCells()) {
          if (cell != cellWithRole && cell.getSubstituteInfo() == null) {
            cell.setSubstituteInfo(substituteInfo);
          }
        }
      }
    }
  }
  return result;
}
