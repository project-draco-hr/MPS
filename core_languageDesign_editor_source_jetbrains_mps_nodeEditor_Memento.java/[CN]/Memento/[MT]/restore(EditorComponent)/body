{
  boolean needsRelayout=false;
  editor.flushEvents();
  if (mySelectedCellInfo != null) {
    EditorCell cellToSelect=mySelectedCellInfo.findClosestCell(editor);
    editor.changeSelection(cellToSelect);
  }
  editor.setSelectedStackFromMemento(mySelectedStack);
  for (  CellInfo collectionInfo : myCollectionsWithEnabledBraces) {
    EditorCell collection=collectionInfo.findCell(editor);
    if (!(collection instanceof EditorCell_Collection))     continue;
    if (((EditorCell_Collection)collection).usesBraces()) {
      ((EditorCell_Collection)collection).enableBraces();
    }
  }
  for (  CellInfo collectionInfo : myFolded) {
    needsRelayout=true;
    EditorCell collection=collectionInfo.findCell(editor);
    if (!(collection instanceof EditorCell_Collection))     continue;
    ((EditorCell_Collection)collection).fold(true);
  }
  needsRelayout=restoreErrors(editor) || needsRelayout;
  EditorCell deepestSelectedCell=editor.getDeepestSelectedCell();
  if (deepestSelectedCell != null && myCaretX != null) {
    deepestSelectedCell.setCaretX(myCaretX);
    if (mySelectionStart != null && deepestSelectedCell instanceof EditorCell_Label && mySelectedCellInfo.equals(deepestSelectedCell.getCellInfo())) {
      ((EditorCell_Label)deepestSelectedCell).setSelectionStart(mySelectionStart);
      ((EditorCell_Label)deepestSelectedCell).setSelectionEnd(mySelectionEnd);
    }
  }
  if (myFirstRangeSelectionNode != null && editor.findNodeCell(myFirstRangeSelectionNode) != null && editor.findNodeCell(myLastRangeSelectionNode) != null && myFirstRangeSelectionNode.getParent() == myLastRangeSelectionNode.getParent()) {
    editor.getNodeRangeSelection().setRange(myFirstRangeSelectionNode,myLastRangeSelectionNode);
  }
  if (needsRelayout) {
    editor.relayout();
  }
}
