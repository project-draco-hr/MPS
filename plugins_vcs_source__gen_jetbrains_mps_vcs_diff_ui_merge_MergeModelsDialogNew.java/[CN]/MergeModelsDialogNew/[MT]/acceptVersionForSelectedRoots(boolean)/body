{
  final List<ModelChange> changesToApply=ListSequence.fromList(new ArrayList<ModelChange>());
  final List<ModelChange> changesToExclude=ListSequence.fromList(new ArrayList<ModelChange>());
  for (  DiffModelTree.RootTreeNode rtn : Sequence.fromIterable(Sequence.fromArray(myMergeTree.getSelectedNodes(DiffModelTree.RootTreeNode.class,null)))) {
    SNodeId root=rtn.getRootId();
    List<ModelChange> changes=(root == null ? myMergeSession.getMetadataChanges() : myMergeSession.getChangesForRoot(root));
    for (    ModelChange change : ListSequence.fromList(changes)) {
      if (!(myMergeSession.isChangeResolved(change))) {
        if (mine == myMergeSession.isMyChange(change)) {
          ListSequence.fromList(changesToApply).addElement(change);
          if (root == null) {
            SetSequence.fromSet(myAppliedMetadataChanges).addElement(change);
          }
        }
 else {
          ListSequence.fromList(changesToExclude).addElement(change);
        }
      }
    }
  }
  ModelAccess.instance().runWriteActionInCommand(new Runnable(){
    public void run(){
      myMergeSession.applyChanges(changesToApply);
      myMergeSession.excludeChanges(changesToExclude);
      myMergeTree.rebuildNow();
    }
  }
);
}
