{
  IModelPersistence modelPersistence=getPersistence(persistenceVersion);
  if (modelPersistence == null) {
    throw new IllegalArgumentException(String.format("Unknown persistence version %d",persistenceVersion));
  }
  IModelWriter writer=modelPersistence.getModelWriter(model instanceof DefaultSModel ? ((DefaultSModel)model).getSModelHeader() : null);
  if (writer == null) {
    throw new IllegalArgumentException(String.format("Persistence has no writer. Version %d",persistenceVersion));
  }
  return writer.saveModel(model);
}
