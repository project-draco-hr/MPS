{
  IModelPersistence modelPersistence=getPersistence(persistenceVersion);
  if (modelPersistence == null) {
    throw new IllegalArgumentException(String.format("Unknown persistence version %d",persistenceVersion));
  }
  SModelBase md=model.getModelDescriptor();
  String location=md == null ? null : md.getSource().getLocation();
  ModelPersistence.checkV8(persistenceVersion,model.getReference(),location);
  if (persistenceVersion < 9) {
    model.getImplicitImportsSupport().calculateImplicitImports();
  }
  IModelWriter modelWriter=modelPersistence.getModelWriter(model instanceof DefaultSModel ? ((DefaultSModel)model).getSModelHeader() : null);
  if (modelWriter == null) {
    throw new IllegalArgumentException(String.format("Unknown persistence version %d",persistenceVersion));
  }
  return modelWriter.saveModel(model);
}
