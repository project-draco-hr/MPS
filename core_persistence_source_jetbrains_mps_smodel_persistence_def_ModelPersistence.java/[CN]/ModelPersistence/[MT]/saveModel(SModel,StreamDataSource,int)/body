{
  LOG.debug("Saving model " + model.getReference() + " to "+ source.getLocation());
  persistenceVersion=actualPersistenceVersion(persistenceVersion);
  if (source.isReadOnly()) {
    throw new IOException("`" + source.getLocation() + "' is read-only");
  }
  int oldVersion=persistenceVersion;
  if (model.getModelDescriptor() instanceof PersistenceVersionAware) {
    PersistenceVersionAware modelWithPersistenceVer=(PersistenceVersionAware)model.getModelDescriptor();
    oldVersion=modelWithPersistenceVer.getPersistenceVersion();
    if (oldVersion != persistenceVersion) {
      modelWithPersistenceVer.setPersistenceVersion(persistenceVersion);
    }
  }
  Document document=modelToXml(model,persistenceVersion);
  JDOMUtil.writeDocument(document,source);
  if (oldVersion != persistenceVersion) {
    LOG.info("persistence upgraded: " + oldVersion + "->"+ persistenceVersion+ " "+ model.getReference());
    return (DefaultSModel)model;
  }
  return null;
}
