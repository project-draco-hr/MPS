{
  int ver=header.getPersistenceVersion();
  if (ver < 0) {
    throw new ModelReadException("Couldn't read model because of unknown persistence version",null);
  }
  IModelPersistence mp=getPersistence(ver);
  if (mp == null) {
    String m="Can not find appropriate persistence version for model %s\n Use newer version of JetBrains MPS to load this model.";
    throw new PersistenceVersionNotFoundException(String.format(m,header.getModelReference()));
  }
  XMLSAXHandler<ModelLoadResult> handler=mp.getModelReaderHandler(state,header);
  if (handler == null) {
    String m="Can not find appropriate persistence version for model %s\n Use newer version of JetBrains MPS to load this model.";
    throw new PersistenceVersionNotFoundException(String.format(m,header.getModelReference()));
  }
  try {
    parseAndHandleExceptions(source,handler);
    return handler.getResult();
  }
 catch (  Exception ex) {
    Throwable th=ex.getCause() == null ? ex : ex.getCause();
    final String causeText=th.getMessage() == null ? th.getClass().getSimpleName() : th.getMessage();
    throw new ModelReadException(String.format("Failed to load model: %s",causeText),th,header);
  }
}
