{
  LOG.debug("Save model " + model.getSModelReference() + " to file "+ file.getPath());
  if (file.isReadOnly()) {
    LOG.error("Can't write to " + file.getPath());
    return null;
  }
  int oldVersion=model.getPersistenceVersion();
  if (oldVersion != persistenceVersion) {
    model.setPersistenceVersion(persistenceVersion);
  }
  SModelDescriptor modelDescriptor=model.getModelDescriptor();
  if (modelDescriptor instanceof DefaultSModelDescriptor) {
    DefaultSModelDescriptor md=(DefaultSModelDescriptor)modelDescriptor;
    Map<String,String> metadata=md.getMetaData();
    SModelHeader header=model.getSModelHeader();
    if (persistenceVersion < 7 && (header.getVersion() != -1 || header.isDoNotGenerate())) {
      metadata=new HashMap<String,String>(metadata);
      if (header.getVersion() != -1) {
        metadata.put(SModelHeader.VERSION,Integer.toString(header.getVersion()));
      }
      if (header.isDoNotGenerate()) {
        metadata.put(SModelHeader.DO_NOT_GENERATE,"true");
      }
    }
    saveMetadata(md.getSource().getFile(),metadata);
  }
  Document document=saveModel(model);
  try {
    JDOMUtil.writeDocument(document,file);
  }
 catch (  IOException e) {
    LOG.error("Error in file " + file,e);
  }
  if (oldVersion != persistenceVersion) {
    LOG.info("persistence upgraded: " + oldVersion + "->"+ persistenceVersion+ " "+ model.getSModelReference());
    return model;
  }
  return null;
}
