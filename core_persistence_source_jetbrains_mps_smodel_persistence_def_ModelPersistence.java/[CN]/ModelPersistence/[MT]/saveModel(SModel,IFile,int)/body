{
  LOG.debug("Save model " + model.getSModelReference() + " to file "+ file.getPath());
  persistenceVersion=Math.min(7,persistenceVersion);
  if (file.isReadOnly()) {
    LOG.error("Can't write to " + file.getPath());
    return null;
  }
  int oldVersion=persistenceVersion;
  if (model instanceof DefaultSModel) {
    DefaultSModel defaultSModel=(DefaultSModel)model;
    oldVersion=defaultSModel.getPersistenceVersion();
    if (oldVersion != persistenceVersion) {
      defaultSModel.setPersistenceVersion(persistenceVersion);
    }
  }
  Document document=saveModel(model);
  try {
    JDOMUtil.writeDocument(document,file);
  }
 catch (  IOException e) {
    LOG.error("Error in file " + file,e);
  }
  if (oldVersion != persistenceVersion) {
    LOG.info("persistence upgraded: " + oldVersion + "->"+ persistenceVersion+ " "+ model.getSModelReference());
    return (DefaultSModel)model;
  }
  return null;
}
