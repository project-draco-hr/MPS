{
  IModelPersistence modelPersistence=null;
  if (sourceModel instanceof DefaultSModel) {
    DefaultSModel defaultSModel=(DefaultSModel)sourceModel;
    int persistenceVersion=defaultSModel.getPersistenceVersion();
    if (persistenceVersion == -1) {
      persistenceVersion=getCurrentPersistenceVersion();
      defaultSModel.setPersistenceVersion(persistenceVersion);
    }
    modelPersistence=getModelPersistence(defaultSModel.getSModelHeader().getPersistenceVersion());
  }
  if (modelPersistence == null) {
    if (sourceModel.getModelDescriptor() != null && TemporaryModels.isTemporary(sourceModel.getModelDescriptor())) {
      modelPersistence=getModelPersistence(8);
    }
 else {
      modelPersistence=getCurrentModelPersistence();
    }
  }
  sourceModel.calculateImplicitImports();
  sourceModel.calculateImplicitUsedLanguages();
  return modelPersistence.getModelWriter().saveModel(sourceModel);
}
