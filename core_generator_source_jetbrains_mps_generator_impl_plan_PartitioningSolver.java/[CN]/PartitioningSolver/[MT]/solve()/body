{
  for (  TemplateMappingConfiguration mapping : myPriorityMap.keySet()) {
    checkSelfLocking(mapping);
  }
  myCoherentMappings=PriorityMapUtil.joinIntersectingCoherentMappings(myCoherentMappings);
  PriorityMapUtil.makeLockedByAllCoherentIfLockedByOne(myCoherentMappings,myPriorityMap);
  PriorityMapUtil.makeLocksEqualsForCoherentMappings(myCoherentMappings,myPriorityMap,myConflictingRules);
  boolean need_more_passes=true;
  while (need_more_passes) {
    need_more_passes=false;
    iterate_all_mappings:     for (    TemplateMappingConfiguration lockedMapping : myPriorityMap.keySet()) {
      while (true) {
        List<TemplateMappingConfiguration> weakLockMappings=PriorityMapUtil.getWeakLockMappingsForLockedMapping(lockedMapping,myPriorityMap);
        if (weakLockMappings.isEmpty())         break;
        for (        TemplateMappingConfiguration weakLockMapping : weakLockMappings) {
          PriorityMapUtil.replaceWeakLock(lockedMapping,weakLockMapping,myPriorityMap);
          checkSelfLocking(lockedMapping);
          List<TemplateMappingConfiguration> lockedMappings_1=PriorityMapUtil.getLockedMappingsForLockMapping(lockedMapping,myPriorityMap);
          for (          TemplateMappingConfiguration lockedMapping_1 : lockedMappings_1) {
            Map<TemplateMappingConfiguration,PriorityData> locks_1=myPriorityMap.get(lockedMapping_1);
            PriorityData priorityDataToApply=locks_1.get(lockedMapping);
            boolean newLockAdded=PriorityMapUtil.addLock(lockedMapping_1,weakLockMapping,priorityDataToApply,myPriorityMap);
            checkSelfLocking(lockedMapping_1);
            if (newLockAdded) {
              if (myPriorityMap.get(lockedMapping_1).get(weakLockMapping).isWeak()) {
                need_more_passes=true;
                break iterate_all_mappings;
              }
            }
          }
        }
      }
    }
  }
  for (  Map<TemplateMappingConfiguration,PriorityData> locks : myPriorityMap.values()) {
    for (    PriorityData priorityData : locks.values()) {
      if (!priorityData.isStrict()) {
        throw new RuntimeException("Unexpected weak priority");
      }
    }
  }
  List<List<TemplateMappingConfiguration>> mappingSets=createMappingSets();
  for (  Map<TemplateMappingConfiguration,PriorityData> grtPriMappings : myPriorityMap.values()) {
    for (    PriorityData priorityData : grtPriMappings.values()) {
      myConflictingRules.addAll(priorityData.myCauseRules);
    }
  }
  return mappingSets;
}
