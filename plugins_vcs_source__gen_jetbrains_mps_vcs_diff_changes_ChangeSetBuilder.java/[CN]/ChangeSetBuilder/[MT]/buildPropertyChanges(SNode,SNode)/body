{
  Map<String,String> oldProperties=((Map<String,String>)oldNode.getProperties());
  Map<String,String> newProperties=((Map<String,String>)newNode.getProperties());
  for (  String name : SetSequence.fromSet(MapSequence.fromMap(oldProperties).keySet()).union(SetSequence.fromSet(MapSequence.fromMap(newProperties).keySet()))) {
    PropertySupport propertySupport=new ChangeSetBuilder.DefaultPropertySupport();
    SNode propertyDeclaration=oldNode.getPropertyDeclaration(name);
    if (propertyDeclaration != null) {
      propertySupport=PropertySupport.getPropertySupport(propertyDeclaration);
    }
    String oldInternalValue=propertySupport.toInternalValue(MapSequence.fromMap(oldProperties).get(name));
    String newInternalValue=propertySupport.toInternalValue(MapSequence.fromMap(newProperties).get(name));
    if (!(ObjectUtils.equals(oldInternalValue,newInternalValue))) {
      myChangeSet.add(new SetPropertyChange(myChangeSet,oldNode.getSNodeId(),name,MapSequence.fromMap(newProperties).get(name)));
    }
  }
}
