{
  AbstractConceptDeclaration inputNodeConcept=inputNode.getConceptDeclarationAdapter();
  if (myTemplateSwitchGraph == null) {
    myTemplateSwitchGraph=new TemplateSwitchGraph(myPlan.getTemplateModels());
    myTemplateSwitchToListCache=new HashMap<TemplateSwitch,List<TemplateSwitch>>();
  }
  List<TemplateSwitch> switches=myTemplateSwitchToListCache.get(templateSwitch);
  if (switches == null) {
    switches=myTemplateSwitchGraph.getSubgraphAsList(templateSwitch);
    myTemplateSwitchToListCache.put(templateSwitch,switches);
  }
  for (  TemplateSwitch aSwitch : switches) {
    List<Reduction_MappingRule> rules=aSwitch.getReductionMappingRules();
    for (    Reduction_MappingRule rule : rules) {
      if (GeneratorUtil.checkPremiseForBaseMappingRule(inputNode,inputNodeConcept,rule,generator)) {
        RuleConsequence ruleConsequence=rule.getRuleConsequence();
        if (ruleConsequence == null) {
          generator.showErrorMessage(inputNode,null,rule.getNode(),"couldn't apply reduction: no rule consequence");
        }
        return ruleConsequence;
      }
    }
    RuleConsequence ruleConsequence=aSwitch.getDefaultConsequence();
    if (ruleConsequence != null) {
      return ruleConsequence;
    }
  }
  return null;
}
