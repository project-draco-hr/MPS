{
  final Set<VirtualFile> roots=new HashSet<VirtualFile>();
  final jetbrains.mps.project.Project mpsProject=ProjectHelper.toMPSProject(getProject());
  mpsProject.getModelAccess().runReadAction(new Runnable(){
    @Override public void run(){
      for (      SModule module : mpsProject.getModulesWithGenerators()) {
        JavaModuleFacet facet=module.getFacet(JavaModuleFacet.class);
        if (facet == null) {
          continue;
        }
        IFile classesGen=facet.getClassesGen();
        if (classesGen == null) {
          continue;
        }
        if (classesGen.getName().endsWith("." + MPSExtentions.MPS_ARCH)) {
          continue;
        }
        if (!(classesGen instanceof IdeaFile)) {
          LogManager.getLogger(ClassesGenPolicy.class).warn("classes_gen dir " + classesGen + " is supposed to be in project and tracked by Idea FS");
          continue;
        }
        VirtualFile classesGenVF=((IdeaFile)classesGen).getVirtualFile();
        if (classesGenVF != null) {
          roots.add(classesGenVF);
        }
        if (((AbstractModule)module).getModuleSourceDir() != null) {
          IFile classesDir=((AbstractModule)module).getModuleSourceDir().getDescendant(AbstractModule.CLASSES);
          if (classesDir.exists()) {
            if (!(classesDir instanceof IdeaFile)) {
              LogManager.getLogger(ClassesGenPolicy.class).warn("Classes dir File " + classesGen + " is supposed to be in project and tracked by Idea FS");
              continue;
            }
            VirtualFile classesVF=((IdeaFile)classesDir).getVirtualFile();
            if (classesVF != null) {
              roots.add(classesVF);
            }
          }
        }
      }
    }
  }
);
  return roots;
}
