{
  if (pack.equals(myModelLongName)) {
    SNode nodeInSameModel=myModel.getNode(targetNodeId);
    if (nodeInSameModel != null) {
      return jetbrains.mps.smodel.SReference.create(role,source,myModelReference,targetNodeId,resolveInfo);
    }
  }
  Collection<SModelReference> possibleModels=myModuleDeps.resolveModel(SModelStereotype.withStereotype(pack,SModelStereotype.JAVA_STUB));
  if (possibleModels.isEmpty()) {
    return jetbrains.mps.smodel.SReference.create(role,source,null,targetNodeId,resolveInfo);
  }
  for (  SModelReference mr : possibleModels) {
    if (myModelReference.equals(mr)) {
      continue;
    }
    new SModelLegacy(myModel).addModelImport(mr,false);
  }
  if (possibleModels.size() > 1) {
    return DynamicReference.createDynamicReference(role,source,pack,resolveInfo);
  }
  SModelReference targetModel=possibleModels.iterator().next();
  return jetbrains.mps.smodel.SReference.create(role,source,targetModel,targetNodeId,resolveInfo);
}
