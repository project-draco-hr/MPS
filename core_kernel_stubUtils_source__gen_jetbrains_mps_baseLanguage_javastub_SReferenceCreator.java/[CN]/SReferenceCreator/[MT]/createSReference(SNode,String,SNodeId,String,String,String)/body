{
  if (pack.equals(SNodeOperations.getModelLongName(model))) {
    SNode nodeInSameModel=model.getNode(targetNodeId);
    if (nodeInSameModel != null) {
      return jetbrains.mps.smodel.SReference.create(role,source,model.getReference(),targetNodeId,resolveInfo);
    }
  }
  Set<SModelReference> models=getModelReferencesFor(pack,rootPresentation);
  if (SetSequence.fromSet(models).isEmpty()) {
    return jetbrains.mps.smodel.SReference.create(role,source,null,targetNodeId,resolveInfo);
  }
  if (SetSequence.fromSet(models).count() > 1) {
    for (    SModelReference m : models) {
      ((jetbrains.mps.smodel.SModel)model).addModelImport(m,false);
    }
    return new DynamicReference(role,source,new SModelReference(pack,SNodeOperations.getModelStereotype(model)),resolveInfo);
  }
  ModuleReference moduleRef=SModelRepository.getInstance().getModelDescriptor(SetSequence.fromSet(models).first()).getModule().getModuleReference();
  SModelReference ref=StubHelper.uidForPackageInStubs(new SModelFqName(pack,SNodeOperations.getModelStereotype(model)),moduleRef,false);
  ((jetbrains.mps.smodel.SModel)model).addModelImport(SetSequence.fromSet(models).first(),false);
  return jetbrains.mps.smodel.SReference.create(role,source,ref,targetNodeId,resolveInfo);
}
