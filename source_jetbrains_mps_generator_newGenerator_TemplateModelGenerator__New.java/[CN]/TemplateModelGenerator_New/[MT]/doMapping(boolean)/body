{
  checkMonitorCanceled();
  int oldErrorCount=getErrorCount();
  RuleManager ruleManager=new RuleManager(this);
  RuleUtil ruleUtil=new RuleUtil(ruleManager);
  ruleManager.getReductionRuleManager().setRuleUtil(ruleUtil);
  if (isPrimary) {
    for (    CreateRootRule createRootRule : ruleManager.getCreateRootRules()) {
      ruleUtil.applyRootRule(createRootRule);
    }
  }
  for (  MappingRule mappingRule : ruleManager.getMappingRules()) {
    checkMonitorCanceled();
    ruleUtil.applyMappingRule(mappingRule);
  }
  for (  Root_MappingRule rootMappingRule : ruleManager.getRoot_MappingRules()) {
    checkMonitorCanceled();
    ruleUtil.applyRoot_MappingRule(rootMappingRule);
  }
  checkMonitorCanceled();
  getGeneratorSessionContext().clearCopiedRootsSet();
  List<SNode> copiedOutputRoots=copyRootsFromInputModel(ruleManager);
  for (  SNode copiedOutputRoot : copiedOutputRoots) {
    getGeneratorSessionContext().registerCopiedRoot(copiedOutputRoot);
    myOutputModel.addRoot(copiedOutputRoot);
  }
  for (  SNode outputRootNode : copiedOutputRoots) {
    checkMonitorCanceled();
    ruleManager.getReductionRuleManager().applyReductionRules(findInputNodeByOutputNodeWithSameId(outputRootNode));
  }
  for (  WeavingRule weavingRule : ruleManager.getWeavingRules()) {
    checkMonitorCanceled();
    ruleUtil.applyWeavingRule(weavingRule);
  }
  for (  Weaving_MappingRule weavingMappingRule : ruleManager.getWeaving_MappingRules()) {
    checkMonitorCanceled();
    ruleUtil.applyWeavingMappingRule(weavingMappingRule);
  }
  checkMonitorCanceled();
  myDelayedChanges.doAllChanges();
  for (  SNode copiedRoot : copiedOutputRoots) {
    checkMonitorCanceled();
    invalidateReferencesInCopiedNode(copiedRoot);
  }
  updateAllReferences();
  checkMonitorCanceled();
  reportWasErrors(getErrorCount() - oldErrorCount);
}
