{
  if (myChooserActivated != visible) {
    boolean canShowPopup=getEditorWindow() != null && getEditorWindow().isShowing() && !(MPSCore.getInstance().isTestMode());
    if (visible) {
      getPatternEditor().activate(getEditorWindow(),myPatternEditorLocation,myPatternEditorSize,canShowPopup);
      myEditorComponent.pushKeyboardHandler(this);
      myNodeSubstituteInfo.invalidateActions();
      rebuildMenuEntries();
      if (canShowPopup) {
        getPopupWindow().setVisible(true);
        getPopupWindow().relayout();
      }
 else {
        getPopupWindow().initListModel();
      }
      getPopupWindow().setSelectionIndex(0);
      getPopupWindow().scrollToSelection();
      myPopupActivated=true;
    }
 else {
      if (canShowPopup) {
        getPopupWindow().setVisible(false);
        getPatternEditor().done();
        getPopupWindow().setRelativeCell(null);
      }
      myNodeSubstituteInfo.invalidateActions();
      myPopupActivated=false;
      myEditorComponent.popKeyboardHandler();
      myContextCell=null;
    }
  }
  myChooserActivated=visible;
}
