{
  if (myChooserActivated != visible) {
    boolean canShowPopup=getEditorWindow() != null && getEditorWindow().isShowing() && !(RuntimeFlags.isTestMode());
    if (visible) {
      myEditorComponent.pushKeyboardHandler(this);
      rebuildMenuEntries();
      getPatternEditor().activate(getEditorWindow(),calcPatternEditorLocation(),calcPatternEditorDimension(),canShowPopup);
      getPopupWindow().setSelectionIndex(0);
      if (canShowPopup) {
        getPopupWindow().setVisible(true);
        getPopupWindow().scrollToSelection();
      }
      myPopupActivated=true;
    }
 else {
      if (canShowPopup) {
        getPopupWindow().setVisible(false);
        getPopupWindow().done();
        getPatternEditor().done();
      }
      myNodeSubstituteInfo.invalidateActions();
      myCellRenderer=null;
      myPopupWindow=null;
      myPopupActivated=false;
      myEditorComponent.popKeyboardHandler();
      myContextCell=null;
    }
  }
  myChooserActivated=visible;
}
