{
  if (myChooserActivated != visible) {
    boolean canShowPopup=getEditorWindow() != null && getEditorWindow().isShowing() && !(RuntimeFlags.isTestMode());
    if (visible) {
      if (myContextCell == null || myNodeSubstituteInfo == null) {
        throw new IllegalStateException("Context cell and substitute info must not be null to show the NodeSubstituteChooser");
      }
      myEditorComponent.pushKeyboardHandler(this);
      rebuildMenuEntries();
      Point location=calcPatternEditorLocation();
      if (location == null) {
        location=new Point(10,10);
      }
      getPatternEditor().activate(getEditorWindow(),location,calcPatternEditorDimension(),canShowPopup);
      getPopupWindow().setSelectionIndex(0);
      if (canShowPopup) {
        getPopupWindow().setVisible(true);
        getPopupWindow().scrollToSelection();
      }
      myPopupActivated=true;
    }
 else {
      dispose();
      myNodeSubstituteInfo.invalidateActions();
      myCellRenderer=null;
      myPopupWindow=null;
      myPopupActivated=false;
      myEditorComponent.popKeyboardHandler();
      myContextCell=null;
      myNodeSubstituteInfo=null;
    }
    myChooserActivated=visible;
  }
}
