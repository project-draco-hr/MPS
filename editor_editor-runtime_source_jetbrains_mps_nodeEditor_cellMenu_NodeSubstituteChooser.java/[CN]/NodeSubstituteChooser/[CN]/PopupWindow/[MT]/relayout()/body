{
  if (!myPatternEditor.isActivated()) {
    return;
  }
  Point location=myPatternEditor.getLeftBottomPosition();
  Rectangle deviceBounds=WindowsUtil.findDeviceBoundsAt(location);
  Dimension preferredSize=getPreferredSize();
  if (location.getY() + preferredSize.getHeight() > deviceBounds.height + deviceBounds.y - 150) {
    setPosition(PopupWindowPosition.TOP);
  }
 else {
    setPosition(PopupWindowPosition.BOTTOM);
  }
  Point newLocation=location;
  int oldIndex=0;
  if (mySelectedSubstituteAction != null) {
    int newIndexOfLastSelectedAction=mySubstituteActions.indexOf(mySelectedSubstituteAction);
    if (newIndexOfLastSelectedAction != -1) {
      oldIndex=newIndexOfLastSelectedAction;
    }
  }
  setSelectionIndex(oldIndex);
  scrollToSelection();
  setSize(preferredSize);
  if (getPosition() == PopupWindowPosition.TOP) {
    newLocation=new Point(newLocation.x,newLocation.y - getHeight() - myPatternEditor.getHeight());
  }
  if (getWidth() >= deviceBounds.width) {
    setSize(deviceBounds.width,getSize().height + myList.getFontMetrics(myList.getFont()).getHeight());
  }
  if (newLocation.x < deviceBounds.x) {
    newLocation.x=deviceBounds.x;
  }
  if (getWidth() + newLocation.x > deviceBounds.width + deviceBounds.x) {
    newLocation=new Point(deviceBounds.width + deviceBounds.x - getWidth(),newLocation.y);
  }
  setLocation(newLocation);
  myScroller.setSize(getSize());
  myScroller.validate();
}
