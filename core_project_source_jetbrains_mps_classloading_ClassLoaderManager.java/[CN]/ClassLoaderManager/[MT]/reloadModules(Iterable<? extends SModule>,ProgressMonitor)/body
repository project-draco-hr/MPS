{
  if (IterableUtils.isEmpty(modules)) {
    LOG.info("Reloaded 0 modules");
    return new ArrayList();
  }
  try {
    monitor.start("Reloading modules' class loaders...",2);
    Collection<ReloadableModule> modulesToReload=new LinkedHashSet();
    for (    SModule module : modules) {
      if (module.getRepository() == null)       throw new IllegalStateException("Cannot reload the module " + module + " which does not belong to a repository");
      if (canLoad(module)) {
        modulesToReload.add((ReloadableModule)module);
      }
    }
    if (modulesToReload.isEmpty())     return Collections.emptySet();
    LOG.info("Reloading " + modulesToReload.size() + " modules");
    refresh();
    myModulesWatcher.onModulesReloaded(modulesToReload);
    Collection<? extends SModuleReference> moduleRefs=myModulesWatcher.getModuleRefs(modulesToReload);
    Collection<? extends ReloadableModule> unloadedModules=doUnloadModules(moduleRefs,monitor.subTask(1));
    modulesToReload.addAll(unloadedModules);
    Collection<ReloadableModule> loadedModules=new LinkedHashSet(preLoadModules(modulesToReload,monitor.subTask(1)));
    LOG.info("Reloaded " + loadedModules.size() + " modules");
    return loadedModules;
  }
  finally {
    monitor.done();
  }
}
