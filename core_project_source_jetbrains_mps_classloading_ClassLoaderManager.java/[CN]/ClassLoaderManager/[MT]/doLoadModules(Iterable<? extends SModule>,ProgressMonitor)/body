{
  Condition<SModule> notLoadedCondition=negateCondition(myLoadedCondition);
synchronized (CLASS_LOADING_LOCK) {
    Set<SModule> modulesToLoad=new LinkedHashSet<SModule>(filterModules(modules,myLoadableCondition,myValidCondition));
    if (modulesToLoad.isEmpty())     return Collections.emptySet();
    modulesToLoad.addAll(myModulesWatcher.getDependencies(modulesToLoad));
    modulesToLoad=filterModules(modulesToLoad,myMPSLoadableCondition,notLoadedCondition);
    if (modulesToLoad.isEmpty())     return Collections.emptySet();
    LOG.debug("Loading " + modulesToLoad.size() + " modules");
    Set<SModule> modulesToNotify=myClassLoadersHolder.doLoadModules(modulesToLoad,monitor);
    myBroadCaster.onLoad(modulesToNotify);
    return modulesToLoad;
  }
}
