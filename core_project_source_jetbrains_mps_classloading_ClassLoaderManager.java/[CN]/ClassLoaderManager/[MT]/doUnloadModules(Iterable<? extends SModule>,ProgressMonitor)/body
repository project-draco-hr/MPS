{
synchronized (CLASS_LOADING_LOCK) {
    monitor.start("Unloading modules...",1);
    try {
      Condition<SModule> loadedCondition=negateCondition(myUnloadedCondition);
      Set<SModule> modulesToUnload=filterModules(modules,myLoadableCondition);
      if (modulesToUnload.isEmpty())       return modulesToUnload;
      Collection<? extends SModule> modulesAndBackDeps=myModulesWatcher.getBackDependencies(modulesToUnload);
      modulesToUnload=filterModules(modulesAndBackDeps,loadedCondition);
      if (modulesToUnload.isEmpty())       return modulesToUnload;
      LOG.debug("Unloading " + modulesToUnload.size() + " modules");
      monitor.step("Disposing old class loaders...");
      myBroadCaster.onUnload(modulesToUnload);
      myClassLoadersHolder.doUnloadModules(modulesToUnload);
      monitor.advance(1);
      return modulesToUnload;
    }
  finally {
      monitor.done();
    }
  }
}
