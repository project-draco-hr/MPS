{
  checkWriteAccess();
  monitor.start("Unloading",6);
  try {
    Condition<SModuleReference> loadedCondition=new NotCondition<SModuleReference>(myUnloadedRefCondition);
    Set<SModuleReference> modulesToUnload=filterModules(modules,loadedCondition);
    if (modulesToUnload.isEmpty())     return Collections.emptySet();
    Collection<? extends SModuleReference> modulesAndBackDeps=myModulesWatcher.getBackDependencies(modulesToUnload);
    modulesToUnload=filterModules(modulesAndBackDeps,loadedCondition);
    if (modulesToUnload.isEmpty())     return Collections.emptySet();
    LOG.debug("Unloading " + modulesToUnload.size() + " modules");
    Collection<ReloadableModule> unloadedModules=myBroadCaster.onUnload(modulesToUnload,monitor.subTask(5,SubProgressKind.AS_COMMENT));
    myClassLoadersHolder.doUnloadModules(modulesToUnload);
    return unloadedModules;
  }
  finally {
    monitor.done();
  }
}
