{
  checkWriteAccess();
  monitor.start("Unloading modules...",1);
  try {
    Condition<SModuleReference> loadedCondition=new NotCondition<SModuleReference>(myUnloadedRefCondition);
    Set<SModuleReference> modulesToUnload=filterModules(modules,loadedCondition);
    if (modulesToUnload.isEmpty())     return Collections.emptySet();
    Collection<? extends SModuleReference> modulesAndBackDeps=myModulesWatcher.getBackDependencies(modulesToUnload);
    modulesToUnload=filterModules(modulesAndBackDeps,loadedCondition);
    if (modulesToUnload.isEmpty())     return Collections.emptySet();
    LOG.debug("Unloading " + modulesToUnload.size() + " modules");
    monitor.step("Disposing old class loaders...");
    Collection<ReloadableModule> unloadedModules=myBroadCaster.onUnload(modulesToUnload);
    myClassLoadersHolder.doUnloadModules(modulesToUnload);
    monitor.advance(1);
    return unloadedModules;
  }
  finally {
    monitor.done();
  }
}
