{
  Set<Module> modules=new HashSet<Module>();
  for (  PsiReference ref : element.getReferences()) {
    PsiElement target=ref.resolve();
    if (target == null)     continue;
    Module targetModule=ModuleUtilCore.findModuleForPsiElement(target);
    if (targetModule == null)     continue;
    if (FacetManager.getInstance(targetModule).getFacetByType(MPSFacetType.ID) == null) {
      modules.add(targetModule);
    }
  }
  for (  PsiElement child : element.getChildren()) {
    modules.addAll(getModulesThatNeedMPSFacet(child));
  }
  return modules;
}
