{
  Set<PsiDirectory> dirs=new HashSet<PsiDirectory>();
  for (  PsiElement element : elements) {
    if (element instanceof PsiDirectory) {
      dirs.add((PsiDirectory)element);
    }
  }
  Set<PsiElement> excluded=new HashSet<PsiElement>();
  Set<PsiDirectory> shallowDirs=new HashSet<PsiDirectory>();
  for (  PsiElement element : elements) {
    PsiElement parent=element.getParent();
    if (dirs.contains(parent)) {
      if (element instanceof PsiDirectory) {
        shallowDirs.add((PsiDirectory)parent);
      }
 else {
        excluded.add(parent);
      }
    }
  }
  List<PsiJavaFile> result=new ArrayList<PsiJavaFile>();
  for (  PsiElement element : elements) {
    if (excluded.contains(element))     continue;
    if (element instanceof PsiDirectory) {
      boolean shallow=shallowDirs.contains(element);
      collectPsiJavaFiles((PsiDirectory)element,shallow,result);
    }
 else     if (element instanceof PsiJavaFile) {
      result.add((PsiJavaFile)element);
    }
  }
  return result;
}
