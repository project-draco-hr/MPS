{
  removeAll();
  SModel modelDescriptor=event.getData(MPSCommonDataKeys.CONTEXT_MODEL);
  if (modelDescriptor == null) {
    setEnabledState(event.getPresentation(),false);
    return;
  }
  if (!(modelDescriptor instanceof EditableSModel) || modelDescriptor.isReadOnly()) {
    event.getPresentation().setEnabled(false);
    event.getPresentation().setVisible(false);
    return;
  }
  IOperationContext context=event.getData(MPSCommonDataKeys.OPERATION_CONTEXT);
  boolean isStubModel=SModelStereotype.isStubModelStereotype(SModelStereotype.getStereotype(modelDescriptor));
  if (context == null || isStubModel) {
    setEnabledState(event.getPresentation(),false);
    return;
  }
  boolean inEditor=event.getData(MPSCommonDataKeys.TREE_SELECTION_SIZE) == null;
  if (!inEditor) {
    Integer selectedItemsCount=event.getData(MPSCommonDataKeys.TREE_SELECTION_SIZE);
    boolean singleItemSelected=selectedItemsCount != null && selectedItemsCount == 1;
    if (!singleItemSelected) {
      setEnabledState(event.getPresentation(),false);
      return;
    }
    TreeNode treeNode=event.getData(MPSCommonDataKeys.TREE_NODE);
    if (!(treeNode instanceof PackageNode)) {
      myPackage=null;
    }
 else {
      final PackageNode node=(PackageNode)treeNode;
      myPackage=node.getPackage();
    }
  }
 else {
    SNode node=event.getData(MPSCommonDataKeys.NODE);
    myPackage=null;
    if (node != null) {
      SNode root=node.getContainingRoot();
      myPackage=SNodeAccessUtil.getProperty(root,SNodeUtil.property_BaseConcept_virtualPackage);
    }
  }
  setEnabledState(event.getPresentation(),true);
  List<Language> modelLanguages=SModelOperations.getLanguages(modelDescriptor);
  LanguageAspect aspect=Language.getModelAspect(modelDescriptor);
  if (aspect != null) {
    SModuleReference ref=aspect.getMainLanguage();
    Language lang=((Language)ref.resolve(MPSModuleRepository.getInstance()));
    if (lang != null) {
      modelLanguages.remove(lang);
      for (      SNode conceptDeclaration : lang.getConceptDeclarations()) {
        if (ModelConstraintsManager.canBeRoot(context,NameUtil.nodeFQName(conceptDeclaration),modelDescriptor)) {
          add(new NewRootNodeAction(new jetbrains.mps.smodel.SNodePointer(conceptDeclaration),modelDescriptor));
        }
      }
      addSeparator();
    }
  }
  Collections.sort(modelLanguages,new ToStringComparator());
  List<Language> languagesWithRoots=new ArrayList<Language>();
  for (  final Language language : modelLanguages) {
    for (    SNode conceptDeclaration : language.getConceptDeclarations()) {
      if (ModelConstraintsManager.canBeRoot(context,NameUtil.nodeFQName(conceptDeclaration),modelDescriptor)) {
        languagesWithRoots.add(language);
        break;
      }
    }
  }
  boolean plain=myPlain || (languagesWithRoots.size() == 1 && aspect == null);
  for (  final Language language : languagesWithRoots) {
    String name=language.getModuleName();
    Icon icon=IconManager.getIconForNamespace(language.getModuleName());
    BaseGroup langRootsGroup;
    if (!plain) {
      langRootsGroup=new BaseGroup(NameUtil.compactNamespace(name),name,icon);
      langRootsGroup.setPopup(true);
    }
 else {
      langRootsGroup=this;
    }
    for (    SNode conceptDeclaration : language.getConceptDeclarations()) {
      if (ModelConstraintsManager.getInstance().canBeRoot(context,NameUtil.nodeFQName(conceptDeclaration),modelDescriptor)) {
        langRootsGroup.add(new NewRootNodeAction(new jetbrains.mps.smodel.SNodePointer(conceptDeclaration),modelDescriptor));
      }
    }
    if (!plain) {
      this.add(langRootsGroup);
    }
 else {
      this.addSeparator();
    }
  }
  if (getChildrenCount() == 0) {
    add(ActionManager.getInstance().getAction("jetbrains.mps.ide.editor.actions.AddLanguageImport_Action"));
  }
}
