{
  final ReferentConstraintContext context=new ReferentConstraintContext(getModel(),reference != null,getContextNode(),contextRole,index,enclosingNode,referenceNode,linkTarget,containingLinkDeclaration);
  ;
  return TypeContextManager.getInstance().runResolveAction(new Computable<Scope>(){
    @Override public Scope compute(){
      try {
        if (scopeProvider != null) {
          Scope searchScope=scopeProvider.createScope(getOperationContext(getModule()),context);
          if (searchScope != null) {
            if (reference != null && searchScope instanceof Adapter) {
              return new RefAdapter(((Adapter)searchScope).getSearchScope(),reference);
            }
            return searchScope;
          }
        }
        return new jetbrains.mps.scope.DefaultScope(getModel(),getModuleScope(getModule()),NameUtil.nodeFQName(linkTarget));
      }
 catch (      Exception t) {
        LOG.error(t,getContextNode());
        return new ErrorScope("can't create search scope for role `" + genuineRole + "' in '"+ sourceNodeConcept.getName()+ "'");
      }
    }
  }
);
}
