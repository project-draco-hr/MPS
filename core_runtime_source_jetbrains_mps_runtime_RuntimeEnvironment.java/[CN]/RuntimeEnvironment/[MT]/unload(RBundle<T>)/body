{
synchronized (myLock) {
    Set<RBundle> deps=getBundlesWhichDependOn(bundles);
    deps.removeAll(Arrays.asList(bundles));
    if (!deps.isEmpty()) {
      String message="Can't unload bundles " + Arrays.asList(bundles) + " because bundles "+ deps+ " depend on them\n";
      Set<RBundle> bundlesSet=new HashSet<RBundle>(Arrays.asList(bundles));
      for (      RBundle<T> b : deps) {
        message+="bundle " + b + " depends on ";
        for (        T depName : b.getDependencies()) {
          if (bundlesSet.contains(get(depName))) {
            message+=depName + " ";
          }
        }
        message+="\n";
      }
      throw new RuntimeEnvironmentException(message);
    }
    for (    RBundle<T> b : bundles) {
      b.unload();
      myBundles.remove(b.getId());
      fireBundleRemoved(b);
    }
    return this;
  }
}
