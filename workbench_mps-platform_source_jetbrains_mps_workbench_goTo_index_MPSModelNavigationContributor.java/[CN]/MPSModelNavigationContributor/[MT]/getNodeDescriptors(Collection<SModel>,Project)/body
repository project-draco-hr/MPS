{
  RootNodeNameIndex index=new RootNodeNameIndex();
  final ID<Integer,List<SNodeDescriptor>> indexName=index.getName();
  final FileBasedIndex fileBasedIndex=FileBasedIndex.getInstance();
  Set<SModel> findDirectly=new HashSet<SModel>();
  final Set<NodeDescriptor> keys=new HashSet<NodeDescriptor>();
  for (  SModel sm : models) {
    if (!SModelStereotype.isUserModel(sm))     continue;
    if (!(sm instanceof BaseEditableSModelDescriptor) || !(sm.getSource() instanceof FileDataSource)) {
      continue;
    }
    FileDataSource source=(FileDataSource)sm.getSource();
    if (!supportedExtensions.contains(FileUtil.getExtension(source.getFile().getName()))) {
      continue;
    }
    if (sm.isLoaded()) {
      findDirectly.add(sm);
      continue;
    }
    IFile modelFile=source.getFile();
    VirtualFile vf=VirtualFileUtils.getVirtualFile(modelFile);
    if (vf == null)     continue;
    int fileId=FileBasedIndex.getFileId(vf);
    GlobalSearchScope scope=GlobalSearchScope.fileScope(ProjectHelper.toIdeaProject(p),vf);
    List<List<SNodeDescriptor>> descriptors=fileBasedIndex.getValues(indexName,fileId,scope);
    if (descriptors.isEmpty())     continue;
    boolean needToLoad=false;
    for (    NodeDescriptor snd : descriptors.get(0)) {
      PropertyConstraintsDescriptor descriptor=ConceptRegistry.getInstance().getConstraintsDescriptor(snd.getConcept().getId()).getProperty(SNodeUtil.property_INamedConcept_name);
      if (descriptor instanceof BasePropertyConstraintsDescriptor && !((BasePropertyConstraintsDescriptor)descriptor).isGetterDefault()) {
        needToLoad=true;
        break;
      }
    }
    if (needToLoad) {
      findDirectly.add(sm);
    }
 else {
      keys.addAll(descriptors.get(0));
    }
  }
  for (  SModel sm : findDirectly) {
    for (    SNode root : index.getRootsToIterate(((DefaultSModelDescriptor)sm).getSModel())) {
      String nodeName=(root.getName() == null) ? "null" : root.getName();
      NodeDescriptor nodeDescriptor=SNodeDescriptor.fromModelReference(nodeName,root.getConcept().getId(),root.getModel().getReference(),root.getNodeId());
      keys.add(nodeDescriptor);
    }
  }
  return keys;
}
