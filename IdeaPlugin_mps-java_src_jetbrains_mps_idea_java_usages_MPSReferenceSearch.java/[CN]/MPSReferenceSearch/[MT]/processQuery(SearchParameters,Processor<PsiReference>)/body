{
  if (!(queryParameters.getEffectiveSearchScope() instanceof GlobalSearchScope)) {
    return;
  }
  final GlobalSearchScope scope=(GlobalSearchScope)queryParameters.getEffectiveSearchScope();
  final PsiElement psiTarget=queryParameters.getElementToSearch();
  if (psiTarget instanceof MPSPsiNodeBase)   return;
  final Project project=psiTarget.getProject();
  final MPSPsiProvider psiProvider=MPSPsiProvider.getInstance(project);
  SRepository repository=ProjectHelper.getProjectRepository(project);
  repository.getModelAccess().runReadAction(new Runnable(){
    @Override public void run(){
      if (DumbService.getInstance(project).isDumb()) {
        return;
      }
      if (psiTarget instanceof LightElement) {
        return;
      }
      final SNode targetNode=getNodeForElement(psiTarget);
      if (targetNode == null) {
        return;
      }
      Set<SNode> targetNodes=new HashSet<SNode>(1);
      targetNodes.add(targetNode);
      Set<SReference> references;
      try {
        references=FindUsagesFacade.getInstance().findUsages(new IdeaSearchScope(scope),targetNodes,null);
      }
 catch (      IndexNotReadyException e) {
        return;
      }
      for (      SReference sReference : references) {
        SNode source=sReference.getSourceNode();
        MPSPsiNode psiNode=(MPSPsiNode)psiProvider.getPsi(source);
        if (psiNode == null)         return;
        String refRole=sReference.getRole();
        MPSPsiRef[] refs=psiNode.getReferences(refRole);
        if (refs.length == 0)         continue;
        for (        MPSPsiRef r : refs) {
          if (targetNode.getNodeId().equals(r.getNodeId())) {
            consumer.process(r.getReference());
          }
        }
      }
    }
  }
);
}
