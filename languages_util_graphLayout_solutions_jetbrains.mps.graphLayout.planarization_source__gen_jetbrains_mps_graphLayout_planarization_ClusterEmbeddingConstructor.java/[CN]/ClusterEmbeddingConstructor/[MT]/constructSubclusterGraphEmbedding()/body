{
  mySubclustersGraph=new Graph();
  Map<Node,Node> nodeMap=MapSequence.<Node,Node>fromMap(new HashMap<Node,Node>());
  myNodeMap=nodeMap;
  mySubclustersMap=MapSequence.<INode,Node>fromMap(new HashMap<INode,Node>());
  List<Node> subclusters=myGraph.getSubclusters(myCluster);
  for (  Node subcluster : ListSequence.<Node>fromList(subclusters)) {
    Node clusterNode=mySubclustersGraph.createNode();
    for (    Node node : myGraph.getNodesInCluster(subcluster)) {
      MapSequence.<Node,Node>fromMap(nodeMap).put(node,clusterNode);
    }
    MapSequence.<INode,Node>fromMap(mySubclustersMap).put(subcluster,clusterNode);
  }
  Map<Edge,Edge> invEdgeMap=MapSequence.<Edge,Edge>fromMap(new HashMap<Edge,Edge>());
  for (  Node source : SetSequence.<Node>fromSet(myClusterNodes)) {
    for (    Edge edge : source.getOutEdges()) {
      Node target=edge.getTarget();
      if (SetSequence.<Node>fromSet(myClusterNodes).contains(target) && MapSequence.<Node,Node>fromMap(nodeMap).get(source) != MapSequence.<Node,Node>fromMap(nodeMap).get(target)) {
        Edge newEdge=mySubclustersGraph.connect(MapSequence.<Node,Node>fromMap(nodeMap).get(source),MapSequence.<Node,Node>fromMap(nodeMap).get(target));
        MapSequence.<Edge,Edge>fromMap(invEdgeMap).put(newEdge,edge);
      }
    }
  }
  if (showInfo > 0) {
    System.out.println("i subgraph " + myCluster + ": "+ mySubclustersGraph.getEdges());
  }
  Set<Edge> connectingEdges=ConnectivityComponents.makeConnected(mySubclustersGraph);
  if (showInfo > 0) {
    System.out.println("c subgraph " + myCluster + ": "+ mySubclustersGraph.getEdges());
  }
  for (  Edge edge : SetSequence.<Edge>fromSet(connectingEdges)) {
    Node source=this.getRealNode(edge.getSource(),nodeMap);
    Node target=getRealNode(edge.getTarget(),nodeMap);
    Edge realEdge=myGraph.connect(source,target);
    MapSequence.<Edge,Edge>fromMap(invEdgeMap).put(edge,realEdge);
  }
  GroupedGraphModificationSynchronizer synchronizer=new GroupedGraphModificationSynchronizer(mySubclustersGraph,myGraph,invEdgeMap);
  mySubEmbeddedGraph=EmbeddingFinderFactory.getFinder().find(mySubclustersGraph);
  if (showInfo > 0) {
    System.out.println("e subgraph " + myCluster + ": "+ mySubclustersGraph.getEdges());
  }
  synchronizer.disconnect();
  if (ListSequence.<Edge>fromList(myOuterEdgesOrder).count() > 0) {
    int numShifts=0;
    while (getSubcluster(ListSequence.<Edge>fromList(myOuterEdgesOrder).first()) == getSubcluster(ListSequence.<Edge>fromList(myOuterEdgesOrder).last()) && numShifts < ListSequence.<Edge>fromList(myOuterEdgesOrder).count()) {
      ListSequence.<Edge>fromList(myOuterEdgesOrder).insertElement(0,ListSequence.<Edge>fromList(myOuterEdgesOrder).removeLastElement());
      numShifts++;
    }
    List<Edge> subClusterBorder=ListSequence.<Edge>fromList(new ArrayList<Edge>(ListSequence.<Edge>fromList(myOuterEdgesOrder).count()));
    myClusterBorder=ListSequence.<Edge>fromList(new ArrayList<Edge>(ListSequence.<Edge>fromList(myOuterEdgesOrder).count()));
    List<Edge> subOuterEdges=ListSequence.<Edge>fromList(new ArrayList<Edge>(ListSequence.<Edge>fromList(myOuterEdgesOrder).count()));
    List<Node> realBorderNodes=ListSequence.<Node>fromList(new ArrayList<Node>(ListSequence.<Edge>fromList(myOuterEdgesOrder).count()));
    List<Node> subBorderNodes=ListSequence.<Node>fromList(new ArrayList<Node>(ListSequence.<Edge>fromList(myOuterEdgesOrder).count()));
    for (    Edge outerEdge : ListSequence.<Edge>fromList(myOuterEdgesOrder)) {
      final Node realClusterNode=getClusterNode(outerEdge);
      boolean isSource=realClusterNode == outerEdge.getSource();
      List<Edge> realSplit=myGraph.splitEdge(outerEdge);
      ListSequence.<Node>fromList(realBorderNodes).addElement(ListSequence.<Edge>fromList(realSplit).getElement(0).getTarget());
      Node subBorderNode=mySubclustersGraph.createNode();
      ListSequence.<Node>fromList(subBorderNodes).addElement(subBorderNode);
      Edge subOuterEdge;
      if (isSource) {
        subOuterEdge=mySubclustersGraph.connect(MapSequence.<Node,Node>fromMap(nodeMap).get(realClusterNode),subBorderNode);
      }
 else {
        subOuterEdge=mySubclustersGraph.connect(subBorderNode,MapSequence.<Node,Node>fromMap(nodeMap).get(realClusterNode));
      }
      Edge realOuterEdge=ListSequence.<Edge>fromList(realSplit).findFirst(new IWhereFilter<Edge>(){
        public boolean accept(        Edge it){
          return ListSequence.<Node>fromList(it.getAdjacentNodes()).contains(realClusterNode);
        }
      }
);
      MapSequence.<Edge,Edge>fromMap(invEdgeMap).put(subOuterEdge,realOuterEdge);
      ListSequence.<Edge>fromList(subOuterEdges).addElement(subOuterEdge);
    }
    Face outerFace=new Face(mySubclustersGraph);
    for (int i=0; i < ListSequence.<Edge>fromList(myOuterEdgesOrder).count(); i++) {
      int next=i + 1;
      if (next == ListSequence.<Edge>fromList(myOuterEdgesOrder).count()) {
        next=0;
      }
      Edge realBorderEdge=myGraph.connect(ListSequence.<Node>fromList(realBorderNodes).getElement(i),ListSequence.<Node>fromList(realBorderNodes).getElement(next));
      ListSequence.<Edge>fromList(myClusterBorder).addElement(realBorderEdge);
      Edge subBorderEdge=mySubclustersGraph.connect(ListSequence.<Node>fromList(subBorderNodes).getElement(i),ListSequence.<Node>fromList(subBorderNodes).getElement(next));
      ListSequence.<Edge>fromList(subClusterBorder).addElement(subBorderEdge);
      MapSequence.<Edge,Edge>fromMap(invEdgeMap).put(subBorderEdge,realBorderEdge);
      outerFace.addFirst(new Dart(subBorderEdge,ListSequence.<Node>fromList(subBorderNodes).getElement(next)));
    }
    for (int i=0; i < numShifts; i++) {
      ListSequence.<Edge>fromList(myClusterBorder).addElement(ListSequence.<Edge>fromList(myClusterBorder).removeElementAt(0));
    }
    Set<Edge> addedEdges=SetSequence.<Edge>fromSet(new HashSet<Edge>());
    if (useSlowFaceFinder) {
      addedEdges=createOuterFaceWithFaceSelection(subBorderNodes,subOuterEdges,subClusterBorder);
    }
 else {
      Edge bridge=this.createOuterFace(subBorderNodes,subOuterEdges,subClusterBorder);
      SetSequence.fromSet(addedEdges).addElement(bridge);
    }
    mySubEmbeddedGraph.addFace(outerFace);
    mySubEmbeddedGraph.setOuterFace(outerFace);
    if (debugMode > 0) {
      CheckEmbeddedGraph.checkEmbeddedGraph(mySubEmbeddedGraph,false);
    }
    synchronizer=new GroupedGraphModificationSynchronizer(mySubclustersGraph,myGraph,invEdgeMap);
    for (    Edge edge : ListSequence.<Edge>fromList(subOuterEdges)) {
      if (SetSequence.<Edge>fromSet(addedEdges).contains(edge)) {
        continue;
      }
      mySubclustersGraph.removeEdge(edge);
      ShortestPathEmbeddingFinder.restoreEdge(mySubEmbeddedGraph,edge,true);
    }
    synchronizer.disconnect();
  }
  return invEdgeMap;
}
