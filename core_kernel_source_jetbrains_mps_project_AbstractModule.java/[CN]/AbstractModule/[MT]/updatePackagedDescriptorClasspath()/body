{
  if (!isPackaged())   return;
  ModuleDescriptor descriptor=getModuleDescriptor();
  if (descriptor == null)   return;
  IFile bundleHomeFile=getBundleHome();
  if (bundleHomeFile == null)   return;
  boolean hasClasspath=false, skipClasspath=false;
  List<String> innerJars=new ArrayList<String>();
  List<ModelRoot> remove=new ArrayList<ModelRoot>();
  for (  ModelRoot entry : descriptor.getStubModelEntries()) {
    String path=entry.getPath();
    if (path.endsWith(".jar")) {
      IFile cp=FileSystem.getInstance().getFileByPath(path);
      if (!cp.exists()) {
        remove.add(entry);
        innerJars.add(cp.getName());
      }
 else       if (bundleHomeFile.equals(cp)) {
        skipClasspath=true;
      }
    }
 else {
      hasClasspath=true;
      remove.add(entry);
    }
  }
  descriptor.getStubModelEntries().removeAll(remove);
  if (hasClasspath && !skipClasspath) {
    ClassPathEntry bundleHome=new ClassPathEntry();
    bundleHome.setPath(bundleHomeFile.getPath());
    descriptor.getStubModelEntries().add(jetbrains.mps.project.structure.model.ModelRootUtil.fromClassPathEntry(bundleHome));
  }
  for (  String jar : innerJars) {
    ClassPathEntry innerJar=new ClassPathEntry();
    innerJar.setPath(bundleHomeFile.getPath() + "!/" + jar);
    descriptor.getStubModelEntries().add(jetbrains.mps.project.structure.model.ModelRootUtil.fromClassPathEntry(innerJar));
  }
}
