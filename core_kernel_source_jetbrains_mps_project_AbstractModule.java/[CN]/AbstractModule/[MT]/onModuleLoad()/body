{
  boolean needToSave=false;
  if (updateSModelReferences()) {
    needToSave=true;
  }
  if (updateModuleReferences()) {
    needToSave=true;
  }
  if (isPackaged()) {
    updatePackagedDescriptorClasspath();
  }
 else {
    Set<StubModelsEntry> visited=new HashSet<StubModelsEntry>();
    List<StubModelsEntry> remove=new ArrayList<StubModelsEntry>();
    for (    StubModelsEntry e : getModuleDescriptor().getStubModelEntries()) {
      if (visited.contains(e)) {
        remove.add(e);
        needToSave=true;
      }
      visited.add(e);
    }
    getModuleDescriptor().getStubModelEntries().removeAll(remove);
  }
  if (needToSave && !isPackaged()) {
    ModelAccess.instance().runWriteInEDT(new Runnable(){
      @Override public void run(){
        save();
      }
    }
);
  }
}
