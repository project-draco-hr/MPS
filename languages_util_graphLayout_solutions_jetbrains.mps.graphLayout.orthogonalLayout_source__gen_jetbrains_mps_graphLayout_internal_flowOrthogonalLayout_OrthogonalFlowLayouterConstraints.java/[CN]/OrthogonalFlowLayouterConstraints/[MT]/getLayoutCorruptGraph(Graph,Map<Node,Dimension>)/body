{
  Set<Node> initialNodes=SetSequence.<Node>fromSet(new HashSet<Node>());
  SetSequence.fromSet(initialNodes).addSequence(ListSequence.<Node>fromList(graph.getNodes()));
  Set<Edge> initialEdges=SetSequence.<Edge>fromSet(new HashSet<Edge>());
  SetSequence.fromSet(initialEdges).addSequence(ListSequence.<Edge>fromList(graph.getEdges()));
  EdgesHistoryManager historyManager=new EdgesHistoryManager(graph);
  BiconnectAugmentation.smartMakeBiconnected(graph);
  EmbeddedGraph embeddedGraph=new ShortestPathEmbeddingFinder(new PQPlanarizationFinder()).find(graph);
  Map<Edge,List<Edge>> history=MapSequence.<Edge,List<Edge>>fromMap(new HashMap<Edge,List<Edge>>());
  for (  Edge edge : SetSequence.<Edge>fromSet(initialEdges)) {
    MapSequence.<Edge,List<Edge>>fromMap(history).put(edge,historyManager.getHistory(edge));
  }
  GraphLayout layout=getLayoutFromEmbeddedGraph(embeddedGraph,nodeSizes,historyManager);
  GraphLayout initialLayout=GraphLayoutFactory.createGraphLayout(graph);
  for (  Node node : SetSequence.<Node>fromSet(initialNodes)) {
    initialLayout.setLayoutFor(node,layout.getNodeLayout(node));
  }
  for (  Edge edge : SetSequence.<Edge>fromSet(initialEdges)) {
    List<Point> edgeLayout=ListSequence.<Point>fromList(new ArrayList<Point>());
    Node cur=edge.getSource();
    for (    Edge historyEdge : ListSequence.<Edge>fromList(MapSequence.<Edge,List<Edge>>fromMap(history).get(edge))) {
      List<Point> historyLayout=layout.getEdgeLayout(historyEdge);
      if (historyEdge.getSource() != cur) {
        historyLayout=ListSequence.<Point>fromList(historyLayout).reversedList();
      }
      ListSequence.<Point>fromList(edgeLayout).addSequence(ListSequence.<Point>fromList(historyLayout));
      cur=historyEdge.getOpposite(cur);
    }
    initialLayout.setLayoutFor(edge,edgeLayout);
  }
  return initialLayout;
}
