{
  if (OrthogonalFlowLayouterConstraints.SHOW_LOG > 0) {
    System.out.println("initial graph: " + embeddedGraph);
  }
  Graph graph=embeddedGraph.getGraph();
  List<Edge> oldEdges=ListSequence.<Edge>fromList(new ArrayList<Edge>());
  ListSequence.<Edge>fromList(oldEdges).addSequence(ListSequence.<Edge>fromList(graph.getEdges()));
  List<Node> oldNodes=ListSequence.<Node>fromList(new ArrayList<Node>());
  ListSequence.<Node>fromList(oldNodes).addSequence(SetSequence.<Node>fromSet(MapSequence.fromMap(nodeSizes).keySet()));
  Map<Dart,Integer> bends=MapSequence.<Dart,Integer>fromMap(new HashMap<Dart,Integer>());
  Map<Dart,Integer> angles=MapSequence.<Dart,Integer>fromMap(new HashMap<Dart,Integer>());
  QuasiOrthogonalRepresentation.getRepresentation(embeddedGraph,bends,angles);
  QuasiRepresentationModifier quasiModifier=new QuasiRepresentationModifier(embeddedGraph,bends,angles);
  quasiModifier.reduceToOrthogonalRepresentation();
  if (OrthogonalFlowLayouterConstraints.SHOW_LOG > 0) {
    System.out.println("modifications: ");
    for (    QuasiRepresentationModifier.Modification modification : ListSequence.<QuasiRepresentationModifier.Modification>fromList(quasiModifier.getModifications())) {
      System.out.println(modification);
    }
  }
  OrthogonalRepresentation.replaceBendsByNodes(embeddedGraph,bends,angles);
  Map<Dart,Direction2D> directions=OrthogonalRepresentation.getDirections(embeddedGraph,angles);
  if (OrthogonalFlowLayouterConstraints.SHOW_LOG > 0) {
    System.out.println("modified graph: " + embeddedGraph);
  }
  Map<Node,Map<Direction2D,Integer>> nodeDirectionSizes=this.getNodeDirectionSizes(oldNodes,nodeSizes);
  Map<Edge,Integer> edgesShifts=getEdgesShifts(quasiModifier.getModifications(),directions,nodeSizes);
  ConstraintsGraphProcessor processor=new ConstraintsGraphProcessor(embeddedGraph,directions);
  processor.setUnitLength(myUnitLength);
  processor.modifyEmbeddedGraph(oldNodes,nodeSizes);
  processor.constructGraph();
  Map<Node,Point> coordinates=processor.getCoordinatesInModifiedGraph(edgesShifts,nodeDirectionSizes,historyManager);
  GraphLayout graphLayout=GraphLayoutFactory.createGraphLayout(graph);
  for (  Node node : ListSequence.<Node>fromList(oldNodes)) {
    Point center=MapSequence.<Node,Point>fromMap(coordinates).get(node);
    Map<Direction2D,Integer> sizes=MapSequence.<Node,Map<Direction2D,Integer>>fromMap(nodeDirectionSizes).get(node);
    Dimension nodeSize=MapSequence.<Node,Dimension>fromMap(nodeSizes).get(node);
    Rectangle rect=new Rectangle(center.x - MapSequence.<Direction2D,Integer>fromMap(sizes).get(Direction2D.LEFT),center.y - MapSequence.<Direction2D,Integer>fromMap(sizes).get(Direction2D.DOWN),nodeSize.width,nodeSize.height);
    graphLayout.setLayoutFor(node,rect);
  }
  for (  Edge edge : ListSequence.<Edge>fromList(oldEdges)) {
    Node source=edge.getSource();
    Node target=edge.getTarget();
    List<Edge> history=historyManager.getHistory(edge);
    List<Point> edgeLayout=ListSequence.<Point>fromList(new LinkedList<Point>());
    Node cur=source;
    ListSequence.<Point>fromList(edgeLayout).addElement(new Point(MapSequence.<Node,Point>fromMap(coordinates).get(cur)));
    for (    Edge historyEdge : ListSequence.<Edge>fromList(history)) {
      Node next=historyEdge.getOpposite(cur);
      ListSequence.<Point>fromList(edgeLayout).addElement(new Point(MapSequence.<Node,Point>fromMap(coordinates).get(next)));
      cur=next;
    }
    if (ListSequence.<Node>fromList(oldNodes).contains(source)) {
      Direction2D dir=MapSequence.<Dart,Direction2D>fromMap(directions).get(embeddedGraph.getSourceDart(ListSequence.<Edge>fromList(history).first(),source));
      int size=MapSequence.<Direction2D,Integer>fromMap(MapSequence.<Node,Map<Direction2D,Integer>>fromMap(nodeDirectionSizes).get(source)).get(dir);
      Point first=ListSequence.<Point>fromList(edgeLayout).removeElementAt(0);
      first.translate(size * dir.dx(),size * dir.dy());
      ListSequence.<Point>fromList(edgeLayout).removeElementAt(0);
      ListSequence.<Point>fromList(edgeLayout).insertElement(0,first);
    }
    if (ListSequence.<Node>fromList(oldNodes).contains(edge.getTarget())) {
      Direction2D dir=MapSequence.<Dart,Direction2D>fromMap(directions).get(embeddedGraph.getSourceDart(ListSequence.<Edge>fromList(history).last(),target));
      int size=MapSequence.<Direction2D,Integer>fromMap(MapSequence.<Node,Map<Direction2D,Integer>>fromMap(nodeDirectionSizes).get(target)).get(dir);
      Point last=ListSequence.<Point>fromList(edgeLayout).removeLastElement();
      last.translate(size * dir.dx(),size * dir.dy());
      ListSequence.<Point>fromList(edgeLayout).removeLastElement();
      ListSequence.<Point>fromList(edgeLayout).addElement(last);
    }
    graphLayout.setLayoutFor(edge,edgeLayout);
  }
  for (  QuasiRepresentationModifier.Modification modification : ListSequence.<QuasiRepresentationModifier.Modification>fromList(quasiModifier.getModifications())) {
    splitEdges(graphLayout,modification,edgesShifts);
  }
  return graphLayout;
}
