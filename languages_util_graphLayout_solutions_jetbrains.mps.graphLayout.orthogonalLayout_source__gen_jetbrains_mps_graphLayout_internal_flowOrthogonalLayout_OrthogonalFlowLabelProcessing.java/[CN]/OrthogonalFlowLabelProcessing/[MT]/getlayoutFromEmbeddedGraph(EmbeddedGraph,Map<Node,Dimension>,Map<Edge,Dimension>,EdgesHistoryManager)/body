{
  if (OrthogonalFlowLabelProcessing.SHOW_INFO > 0) {
    System.out.println("initial graph: " + embeddedGraph);
  }
  Graph graph=embeddedGraph.getGraph();
  List<Edge> oldEdges=ListSequence.<Edge>fromList(new ArrayList<Edge>());
  ListSequence.<Edge>fromList(oldEdges).addSequence(ListSequence.<Edge>fromList(graph.getEdges()));
  List<Node> oldNodes=ListSequence.<Node>fromList(new ArrayList<Node>());
  ListSequence.<Node>fromList(oldNodes).addSequence(SetSequence.<Node>fromSet(MapSequence.fromMap(nodeSizes).keySet()));
  Map<Dart,Integer> bends=MapSequence.<Dart,Integer>fromMap(new HashMap<Dart,Integer>());
  Map<Dart,Integer> angles=MapSequence.<Dart,Integer>fromMap(new HashMap<Dart,Integer>());
  QuasiOrthogonalRepresentation.getRepresentation(embeddedGraph,bends,angles);
  QuasiRepresentationModifier quasiModifier=new QuasiRepresentationModifier(embeddedGraph,bends,angles);
  quasiModifier.reduceToOrthogonalRepresentation();
  if (OrthogonalFlowLabelProcessing.SHOW_INFO > 0) {
    System.out.println("modifications: ");
    for (    QuasiRepresentationModifier.Modification modification : ListSequence.<QuasiRepresentationModifier.Modification>fromList(quasiModifier.getModifications())) {
      System.out.println(modification);
    }
  }
  OrthogonalRepresentation.replaceBendsByNodes(embeddedGraph,bends,angles);
  if (OrthogonalFlowLabelProcessing.SHOW_INFO > 0) {
    System.out.println("modified graph: " + embeddedGraph);
  }
  Map<Dart,Direction2D> directions=OrthogonalRepresentation.getDirections(embeddedGraph,angles);
  Map<Edge,Node> labelNodes=MapSequence.<Edge,Node>fromMap(new HashMap<Edge,Node>());
  Map<Node,Dimension> labelNodeSizes=MapSequence.<Node,Dimension>fromMap(new HashMap<Node,Dimension>());
  for (  Edge edge : SetSequence.<Edge>fromSet(MapSequence.fromMap(labelSizes).keySet())) {
    Edge labeledEdge=getLabeledEdge(historyManager.getHistory(edge));
    Node node=splitEdge(labeledEdge,embeddedGraph,directions);
    MapSequence.<Edge,Node>fromMap(labelNodes).put(edge,node);
    MapSequence.<Node,Dimension>fromMap(labelNodeSizes).put(node,MapSequence.<Edge,Dimension>fromMap(labelSizes).get(edge));
  }
  Map<Node,Map<Direction2D,Integer>> nodeAndLabelDirectionSizes=getNodeDirectionSizes(nodeSizes);
  Map<Node,Map<Direction2D,Integer>> labelDirectionSizes=getNodeDirectionSizes(labelNodeSizes);
  for (  Node node : SetSequence.<Node>fromSet(MapSequence.fromMap(labelDirectionSizes).keySet())) {
    MapSequence.<Node,Map<Direction2D,Integer>>fromMap(nodeAndLabelDirectionSizes).put(node,MapSequence.<Node,Map<Direction2D,Integer>>fromMap(labelDirectionSizes).get(node));
  }
  Map<Node,Dimension> nodeAndLabelSizes=MapSequence.<Node,Dimension>fromMap(new HashMap<Node,Dimension>());
  for (  Node node : SetSequence.<Node>fromSet(MapSequence.fromMap(nodeSizes).keySet())) {
    MapSequence.<Node,Dimension>fromMap(nodeAndLabelSizes).put(node,MapSequence.<Node,Dimension>fromMap(nodeSizes).get(node));
  }
  for (  Node node : SetSequence.<Node>fromSet(MapSequence.fromMap(labelNodeSizes).keySet())) {
    MapSequence.<Node,Dimension>fromMap(nodeAndLabelSizes).put(node,MapSequence.<Node,Dimension>fromMap(labelNodeSizes).get(node));
  }
  Map<Edge,Integer> initialEdgesShifts=getEdgesShifts(quasiModifier.getModifications(),directions,nodeAndLabelDirectionSizes);
  Map<Edge,Integer> edgeShifts=MapSequence.<Edge,Integer>fromMap(new HashMap<Edge,Integer>());
  for (  Edge initialEdge : SetSequence.<Edge>fromSet(MapSequence.fromMap(initialEdgesShifts).keySet())) {
    Edge edge=ListSequence.<Edge>fromList(historyManager.getHistory(initialEdge)).first();
    MapSequence.<Edge,Integer>fromMap(edgeShifts).put(edge,MapSequence.<Edge,Integer>fromMap(initialEdgesShifts).get(initialEdge));
  }
  List<Node> nodesAndLabels=ListSequence.<Node>fromList(new LinkedList<Node>());
  ListSequence.<Node>fromList(nodesAndLabels).addSequence(SetSequence.<Node>fromSet(MapSequence.fromMap(nodeSizes).keySet()));
  ListSequence.<Node>fromList(nodesAndLabels).addSequence(SetSequence.<Node>fromSet(MapSequence.fromMap(labelNodeSizes).keySet()));
  ConstraintsGraphProcessor processor=new ConstraintsGraphProcessor(embeddedGraph,directions);
  processor.setUnitLength(myUnitLength);
  processor.modifyEmbeddedGraph(nodesAndLabels,nodeAndLabelSizes);
  processor.constructGraph();
  Map<Node,Point> coordinates=processor.getCoordinatesInModifiedGraph(initialEdgesShifts,nodeAndLabelDirectionSizes,historyManager);
  GraphLayout graphLayout=GraphLayoutFactory.createGraphLayout(graph);
  for (  Node node : ListSequence.<Node>fromList(oldNodes)) {
    Rectangle rect=getRectangle(coordinates,node,nodeAndLabelDirectionSizes,nodeAndLabelSizes);
    graphLayout.setLayoutFor(node,rect);
  }
  for (  Edge edge : SetSequence.<Edge>fromSet(MapSequence.fromMap(labelNodes).keySet())) {
    Rectangle rect=getRectangle(coordinates,MapSequence.<Edge,Node>fromMap(labelNodes).get(edge),nodeAndLabelDirectionSizes,nodeAndLabelSizes);
    graphLayout.setLabelLayout(edge,rect);
  }
  for (  Edge edge : ListSequence.<Edge>fromList(oldEdges)) {
    Node source=edge.getSource();
    Node target=edge.getTarget();
    List<Edge> history=historyManager.getHistory(edge);
    List<Point> edgeLayout=ListSequence.<Point>fromList(new LinkedList<Point>());
    Node cur=source;
    ListSequence.<Point>fromList(edgeLayout).addElement(new Point(MapSequence.<Node,Point>fromMap(coordinates).get(cur)));
    for (    Edge historyEdge : ListSequence.<Edge>fromList(history)) {
      Node next=historyEdge.getOpposite(cur);
      ListSequence.<Point>fromList(edgeLayout).addElement(new Point(MapSequence.<Node,Point>fromMap(coordinates).get(next)));
      cur=next;
    }
    if (ListSequence.<Node>fromList(oldNodes).contains(source)) {
      Direction2D dir=MapSequence.<Dart,Direction2D>fromMap(directions).get(embeddedGraph.getSourceDart(ListSequence.<Edge>fromList(history).first(),source));
      int size=MapSequence.<Direction2D,Integer>fromMap(MapSequence.<Node,Map<Direction2D,Integer>>fromMap(nodeAndLabelDirectionSizes).get(source)).get(dir);
      Point first=ListSequence.<Point>fromList(edgeLayout).removeElementAt(0);
      first.translate(size * dir.dx(),size * dir.dy());
      ListSequence.<Point>fromList(edgeLayout).removeElementAt(0);
      ListSequence.<Point>fromList(edgeLayout).insertElement(0,first);
    }
    if (ListSequence.<Node>fromList(oldNodes).contains(edge.getTarget())) {
      Direction2D dir=MapSequence.<Dart,Direction2D>fromMap(directions).get(embeddedGraph.getSourceDart(ListSequence.<Edge>fromList(history).last(),target));
      int size=MapSequence.<Direction2D,Integer>fromMap(MapSequence.<Node,Map<Direction2D,Integer>>fromMap(nodeAndLabelDirectionSizes).get(target)).get(dir);
      Point last=ListSequence.<Point>fromList(edgeLayout).removeLastElement();
      last.translate(size * dir.dx(),size * dir.dy());
      ListSequence.<Point>fromList(edgeLayout).removeLastElement();
      ListSequence.<Point>fromList(edgeLayout).addElement(last);
    }
    graphLayout.setLayoutFor(edge,edgeLayout);
  }
  for (  QuasiRepresentationModifier.Modification modification : ListSequence.<QuasiRepresentationModifier.Modification>fromList(quasiModifier.getModifications())) {
    splitEdges(graphLayout,modification,initialEdgesShifts);
  }
  return graphLayout;
}
