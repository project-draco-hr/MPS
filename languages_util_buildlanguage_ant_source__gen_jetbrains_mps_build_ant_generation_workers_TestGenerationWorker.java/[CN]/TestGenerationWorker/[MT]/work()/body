{
  setupEnvironment();
  myReporter.init();
  Map<File,List<String>> mpsProjects=myWhatToDo.getMPSProjectFiles();
  for (  File file : mpsProjects.keySet()) {
    if (!(file.getName().endsWith(MPSExtentions.DOT_MPS_PROJECT))) {
      continue;
    }
    Project p;
    try {
      Class<?> cls=Class.forName("jetbrains.mps.TestMain");
      Method meth=cls.getMethod("loadProject",File.class);
      p=(Project)meth.invoke(null,file);
    }
 catch (    Exception ex) {
      throw new RuntimeException(ex);
    }
    info("Loaded project " + p);
    executeTask(p,new MpsWorker.ObjectsToProcess(Collections.singleton(p),new HashSet<IModule>(),new HashSet<SModelDescriptor>()));
    disposeProject(p);
    dispose();
  }
  LinkedHashSet<IModule> modules=new LinkedHashSet<IModule>();
  LinkedHashSet<SModelDescriptor> models=new LinkedHashSet<SModelDescriptor>();
  collectFromModuleFiles(modules);
  collectFromModelFiles(models);
  MpsWorker.ObjectsToProcess go=new MpsWorker.ObjectsToProcess(Collections.EMPTY_SET,modules,models);
  if (go.hasAnythingToGenerate()) {
    Project project=createDummyProject();
    executeTask(project,go);
  }
 else {
    error("Could not find anything to generate.");
    myTestFailed=true;
  }
  myReporter.finishRun();
  cleanUp();
  dispose();
  showStatistic();
}
