{
  Graph graph=embeddedGraph.getGraph();
  Graph network=new Graph();
  Node center=network.createNode();
  Map<Edge,Integer> low=MapSequence.<Edge,Integer>fromMap(new HashMap<Edge,Integer>());
  Map<Edge,Integer> capacity=MapSequence.<Edge,Integer>fromMap(new HashMap<Edge,Integer>());
  Map<Edge,Integer> cost=MapSequence.<Edge,Integer>fromMap(new HashMap<Edge,Integer>());
  Map<Node,Node> nodeMap=MapSequence.<Node,Node>fromMap(new HashMap<Node,Node>());
  for (  Node node : ListSequence.<Node>fromList(graph.getNodes())) {
    Node networkNode=network.createNode();
    MapSequence.<Node,Node>fromMap(nodeMap).put(node,networkNode);
    Edge edge=network.connect(center,networkNode);
    MapSequence.<Edge,Integer>fromMap(low).put(edge,4);
    MapSequence.<Edge,Integer>fromMap(capacity).put(edge,MapSequence.<Edge,Integer>fromMap(low).get(edge));
    MapSequence.<Edge,Integer>fromMap(cost).put(edge,0);
  }
  Map<Face,Node> faceMap=MapSequence.<Face,Node>fromMap(new HashMap<Face,Node>());
  for (  Face face : ListSequence.<Face>fromList(embeddedGraph.getFaces())) {
    Node node=network.createNode();
    MapSequence.<Face,Node>fromMap(faceMap).put(face,node);
    Edge edge=network.connect(node,center);
    if (embeddedGraph.isOuterFace(face)) {
      MapSequence.<Edge,Integer>fromMap(low).put(edge,2 * ListSequence.<Dart>fromList(face.getDarts()).count() + 4);
    }
 else {
      MapSequence.<Edge,Integer>fromMap(low).put(edge,2 * ListSequence.<Dart>fromList(face.getDarts()).count() - 4);
    }
    MapSequence.<Edge,Integer>fromMap(capacity).put(edge,MapSequence.<Edge,Integer>fromMap(low).get(edge));
    MapSequence.<Edge,Integer>fromMap(cost).put(edge,0);
  }
  Map<Dart,Edge> dartBendMap=MapSequence.<Dart,Edge>fromMap(new HashMap<Dart,Edge>());
  Map<Dart,Edge> dartAngleMap=MapSequence.<Dart,Edge>fromMap(new HashMap<Dart,Edge>());
  for (  Face face : ListSequence.<Face>fromList(embeddedGraph.getFaces())) {
    Node faceNode=MapSequence.<Face,Node>fromMap(faceMap).get(face);
    for (    Dart dart : ListSequence.<Dart>fromList(face.getDarts())) {
      Edge edge=network.connect(MapSequence.<Node,Node>fromMap(nodeMap).get(dart.getSource()),faceNode);
      MapSequence.<Dart,Edge>fromMap(dartAngleMap).put(dart,edge);
      MapSequence.<Edge,Integer>fromMap(low).put(edge,1);
      MapSequence.<Edge,Integer>fromMap(capacity).put(edge,4);
      MapSequence.<Edge,Integer>fromMap(cost).put(edge,0);
      List<Face> faces=embeddedGraph.getAdjacentFaces(dart.getEdge());
      Node oppositeFaceNode;
      if (ListSequence.<Face>fromList(faces).getElement(0) == face) {
        oppositeFaceNode=MapSequence.<Face,Node>fromMap(faceMap).get(ListSequence.<Face>fromList(faces).getElement(1));
      }
 else {
        oppositeFaceNode=MapSequence.<Face,Node>fromMap(faceMap).get(ListSequence.<Face>fromList(faces).getElement(0));
      }
      edge=network.connect(faceNode,oppositeFaceNode);
      MapSequence.<Dart,Edge>fromMap(dartBendMap).put(dart,edge);
      MapSequence.<Edge,Integer>fromMap(low).put(edge,0);
      if (SetSequence.<Edge>fromSet(edgesToBeStraight).contains(dart.getEdge())) {
        MapSequence.<Edge,Integer>fromMap(capacity).put(edge,0);
      }
 else {
        MapSequence.<Edge,Integer>fromMap(capacity).put(edge,Integer.MAX_VALUE / 2);
      }
      MapSequence.<Edge,Integer>fromMap(cost).put(edge,1);
    }
  }
  if (SHOW_INFO > 0) {
    System.out.println("Constructed network:");
    for (    Node node : ListSequence.<Node>fromList(graph.getNodes())) {
      System.out.println("for node " + node + ": "+ MapSequence.<Node,Node>fromMap(nodeMap).get(node));
    }
    for (    Face face : ListSequence.<Face>fromList(embeddedGraph.getFaces())) {
      System.out.println("for face " + face + ": "+ MapSequence.<Face,Node>fromMap(faceMap).get(face));
    }
    for (    Edge edge : ListSequence.<Edge>fromList(network.getEdges())) {
      System.out.println("edge " + edge + ": low = "+ MapSequence.<Edge,Integer>fromMap(low).get(edge)+ ", cap = "+ MapSequence.<Edge,Integer>fromMap(capacity).get(edge)+ ", cost = "+ MapSequence.<Edge,Integer>fromMap(cost).get(edge));
    }
  }
  Map<Edge,Integer> circulation=MinCostCirculation.getCirculation(network,low,capacity,cost);
  for (  Dart dart : SetSequence.<Dart>fromSet(MapSequence.fromMap(dartBendMap).keySet())) {
    MapSequence.<Dart,Integer>fromMap(bends).put(dart,MapSequence.<Edge,Integer>fromMap(circulation).get(MapSequence.<Dart,Edge>fromMap(dartBendMap).get(dart)));
    MapSequence.<Dart,Integer>fromMap(angles).put(dart,MapSequence.<Edge,Integer>fromMap(circulation).get(MapSequence.<Dart,Edge>fromMap(dartAngleMap).get(dart)));
  }
  if (SHOW_INFO > 0) {
    System.out.println("bends: " + bends);
    System.out.println("angles: " + angles);
  }
}
