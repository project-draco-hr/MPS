{
  final EditorComponent editorComponent=(EditorComponent)editorContext.getEditorComponent();
  Set<EditorCell> editorErrorCells=editorComponent.getCellTracker().getErrorCells();
  final Set<EditorCell> errorCells=SetSequence.fromSetWithValues(new HashSet<EditorCell>(),editorErrorCells);
  final boolean wasForceAutofix=myForceAutofix;
  myForceAutofix=false;
  myProject.getModelAccess().runWriteInEDT(new Runnable(){
    @Override public void run(){
      myProject.getModelAccess().executeUndoTransparentCommand(new Runnable(){
        @Override public void run(){
          EditorComponentState state=editorContext.getEditorComponentState();
          boolean doRecheckEditor=false;
          for (          SReference brokenRef : SetSequence.fromSet(badReferences)) {
            boolean resolvedByScope=ResolverComponent.getInstance().resolveScopesOnly(brokenRef,editorContext.getRepository());
            if (resolvedByScope) {
              doRecheckEditor=true;
            }
            SNode sourceNode=brokenRef.getSourceNode();
            if (sourceNode == null) {
              continue;
            }
            String referenceRole=brokenRef.getRole();
            EditorCell cellWithRole=editorComponent.findNodeCellWithRole(sourceNode,referenceRole);
            if (!(resolvedByScope)) {
              if (cellWithRole == null) {
                continue;
              }
              String resolveInfo=ReferenceResolverUtils.getResolveInfo(brokenRef,sourceNode);
              if (resolveInfo == null) {
                continue;
              }
              if (EditorBasedReferenceResolverUtils.substituteCell(cellWithRole,resolveInfo,editorContext)) {
                doRecheckEditor=true;
              }
            }
            SetSequence.fromSet(errorCells).removeElement(cellWithRole);
          }
          for (          EditorCell errorCell : SetSequence.fromSet(errorCells)) {
            if (!(errorCell instanceof EditorCell_Label)) {
              continue;
            }
            EditorCell_Label labelErrorCell=(EditorCell_Label)errorCell;
            String errorText=labelErrorCell.getText();
            if ((errorText == null || errorText.length() == 0)) {
              continue;
            }
            if (EditorBasedReferenceResolverUtils.substituteCell(labelErrorCell,errorText,editorContext)) {
              doRecheckEditor=true;
            }
          }
          if (doRecheckEditor) {
            editorContext.restoreEditorComponentState(state);
            if (wasForceAutofix) {
              myForceAutofix=true;
            }
          }
        }
      }
);
    }
  }
);
}
