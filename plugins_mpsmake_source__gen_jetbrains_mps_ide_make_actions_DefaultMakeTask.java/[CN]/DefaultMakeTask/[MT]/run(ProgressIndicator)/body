{
  final boolean[] reloadingNeeded=new boolean[1];
  final ProgressMonitor monitor=new ProgressMonitorAdapter(indicator);
  monitor.start("",(needClean ? 10 : 9));
  try {
    ModelAccess.instance().runReadAction(new Runnable(){
      public void run(){
        ModuleMaker maker=new ModuleMaker(new DefaultMakeTask.MessageHandler(),MessageKind.ERROR);
        if (needClean) {
          maker.clean(modules,monitor.subTask(1));
        }
        MPSCompilationResult compilationResult=maker.make(modules,monitor.subTask(7));
        reloadingNeeded[0]=compilationResult.isReloadingNeeded();
      }
    }
);
    if (reloadingNeeded[0]) {
      ModelAccess.instance().runWriteAction(new Runnable(){
        public void run(){
          ClassLoaderManager.getInstance().reloadAll(monitor.subTask(2));
        }
      }
);
    }
  }
  finally {
    monitor.done();
  }
}
