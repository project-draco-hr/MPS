{
  final ProgressMonitor monitor=new ProgressMonitorAdapter(indicator);
  monitor.start("",(needClean ? 10 : 9));
  try {
    final MPSCompilationResult[] mpsCompilationResult=new MPSCompilationResult[1];
    myProject.getModelAccess().runReadAction(new Runnable(){
      public void run(){
        MessagesViewTool mvt=getProject().getComponent(MessagesViewTool.class);
        ModuleMaker maker=new ModuleMaker(mvt.newHandler(),MessageKind.ERROR);
        if (needClean) {
          maker.clean(modules,monitor.subTask(1));
        }
        if (myProject != null) {
          mpsCompilationResult[0]=maker.make(modules,monitor.subTask(7),JavaCompilerOptionsComponent.getInstance().getJavaCompilerOptions(myProject));
        }
 else {
          mpsCompilationResult[0]=maker.make(modules,monitor.subTask(7));
        }
      }
    }
);
    if (mpsCompilationResult[0].isReloadingNeeded()) {
      myProject.getModelAccess().runWriteAction(new Runnable(){
        public void run(){
          ClassLoaderManager.getInstance().reloadModules(mpsCompilationResult[0].getChangedModules(),monitor.subTask(2));
        }
      }
);
    }
  }
  finally {
    monitor.done();
  }
}
