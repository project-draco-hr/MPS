{
  if (!(dataSource instanceof StreamDataSource)) {
    throw new UnsupportedDataSourceException(dataSource);
  }
  String moduleRef=options.get(OPTION_MODULEREF);
  String relPath=options.get(OPTION_RELPATH);
  String modelName=options.get(OPTION_MODELNAME);
  boolean contentOnly="true".equals(options.get(OPTION_CONTENT_ONLY));
  SModelReference ref;
  if (relPath == null || moduleRef == null || modelName == null) {
    if (!contentOnly) {
      if (dataSource instanceof FileDataSource) {
        LOG.error("cannot load " + dataSource.getLocation() + ": relPath = "+ relPath,new Throwable());
      }
      return null;
    }
    ref=PersistenceFacade.getInstance().createModelReference(null,jetbrains.mps.smodel.SModelId.generate(),"temp");
  }
 else {
    SModelId id=PersistenceFacade.getInstance().createModelId("path:" + relPath);
    SModuleReference mref=PersistenceFacade.getInstance().createModuleReference(moduleRef);
    if (mref == null) {
      return null;
    }
    ref=PersistenceFacade.getInstance().createModelReference(mref,id,modelName);
  }
  return new CustomPersistenceSModel(ref,(StreamDataSource)dataSource,this);
}
