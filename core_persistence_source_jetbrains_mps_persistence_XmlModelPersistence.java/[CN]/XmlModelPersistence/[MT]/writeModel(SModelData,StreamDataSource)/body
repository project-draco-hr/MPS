{
  SNode root=model.getRootNodes().iterator().next();
  if (root == null) {
    throw new ModelSaveException("cannot save empty model",Collections.<Problem>singletonList(new PersistenceProblem("cannot save empty model",null,true)));
  }
  TextGenerationResult result=TextGen.generateText(root);
  if (result.hasErrors()) {
    throw new ModelSaveException("cannot save xml root",PersistenceProblem.fromIMessages(result.problems()));
  }
  String content=(String)result.getResult();
  OutputStream stream=new BufferedOutputStream(source.openOutputStream());
  try {
    OutputStreamWriter writer=new OutputStreamWriter(stream,FileUtil.DEFAULT_CHARSET);
    writer.write(content);
    writer.flush();
  }
  finally {
    FileUtil.closeFileSafe(stream);
  }
}
