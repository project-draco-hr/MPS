{
  Iterator<SNode> iterator=model.getRootNodes().iterator();
  SNode root=iterator.hasNext() ? iterator.next() : null;
  if (root == null) {
    throw new ModelSaveException("cannot save empty model",Collections.<Problem>singletonList(new PersistenceProblem("cannot save empty model",null,true)));
  }
  if (IterableUtil.copyToList(model.getRootNodes()).size() > 1) {
    throw new ModelSaveException("cannot save more than one root into .xml file",Collections.<Problem>singletonList(new PersistenceProblem("cannot save more than one root into .xml file",null,true,-1,-1,root)));
  }
  TextGenerationResult result=TextGen.generateText(root);
  if (result.hasErrors()) {
    throw new ModelSaveException("cannot save xml root",PersistenceProblem.fromIMessages(result.problems()));
  }
  String content=(String)result.getResult();
  OutputStream stream=new BufferedOutputStream(source.openOutputStream());
  try {
    OutputStreamWriter writer=new OutputStreamWriter(stream,FileUtil.DEFAULT_CHARSET);
    writer.write(content);
    writer.flush();
  }
  finally {
    FileUtil.closeFileSafe(stream);
  }
}
