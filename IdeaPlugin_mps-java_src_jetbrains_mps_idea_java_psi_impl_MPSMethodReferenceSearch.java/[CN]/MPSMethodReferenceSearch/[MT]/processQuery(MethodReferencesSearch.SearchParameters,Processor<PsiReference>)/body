{
  if (!(queryParameters.getScope() instanceof GlobalSearchScope)) {
    return;
  }
  GlobalSearchScope scope=(GlobalSearchScope)queryParameters.getScope();
  Project project=scope.getProject();
  final MPSPsiProvider psiProvider=MPSPsiProvider.getInstance(project);
  final PsiMethod targetMethod=queryParameters.getMethod();
  for (  Module module : ModuleManager.getInstance(project).getModules()) {
    if (!scope.isSearchInModuleContent(module))     continue;
    MPSFacet facet=FacetManager.getInstance(module).getFacetByType(MPSFacetType.ID);
    if (facet == null)     continue;
    final Solution facetSolution=facet.getSolution();
    ModelAccess.instance().runReadAction(new Runnable(){
      @Override public void run(){
        for (        SModelDescriptor model : SModelRepository.getInstance().getModelDescriptors(facetSolution)) {
          Deque<SNode> stack=new ArrayDeque<SNode>();
          for (          SNode node : model.getRootNodes()) {
            stack.addLast(node);
          }
          while (!stack.isEmpty()) {
            SNode node=stack.pop();
            for (            SNode child : node.getChildren()) {
              stack.push(child);
            }
            for (            SReference ref : node.getReferences()) {
              SNode targetNode=ref.getTargetNode();
              PsiElement targetPsiElement=JavaMPSPsiNodeFactory.getPsiSourceOf(targetNode);
              if (targetPsiElement == targetMethod) {
                PsiElement mpsPsiElem=psiProvider.getPsi(node);
                if (!(mpsPsiElem instanceof MPSPsiNode))                 continue;
                MPSPsiNode mpsPsiNode=(MPSPsiNode)mpsPsiElem;
                MPSPsiRef[] refs=mpsPsiNode.getReferences("baseMethodDeclaration");
                if (refs.length == 0) {
                  continue;
                }
                boolean proceed=consumer.process(refs[0].getReference());
                if (!proceed)                 return;
              }
            }
          }
        }
      }
    }
);
  }
}
