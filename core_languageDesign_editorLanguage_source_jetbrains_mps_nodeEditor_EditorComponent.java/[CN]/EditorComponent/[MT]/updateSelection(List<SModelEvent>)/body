{
  SModelEvent lastAdd=null;
  SModelEvent lastRemove=null;
  SNode lastSelectedNode=getSelectedNode();
  List<SNode> childAddedEventNodes=new ArrayList<SNode>();
  for (  SModelEvent e : events) {
    if (e instanceof SModelChildEvent) {
      SModelChildEvent ce=(SModelChildEvent)e;
      if (ce.getParent().getAncestors(true).contains(getEditedNode())) {
        if (ce.isAdded()) {
          lastAdd=ce;
          childAddedEventNodes.add(ce.getChild());
        }
        if (ce.isRemoved())         lastRemove=ce;
      }
    }
    if (e instanceof SModelReferenceEvent) {
      SModelReferenceEvent re=(SModelReferenceEvent)e;
      if (re.isAdded())       lastAdd=re;
      if (re.isRemoved())       lastRemove=re;
    }
  }
  if (lastAdd != null && isExecutingCommand()) {
    if (lastAdd instanceof SModelChildEvent) {
      List<NodesParetoFrontier.NodeBox> frontier=NodesParetoFrontier.findParetoFrontier(childAddedEventNodes);
      SNode addedChild=frontier.get(frontier.size() - 1).getNode();
      EditorCell cell=findNodeCell(addedChild);
      if (cell != null) {
        changeSelectionWRTFocusPolicy(cell);
      }
      return;
    }
 else {
      if (lastAdd instanceof SModelReferenceEvent) {
        SModelReferenceEvent re=(SModelReferenceEvent)lastAdd;
        selectRefCell(re.getReference());
        return;
      }
 else {
      }
    }
  }
  if (lastRemove != null) {
    if (lastRemove instanceof SModelChildEvent && (lastSelectedNode == null || lastSelectedNode.isDeleted())) {
      SModelChildEvent ce=(SModelChildEvent)lastRemove;
      int index=ce.getChildIndex();
      String role=ce.getChildRole();
      SNode parent=ce.getParent();
      if (parent.getChildCount() > index) {
        SNode child=parent.getChildAt(index);
        if (role.equals(child.getRole_())) {
          EditorCell cell=findNodeCell(child);
          if (cell != null) {
            changeSelectionWRTFocusPolicy(cell);
          }
          return;
        }
      }
      if (index != 0) {
        SNode child=parent.getChildAt(index - 1);
        if (role.equals(child.getRole_())) {
          EditorCell cell=findNodeCell(child);
          if (cell != null) {
            changeSelectionWRTFocusPolicy(cell);
          }
          return;
        }
      }
      EditorCell nullCell=findNodeCellWithRole(parent,role);
      if (nullCell == null) {
        EditorCell cell=findNodeCell(parent);
        if (cell != null) {
          changeSelectionWRTFocusPolicy(cell);
        }
      }
 else {
        changeSelectionWRTFocusPolicy(nullCell);
      }
      return;
    }
    if (lastRemove instanceof SModelReferenceEvent && isExecutingCommand()) {
      SModelReferenceEvent re=(SModelReferenceEvent)lastRemove;
      SReference ref=re.getReference();
      SNode sourceNode=ref.getSourceNode();
      String role=ref.getRole();
      EditorCell nullCell=findNodeCellWithRole(sourceNode,role);
      if (nullCell == null) {
        EditorCell cell=findNodeCell(sourceNode);
        if (cell != null) {
          changeSelectionWRTFocusPolicy(cell);
        }
      }
 else {
        changeSelectionWRTFocusPolicy(nullCell);
      }
    }
  }
}
