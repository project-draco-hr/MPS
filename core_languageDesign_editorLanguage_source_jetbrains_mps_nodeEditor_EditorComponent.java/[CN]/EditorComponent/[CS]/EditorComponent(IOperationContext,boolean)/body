{
  myOperationContext=operationContext;
  setBackground(Color.white);
  setFocusTraversalPolicyProvider(true);
  setFocusCycleRoot(true);
  setFocusTraversalPolicy(new FocusTraversalPolicy(){
    public Component getComponentAfter(    Container aContainer,    Component aComponent){
      executeComponentAction(CellActionType.NEXT);
      return aContainer;
    }
    public Component getComponentBefore(    Container aContainer,    Component aComponent){
      executeComponentAction(CellActionType.PREV);
      return aContainer;
    }
    public Component getFirstComponent(    Container aContainer){
      return aContainer;
    }
    public Component getLastComponent(    Container aContainer){
      return aContainer;
    }
    public Component getDefaultComponent(    Container aContainer){
      return aContainer;
    }
  }
);
  setFocusTraversalKeysEnabled(false);
  setDoubleBuffered(true);
  myScrollPane=new JScrollPane();
  myScrollPane.setVerticalScrollBarPolicy(JScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED);
  myScrollPane.setHorizontalScrollBarPolicy(JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED);
  myScrollPane.setViewportView(this);
  myContainer=new JPanel();
  myContainer.setMinimumSize(new Dimension(0,0));
  myContainer.setLayout(new BorderLayout());
  myContainer.add(myScrollPane,BorderLayout.CENTER);
  myScrollPane.setBorder(new LineBorder(Color.LIGHT_GRAY));
  if (showErrorsGutter) {
    myContainer.add(myMessagesGutter,BorderLayout.EAST);
  }
  myNodeSubstituteChooser=new NodeSubstituteChooser(this);
  myNodeRangeSelection=new NodeRangeSelection(this);
  myKbdHandlersStack=new Stack<KeyboardHandler>();
  myKbdHandlersStack.push(new EditorComponentKeyboardHandler());
  myActionMap=new HashMap<CellActionType,EditorCellAction>();
  myActionMap.put(CellActionType.LEFT,new NodeEditorActions.MoveLeft());
  myActionMap.put(CellActionType.RIGHT,new NodeEditorActions.MoveRight());
  myActionMap.put(CellActionType.UP,new NodeEditorActions.MoveUp());
  myActionMap.put(CellActionType.DOWN,new NodeEditorActions.MoveDown());
  myActionMap.put(CellActionType.NEXT,new NodeEditorActions.MoveNext());
  myActionMap.put(CellActionType.PREV,new NodeEditorActions.MovePrev());
  myActionMap.put(CellActionType.LOCAL_HOME,new NodeEditorActions.MoveLeft(true));
  myActionMap.put(CellActionType.LOCAL_END,new NodeEditorActions.MoveRight(false));
  myActionMap.put(CellActionType.ROOT_HOME,new NodeEditorActions.MoveToRootHome());
  myActionMap.put(CellActionType.ROOT_END,new NodeEditorActions.MoveToRootEnd());
  myActionMap.put(CellActionType.HOME,new NodeEditorActions.MoveHome());
  myActionMap.put(CellActionType.END,new NodeEditorActions.MoveEnd());
  myActionMap.put(CellActionType.PAGE_DOWN,new NodeEditorActions.MovePageUp());
  myActionMap.put(CellActionType.PAGE_UP,new NodeEditorActions.MovePageDown());
  myActionMap.put(CellActionType.SELECT_UP,new NodeEditorActions.SelectUp());
  myActionMap.put(CellActionType.SELECT_DOWN,new NodeEditorActions.SelectDown());
  myActionMap.put(CellActionType.SELECT_RIGHT,new NodeEditorActions.SideSelect(CellSide.RIGHT));
  myActionMap.put(CellActionType.SELECT_LEFT,new NodeEditorActions.SideSelect(CellSide.LEFT));
  myActionMap.put(CellActionType.COPY,new CellAction_CopyNode());
  myActionMap.put(CellActionType.CUT,new CellAction_CutNode());
  myActionMap.put(CellActionType.PASTE,new CellAction_PasteNode());
  myActionMap.put(CellActionType.PASTE_BEFORE,new CellAction_PasteNodeRelative(true));
  myActionMap.put(CellActionType.PASTE_AFTER,new CellAction_PasteNodeRelative(false));
  myActionMap.put(CellActionType.FOLD,new CellAction_FoldCell());
  myActionMap.put(CellActionType.UNFOLD,new CellAction_UnfoldCell());
  myActionMap.put(CellActionType.FOLD_ALL,new CellAction_FoldAll());
  myActionMap.put(CellActionType.UNFOLD_ALL,new CellAction_UnfoldAll());
  myActionMap.put(CellActionType.RIGHT_TRANSFORM,new CellAction_SideTransform(CellSide.RIGHT));
  myActionMap.put(CellActionType.LEFT_TRANSFORM,new CellAction_SideTransform(CellSide.LEFT));
  myActionMap.put(CellActionType.COMPLETE,new NodeEditorActions.Complete());
  myActionMap.put(CellActionType.SHOW_MESSAGE,new ShowMessage());
  registerKeyboardAction(new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      EditorCell cell=getSelectedCell();
      if (cell == null)       return;
      if (cell.getSNode() == null)       return;
      Frame frame=(Frame)SwingUtilities.getRoot(EditorComponent.this);
      Point point=new Point(cell.getX() + cell.getWidth(),cell.getY());
      SwingUtilities.convertPointToScreen(point,EditorComponent.this);
      new NodeInformationDialog(frame,point,cell.getSNode()).setVisible(true);
    }
  }
,KeyStroke.getKeyStroke("control Q"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  registerKeyboardAction(new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      if (!getHighlightManager().clearForOwner(myOwner)) {
        onEscape();
      }
    }
  }
,KeyStroke.getKeyStroke("ESCAPE"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  registerKeyboardAction(new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      moveCurrentUp();
    }
  }
,KeyStroke.getKeyStroke("alt UP"),WHEN_FOCUSED);
  registerKeyboardAction(new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      moveCurrentDown();
    }
  }
,KeyStroke.getKeyStroke("alt DOWN"),WHEN_FOCUSED);
  registerKeyboardAction(new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      goToNextErrorCell(false);
    }
  }
,KeyStroke.getKeyStroke("F2"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  registerKeyboardAction(new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      goToNextErrorCell(true);
    }
  }
,KeyStroke.getKeyStroke("shift F2"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  registerKeyboardAction(new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      goToNextHighlightedCell(false);
    }
  }
,KeyStroke.getKeyStroke("F3"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  registerKeyboardAction(new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      goToNextHighlightedCell(true);
    }
  }
,KeyStroke.getKeyStroke("shift F3"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  registerKeyboardAction(new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      EditorCell cell=getSelectedCell();
      if (cell == null)       return;
      showPopupMenu(cell.getX(),cell.getY());
    }
  }
,KeyStroke.getKeyStroke("CONTEXT_MENU"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  addMouseListener(new MouseAdapter(){
    public void mousePressed(    final MouseEvent e){
      if (e.isPopupTrigger()) {
        processPopupMenu(e);
      }
 else {
        processMousePressed(e);
      }
    }
    public void mouseReleased(    MouseEvent e){
      if (e.isPopupTrigger()) {
        processPopupMenu(e);
      }
      super.mouseReleased(e);
    }
  }
);
  myCellSpeedSearch=new CellSpeedSearch(this);
  addKeyListener(new KeyAdapter(){
    public void keyPressed(    final KeyEvent e){
      processKeyPressed(e);
    }
    public void keyReleased(    final KeyEvent e){
      processKeyReleased(e);
    }
  }
);
  myRebuildListeners=new ArrayList<RebuildListener>();
  myLeftHighlighter=new LeftEditorHighlighter(this);
  addFocusListener(new FocusListener(){
    public void focusGained(    FocusEvent e){
      EditorCell selectedCell=getSelectedCell();
      if (selectedCell == null) {
        EditorCell rootCell=getRootCell();
        if (rootCell instanceof EditorCell_Collection) {
          EditorCell focusPolicyCell=FocusPolicyUtil.findCellToSelectDueToFocusPolicy(rootCell);
          EditorCell toSelect;
          if (focusPolicyCell == null || (focusPolicyCell == rootCell && !focusPolicyCell.hasFocusPolicy())) {
            toSelect=rootCell.findChild(CellFinders.or(CellFinders.FIRST_EDITABLE,CellFinders.FIRST_SELECTABLE_LEAF));
          }
 else {
            toSelect=focusPolicyCell;
          }
          if (toSelect == null)           toSelect=rootCell;
          changeSelection(toSelect);
          repaint();
          return;
        }
        if (rootCell != null && rootCell.isSelectable()) {
          changeSelection(rootCell);
        }
      }
      repaint();
    }
    public void focusLost(    FocusEvent e){
      repaint();
      if (myNodeSubstituteChooser.getWindow() != null && (myNodeSubstituteChooser.getWindow().isAncestorOf(e.getOppositeComponent()) || myNodeSubstituteChooser.getWindow() == e.getOppositeComponent()))       return;
      myNodeSubstituteChooser.setVisible(false);
    }
  }
);
  myIntentionsSupport=new IntentionsSupport(this);
  myAutoValidator=new AutoValidator(this);
  ToolTipManager.sharedInstance().registerComponent(this);
  CaretBlinker.getInstance().registerEditor(this);
  KeyboardFocusManager.getCurrentKeyboardFocusManager().addPropertyChangeListener("focusOwner",myFocusListener=new PropertyChangeListener(){
    public void propertyChange(    PropertyChangeEvent evt){
      Component focusOwner=KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner();
      if (EditorComponent.this.isAncestorOf(focusOwner)) {
        Component current=focusOwner;
        while (current.getParent() != EditorComponent.this) {
          current=current.getParent();
        }
        selectComponentCell(current);
      }
    }
  }
);
  EditorSettings.getInstance().addEditorSettingsListener(mySettingsListener);
  ClassLoaderManager.getInstance().addReloadHandler(myReloadListener);
  addFocusListener(new FocusAdapter(){
    public void focusLost(    FocusEvent e){
      commitAll();
    }
  }
);
}
