{
  Map<Project,List<VirtualFile>> toMerge=new HashMap<Project,List<VirtualFile>>();
  Map<VirtualFile,SModelDescriptor> fileToModel=new HashMap<VirtualFile,SModelDescriptor>();
  List<SModelDescriptor> toReload=new ArrayList<SModelDescriptor>();
  for (  Pair<SModelDescriptor,Boolean> pair : models) {
    SModelDescriptor modelDescriptor=pair.getK();
    IFile ifile=modelDescriptor.getModelFile();
    if (isInConflict(ifile,true)) {
      VirtualFile vfile=VFileSystem.getFile(ifile);
      Project project=getProjectForFile(vfile);
      List<VirtualFile> files=toMerge.get(project);
      if (files == null) {
        files=new LinkedList<VirtualFile>();
        toMerge.put(project,files);
      }
      files.add(vfile);
      fileToModel.put(vfile,modelDescriptor);
    }
 else     if (pair.getV() || modelDescriptor.needsReloading()) {
      toReload.add(modelDescriptor);
    }
  }
  for (  Project project : toMerge.keySet()) {
    List<VirtualFile> virtualFileList=AbstractVcsHelper.getInstance(project).showMergeDialog(toMerge.get(project));
    for (    VirtualFile vfile : virtualFileList) {
      SModelDescriptor model=fileToModel.get(vfile);
      if (model != null) {
        toReload.add(model);
      }
    }
  }
  return toReload;
}
