{
  indicator.pushState();
  try {
    indicator.setText("Compiling...");
    indicator.setIndeterminate(true);
    Set<IModule> toCompile=new LinkedHashSet<IModule>();
    Set<IModule> candidates=new LinkedHashSet<IModule>();
    candidates.addAll(modules);
    for (    IModule m : modules) {
      candidates.addAll(m.getAllDependOnModules(IModule.class));
    }
    myDependencies=new Dependencies(candidates);
    for (    IModule c : candidates) {
      if (!isUpToDate(c)) {
        toCompile.add(c);
      }
    }
    int errorCount=0;
    List<Set<IModule>> schedule=StronglyConnectedModules.getInstance().getStronglyConnectedComponents(modules,false);
    for (    Set<IModule> cycle : schedule) {
      if (indicator.isCanceled()) {
        break;
      }
      indicator.setText2("Compiling modules " + cycle + "...");
      int currentErrorsCount=compile(cycle).getErrors();
      errorCount+=currentErrorsCount;
    }
    return new jetbrains.mps.plugin.CompilationResult(errorCount,0,false);
  }
  finally {
    indicator.popState();
  }
}
