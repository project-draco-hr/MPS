{
  monitor.start("Compiling",12);
  ttrace.push("making " + modules.size() + " modules",false);
  try {
    monitor.step("Collecting candidates");
    ttrace.push("collecting candidates",false);
    Set<IModule> candidates=collectCandidates(modules);
    ttrace.pop();
    monitor.advance(1);
    ttrace.push("loading deps",false);
    monitor.step("Loading dependencies");
    myDependencies=new Dependencies(candidates);
    ttrace.pop();
    monitor.advance(1);
    ttrace.push("modules to compile",false);
    monitor.step("Calculating modules to compile");
    Set<IModule> toCompile=getModulesToCompile(candidates);
    ttrace.pop();
    monitor.advance(1);
    int errorCount=0;
    int warnCount=0;
    boolean compiled=false;
    List<IMessage> messages=new ArrayList<IMessage>();
    monitor.step("Building module cycles");
    ttrace.push("building cycles",false);
    List<Set<IModule>> schedule=StronglyConnectedModules.getInstance().getStronglyConnectedComponents(toCompile);
    ttrace.pop();
    monitor.advance(1);
    ProgressMonitor inner=monitor.subTask(8);
    inner.start("",toCompile.size());
    try {
      for (      Set<IModule> cycle : schedule) {
        if (monitor.isCanceled())         break;
        inner.step("compiling " + cycle);
        ttrace.push("processing cycle",false);
        MPSCompilationResult result=compile(cycle);
        inner.advance(cycle.size());
        ttrace.pop();
        errorCount+=result.getErrors();
        warnCount+=result.getWarnings();
        compiled=compiled || result.isCompiledAnything();
        messages.addAll(result.getMessages());
      }
    }
  finally {
      inner.done();
    }
    return new MPSCompilationResult(errorCount,warnCount,false,compiled,messages);
  }
  finally {
    ttrace.pop();
    final String report=ttrace.report();
    if (report != null) {
      handler.handle(new Message(MessageKind.INFORMATION,report));
    }
    monitor.done();
  }
}
