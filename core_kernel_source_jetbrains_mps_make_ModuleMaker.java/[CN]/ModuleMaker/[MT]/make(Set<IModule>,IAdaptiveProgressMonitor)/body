{
  try {
    monitor.start("Compiling...",1000 * modules.size());
    Set<IModule> toCompile=getModulesToCompile(modules);
    int errorCount=0;
    for (    Set<IModule> cycle : new MakeScheduleBuilder().buildSchedule(toCompile)) {
      monitor.addText("Compiling modules: " + cycle + "...");
      int currentErrorsCount=compile(cycle).getErrors();
      if (currentErrorsCount != 0) {
        monitor.addText("There were compilation errors in these modules. See messages view for more information.");
      }
      errorCount+=currentErrorsCount;
    }
    return new jetbrains.mps.plugin.CompilationResult(errorCount,0,false);
  }
  finally {
    monitor.finish();
  }
}
