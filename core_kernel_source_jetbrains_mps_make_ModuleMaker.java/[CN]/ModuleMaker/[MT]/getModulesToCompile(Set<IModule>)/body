{
  ttrace.push("checking if " + modules.size() + " modules are dirty",false);
  List<IModule> dirtyModules=new ArrayList<IModule>(modules.size());
  for (  IModule m : modules) {
    if (isDirty(m)) {
      dirtyModules.add(m);
    }
  }
  ttrace.pop();
  Set<IModule> toCompile=new LinkedHashSet<IModule>();
  ttrace.push("adding modules dependent on dirty ones - " + dirtyModules.size(),false);
  for (  IModule m : MPSModuleRepository.getInstance().getAllModules()) {
    if (m.isPackaged())     continue;
    for (    IModule dep : new GlobalModuleDependenciesManager(m).getModules(Deptype.COMPILE)) {
      if (!dirtyModules.contains(dep))       continue;
      toCompile.add(m);
    }
  }
  ttrace.pop();
  return toCompile;
}
