{
  boolean hasAnythingToCompile=false;
  List<MyMessage> messages=new ArrayList<MyMessage>();
  for (  IModule m : modules) {
    if (m.isCompileInMPS()) {
      hasAnythingToCompile=true;
    }
  }
  if (!hasAnythingToCompile) {
    return new MPSCompilationResult(0,0,false,false);
  }
  JavaCompiler compiler=new JavaCompiler();
  boolean hasJavaToCompile=false;
  boolean hasFilesToCopyOrDelete=false;
  Set<IModule> modulesWithRemovals=new HashSet<IModule>();
  for (  IModule m : modules) {
    if (areClassesUpToDate(m))     continue;
    if (!m.isCompileInMPS()) {
      String text="Module which compiled in IDEA depend on module which has to be compiled in MPS:" + m.getModuleFqName();
      messages.add(new MyMessage(MessageKind.WARNING,text,m));
      LOG.debug(text,m);
      continue;
    }
    ModuleSources sources=getModuleSources(m);
    hasFilesToCopyOrDelete|=!sources.isResourcesUpToDate();
    hasJavaToCompile|=!sources.isJavaUpToDate();
    for (    File f : sources.getFilesToDelete()) {
      f.delete();
      modulesWithRemovals.add(m);
    }
    for (    JavaFile f : sources.getFilesToCompile()) {
      compiler.addSource(f.getClassName(),f.getContents());
      myContainingModules.put(f.getClassName(),m);
    }
  }
  if (!hasJavaToCompile && !hasFilesToCopyOrDelete) {
    return new MPSCompilationResult(0,0,false,false,messages);
  }
  for (  IModule module : modulesWithRemovals) {
    ClassPathFactory.getInstance().invalidate(Collections.singleton(module.getClassesGen().getPath()));
  }
  MyCompilationResultAdapter listener=null;
  if (hasJavaToCompile) {
    IClassPathItem classPathItems=computeDependenciesClassPath(modules);
    listener=new MyCompilationResultAdapter(modules,classPathItems,messages);
    compiler.addCompilationResultListener(listener);
    compiler.compile(classPathItems);
    compiler.removeCompilationResultListener(listener);
    for (    IModule module : modules) {
      ClassPathFactory.getInstance().invalidate(Collections.singleton(module.getClassesGen().getPath()));
    }
  }
  for (  IModule module : modules) {
    ModuleSources sources=getModuleSources(module);
    for (    ResourceFile toCopy : sources.getResourcesToCopy()) {
      String fqName=toCopy.getPath();
      fqName=fqName.substring(0,fqName.length() - toCopy.getFile().getName().length());
      String path=fqName.replace('/',File.separatorChar) + toCopy.getFile().getName();
      if (new File(toCopy.getFile().getAbsolutePath()).exists()) {
        FileUtil.copyFile(new File(toCopy.getFile().getAbsolutePath()),new File(module.getClassesGen().getDescendant(path).getPath()));
      }
    }
  }
  for (  IModule module : modules) {
    ClassPathFactory.getInstance().invalidate(Collections.singleton(module.getClassesGen().getPath()));
  }
  return new MPSCompilationResult(listener == null ? 0 : listener.getErrorCount(),0,false,hasJavaToCompile,messages);
}
