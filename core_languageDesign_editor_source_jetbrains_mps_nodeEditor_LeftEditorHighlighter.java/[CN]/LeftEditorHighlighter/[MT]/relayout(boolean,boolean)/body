{
  if (updateBraces) {
    for (    HighlighterBracket bracket : myBrackets.values()) {
      bracket.relayout();
      bracket.setX(myWidth);
    }
  }
  deleteUnresolvedBrackets();
  if (updateFolding) {
    for (    FoldingButton button : myFoldingButtons.values()) {
      button.relayout();
      button.setX(myWidth);
    }
    deleteUnresolvedFoldingButtons();
  }
  for (  Bookmark bookmark : myBookmarks.values()) {
    bookmark.relayout();
    bookmark.setX(myWidth);
  }
  deleteUnresolvedBookmarks();
  myBracketEdges.clear();
  myBracketsLayoutStack.clear();
  for (  HighlighterBracket bracket : myBrackets.values()) {
    myBracketEdges.add(bracket.getBeginningEdge());
    myBracketEdges.add(bracket.getEndingEdge());
  }
  Collections.sort(myBracketEdges);
  try {
    int maxDepth=0;
    for (int i=0; i < myBracketEdges.size(); i++) {
      BracketEdge edge=myBracketEdges.get(i);
      HighlighterBracket bracket=edge.myHighlighterBracket;
      if (edge.myBeginning) {
        myBracketsLayoutStack.push(bracket);
      }
 else {
        HighlighterBracket poppedBracket=myBracketsLayoutStack.pop();
        while (poppedBracket != bracket) {
          myBracketEdges.remove(poppedBracket.getEndingEdge());
          myBrackets.remove(poppedBracket.myEditorCellInfo);
          poppedBracket=myBracketsLayoutStack.pop();
        }
        int wasDepth=myBracketsLayoutStack.size() + 1;
        maxDepth=Math.max(wasDepth,maxDepth);
        bracket.myDepth=wasDepth;
      }
    }
    myCurrentBracketsWidth=(myWidth - maxDepth) / (2 + maxDepth);
    for (    HighlighterBracket bracket : myBrackets.values()) {
      int inverseDepth=maxDepth - bracket.myDepth;
      bracket.myCurrentWidth=getCurrentBracketsWidth() * 2 + inverseDepth * (getCurrentBracketsWidth() + 1);
    }
  }
 catch (  EmptyStackException ex) {
    LOG.error("brackets error");
  }
  myBracketsLayoutStack.clear();
  myBracketEdges.clear();
}
