{
  List<AbstractTreeNode> updatedChildren=null;
  MPSPsiProvider mpsPsiProvider=MPSPsiProvider.getInstance(treeNode.getProject());
  for (  AbstractTreeNode child : children) {
    if (child instanceof PsiFileNode) {
      PsiFile value=((PsiFileNode)child).getValue();
      if (value instanceof FileSourcePsiFile) {
        SModelReference modelReference=((FileSourcePsiFile)value).getModelReference();
        MPSPsiModel psiModel=mpsPsiProvider.getPsi(modelReference);
        if (updatedChildren == null)         updatedChildren=new ArrayList<AbstractTreeNode>(children);
        int idx=updatedChildren.indexOf(child);
        updatedChildren.remove(idx);
        updatedChildren.add(idx,new MPSPsiModelTreeNode(treeNode.getProject(),psiModel,settings));
      }
    }
 else     if (child instanceof PsiDirectoryNode) {
      for (      AbstractTreeNode innerChild : ((PsiDirectoryNode)child).getChildren()) {
        if (!(innerChild instanceof PsiFileNode) || !(((PsiFileNode)innerChild).getValue() instanceof FilePerRootModelPsiFile))         continue;
        PsiFile value=((PsiFileNode)innerChild).getValue();
        SModelReference modelReference=((FileSourcePsiFile)value).getModelReference();
        MPSPsiModel psiModel=mpsPsiProvider.getPsi(modelReference);
        if (updatedChildren == null)         updatedChildren=new ArrayList<AbstractTreeNode>(children);
        int idx=updatedChildren.indexOf(child);
        updatedChildren.remove(idx);
        final MPSPsiModelTreeNode perRootModelTreeNode=new MPSPsiModelTreeNode(treeNode.getProject(),psiModel,settings);
        updatedChildren.add(idx,perRootModelTreeNode);
        break;
      }
    }
  }
  return updatedChildren != null ? updatedChildren : children;
}
