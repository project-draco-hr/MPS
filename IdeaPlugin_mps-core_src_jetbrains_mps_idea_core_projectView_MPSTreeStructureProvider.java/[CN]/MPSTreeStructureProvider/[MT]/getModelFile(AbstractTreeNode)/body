{
  if (treeNode instanceof MPSPsiElementTreeNode) {
    return getModelFile(treeNode.getParent());
  }
 else   if (treeNode instanceof MPSPsiModelTreeNode) {
    MPSPsiModelTreeNode fileNode=(MPSPsiModelTreeNode)treeNode;
    VirtualFile virtualFile=fileNode.getVirtualFile();
    if (virtualFile == null || virtualFile.getFileType() != MPSFileTypeFactory.MPS_FILE_TYPE && virtualFile.getFileType() != MPSFileTypeFactory.MPS_HEADER_FILE_TYPE)     return null;
    return FileSystem.getInstance().getFileByPath(virtualFile.getPath());
  }
 else   if (treeNode instanceof PsiDirectoryNode) {
    IFile ifile=FileSystem.getInstance().getFileByPath(((PsiDirectoryNode)treeNode).getVirtualFile().getPath());
    SModel model=SModelFileTracker.getInstance().findModel(ifile);
    if (model != null)     return ifile;
  }
  return null;
}
