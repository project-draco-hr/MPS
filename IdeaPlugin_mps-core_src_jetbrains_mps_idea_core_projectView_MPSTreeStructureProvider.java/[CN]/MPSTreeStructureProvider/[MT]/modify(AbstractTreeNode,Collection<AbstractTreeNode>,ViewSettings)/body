{
  final Ref<Collection<AbstractTreeNode>> result=new Ref<Collection<AbstractTreeNode>>(children);
  SRepository repository=ProjectHelper.getProjectRepository(treeNode.getProject());
  repository.getModelAccess().runReadAction(new Runnable(){
    @Override public void run(){
      List<AbstractTreeNode> updatedChildren=null;
      final MPSPsiProvider mpsPsiProvider=MPSPsiProvider.getInstance(treeNode.getProject());
      FolderDataSource currentDirectoryDataSource=null;
      if (treeNode instanceof PsiDirectoryNode) {
        SModel sModel=SModelFileTracker.getInstance(repository).findModel(VirtualFileUtils.toIFile(((PsiDirectoryNode)treeNode).getVirtualFile()));
        if (sModel != null) {
          List<MPSPsiElementTreeNode> rootsTreeNodes=new ArrayList<MPSPsiElementTreeNode>();
          for (          SNode root : sModel.getRootNodes()) {
            rootsTreeNodes.add(new MPSPsiElementTreeNode(treeNode.getProject(),(MPSPsiRootNode)mpsPsiProvider.getPsi(root).getContainingFile(),settings));
          }
          if (!rootsTreeNodes.isEmpty() && updatedChildren == null) {
            updatedChildren=new ArrayList<AbstractTreeNode>(children);
            updatedChildren.addAll(rootsTreeNodes);
          }
          DataSource dataSource=sModel.getSource();
          if (dataSource instanceof FolderDataSource) {
            currentDirectoryDataSource=(FolderDataSource)dataSource;
          }
        }
      }
 else       if (treeNode instanceof MPSPsiModelTreeNode) {
        MPSPsiModel psiModel=((MPSPsiModelTreeNode)treeNode).extractPsiFromValue();
        updatedChildren=new ArrayList<AbstractTreeNode>();
        for (        PsiElement psiElement : psiModel.getChildren()) {
          updatedChildren.add(new MPSPsiElementTreeNode(treeNode.getProject(),(MPSPsiRootNode)psiElement,settings));
        }
      }
      for (      final AbstractTreeNode child : children) {
        if (child instanceof PsiFileNode) {
          VirtualFile vFile=((PsiFileNode)child).getVirtualFile();
          if (vFile == null) {
            continue;
          }
          final SModel sModel=SModelFileTracker.getInstance(repository).findModel(VirtualFileUtils.toIFile(vFile));
          if (sModel != null) {
            if (updatedChildren == null)             updatedChildren=new ArrayList<AbstractTreeNode>(children);
            int idx=updatedChildren.indexOf(child);
            updatedChildren.remove(idx);
            updatedChildren.add(idx,new MPSPsiModelTreeNode(treeNode.getProject(),mpsPsiProvider.getPsi(sModel),settings));
            continue;
          }
          if (currentDirectoryDataSource != null && currentDirectoryDataSource.isIncluded(VirtualFileUtils.toIFile(vFile))) {
            if (updatedChildren == null)             updatedChildren=new ArrayList<AbstractTreeNode>(children);
            int idx=updatedChildren.indexOf(child);
            updatedChildren.remove(idx);
          }
        }
 else         if (child instanceof PsiDirectoryNode) {
          final SModel perRootModel=SModelFileTracker.getInstance(repository).findModel(VirtualFileUtils.toIFile(((PsiDirectoryNode)child).getVirtualFile()));
          if (perRootModel != null) {
            if (updatedChildren == null)             updatedChildren=new ArrayList<AbstractTreeNode>(children);
            int idx=updatedChildren.indexOf(child);
            updatedChildren.remove(idx);
            updatedChildren.add(idx,new PsiDirectoryNode(treeNode.getProject(),((PsiDirectoryNode)child).getValue(),settings){
              @Override public boolean canNavigate(){
                return true;
              }
              @Override public String getNavigateActionText(              boolean focusEditor){
                return MPSBundle.message("open.model.properties.action");
              }
              @Override public void navigate(              boolean requestFocus){
                MPSPropertiesConfigurable configurable=new ModelPropertiesConfigurable(perRootModel,ProjectHelper.toMPSProject(myProject),true);
                final SingleConfigurableEditor dialog=new SingleConfigurableEditor(myProject,configurable);
                configurable.setParentForCallBack(dialog);
                SwingUtilities.invokeLater(new Runnable(){
                  @Override public void run(){
                    dialog.show();
                  }
                }
);
              }
            }
);
          }
        }
      }
      if (updatedChildren != null) {
        result.set(updatedChildren);
      }
    }
  }
);
  return result.get();
}
