{
  SNode n=item;
  for (  SNode child : ListSequence.fromList((List<SNode>)n.getChildren("item"))) {
    SNode optChild=optimize(child);
    if (SNodeOperations.isInstanceOf(optChild,"jetbrains.mps.gtext.structure.GItemList")) {
      inlineChildren(optChild,optChild);
      SNodeOperations.deleteNode(optChild);
    }
 else     if (SNodeOperations.isInstanceOf(optChild,"jetbrains.mps.gtext.structure.GConditionalLine")) {
      SNode nextChild=optChild;
      if (SPropertyOperations.getBoolean(SNodeOperations.cast(optChild,"jetbrains.mps.gtext.structure.GConditionalLine"),"isSeparate")) {
        SNodeOperations.insertNextSiblingChild(nextChild,SModelOperations.createNewNode(SNodeOperations.getModel(item),null,"jetbrains.mps.gtext.structure.GIndent"));
        nextChild=SNodeOperations.cast(SNodeOperations.getNextSibling(nextChild),"jetbrains.mps.gtext.structure.GItem");
      }
      nextChild=inlineChildren(optChild,nextChild);
      if (SPropertyOperations.getBoolean(SNodeOperations.cast(optChild,"jetbrains.mps.gtext.structure.GConditionalLine"),"isSeparate")) {
        SNodeOperations.insertNextSiblingChild(nextChild,SModelOperations.createNewNode(SNodeOperations.getModel(item),null,"jetbrains.mps.gtext.structure.GNewLine"));
      }
      SNodeOperations.deleteNode(optChild);
    }
 else     if (SNodeOperations.isInstanceOf(optChild,"jetbrains.mps.gtext.structure.GLine")) {
      SNode nextChild=optChild;
      SNodeOperations.insertNextSiblingChild(nextChild,SModelOperations.createNewNode(SNodeOperations.getModel(item),null,"jetbrains.mps.gtext.structure.GIndent"));
      nextChild=SNodeOperations.cast(SNodeOperations.getNextSibling(nextChild),"jetbrains.mps.gtext.structure.GItem");
      nextChild=inlineChildren(optChild,nextChild);
      SNodeOperations.insertNextSiblingChild(nextChild,SModelOperations.createNewNode(SNodeOperations.getModel(item),null,"jetbrains.mps.gtext.structure.GNewLine"));
      SNodeOperations.deleteNode(optChild);
    }
  }
  SNode t=null;
  for (  SNode child : ListSequence.fromList((List<SNode>)n.getChildren("item"))) {
    if (SNodeOperations.isInstanceOf(child,"jetbrains.mps.gtext.structure.GText")) {
      if (t == null) {
        t=SNodeOperations.cast(child,"jetbrains.mps.gtext.structure.GText");
      }
 else {
        String text=SPropertyOperations.getString(SNodeOperations.cast(child,"jetbrains.mps.gtext.structure.GText"),"text");
        if (text != null) {
          SPropertyOperations.set(t,"text",SPropertyOperations.getString(t,"text") + text);
        }
        SNodeOperations.deleteNode(child);
      }
    }
 else {
      t=null;
    }
  }
  return IterableUtil.asCollection(n.getChildren("item")).size();
}
