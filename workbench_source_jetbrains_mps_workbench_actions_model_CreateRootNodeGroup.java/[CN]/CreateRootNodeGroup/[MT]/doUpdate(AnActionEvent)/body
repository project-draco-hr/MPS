{
  removeAll();
  SModelDescriptor modelDescriptor=MPSDataKeys.MODEL.getData(event.getDataContext());
  if (modelDescriptor == null) {
    setEnabledState(event.getPresentation(),false);
    return;
  }
  IScope scope=MPSDataKeys.SCOPE.getData(event.getDataContext());
  IOperationContext context=MPSDataKeys.OPERATION_CONTEXT.getData(event.getDataContext());
  Integer selectedItemsCount=MPSDataKeys.LOGICAL_VIEW_SELECTION_SIZE.getData(event.getDataContext());
  boolean isJavaStubModel=SModelStereotype.JAVA_STUB.equals(modelDescriptor.getStereotype());
  boolean singleItemSelected=selectedItemsCount != null && selectedItemsCount == 1;
  if (scope == null || context == null || isJavaStubModel || !singleItemSelected) {
    setEnabledState(event.getPresentation(),false);
    return;
  }
  setEnabledState(event.getPresentation(),true);
  DataContext dataContext=DataManager.getInstance().getDataContext();
  TreeNode treeNode=MPSDataKeys.LOGICAL_VIEW_NODE.getData(dataContext);
  if (!(treeNode instanceof PackageNode)) {
    myPackage=null;
  }
 else {
    final PackageNode node=(PackageNode)treeNode;
    myPackage=node.getPackage();
  }
  List<Language> modelLanguages=modelDescriptor.getSModel().getLanguages(scope);
  if (modelLanguages.size() == 0) {
    add(new BaseAction("<NO LANGUAGES>"){
      protected void doExecute(      AnActionEvent e){
      }
    }
);
  }
  LanguageAspect aspect=Language.getModelAspect(modelDescriptor);
  if (aspect != null) {
    ModuleReference ref=aspect.getMainLanguage();
    Language lang=scope.getLanguage(ref);
    modelLanguages.remove(lang);
    for (    ConceptDeclaration conceptDeclaration : lang.getConceptDeclarations()) {
      if (ModelConstraintsManager.getInstance().canBeRoot(context,NameUtil.nodeFQName(conceptDeclaration),modelDescriptor.getSModel())) {
        add(newRootNodeAction(new SNodePointer(conceptDeclaration),modelDescriptor));
      }
    }
    addSeparator();
  }
  Collections.sort(modelLanguages,new ToStringComparator());
  List<Language> languagesWithRoots=new ArrayList<Language>();
  for (  final Language language : modelLanguages) {
    for (    ConceptDeclaration conceptDeclaration : language.getConceptDeclarations()) {
      if (ModelConstraintsManager.getInstance().canBeRoot(context,NameUtil.nodeFQName(conceptDeclaration),modelDescriptor.getSModel())) {
        languagesWithRoots.add(language);
        break;
      }
    }
  }
  boolean plain=myPlain || (languagesWithRoots.size() == 1 && aspect == null);
  for (  final Language language : languagesWithRoots) {
    String name=language.getNamespace();
    Icon icon=IconManager.getIconForNamespace(language.getNamespace());
    BaseGroup langRootsGroup;
    if (!plain) {
      langRootsGroup=new BaseGroup(name,name,icon);
      langRootsGroup.setPopup(true);
    }
 else {
      langRootsGroup=this;
    }
    for (    ConceptDeclaration conceptDeclaration : language.getConceptDeclarations()) {
      if (ModelConstraintsManager.getInstance().canBeRoot(context,NameUtil.nodeFQName(conceptDeclaration),modelDescriptor.getSModel())) {
        langRootsGroup.add(newRootNodeAction(new SNodePointer(conceptDeclaration),modelDescriptor));
      }
    }
    if (!plain) {
      this.add(langRootsGroup);
    }
 else {
      this.addSeparator();
    }
  }
}
