{
  if (node == null)   return null;
  SNode containingRoot=node.getContainingRoot();
  if (containingRoot == null)   return null;
  NodeTypesComponent component=NodeTypesComponentsRepository.getInstance().getNodeTypesComponent(node.getContainingRoot());
  if (!myCheckedRoots.contains(containingRoot) || component == null) {
    final SNode[] result=new SNode[1];
    final NodeTypesComponent component1=NodeTypesComponentsRepository.getInstance().createNodeTypesComponent(containingRoot);
    setCurrentTypesComponent(component1);
    try {
      checkWithinRoot(node,new Runnable(){
        public void run(){
          result[0]=component1.computeTypesForNodeDuringGeneration(node,new Runnable(){
            public void run(){
              myCheckedRoots.add(node);
            }
          }
);
        }
      }
);
    }
  finally {
      clearCurrentTypesComponent();
    }
    return result[0];
  }
  return getTypeDontCheck(node);
}
