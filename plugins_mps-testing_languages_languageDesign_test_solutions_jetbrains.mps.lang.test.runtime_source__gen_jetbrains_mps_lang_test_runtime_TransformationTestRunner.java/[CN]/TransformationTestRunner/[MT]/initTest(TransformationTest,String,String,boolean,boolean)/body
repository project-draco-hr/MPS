{
  initLoggingSystem();
  if (reOpenProject) {
    closeProjectsBeforeRunningTest();
  }
  if (LOG.isInfoEnabled()) {
    LOG.info("Initializing MPS environment");
  }
  MpsTestsSupport.initEnv(true);
  IdeMain.setTestMode((uiTest ? IdeMain.TestMode.UI_TEST : IdeMain.TestMode.CORE_TEST));
  ApplicationManagerEx.getApplicationEx().doNotSave();
  clearSystemClipboard();
  readSystemMacro();
  setProjectForTest(projectName,test);
  SwingUtilities.invokeAndWait(new Runnable(){
    @Override public void run(){
      ModelAccess.instance().runWriteActionInCommand(new Runnable(){
        public void run(){
          SModel modelDescriptor=SModelRepository.getInstance().getModelDescriptor(PersistenceFacade.getInstance().createModelReference(model));
          if (modelDescriptor == null) {
            Assert.fail("Can't find model " + model + " in projects "+ Arrays.toString(ProjectManager.getInstance().getOpenProjects())+ ".");
          }
          test.setModelDescriptor(modelDescriptor);
          test.init();
        }
      }
,test.getProject());
    }
  }
);
  ModelAccess.instance().flushEventQueue();
}
