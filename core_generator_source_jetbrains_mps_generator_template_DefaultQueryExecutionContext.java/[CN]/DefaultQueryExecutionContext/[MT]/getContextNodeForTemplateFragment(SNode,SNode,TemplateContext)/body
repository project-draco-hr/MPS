{
  SNode fragment=RuleUtil.getTemplateFragmentByAnnotatedNode(templateFragmentNode);
  SNode query=RuleUtil.getTemplateFragment_ContextNodeQuery(fragment);
  if (query != null) {
    String methodName=TemplateFunctionMethodName.templateFragment_ContextNodeQuery(query);
    try {
      final TemplateFragmentContext qctx=new TemplateFragmentContext(context,mainContextNode,templateFragmentNode.getReference());
      return this.invokeMethod(query.getModel(),methodName,qctx);
    }
 catch (    NoSuchMethodException e) {
      getLog().warning(templateFragmentNode.getReference(),"cannot find context node method for template fragment '" + methodName + "' : evaluate to null");
      return null;
    }
catch (    Exception e) {
      getLog().handleException(e);
      getLog().error(templateFragmentNode.getReference(),"cannot evaluate template fragment context query, exception was thrown",GeneratorUtil.describeInput(context));
      return null;
    }
  }
  return mainContextNode;
}
