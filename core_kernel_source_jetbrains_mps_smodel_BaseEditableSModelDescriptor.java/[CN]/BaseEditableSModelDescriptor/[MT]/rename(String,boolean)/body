{
  ModelAccess.assertLegalWrite();
  String oldFqName=getReference().getModelName();
  SModel model=getSModelInternal();
  fireBeforeModelRenamed(new SModelRenamedEvent(model,oldFqName,newModelName));
  SModelReference newModelReference=new SModelReference(SModelFqName.fromString(newModelName),myModelReference.getSModelId());
  ((jetbrains.mps.smodel.SModelInternal)model).changeModelReference(newModelReference);
  if (!changeFile) {
    save();
  }
 else {
    IFile oldFile=getSource().getFile();
    ModelRoot root=ModelRootUtil.getModelRoot(this);
    if (root instanceof DefaultModelRoot) {
      DefaultModelRoot defaultModelRoot=(DefaultModelRoot)root;
      String sourceRoot=null;
      for (      String sr : defaultModelRoot.getFiles(FileBasedModelRoot.SOURCE_ROOTS)) {
        if (oldFile.getPath().startsWith(sr)) {
          sourceRoot=sr;
          break;
        }
      }
      IFile newFile=defaultModelRoot.createSource(newModelName,FileUtil.getExtension(oldFile.getName()),sourceRoot).getFile();
      newFile.getParent().mkdirs();
      newFile.createNewFile();
      changeModelFile(newFile);
      save();
      oldFile.delete();
    }
  }
  myModelReference=newModelReference;
  fireModelRenamed(new SModelRenamedEvent(model,oldFqName,newModelName));
}
