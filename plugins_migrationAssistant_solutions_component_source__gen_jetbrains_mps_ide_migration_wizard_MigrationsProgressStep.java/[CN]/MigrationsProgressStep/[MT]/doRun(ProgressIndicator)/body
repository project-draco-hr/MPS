{
  PersistenceRegistry.getInstance().disableFastFindUsages();
  Map<String,Object> options=InitialStep.getOptions();
  double projectStepsFraction=0.3;
  int projectStepsCount=myManager.projectStepsCount();
  setFraction(progress,0);
  boolean cleanNotification=false;
  while (executeSingleStep(myManager.nextProjectStep(options,true))) {
    if (!(cleanNotification)) {
      cleanNotification=true;
      addElementToMigrationList("Cleaning project... Please wait.");
    }
    setFraction(progress,progress.getFraction() + projectStepsFraction / projectStepsCount);
  }
  addElementToMigrationList("Checking models... Please wait.");
  final Wrappers._boolean preProblems=new Wrappers._boolean();
  ModelAccess.instance().runReadAction(new Runnable(){
    public void run(){
      Iterable<SModule> modules=((Iterable<SModule>)ProjectHelper.toMPSProject(myProject).getModulesWithGenerators());
      Iterable<SNode> problems=MigrationCheckUtil.getProblemNodes(modules);
      preProblems.value=Sequence.fromIterable(problems).isNotEmpty();
    }
  }
);
  final Wrappers._boolean postProblems=new Wrappers._boolean(false);
  if (!(preProblems.value)) {
    while (executeSingleStep(myManager.nextProjectStep(options,false))) {
      setFraction(progress,progress.getFraction() + projectStepsFraction / projectStepsCount);
    }
    setFraction(progress,projectStepsFraction);
    int languageStepsCount=myManager.languageStepsCount();
    while (executeSingleStep(myManager.nextLanguageStep())) {
      setFraction(progress,progress.getFraction() + (1.0 - projectStepsFraction) / languageStepsCount);
    }
    setFraction(progress,1.0);
    addElementToMigrationList("Saving changed models... Please wait.");
    ModelAccess.instance().runWriteInEDT(new Runnable(){
      public void run(){
        MPSModuleRepository.getInstance().saveAll();
      }
    }
);
    addElementToMigrationList("Checking models... Please wait.");
    ModelAccess.instance().runReadAction(new Runnable(){
      public void run(){
        Iterable<SModule> modules=((Iterable<SModule>)ProjectHelper.toMPSProject(myProject).getModulesWithGenerators());
        Iterable<SNode> problems=MigrationCheckUtil.getProblemNodes(modules);
        postProblems.value=Sequence.fromIterable(problems).isNotEmpty();
      }
    }
);
  }
  myFinishedState=new MigrationsProgressStep.FinishedState(preProblems.value,myNoErrors && !(myManager.isMigrationRequired()),postProblems.value);
  addElementToMigrationList((myFinishedState.isEverythingOk() ? "Done!" : "Finished with errors. Click 'Next' to continue."));
  PersistenceRegistry.getInstance().enableFastFindUsages();
}
