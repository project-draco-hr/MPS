{
  return new BufferLayoutConfiguration(){
    private BufferLayout myLayout;
    @Override public void prepareBuffer(    @NotNull TextBuffer buffer){
      for (      TextAreaToken t : myRootTokens) {
        buffer.pushTextArea(t).popTextArea();
      }
      if (!myChildToParentTokens.isEmpty()) {
        myLayout=buffer.newLayout();
        for (        Entry<TextAreaToken,TextAreaToken> p : myChildToParentTokens.entrySet()) {
          buffer.pushTextArea(p.getKey()).popTextArea();
          TextMark childAreaLocationMark=buffer.pushTextArea(p.getValue()).pushMark().popMark();
          buffer.popTextArea();
          myLayout.replace(childAreaLocationMark,p.getKey());
        }
      }
      buffer.pushTextArea(new BasicToken(TextGenBuffer.TOP)).popTextArea();
      buffer.pushTextArea(new BasicToken(TextGenBuffer.DEFAULT));
      if (myInitial != null) {
        buffer.popTextArea();
        buffer.pushTextArea(myInitial);
      }
    }
    @NotNull @Override public BufferSnapshot prepareSnapshot(    @NotNull TextBuffer buffer){
      if (myLayout != null) {
        return buffer.snapshot(myLayout);
      }
      return super.prepareSnapshot(buffer);
    }
  }
;
}
