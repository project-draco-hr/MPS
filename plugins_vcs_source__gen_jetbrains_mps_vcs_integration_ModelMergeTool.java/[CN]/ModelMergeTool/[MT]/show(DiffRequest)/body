{
  ModelMergeRequest mrequest=(ModelMergeRequest)request;
  try {
    DiffContent[] contents=mrequest.getContents();
    final SModel baseModel=ModelDiffTool.readModel(contents[ModelMergeRequestConstants.ORIGINAL],mrequest.getFile().getPath());
    final SModel mineModel=ModelDiffTool.readModel(contents[ModelMergeRequestConstants.CURRENT],mrequest.getFile().getPath());
    final SModel newModel=ModelDiffTool.readModel(contents[ModelMergeRequestConstants.LAST_REVISION],mrequest.getFile().getPath());
    SModelDescriptor modelDescriptor=SModelRepository.getInstance().getModelDescriptor(baseModel.getSModelReference());
    if (modelDescriptor == null) {
      modelDescriptor=SModelRepository.getInstance().getModelDescriptor(mineModel.getSModelFqName());
    }
    String errorMsg=null;
    if (modelDescriptor == null) {
      errorMsg="Model " + mineModel.getLongName() + " is not in model repository.";
    }
 else     if (modelDescriptor.getModule() == null) {
      errorMsg="Model " + mineModel.getLongName() + " is not owned by any module.";
    }
    if (errorMsg != null) {
      int result=Messages.showYesNoDialog(request.getProject(),errorMsg + " If you want to merge it using MPS merger," + " you need to cancel it now and invoke merge tool from project where this model"+ "is owned by any visible module. Also, you can use text merge.\n"+ "Do you want to use text merge tool?","Can't Merge Model",Messages.getErrorIcon());
      if (result == 0) {
        showTextMerge(request);
      }
      return;
    }
    IOperationContext context=new ModuleContext(modelDescriptor.getModule(),request.getProject());
    if (MergeModelsDialog.isNewMergeEnabled()) {
      final MergeModelsDialog dialog=new MergeModelsDialog(request.getProject(),context,baseModel,mineModel,newModel,mrequest);
      SwingUtilities.invokeLater(new Runnable(){
        public void run(){
          dialog.toFront();
        }
      }
);
      dialog.showDialog();
      if (dialog.getResultModel() != null) {
        byte[] bytes=ModelUtils.modelToBytes(dialog.getResultModel());
        mrequest.resolved(bytes);
      }
    }
 else {
      final OldMergeModelsDialog dialog=new OldMergeModelsDialog(context,baseModel,mineModel,newModel);
      SwingUtilities.invokeLater(new Runnable(){
        public void run(){
          dialog.toFront();
        }
      }
);
      dialog.showDialog();
      if (dialog.getResultModel() != null) {
        byte[] bytes=ModelUtils.modelToBytes(dialog.getResultModel());
        mrequest.resolved(bytes);
      }
    }
  }
 catch (  ModelDiffTool.ReadException e) {
    LOG.warning("Can't read models. Using text based diff...",e);
    showTextMerge(request);
  }
catch (  IOException e) {
    LOG.error(e);
  }
}
