{
  Iterator<SNode> iterator=model.getRootNodes().iterator();
  SNode root=(iterator.hasNext() ? iterator.next() : null);
  if (root == null) {
    throw new ModelSaveException("cannot save empty model",Collections.<SModel.Problem>singletonList(new PersistenceProblem(SModel.Problem.Kind.Save,"cannot save empty model",null,true)));
  }
  if (IterableUtil.copyToList(model.getRootNodes()).size() > 1) {
    throw new ModelSaveException("cannot save more than one root into .xml file",Collections.<SModel.Problem>singletonList(new PersistenceProblem(SModel.Problem.Kind.Save,"cannot save more than one root into .xml file",null,true,-1,-1,root)));
  }
  RegularTextUnit tu=new RegularTextUnit(root,"dummy.xml");
  tu.generate();
  if (tu.getState() != TextUnit.Status.Generated) {
    throw new ModelSaveException("cannot save xml root",Collections.<SModel.Problem>singleton(new PersistenceProblem(SModel.Problem.Kind.Save,"Failed to generate text, status is " + tu.getState(),null,true)));
  }
  byte[] content=tu.getBytes();
  OutputStream stream=new BufferedOutputStream(source.openOutputStream());
  try {
    stream.write(content);
    stream.flush();
  }
  finally {
    FileUtil.closeFileSafe(stream);
  }
}
