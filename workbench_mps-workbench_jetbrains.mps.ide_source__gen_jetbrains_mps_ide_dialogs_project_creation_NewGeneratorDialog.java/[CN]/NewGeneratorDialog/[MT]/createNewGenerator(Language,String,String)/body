{
  final LanguageDescriptor languageDescriptor=language.getModuleDescriptor();
  final GeneratorDescriptor generatorDescriptor=new GeneratorDescriptor();
  generatorDescriptor.setGeneratorUID(Generator.generateGeneratorUID(language));
  generatorDescriptor.setNamespace(name);
  DefaultModelRoot templateModelsRoot=new DefaultModelRoot(new IdeaFileSystem());
  templateModelsRoot.setContentRoot(templateModelsDir);
  templateModelsRoot.addFile(DefaultModelRoot.SOURCE_ROOTS,templateModelsDir);
  generatorDescriptor.getModelRootDescriptors().add(templateModelsRoot.toDescriptor());
  generatorDescriptor.getUsedDevkits().add(PersistenceFacade.getInstance().createModuleReference("fbc25dd2-5da4-483a-8b19-70928e1b62d7(jetbrains.mps.devkit.general-purpose)"));
  languageDescriptor.getGenerators().add(generatorDescriptor);
  language.setModuleDescriptor(languageDescriptor);
  language.save();
  return (Generator)MPSModuleRepository.getInstance().getModule(generatorDescriptor.getId());
}
