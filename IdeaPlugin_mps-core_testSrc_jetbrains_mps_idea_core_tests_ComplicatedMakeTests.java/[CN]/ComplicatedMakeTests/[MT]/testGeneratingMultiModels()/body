{
  CompilerManagerImpl.testSetup();
  ModuleRootManager mrm=ModuleRootManager.getInstance(myFacet.getModule());
  VirtualFile[] srs=mrm.getSourceRoots();
  assertTrue(srs.length == 2);
  VirtualFile models=srs[0];
  assertEquals("models",models.getName());
  assertTrue(models.getChildren().length == 4);
  assertExists(models,"code.mps");
  assertExists(models,"data.mps");
  assertExists(models,"code2.mps");
  assertExists(models,"data2.mps");
  final VirtualFile moduleDir=models.getParent();
  assertTrue(moduleDir.findChild("src") == null);
  CompilerManager cm=CompilerManager.getInstance(myFacet.getModule().getProject());
  assertCompiles(cm,1,0);
  MPSCompiler2[] mpscs=cm.getCompilers(MPSCompiler2.class);
  assertSame(1,mpscs.length);
  VirtualFile outputDir=moduleDir.findChild("src");
  assertNotNull("Not found output dir",outputDir);
  assertExists(outputDir,"code/Test.java");
  assertExists(outputDir,"code/trace.info");
  assertChildrenCount(outputDir,"code",2);
  assertExists(outputDir,"code2");
  assertExists(outputDir,"code2/Test2.java");
  assertExists(outputDir,"code2/trace.info");
  assertChildrenCount(outputDir,"code2",2);
  assertExists(models,"Manifest.java");
  assertExists(models,"Manifest2.java");
  assertExists(models,"trace.info");
  assertTrue(models.getChildren().length == 7);
  String cachesOutputPath=MPSCompilerPaths.getCachesOutputPath(mpscs[0],myFacet.getModule(),false);
  new File(cachesOutputPath,"code2/generated").delete();
  new File(cachesOutputPath,"data2/generated").delete();
  new File(outputDir.findFileByRelativePath("code/Test.java").getPath()).delete();
  new File(models.findFileByRelativePath("Manifest.java").getPath()).delete();
  getVFS().refresh(false);
  assertCompiles(cm,1,0);
  assertExists(outputDir,"code");
  assertNotExists(outputDir,"code/Test.java");
  assertExists(outputDir,"code/trace.info");
  assertTrue(outputDir.findFileByRelativePath("code").getChildren().length == 1);
  assertNotExists(models,"Manifest.java");
  assertExists(models,"Manifest2.java");
  assertExists(models,"trace.info");
  assertTrue(models.getChildren().length == 6);
  getVFS().refresh(false);
  assertNotExists(moduleDir,"source_gen");
  VirtualFile cachesOutputDir=getVFS().findFileByPath(MPSCompilerPaths.getCachesOutputPath(mpscs[0],myFacet.getModule(),false));
  assertExists(cachesOutputDir,"code");
  assertExists(cachesOutputDir,"code/dependencies");
  assertExists(cachesOutputDir,"code/generated");
  assertExists(cachesOutputDir,"data/dependencies");
  assertExists(cachesOutputDir,"data/generated");
}
