{
  final java.util.Date date=new Date(System.currentTimeMillis());
  ensureCachesAreUpToDate();
  final Set<SNodeDescriptor> keys=new HashSet<SNodeDescriptor>();
  final Set<SModelReference> hasToLoad=new HashSet<SModelReference>();
  final Set<SModelReference> changedModels=new HashSet<SModelReference>();
  for (  SModelDescriptor sm : SModelRepository.getInstance().getChangedModels()) {
    changedModels.add(sm.getSModelReference());
  }
  FileBasedIndex.getInstance().processAllKeys(RootNodeNameIndex.NAME,new Processor<SNodeDescriptor>(){
    public boolean process(    SNodeDescriptor s){
      if (s.isDependOnOtherModel() || changedModels.contains(s.getModelReference())) {
        hasToLoad.add(s.getModelReference());
      }
 else {
        keys.add(s);
      }
      return true;
    }
  }
);
  for (  SModelReference ref : hasToLoad) {
    SModelDescriptor sm=scope.getModelDescriptor(ref);
    List<SNode> roots=sm.getSModel().getRoots();
    for (    SNode root : roots) {
      int number=roots.indexOf(root);
      keys.add(new SNodeDescriptor(NameUtil.nodeFQName(root),root.getConceptFqName(),root.getModel().getSModelReference(),true,number));
    }
  }
  System.out.println(keys.size());
  System.out.println("Use caches. " + (new Date(System.currentTimeMillis()).getTime() - date.getTime()) + " ms");
  return keys.toArray(new SNodeDescriptor[keys.size()]);
}
