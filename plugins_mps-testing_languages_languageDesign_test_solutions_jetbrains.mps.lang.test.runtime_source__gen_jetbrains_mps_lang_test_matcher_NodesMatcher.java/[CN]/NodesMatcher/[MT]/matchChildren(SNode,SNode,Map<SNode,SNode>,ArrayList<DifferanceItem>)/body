{
  HashSet<String> roles=new HashSet<String>();
  roles.addAll(SNodeOperations.getChildRoles(a));
  roles.addAll(SNodeOperations.getChildRoles(b));
  for (  String role : roles) {
    Iterable<? extends SNode> children1=a.getChildren(role);
    Iterable<? extends SNode> children2=b.getChildren(role);
    int size1=countElements(children1.iterator());
    int size2=countElements(children2.iterator());
    if (size1 != size2) {
      difference.add(new ChildrenCountDifference(role,size1,size2));
      continue;
    }
    Iterator<? extends SNode> iterator1=children1.iterator();
    Iterator<? extends SNode> iterator2=children2.iterator();
    while (iterator1.hasNext() && iterator2.hasNext()) {
      NodeDifference d=NodesMatcher.matchNodes(iterator1.next(),iterator2.next(),map);
      if (d != null) {
        difference.add(d);
      }
    }
  }
}
