{
  SNode routineDefinition=SNodeFactoryOperations.createNewNode("jetbrains.mps.samples.Kaja.structure.RoutineDefinition",null);
  List<SNode> selectedNodes=editorContext.getSelectedNodes();
  ListSequence.fromList(SLinkOperations.getTargets(SLinkOperations.getTarget(SNodeOperations.getAncestor(node,"jetbrains.mps.samples.Kaja.structure.Script",true,false),"body",true),"commands",true)).addElement(routineDefinition);
  SNode call=SConceptOperations.createNewNode("jetbrains.mps.samples.Kaja.structure.RoutineCall",null);
  SLinkOperations.setTarget(call,"definition",routineDefinition,false);
  SNodeOperations.insertPrevSiblingChild(ListSequence.fromList(selectedNodes).first(),call);
  for (  SNode selectedNode : ListSequence.fromList(selectedNodes)) {
    ListSequence.fromList(SLinkOperations.getTargets(SLinkOperations.getTarget(routineDefinition,"body",true),"commands",true)).addElement(SNodeOperations.getAncestor(selectedNode,"jetbrains.mps.samples.Kaja.structure.AbstractCommand",true,false));
  }
  editorContext.selectWRTFocusPolicy(routineDefinition);
}
