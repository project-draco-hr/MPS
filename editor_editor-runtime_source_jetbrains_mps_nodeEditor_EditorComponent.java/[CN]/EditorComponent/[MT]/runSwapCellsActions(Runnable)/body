{
  try {
    myCellSwapInProgress=true;
    EditorContext ec=getEditorContext();
    boolean needsSavingState=ec != null;
    if (getRootCell() != null && getRootCell().getSNode() != null && ((jetbrains.mps.smodel.SNode)getRootCell().getSNode()).isDisposed()) {
      needsSavingState=false;
    }
    if (needsSavingState) {
      jetbrains.mps.openapi.editor.cells.EditorCell sc=getSelectedCell();
      if (sc != null) {
        myRecentlySelectedCellInfo=APICellAdapter.getCellInfo(sc);
      }
      Object memento=ec.createMemento();
      action.run();
      ec.pushTracerTask("restoring memento",true);
      ec.setMemento(memento);
      ec.popTracerTask();
    }
 else {
      action.run();
    }
    myRecentlySelectedCellInfo=null;
  }
  finally {
    myCellSwapInProgress=false;
  }
}
