{
  EditorCell newSelectedCell=myRootCell.findLeaf(mouseEvent.getX(),mouseEvent.getY(),CellConditions.SELECTABLE);
  if (newSelectedCell != null && CellTraversalUtil.getFoldedParent(newSelectedCell) != null) {
    return;
  }
  if (newSelectedCell == null || !newSelectedCell.isSelectable()) {
    newSelectedCell=myRootCell.findCellWeak(mouseEvent.getX(),mouseEvent.getY(),CellConditions.SELECTABLE);
  }
  jetbrains.mps.openapi.editor.cells.EditorCell selectedCell=getSelectedCell();
  if (newSelectedCell != null && (mouseEvent.getButton() != MouseEvent.BUTTON3 || selectedCell == null || !CellTraversalUtil.isAncestor(selectedCell,newSelectedCell))) {
    resetLastCaretX();
    mySelectionManager.setSelection(newSelectedCell);
    newSelectedCell.processMousePressed(mouseEvent);
    revalidateAndRepaint();
  }
}
