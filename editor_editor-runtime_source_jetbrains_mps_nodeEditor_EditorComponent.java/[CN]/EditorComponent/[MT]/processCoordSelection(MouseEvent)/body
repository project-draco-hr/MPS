{
  jetbrains.mps.openapi.editor.cells.EditorCell newSelectedCell=GeometryUtil.findLeaf(myRootCell,mouseEvent.getX(),mouseEvent.getY());
  if (newSelectedCell != null && CellTraversalUtil.getFoldedParent(newSelectedCell) != null) {
    return;
  }
  if (newSelectedCell == null || !newSelectedCell.isSelectable()) {
    newSelectedCell=GeometryUtil.findNearestCell(myRootCell,mouseEvent.getX(),mouseEvent.getY(),jetbrains.mps.openapi.editor.cells.CellConditions.SELECTABLE);
  }
  if (newSelectedCell != null && (mouseEvent.getButton() != MouseEvent.BUTTON3 || !isUnderSelection(getSelectionManager().getSelection(),newSelectedCell))) {
    mySelectionManager.setSelection(newSelectedCell);
    ((EditorCell)newSelectedCell).processMousePressed(mouseEvent);
  }
}
