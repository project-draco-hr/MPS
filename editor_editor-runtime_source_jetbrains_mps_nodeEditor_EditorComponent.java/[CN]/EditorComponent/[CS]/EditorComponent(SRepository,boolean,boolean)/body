{
  setLayout(new EditorComponentLayoutManager(this));
  myRepository=repository;
  myUpdater=createUpdater();
  myUpdater.addListener(new UpdaterEventDispatcher());
  setEditorContext(null,repository);
  setBackground(StyleRegistry.getInstance() == null ? Color.white : StyleRegistry.getInstance().getEditorBackground());
  setFocusCycleRoot(true);
  setFocusTraversalPolicy(new FocusTraversalPolicy(){
    @Override public Component getComponentAfter(    Container aContainer,    Component aComponent){
      if (myIsInFiguresHierarchy) {
        executeComponentAction(CellActionType.NEXT);
      }
      return myIsInFiguresHierarchy ? aContainer : null;
    }
    @Override public Component getComponentBefore(    Container aContainer,    Component aComponent){
      if (myIsInFiguresHierarchy) {
        executeComponentAction(CellActionType.PREV);
      }
      return myIsInFiguresHierarchy ? aContainer : null;
    }
    @Override public Component getFirstComponent(    Container aContainer){
      return myIsInFiguresHierarchy ? aContainer : null;
    }
    @Override public Component getLastComponent(    Container aContainer){
      return myIsInFiguresHierarchy ? aContainer : null;
    }
    @Override public Component getDefaultComponent(    Container aContainer){
      return myIsInFiguresHierarchy ? aContainer : null;
    }
  }
);
  setFocusTraversalKeysEnabled(false);
  setDoubleBuffered(true);
  myScrollPane=ScrollPaneFactory.createScrollPane();
  if (rightToLeft) {
    myScrollPane.setLayout(new LeftHandScrollbarLayout());
  }
  myScrollPane.setVerticalScrollBarPolicy(JScrollPane.VERTICAL_SCROLLBAR_ALWAYS);
  myScrollPane.setVerticalScrollBar(myVerticalScrollBar);
  myScrollPane.setHorizontalScrollBarPolicy(JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED);
  myScrollPane.setViewportView(this);
  myScrollPane.getViewport().addChangeListener(new ChangeListener(){
    @Override public void stateChanged(    ChangeEvent e){
      if (!getNodeSubstituteChooser().isVisible()) {
        return;
      }
      Point point=getNodeSubstituteChooser().calcPatternEditorLocation();
      Rectangle viewRect=getViewport().getViewRect();
      if (isInsideEditor(point,viewRect)) {
        getNodeSubstituteChooser().moveToContextCell();
      }
 else {
        deactivateSubstituteChooser();
      }
    }
    private boolean isInsideEditor(    Point point,    Rectangle viewRect){
      return isShowing() && point != null && point.getX() >= 0 && point.getX() <= getLocationOnScreen().getX() + viewRect.getX() + viewRect.getWidth() && point.getY() >= 0 && point.getY() <= getLocationOnScreen().getY() + viewRect.getY() + viewRect.getHeight()+ myScrollPane.getHorizontalScrollBar().getHeight();
    }
  }
);
  myContainer=new JPanel(){
    @Override public void addNotify(){
      super.addNotify();
      myIsInFiguresHierarchy=true;
    }
    @Override public void removeNotify(){
      myIsInFiguresHierarchy=false;
      super.removeNotify();
    }
  }
;
  myContainer.setMinimumSize(new Dimension(0,0));
  myContainer.setLayout(new BorderLayout());
  myContainer.add(myScrollPane,BorderLayout.CENTER);
  myNodeSubstituteChooser=new NodeSubstituteChooser(this);
  myKbdHandlersStack=new Stack<KeyboardHandler>();
  myKbdHandlersStack.push(new EditorComponentKeyboardHandler(myKeymapHandler));
  myActionMap=new HashMap<CellActionType,CellAction>();
  myActionMap.put(CellActionType.LEFT,new NodeEditorActions.MoveLeft());
  myActionMap.put(CellActionType.RIGHT,new NodeEditorActions.MoveRight());
  CursorPositionTracker cursorPositionTracker=new CursorPositionTracker(getEditorContext());
  myActionMap.put(CellActionType.UP,new NodeEditorActions.MoveUp(cursorPositionTracker));
  myActionMap.put(CellActionType.DOWN,new NodeEditorActions.MoveDown(cursorPositionTracker));
  myActionMap.put(CellActionType.NEXT,new NodeEditorActions.MoveNext());
  myActionMap.put(CellActionType.PREV,new NodeEditorActions.MovePrev());
  myActionMap.put(CellActionType.LOCAL_HOME,new NodeEditorActions.MoveLocal(true));
  myActionMap.put(CellActionType.LOCAL_END,new NodeEditorActions.MoveLocal(false));
  myActionMap.put(CellActionType.ROOT_HOME,new NodeEditorActions.MoveToRoot(true));
  myActionMap.put(CellActionType.ROOT_END,new NodeEditorActions.MoveToRoot(false));
  myActionMap.put(CellActionType.HOME,new NodeEditorActions.MoveHome());
  myActionMap.put(CellActionType.END,new NodeEditorActions.MoveEnd());
  myActionMap.put(CellActionType.PAGE_DOWN,new NodeEditorActions.MovePageUp());
  myActionMap.put(CellActionType.PAGE_UP,new NodeEditorActions.MovePageDown());
  myActionMap.put(CellActionType.SELECT_UP,new NodeEditorActions.SelectUp());
  myActionMap.put(CellActionType.SELECT_DOWN,new NodeEditorActions.SelectDown());
  myActionMap.put(CellActionType.SELECT_RIGHT,new NodeEditorActions.SideSelect(CellSide.RIGHT));
  myActionMap.put(CellActionType.SELECT_LEFT,new NodeEditorActions.SideSelect(CellSide.LEFT));
  myActionMap.put(CellActionType.SELECT_NEXT,new NodeEditorActions.EnlargeSelection(true));
  myActionMap.put(CellActionType.SELECT_PREVIOUS,new NodeEditorActions.EnlargeSelection(false));
  myActionMap.put(CellActionType.COPY,new CellAction_CopyNode());
  myActionMap.put(CellActionType.CUT,new CellAction_CutNode());
  myActionMap.put(CellActionType.PASTE,new CellAction_PasteNode());
  myActionMap.put(CellActionType.PASTE_BEFORE,new CellAction_PasteNodeRelative(true));
  myActionMap.put(CellActionType.PASTE_AFTER,new CellAction_PasteNodeRelative(false));
  myActionMap.put(CellActionType.FOLD,new CellAction_FoldCell());
  myActionMap.put(CellActionType.UNFOLD,new CellAction_UnfoldCell());
  myActionMap.put(CellActionType.FOLD_ALL,new CollapseAllCellAction(true));
  myActionMap.put(CellActionType.UNFOLD_ALL,new CollapseAllCellAction(false));
  myActionMap.put(CellActionType.FOLD_RECURSIVELY,new CollapseRecursivelyCellAction(true));
  myActionMap.put(CellActionType.UNFOLD_RECURSIVELY,new CollapseRecursivelyCellAction(false));
  myActionMap.put(CellActionType.TOGGLE_FOLDING,new CallAction_ToggleCellFolding());
  myActionMap.put(CellActionType.RIGHT_TRANSFORM,new CellAction_SideTransform(CellSide.RIGHT));
  myActionMap.put(CellActionType.LEFT_TRANSFORM,new CellAction_SideTransform(CellSide.LEFT));
  myActionMap.put(CellActionType.COMPLETE,new NodeEditorActions.Complete());
  myActionMap.put(CellActionType.COMPLETE_SMART,new CompleteSmart());
  myActionMap.put(CellActionType.SHOW_MESSAGE,new ShowMessage());
  registerKeyboardAction(new AbstractAction(){
    @Override public void actionPerformed(    ActionEvent e){
      goToNextErrorCell(false);
    }
  }
,KeyStroke.getKeyStroke("F2"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  registerKeyboardAction(new AbstractAction(){
    @Override public void actionPerformed(    ActionEvent e){
      goToNextErrorCell(true);
    }
  }
,KeyStroke.getKeyStroke("shift F2"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  registerKeyboardAction(new AbstractAction(){
    @Override public void actionPerformed(    ActionEvent e){
      goToNextHighlightedCell(false);
    }
  }
,KeyStroke.getKeyStroke("F3"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  registerKeyboardAction(new AbstractAction(){
    @Override public void actionPerformed(    ActionEvent e){
      goToNextHighlightedCell(true);
    }
  }
,KeyStroke.getKeyStroke("shift F3"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  registerKeyboardAction(new AbstractAction(){
    @Override public void actionPerformed(    ActionEvent e){
      final jetbrains.mps.openapi.editor.cells.EditorCell cell=getSelectedCell();
      if (cell == null)       return;
      getModelAccess().runReadAction(new Runnable(){
        @Override public void run(){
          showPopupMenu(cell.getX(),cell.getY());
        }
      }
);
    }
  }
,KeyStroke.getKeyStroke("CONTEXT_MENU"),WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  addMouseListener(new MouseAdapter(){
    @Override public void mousePressed(    final MouseEvent e){
      if (areMouseEventsBlocked()) {
        return;
      }
      if (e.isPopupTrigger()) {
        processPopupMenu(e);
      }
 else {
        processMousePressed(e);
      }
    }
    @Override public void mouseClicked(    MouseEvent e){
      if (areMouseEventsBlocked()) {
        return;
      }
      jetbrains.mps.openapi.editor.cells.EditorCell selectedCell=getSelectedCell();
      boolean inSelectedCell=myRootCell.findLeaf(e.getX(),e.getY()) == selectedCell;
      if (inSelectedCell) {
        Selection selection=getSelectionManager().getSelection();
        if (selection.canExecuteAction(CellActionType.CLICK)) {
          selection.executeAction(CellActionType.CLICK);
        }
 else         if (e.getClickCount() == 2 && selectedCell instanceof EditorCell_Label) {
          ((EditorCell_Label)selectedCell).selectWordOrAll();
          repaintExternalComponent();
        }
      }
    }
    @Override public void mouseReleased(    MouseEvent e){
      if (areMouseEventsBlocked()) {
        return;
      }
      if (e.isPopupTrigger()) {
        processPopupMenu(e);
      }
      super.mouseReleased(e);
    }
  }
);
  addKeyListener(new KeyAdapter(){
    @Override public void keyPressed(    final KeyEvent e){
      processKeyPressed(e);
    }
    @Override public void keyTyped(    KeyEvent e){
      processKeyTyped(e);
    }
    @Override public void keyReleased(    final KeyEvent e){
      processKeyReleased(e);
    }
  }
);
  myMessagesGutter=new MessagesGutter(this,rightToLeft);
  if (showErrorsGutter) {
    getVerticalScrollBar().setPersistentUI(myMessagesGutter);
  }
 else {
    getVerticalScrollBar().setPersistentUI(new ButtonlessScrollBarUI(){
      @Override public boolean alwaysShowTrack(){
        return true;
      }
    }
);
  }
  myLeftHighlighter=new LeftEditorHighlighter(this,rightToLeft);
  myLeftHighlighter.addMouseListener(new MouseAdapter(){
    @Override public void mousePressed(    MouseEvent e){
      for (      LeftMarginMouseListener listener : new ArrayList<LeftMarginMouseListener>(myLeftMarginPressListeners)) {
        listener.mousePressed(e,EditorComponent.this);
      }
    }
    @Override public void mouseReleased(    MouseEvent e){
      for (      LeftMarginMouseListener listener : new ArrayList<LeftMarginMouseListener>(myLeftMarginPressListeners)) {
        listener.mouseReleased(e,EditorComponent.this);
      }
    }
    @Override public void mouseClicked(    MouseEvent e){
      for (      LeftMarginMouseListener listener : new ArrayList<LeftMarginMouseListener>(myLeftMarginPressListeners)) {
        listener.mouseClicked(e,EditorComponent.this);
      }
    }
  }
);
  myScrollPane.setRowHeaderView(myLeftHighlighter);
  addFocusListener(new FocusListener(){
    @Override public void focusGained(    FocusEvent e){
      if (isDisposed()) {
        return;
      }
      if (getSelectionManager().getSelection() == null) {
        EditorCell rootCell=getRootCell();
        if (rootCell instanceof EditorCell_Collection) {
          jetbrains.mps.openapi.editor.cells.EditorCell focusPolicyCell=FocusPolicyUtil.findCellToSelectDueToFocusPolicy(rootCell);
          jetbrains.mps.openapi.editor.cells.EditorCell toSelect;
          if (focusPolicyCell == null || (focusPolicyCell == rootCell && !FocusPolicyUtil.hasFocusPolicy(focusPolicyCell))) {
            toSelect=CellFinderUtil.findChildByManyFinders(rootCell,Finder.FIRST_EDITABLE,Finder.FIRST_SELECTABLE_LEAF);
          }
 else {
            toSelect=focusPolicyCell;
          }
          if (toSelect == null)           toSelect=rootCell;
          changeSelection(toSelect);
          repaintExternalComponent();
          return;
        }
        if (rootCell != null && rootCell.isSelectable()) {
          changeSelection(rootCell);
        }
      }
      repaintExternalComponent();
    }
    @Override public void focusLost(    FocusEvent e){
      repaintExternalComponent();
      if (myNodeSubstituteChooser.getWindow() != null && (myNodeSubstituteChooser.getWindow().isAncestorOf(e.getOppositeComponent()) || myNodeSubstituteChooser.getWindow() == e.getOppositeComponent()))       return;
      deactivateSubstituteChooser();
    }
  }
);
  myIntentionsSupport=new IntentionsSupport(this);
  myAutoValidator=new AutoValidator(this);
  if (MPSToolTipManager.getInstance() != null) {
    MPSToolTipManager.getInstance().registerComponent(this);
  }
  if (CaretBlinker.getInstance() != null) {
    CaretBlinker.getInstance().registerEditor(this);
  }
  KeyboardFocusManager.getCurrentKeyboardFocusManager().addPropertyChangeListener("focusOwner",myFocusListener=new PropertyChangeListener(){
    @Override public void propertyChange(    PropertyChangeEvent evt){
      Component focusOwner=KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner();
      if (EditorComponent.this.isAncestorOf(focusOwner)) {
        Component current=focusOwner;
        while (current.getParent() != EditorComponent.this) {
          current=current.getParent();
        }
        selectComponentCell(current);
      }
    }
  }
);
  attachListeners();
  addFocusListener(new FocusAdapter(){
    @Override public void focusLost(    FocusEvent e){
      commitAll();
    }
  }
);
  getSelectionManager().addSelectionListener(new SelectionListener(){
    @Override public void selectionChanged(    jetbrains.mps.openapi.editor.EditorComponent editorComponent,    Selection oldSelection,    Selection newSelection){
      if (oldSelection == newSelection) {
        return;
      }
      deactivateSubstituteChooser();
      updateStatusBarMessage();
      if (oldSelection != null) {
        for (        jetbrains.mps.openapi.editor.cells.EditorCell editorCell : oldSelection.getSelectedCells()) {
          repaint(editorCell);
        }
      }
      if (newSelection != null) {
        for (        jetbrains.mps.openapi.editor.cells.EditorCell editorCell : newSelection.getSelectedCells()) {
          repaint(editorCell);
        }
      }
    }
  }
);
  enablePasteFromHistory();
}
