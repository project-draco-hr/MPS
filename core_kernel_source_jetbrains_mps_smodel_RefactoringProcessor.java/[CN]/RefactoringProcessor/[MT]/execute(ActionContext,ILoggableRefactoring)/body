{
  final RefactoringContext refactoringContext=new RefactoringContext(refactoring);
  boolean success=refactoring.askForInfo(context,refactoringContext);
  if (!success)   return;
  if (refactoring.showsAffectedNodes()) {
    Thread thread=new Thread(){
      public void run(){
        final boolean toReturn[]=new boolean[]{false};
        ModelAccess.instance().runReadAction(new Runnable(){
          public void run(){
            try {
              ActionContext newContext=new ActionContext(context);
              newContext.put(IOperationContext.class,new ProjectOperationContext(context.getOperationContext().getMPSProject()));
              refactoringContext.setUsages(refactoring.getAffectedNodes(newContext,refactoringContext));
            }
 catch (            Throwable t) {
              LOG.error(t);
              ThreadUtils.runInUIThreadAndWait(new Runnable(){
                public void run(){
                  int promptResult=JOptionPane.showConfirmDialog(context.getFrame(),"An exception occurred during searching affected nodes. Do you want to continue anyway?","Exception",JOptionPane.YES_NO_OPTION);
                  toReturn[0]=promptResult == JOptionPane.NO_OPTION;
                }
              }
);
            }
          }
        }
);
        if (toReturn[0])         return;
        SearchResults usages=refactoringContext.getUsages();
        if (usages == null || (refactoring.refactorImmediatelyIfNoUsages() && usages.getSearchResults().isEmpty())) {
          doExecuteInThread(context,refactoringContext);
        }
 else {
          ThreadUtils.runInUIThreadNoWait(new Runnable(){
            public void run(){
              ModelAccess.instance().runReadAction(new Runnable(){
                public void run(){
                  NewRefactoringView.showRefactoringView(context,refactoringContext);
                }
              }
);
            }
          }
);
        }
      }
    }
;
    thread.start();
  }
 else {
    doExecuteInThread(context,refactoringContext);
  }
}
