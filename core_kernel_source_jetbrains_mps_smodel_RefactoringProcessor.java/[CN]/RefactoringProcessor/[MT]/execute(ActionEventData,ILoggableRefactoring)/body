{
  final RefactoringContext refactoringContext=new RefactoringContext(refactoring);
  refactoringContext.setActionData(data);
  boolean success=refactoring.askForInfo(data,refactoringContext);
  if (!success)   return;
  ModelAccess.instance().runWriteActionInCommand(new Runnable(){
    public void run(){
      if (refactoring.showsAffectedNodes()) {
        Thread thread=new Thread(){
          public void run(){
            final boolean toReturn[]=new boolean[]{false};
            ThreadUtils.runInUIThreadAndWait(new Runnable(){
              public void run(){
                final boolean[] wasError=new boolean[]{false};
                ProgressManager.getInstance().run(new Modal(refactoringContext.getCurrentOperationContext().getComponent(Project.class),"Finding usages...",false){
                  public void run(                  @NotNull ProgressIndicator indicator){
                    indicator.setIndeterminate(true);
                    ModelAccess.instance().runReadAction(new Runnable(){
                      public void run(){
                        try {
                          ActionEventData newContext=data;
                          newContext.put(IOperationContext.class,new ProjectOperationContext(refactoringContext.getSelectedMPSProject()));
                          refactoringContext.setUsages(refactoring.getAffectedNodes(newContext,refactoringContext));
                        }
 catch (                        Throwable t) {
                          LOG.error(t);
                          wasError[0]=true;
                        }
                      }
                    }
);
                  }
                }
);
                if (wasError[0]) {
                  int promptResult=JOptionPane.showConfirmDialog(data.getFrame(),"An exception occurred during searching affected nodes. Do you want to continue anyway?","Exception",JOptionPane.YES_NO_OPTION);
                  toReturn[0]=promptResult == JOptionPane.NO_OPTION;
                }
              }
            }
);
            if (toReturn[0])             return;
            SearchResults usages=refactoringContext.getUsages();
            if (usages == null || (refactoring.refactorImmediatelyIfNoUsages() && usages.getSearchResults().isEmpty())) {
              doExecuteInThread(data,refactoringContext);
            }
 else {
              ThreadUtils.runInUIThreadNoWait(new Runnable(){
                public void run(){
                  ModelAccess.instance().runReadAction(new Runnable(){
                    public void run(){
                      refactoringContext.getCurrentOperationContext().getComponent(NewRefactoringView.class).showRefactoringView(data,new LoggableRefactoringViewAction(refactoringContext),refactoringContext.getUsages());
                    }
                  }
);
                }
              }
);
            }
          }
        }
;
        thread.start();
      }
 else {
        doExecuteInThread(data,refactoringContext);
      }
    }
  }
);
}
