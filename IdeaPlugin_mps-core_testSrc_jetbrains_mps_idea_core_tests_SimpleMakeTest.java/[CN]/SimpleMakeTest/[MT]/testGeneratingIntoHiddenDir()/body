{
  CompilerManagerImpl.testSetup();
  ModuleRootManager mrm=ModuleRootManager.getInstance(myFacet.getModule());
  VirtualFile[] srs=mrm.getSourceRoots();
  assertTrue(srs.length == 2);
  assertEquals("models",srs[0].getName());
  VirtualFile[] children=srs[0].getChildren();
  assertTrue(children.length == 1);
  assertEquals("simple.mps",children[0].getName());
  VirtualFileSystem vfs=VirtualFileManager.getInstance().getFileSystem("file");
  vfs.refresh(false);
  final VirtualFile moduleDir=srs[0].getParent();
  assertTrue(moduleDir.findChild("source_gen") == null);
class Result {
    boolean aborted;
    int errors;
    int warnings;
  }
  final Result res=new Result();
  CompilerManager cm=CompilerManager.getInstance(myFacet.getModule().getProject());
  cm.compile(myFacet.getModule(),new CompileStatusNotification(){
    @Override public void finished(    boolean aborted,    int errors,    int warnings,    CompileContext compileContext){
      res.aborted=aborted;
      res.errors=errors;
      res.warnings=warnings;
    }
  }
);
  assertFalse(res.aborted);
  assertSame(0,res.errors);
  assertSame(0,res.warnings);
  MPSCompiler2[] mpscs=cm.getCompilers(MPSCompiler2.class);
  assertSame(1,mpscs.length);
  VirtualFile outputDir=vfs.findFileByPath(CompilerPaths.getGenerationOutputPath(mpscs[0],myFacet.getModule(),false));
  assertNotNull("Not found output dir",outputDir);
  assertNotNull(outputDir.findFileByRelativePath("simple"));
  assertNotNull(outputDir.findFileByRelativePath("simple/Launchme.java"));
  assertNotNull(outputDir.findFileByRelativePath("simple/trace.info"));
  assertTrue(outputDir.findFileByRelativePath("simple").getChildren().length == 2);
  vfs.refresh(false);
  assertNull("Shouldn't be there: " + moduleDir.getPath() + "/source_gen",moduleDir.findChild("source_gen"));
  assertNotNull(moduleDir.findChild("classes_gen"));
  assertNotNull(moduleDir.findFileByRelativePath("classes_gen/simple"));
  assertTrue(moduleDir.findFileByRelativePath("classes_gen/simple").getChildren().length == 1);
  assertNotNull(moduleDir.findFileByRelativePath("classes_gen/simple/trace.info"));
  VirtualFile cachesOutputDir=vfs.findFileByPath(MPSCompilerPaths.getCachesOutputPath(mpscs[0],myFacet.getModule(),false));
  assertNotNull("Not found output dir",cachesOutputDir);
  assertNotNull(cachesOutputDir.findFileByRelativePath("simple"));
}
