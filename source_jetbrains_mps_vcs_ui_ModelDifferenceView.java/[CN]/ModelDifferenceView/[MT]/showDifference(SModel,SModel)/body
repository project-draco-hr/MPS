{
  myNewModel=newModel;
  DiffBuilder builder=new DiffBuilder(oldModel,newModel);
  final List<Change> changes=builder.getChanges();
  myChanges=changes;
  for (  AddRootChange ar : CollectionUtil.filter(AddRootChange.class,changes)) {
    myAddedNodes.add(ar.getNodeId());
  }
  for (  AddNodeChange an : CollectionUtil.filter(AddNodeChange.class,changes)) {
    myAddedNodes.add(an.getNodeId());
  }
  for (  SetNodeChange c : CollectionUtil.filter(SetNodeChange.class,changes)) {
    myAddedNodes.add(c.getNodeId());
  }
  for (  SetPropertyChange p : CollectionUtil.filter(SetPropertyChange.class,changes)) {
    myChangedNodes.add(p.getNodeId());
  }
  for (  SetReferenceChange r : CollectionUtil.filter(SetReferenceChange.class,changes)) {
    myChangedNodes.add(r.getNodeId());
  }
  updateView();
  myModelTree.runWithoutExpansion(new Runnable(){
    public void run(){
      for (      Change c : changes) {
        if (c instanceof NewNodeChange) {
          NewNodeChange nnc=(NewNodeChange)c;
          if (nnc.getNodeParent() == null || !myAddedNodes.contains(nnc.getNodeParent())) {
            expandNode(c.getAffectedNodeId());
          }
        }
 else         if (c instanceof SetPropertyChange || c instanceof SetReferenceChange) {
          String id=c.getAffectedNodeId();
          if (!myAddedNodes.contains(id)) {
            expandNode(id);
          }
        }
 else         if (c instanceof DeleteNodeChange) {
        }
 else {
          expandNode(c.getAffectedNodeId());
        }
      }
    }
  }
);
  return this;
}
