{
  Map<Edge,Integer> capacity=MapSequence.<Edge,Integer>fromMap(new HashMap<Edge,Integer>());
  Node source=graph.createNode();
  Node target=graph.createNode();
  for (  Edge edge : ListSequence.<Edge>fromList(graph.getEdges())) {
    MapSequence.<Edge,Integer>fromMap(capacity).put(edge,MapSequence.<Edge,Integer>fromMap(initialCapacity).get(edge) - MapSequence.<Edge,Integer>fromMap(low).get(edge));
  }
  for (  Node node : ListSequence.<Node>fromList(graph.getNodes())) {
    if (node == source || node == target) {
      continue;
    }
    int diff=0;
    for (    Edge edge : ListSequence.<Edge>fromList(node.getInEdges())) {
      diff+=MapSequence.<Edge,Integer>fromMap(low).get(edge);
    }
    for (    Edge edge : ListSequence.<Edge>fromList(node.getOutEdges())) {
      diff-=MapSequence.<Edge,Integer>fromMap(low).get(edge);
    }
    Edge newEdge=null;
    if (diff > 0) {
      newEdge=graph.connect(source,node);
    }
    if (diff < 0) {
      newEdge=graph.connect(node,target);
    }
    if (newEdge != null) {
      MapSequence.<Edge,Integer>fromMap(capacity).put(newEdge,Math.abs(diff));
      MapSequence.<Edge,Integer>fromMap(cost).put(newEdge,0);
    }
  }
  Map<Edge,Integer> flow;
  if (TEST_MODE > 0) {
    flow=MinCostMaxFlowWithPotentials.getFlow(graph,source,target,capacity,cost);
  }
 else {
    flow=MinCostMaxFlow.getFlow(graph,source,target,capacity,cost);
  }
  for (  Edge edge : ListSequence.<Edge>fromList(source.getEdges()).concat(ListSequence.<Edge>fromList(target.getEdges()))) {
    MapSequence.fromMap(flow).removeKey(edge);
  }
  graph.deleteNode(source);
  graph.deleteNode(target);
  for (  Edge edge : ListSequence.<Edge>fromList(graph.getEdges())) {
    MapSequence.<Edge,Integer>fromMap(flow).put(edge,MapSequence.<Edge,Integer>fromMap(flow).get(edge) + MapSequence.<Edge,Integer>fromMap(low).get(edge));
  }
  return flow;
}
