{
  if (template == null) {
    myGenerator.showErrorMessage(context.getInput(),macro,"couldn't evaluate weave macro: no template");
    return;
  }
  List<SNode> templateFragments=GeneratorUtilEx.getTemplateFragments(template);
  if (templateFragments.isEmpty()) {
    myGenerator.showErrorMessage(context.getInput(),template,macro,"nothing to weave: no template fragments found in template");
    return;
  }
  TemplateWeavingRuleInterpreted.checkTemplateFragmentsForWeaving(template,templateFragments,myGenerator.getLogger());
  TemplateProcessor templateProcessor=new TemplateProcessor(myEnv);
  for (  SNode templateFragment : templateFragments) {
    SNode templateFragmentNode=templateFragment.getParent();
    SNode contextParentNode=null;
    try {
      contextParentNode=myEnv.getQueryExecutor().getContextNodeForTemplateFragment(templateFragmentNode,outputContextNode,context);
    }
 catch (    Exception e) {
      myGenerator.getLogger().handleException(e);
    }
    if (contextParentNode != null) {
      try {
        List<SNode> outputNodesToWeave=templateProcessor.apply(GeneratorUtilEx.getMappingName(templateFragment,null),templateFragmentNode,context);
        String childRole=templateFragmentNode.getRoleInParent();
        for (        SNode outputNodeToWeave : outputNodesToWeave) {
          myEnv.weaveNode(contextParentNode,childRole,outputNodeToWeave,new jetbrains.mps.smodel.SNodePointer(templateFragment),context.getInput());
        }
      }
 catch (      DismissTopMappingRuleException e) {
        myGenerator.showErrorMessage(context.getInput(),templateFragment,macro,"wrong template: dismiss in weave macro is not supported");
      }
catch (      TemplateProcessingFailureException ex) {
        ProblemDescription[] pd=new ProblemDescription[]{GeneratorUtil.describe(templateFragmentNode,"template fragment"),GeneratorUtil.describe(context.getInput(),"input node"),GeneratorUtil.describe(contextParentNode,"output context node")};
        myGenerator.getLogger().error(macro.getReference(),"error processing template fragment",GeneratorUtil.concat(pd,ex.asProblemDescription()));
      }
    }
 else {
      myGenerator.showErrorMessage(context.getInput(),templateFragment,macro,"couldn't define 'context' for template fragment");
    }
  }
}
