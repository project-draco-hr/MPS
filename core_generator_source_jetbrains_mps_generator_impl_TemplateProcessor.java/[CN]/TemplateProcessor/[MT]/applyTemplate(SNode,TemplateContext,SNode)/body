{
  SNode nextMacro=nextMacro(templateNode,prevMacro);
  if (nextMacro != null) {
    myTracer.pushMacro(new jetbrains.mps.smodel.SNodePointer(nextMacro));
    try {
      String macroConceptFQName=nextMacro.getConcept().getQualifiedName();
      MacroImpl macroImpl=macroImplMap.get(macroConceptFQName);
      if (macroImpl == null) {
        macroImpl=new NoMacro(this);
      }
      return macroImpl.apply(nextMacro,templateNode,context.subContext(GeneratorUtilEx.getMappingName_NodeMacro(nextMacro,null)));
    }
  finally {
      myTracer.closeMacro(new jetbrains.mps.smodel.SNodePointer(nextMacro));
    }
  }
  final SNodePointer templateNodeReference=new SNodePointer(templateNode);
  myTracer.pushTemplateNode(templateNodeReference);
  SNode outputNode=myOutputModel.createNode(templateNode.getConcept());
  myEnv.nodeCopied(context,outputNode,GeneratorUtil.getTemplateNodeId(templateNode));
  myGenerator.registerMappingLabel(context.getInput(),context.getInputName(),outputNode);
  jetbrains.mps.util.SNodeOperations.copyProperties(templateNode,outputNode);
  SModel templateModel=templateNode.getModel();
  for (  SReference reference : templateNode.getReferences()) {
    if (GeneratorUtilEx.getReferenceMacro(templateNode,reference.getRole()) != null) {
      continue;
    }
    if (reference instanceof StaticReference) {
      SModelReference targetModelReference=reference.getTargetSModelReference();
      if (targetModelReference != null && !(templateModel.getReference().equals(targetModelReference))) {
        SReference newReference=new StaticReference(reference.getRole(),outputNode,targetModelReference,reference.getTargetNodeId(),((StaticReference)reference).getResolveInfo());
        outputNode.setReference(reference.getRole(),newReference);
        continue;
      }
    }
    SNode templateReferentNode=reference.getTargetNode();
    if (templateReferentNode == null) {
      myGenerator.getLogger().error(templateNode.getReference(),"cannot resolve reference in template model; role: " + reference.getRole() + " in "+ org.jetbrains.mps.openapi.model.SNodeUtil.getDebugText(templateNode));
      continue;
    }
    if (templateReferentNode.getModel() == templateModel) {
      String resolveInfo=SNodeOperations.getResolveInfo(templateReferentNode);
      ReferenceInfo_Template refInfo=new ReferenceInfo_Template(outputNode,reference.getRole(),templateNodeReference,GeneratorUtil.getTemplateNodeId(templateReferentNode),resolveInfo,context);
      PostponedReference postponedReference=new PostponedReference(refInfo,myGenerator);
      postponedReference.setReferenceInOutputSourceNode();
    }
 else {
      outputNode.setReferenceTarget(reference.getRole(),templateReferentNode);
    }
  }
  List<SNode> templateChildNodes=new ArrayList<SNode>();
  for (  SNode templateChildNode : templateNode.getChildren()) {
    if (GeneratorUtilEx.isTemplateLanguageElement(templateChildNode)) {
      String templateChildNodeConcept=templateChildNode.getConcept().getQualifiedName();
      if (templateChildNodeConcept.equals(RuleUtil.concept_PropertyMacro)) {
        myEnv.getQueryExecutor().expandPropertyMacro(templateChildNode,context.getInput(),templateNode,outputNode,context);
      }
 else       if (templateChildNodeConcept.equals(RuleUtil.concept_ReferenceMacro)) {
        final String refMacroRole=AttributeOperations.getLinkRole(templateChildNode);
        MacroResolver mr=new MacroResolver(myEnv.getQueryExecutor(),templateChildNode,templateNode.getReferenceTarget(refMacroRole));
        ReferenceInfo_Macro refInfo=new ReferenceInfo_Macro(mr,outputNode,refMacroRole,context);
        PostponedReference postponedReference=new PostponedReference(refInfo,myGenerator);
        postponedReference.setReferenceInOutputSourceNode();
      }
    }
 else {
      templateChildNodes.add(templateChildNode);
    }
  }
  context=context.subContext();
  try {
    for (    SNode templateChildNode : templateChildNodes) {
      List<SNode> outputChildNodes=applyTemplate(templateChildNode,context,null);
      if (outputChildNodes != null) {
        SConcept originalConcept=templateChildNode.getConcept();
        String role=templateChildNode.getRoleInParent();
        RoleValidator validator=myGenerator.getChildRoleValidator(outputNode,role);
        for (        SNode outputChildNode : outputChildNodes) {
          final boolean notSubConcept=!(outputChildNode.getConcept().isSubConceptOf(originalConcept));
          if (notSubConcept) {
            RoleValidationStatus status=validator.validate(outputChildNode);
            if (status != null) {
              status.reportProblem(false,outputNode,"",GeneratorUtil.describe(context.getInput(),"input"),GeneratorUtil.describe(templateNode,"parent in template"),GeneratorUtil.describe(templateChildNode,"child in template"));
            }
          }
          outputNode.addChild(role,outputChildNode);
        }
      }
    }
  }
  finally {
    myTracer.pushOutputNode(GenerationTracerUtil.getSNodePointer(myOutputModel,outputNode));
    myTracer.closeTemplateNode(templateNodeReference);
  }
  return Collections.singletonList(outputNode);
}
