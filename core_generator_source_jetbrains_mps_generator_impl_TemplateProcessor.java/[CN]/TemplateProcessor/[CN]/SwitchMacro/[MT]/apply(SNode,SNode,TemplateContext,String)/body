{
  SNode templateSwitch=getTemplateSwitch(macro);
  if (templateSwitch == null) {
    showErrorMessage(templateContext.getInput(),null,macro,"error processing $SWITCH$ - bad TemplateSwitch reference");
    throw new TemplateProcessingFailureException();
  }
  final SNodeReference switchPtr=new jetbrains.mps.smodel.SNodePointer(templateSwitch);
  SNode newInputNode=getNewInputNode(macro,templateContext);
  if (newInputNode == null) {
    TemplateSwitchMapping tswitch=getGenerator().getSwitch(switchPtr);
    if (tswitch != null) {
      tswitch.processNull(myTemplateProcessor.myEnv,switchPtr,templateContext);
    }
    return Collections.emptyList();
  }
  boolean inputChanged=(newInputNode != templateContext.getInput());
  if (inputChanged) {
    myTracer.pushInputNode(GenerationTracerUtil.getSNodePointer(newInputNode));
  }
  myTracer.pushSwitch(new jetbrains.mps.smodel.SNodePointer(templateSwitch));
  try {
    final TemplateContext switchContext=prepareContext(macro,mappingName,templateContext,newInputNode);
    Collection<SNode> collection=null;
    try {
      collection=myTemplateProcessor.myEnv.trySwitch(switchPtr,mappingName,switchContext);
    }
 catch (    GenerationCanceledException e) {
      throw e;
    }
catch (    GenerationFailureException e) {
      throw e;
    }
catch (    DismissTopMappingRuleException e) {
      throw e;
    }
catch (    GenerationException e) {
      showErrorMessage(null,switchPtr.resolve(MPSModuleRepository.getInstance()),macro,"internal error in switch.applyDefault: " + e.toString());
    }
    if (collection == null) {
      collection=myTemplateProcessor.applyTemplate(mappingName,templateNode,templateContext.subContext(mappingName,newInputNode),macro);
    }
    return new ArrayList<SNode>(collection);
  }
  finally {
    if (inputChanged) {
      myTracer.closeInputNode(GenerationTracerUtil.getSNodePointer(newInputNode));
    }
  }
}
