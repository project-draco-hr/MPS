{
  List<SNode> _outputNodes=nextMacro(templateContext);
  if (_outputNodes.isEmpty()) {
    return Collections.emptyList();
  }
  if (_outputNodes.size() > 1) {
    getLogger().error(macro.getReference(),"cannot apply $WEAVE$ to a list of nodes",GeneratorUtil.describe(templateContext.getInput(),"input"));
    return _outputNodes;
  }
  SNode consequence=RuleUtil.getWeaveMacro_Consequence(macro);
  if (consequence == null) {
    getLogger().error(macro.getReference(),"couldn't evaluate weave macro: no consequence",GeneratorUtil.describeIfExists(templateContext.getInput(),"input"));
    return _outputNodes;
  }
  SNode template=RuleUtil.getTemplateDeclarationReference_Template(consequence);
  if (template == null) {
    getLogger().error(macro.getReference(),"couldn't evaluate weave macro: no template",GeneratorUtil.describeIfExists(templateContext.getInput(),"input"));
    return _outputNodes;
  }
  WeaveTemplateContainer wtc=new WeaveTemplateContainer(template,this);
  wtc.initialize(getLogger());
  SNode contextNode=_outputNodes.get(0);
  for (  SNode node : getNewInputNodes(templateContext)) {
    wtc.apply(contextNode,templateContext.subContext(node));
  }
  return _outputNodes;
}
