{
  SNode newInputNode=getNewInputNode(templateContext);
  if (newInputNode == null) {
    return Collections.emptyList();
  }
  SNode invokedTemplate=myInvokedTemplate;
  if (invokedTemplate == null) {
    throw new TemplateProcessingFailureException(macro,String.format("error processing %s : no template to invoke",myName));
  }
  TemplateContext newcontext=prepareContext(templateContext).subContext(newInputNode);
  if (newcontext == null) {
    throw new TemplateProcessingFailureException(macro,String.format("error processing %s : failed to prepare new context",myName),GeneratorUtil.describe(invokedTemplate,"invoked template"));
  }
  final TemplateContainer tc=getTemplates();
  final List<SNode> rv=tc.processRuleConsequence(newcontext);
  templateContext.getEnvironment().getTrace().trace(newInputNode.getNodeId(),GenerationTracerUtil.translateOutput(rv),getMacroNodeRef());
  return rv;
}
