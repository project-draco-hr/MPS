{
  Collection<SNode> newInputNodes=getNewInputNodes(templateContext);
  if (newInputNodes.isEmpty()) {
    return Collections.emptyList();
  }
  final GenerationTrace trace=templateContext.getEnvironment().getTrace();
  String counterVarName=RuleUtil.getLoopMacroCounterVarName(macro);
  ArrayList<SNode> outputNodes=new ArrayList<SNode>();
  int i=0;
  for (  SNode newInputNode : newInputNodes) {
    TemplateContext ctx=templateContext;
    if (counterVarName != null) {
      ctx=ctx.withVariable("cv:" + counterVarName,i);
    }
    ctx=ctx.subContext(newInputNode);
    List<SNode> _outputNodes=nextMacro(ctx);
    outputNodes.addAll(_outputNodes);
    i++;
    trace.trace(newInputNode.getNodeId(),GenerationTracerUtil.translateOutput(_outputNodes),getMacroNodeRef());
  }
  return outputNodes;
}
