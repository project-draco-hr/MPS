{
  if (getContentsStack().size() != 1) {
    throw new IllegalStateException("Can't get text, because there is open content block [" + getContentsStack().peek().getName() + "]");
  }
  notify(new ListenerVisitor(){
    public void visit(    TBaseBuilderContextListener l){
      l.getTextCalled(TBaseBuilderContext.this);
    }
  }
);
  if (getContents().size() == 1) {
    return myBuffer.getText();
  }
  StringBuilder res=new StringBuilder();
  List<TContent> sortedContents=new ArrayList<TContent>(getContents().values());
  sortedContents.remove(getContentsStack().peek());
  Collections.sort(sortedContents,new Comparator<TContent>(){
    public int compare(    TContent o1,    TContent o2){
      return o2.getPosition() - o1.getPosition();
    }
  }
);
  for (  TContent c : sortedContents) {
    if (c.getPosition() == -1) {
      Logger.getLogger(TBaseBuilderContext.class.getName()).info("There is no placeholder for content [" + c.getName() + "]");
    }
 else {
      myBuffer.getStringBuilder().insert(c.getPosition(),c.getBuf().getText());
    }
  }
  return myBuffer.getText();
}
