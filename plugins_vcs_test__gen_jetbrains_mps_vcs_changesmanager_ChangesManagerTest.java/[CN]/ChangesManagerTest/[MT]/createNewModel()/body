{
  final Wrappers._T<CurrentDifference> newModelDiff=new Wrappers._T<CurrentDifference>();
  ModelAccess.instance().runReadAction(new Runnable(){
    public void run(){
      String modelName="newmodel";
      IModule module=myUiDiff.getModelDescriptor().getModule();
      module.createModel(SModelFqName.fromString(MODEL_PREFIX + modelName),module.getSModelRoots().iterator().next(),null);
      newModelDiff.value=getCurrentDifference(modelName);
    }
  }
);
  final EditableSModelDescriptor md=newModelDiff.value.getModelDescriptor();
  ModelAccess.instance().runWriteInEDT(new Runnable(){
    public void run(){
      md.getSModel();
      md.save();
    }
  }
);
  ModelAccess.instance().flushEventQueue();
  final VirtualFile vf=VirtualFileUtils.getVirtualFile(((DefaultSModelDescriptor)md).getModelFile());
  doSomethingAndWaitForFileStatusChange(new Runnable(){
    public void run(){
    }
  }
,vf,FileStatus.UNKNOWN);
  newModelDiff.value.setEnabled(true);
  waitForChangesManager();
  Assert.assertTrue((int)ListSequence.fromList(check_4gxggu_a0a0l0lb(newModelDiff.value.getChangeSet())).count() == 0);
  checkRootStatuses();
  runCommandAndWait(new Runnable(){
    public void run(){
      SModel m=md.getSModel();
      m.addLanguage(ModuleReference.fromString("f3061a53-9226-4cc5-a443-f952ceaf5816(jetbrains.mps.baseLanguage)"));
      createNewRoot(m);
    }
  }
);
  checkOneAddedRoot(newModelDiff.value);
  MapSequence.fromMap(myExpectedFileStatuses).put("newmodel.NewRoot",FileStatus.UNKNOWN);
  checkRootStatuses();
  doSomethingAndWaitForFileStatusChange(new Runnable(){
    public void run(){
      myChangeListManager.addUnversionedFiles(myChangeListManager.getDefaultChangeList(),Arrays.asList(vf));
    }
  }
,vf,null);
  myChangeListManager.ensureUpToDate(false);
  checkOneAddedRoot(newModelDiff.value);
  MapSequence.fromMap(myExpectedFileStatuses).put("newmodel.NewRoot",FileStatus.ADDED);
  checkRootStatuses();
}
