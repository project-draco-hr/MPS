{
  List<SReference> references=new ArrayList<SReference>((List<SReference>)jetbrains.mps.util.SNodeOperations.getReferences(node));
  for (  SReference reference : references) {
    SNode oldNode=reference.getTargetNode();
    if (TypesUtil.isVariable(oldNode)) {
      SNode newNode=expandNode(oldNode,variablesMet,finalExpansion,false);
      if (finalExpansion && TypesUtil.isVariable(newNode)) {
        newNode=convertReferentVariable(node,reference.getRole(),newNode);
      }
      if (newNode != oldNode) {
        String role=reference.getRole();
        node.removeReference(reference);
        node.setReferenceTarget(role,newNode);
      }
    }
  }
}
