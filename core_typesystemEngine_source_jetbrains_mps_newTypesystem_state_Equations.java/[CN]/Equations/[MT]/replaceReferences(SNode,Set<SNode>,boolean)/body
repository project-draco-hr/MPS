{
  List<SReference> references=new ArrayList<SReference>(node.getReferences());
  for (  SReference reference : references) {
    SNode oldNode=reference.getTargetNode();
    if (TypesUtil.isVariable(oldNode)) {
      SNode newNode=expandNode(oldNode,variablesMet,finalExpansion);
      if (finalExpansion && TypesUtil.isVariable(newNode)) {
        newNode=convertReferentVariable(node,reference.getRole(),newNode);
      }
      if (newNode != oldNode) {
        String role=reference.getRole();
        node.removeReference(reference);
        node.setReferent(role,newNode);
      }
    }
  }
}
