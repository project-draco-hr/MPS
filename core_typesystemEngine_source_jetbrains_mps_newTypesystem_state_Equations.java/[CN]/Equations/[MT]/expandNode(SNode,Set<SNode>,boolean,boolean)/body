{
  if (node == null) {
    return null;
  }
  SNode type=getRepresentativeNoShortenPaths(node);
  if (finalExpansion && LatticeUtil.isMeet(type)) {
    Set<SNode> newArgs=new THashSet<SNode>();
    final List<SNode> arguments=LatticeUtil.getMeetArguments(type);
    boolean addTheRest=false;
    for (    SNode arg : arguments) {
      if (arg != null && (addTheRest || !SNodeOperations.isInstanceOf(arg,"jetbrains.mps.baseLanguage.structure.VoidType"))) {
        newArgs.add(arg);
      }
 else {
        addTheRest=true;
      }
    }
    if (newArgs.size() != arguments.size()) {
      type=LatticeUtil.meetNodes(newArgs);
    }
  }
  if (type != node) {
    SNode result=expandNode(type,variablesMet,finalExpansion,copy);
    variablesMet.remove(type);
    return result;
  }
 else {
    SNode result=copy ? CopyUtil.copy(node) : node;
    replaceChildren(result,variablesMet,finalExpansion,copy);
    replaceReferences(result,variablesMet,finalExpansion);
    return result;
  }
}
