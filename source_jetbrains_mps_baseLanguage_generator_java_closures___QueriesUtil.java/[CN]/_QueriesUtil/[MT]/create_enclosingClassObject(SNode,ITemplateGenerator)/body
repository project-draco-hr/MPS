{
  SNode enclosingClass=SNodeOperations.getAncestor(nodeInsideClosure,"jetbrains.mps.baseLanguage.structure.ClassConcept",false,false);
  if (enclosingClass != null) {
    Class[] classes=new Class[]{BaseMethodDeclaration.class,Closure.class};
    INodeAdapter enclosingNode=nodeInsideClosure.getAdapter().findFirstParent(classes);
    if (enclosingNode instanceof InstanceMethodDeclaration || enclosingNode instanceof ConstructorDeclaration) {
      ThisExpression thisExpr=ThisExpression.newInstance(generator.getTargetModel());
      thisExpr.setClassConcept((ClassConcept)enclosingClass.getAdapter());
      return thisExpr.getNode();
    }
    if (enclosingNode instanceof Closure) {
      InternalPartialFieldReference fieldRef_intern=InternalPartialFieldReference.newInstance(null);
      fieldRef_intern.setInstance(ThisExpression.newInstance(null));
      fieldRef_intern.setFieldName(ClosuresMappingId.NAME__CLOSURE_ADAPTER__ENCLOSING_CLASS_FIELD);
      ClassifierType typeOfField=ClassifierType.newInstance(null);
      typeOfField.setClassifier((Classifier)enclosingClass.getAdapter());
      fieldRef_intern.setFieldType(typeOfField);
      return fieldRef_intern.getNode();
    }
  }
  return NullLiteral.newInstance(generator.getTargetModel()).getNode();
}
