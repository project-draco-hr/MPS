{
  final ModelLoadResult[] result=new ModelLoadResult[1];
  final boolean[] wasException={false};
  final boolean[] correctVersion={true};
  ApplicationManager.getApplication().invokeAndWait(new Runnable(){
    @Override public void run(){
      ModelAccess.instance().runWriteAction(new Runnable(){
        @Override public void run(){
          upgradePersistence(testModel,finalToVersion);
          correctVersion[0]=testModel.getPersistenceVersion() == finalToVersion;
          try {
            result[0]=ModelPersistence.readModel(SModelHeader.create(finalToVersion),(StreamDataSource)testModel.getSource(),ModelLoadingState.FULLY_LOADED);
          }
 catch (          ModelReadException e) {
            e.printStackTrace();
            wasException[0]=true;
          }
        }
      }
);
    }
  }
,ModalityState.NON_MODAL);
  assertTrue(correctVersion[0]);
  assertFalse(wasException[0]);
  assertNotNull(result[0]);
  assertTrue(result[0].getState().equals(ModelLoadingState.FULLY_LOADED));
  ModelAccess.instance().runReadAction(new Runnable(){
    @Override public void run(){
      ModelAssert.assertDeepModelEquals(resultFrom.getModel(),result[0].getModel());
    }
  }
);
  waitEDT();
}
