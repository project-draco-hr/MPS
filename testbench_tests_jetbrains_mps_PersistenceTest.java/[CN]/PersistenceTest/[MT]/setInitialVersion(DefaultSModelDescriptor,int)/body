{
  final boolean[] correctPersistenceVersion=new boolean[1];
  final ModelLoadResult[] result=new ModelLoadResult[1];
  final boolean[] wasException={false};
  ApplicationManager.getApplication().invokeAndWait(new Runnable(){
    @Override public void run(){
      ModelAccess.instance().runWriteAction(new Runnable(){
        @Override public void run(){
          try {
            if (fromVersion > START_PERSISTENCE_TEST_VERSION) {
              upgradePersistence(testModel,fromVersion);
              correctPersistenceVersion[0]=testModel.getPersistenceVersion() == fromVersion;
            }
            result[0]=ModelPersistence.readModel(SModelHeader.create(fromVersion),(StreamDataSource)testModel.getSource(),ModelLoadingState.FULLY_LOADED);
          }
 catch (          ModelReadException e) {
            wasException[0]=true;
          }
        }
      }
);
    }
  }
,ModalityState.NON_MODAL);
  assertFalse(wasException[0]);
  assertTrue(correctPersistenceVersion[0]);
  assertNotNull(result[0]);
  assertTrue(result[0].getState() == ModelLoadingState.FULLY_LOADED);
  waitEDT();
  return result[0];
}
