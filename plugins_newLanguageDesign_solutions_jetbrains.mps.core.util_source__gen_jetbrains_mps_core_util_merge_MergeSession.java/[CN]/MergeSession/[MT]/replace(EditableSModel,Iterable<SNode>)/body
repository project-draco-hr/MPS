{
  jetbrains.mps.smodel.SModel existing=((SModelBase)model).getSModelInternal();
  if (existing == null) {
    messageHandler.handle(new Message(MessageKind.ERROR,"no " + SModelStereotype.withoutStereotype(model.getModelName()) + " model"));
    return;
  }
  final jetbrains.mps.smodel.SModel newmodel=existing.createEmptyCopy();
  existing.copyPropertiesTo(newmodel);
  SModel newsmodel=newmodel.getReference().resolve(MPSModuleRepository.getInstance());
  Sequence.fromIterable(mergeLists((Iterable<SNode>)model.getRootNodes(),roots,newsmodel)).visitAll(new IVisitor<SNode>(){
    public void visit(    SNode it){
      newmodel.addRootNode(it);
    }
  }
);
  MapSequence.fromMap(newContent).put(model,newsmodel);
}
