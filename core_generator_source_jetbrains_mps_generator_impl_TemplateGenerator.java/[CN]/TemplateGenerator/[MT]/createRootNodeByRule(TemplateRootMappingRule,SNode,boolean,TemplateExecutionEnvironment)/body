{
  try {
    Collection<SNode> outputNodes=environment.getReductionContext().getQueryExecutor().applyRule(rule,environment,new DefaultTemplateContext(inputNode));
    if (outputNodes == null) {
      return;
    }
    for (    SNode outputNode : outputNodes) {
      registerRoot(outputNode,inputNode,rule.getRuleNode(),false);
      setChanged();
      outputNode.putUserObject(TemplateQueryContext.ORIGINAL_INPUT_NODE,inputNode.getUserObject(TemplateQueryContext.ORIGINAL_INPUT_NODE));
    }
    if (inputNode.getModel() == getGeneratorSessionContext().getOriginalInputModel()) {
      for (      SNode outputNode : outputNodes) {
        outputNode.putUserObject(TemplateQueryContext.ORIGINAL_INPUT_NODE,inputNode);
      }
    }
  }
 catch (  DismissTopMappingRuleException e) {
    if (copyRootOnFailure && inputNode.isRoot()) {
      copyRootNodeFromInput(inputNode,environment);
    }
  }
catch (  TemplateProcessingFailureException e) {
    showErrorMessage(inputNode,rule.getRuleNode().getNode(),"couldn't create root node");
  }
catch (  GenerationException e) {
    if (e instanceof GenerationCanceledException)     throw (GenerationCanceledException)e;
    if (e instanceof GenerationFailureException)     throw (GenerationFailureException)e;
    showErrorMessage(inputNode,rule.getRuleNode().getNode(),"internal error: " + e.toString());
  }
}
