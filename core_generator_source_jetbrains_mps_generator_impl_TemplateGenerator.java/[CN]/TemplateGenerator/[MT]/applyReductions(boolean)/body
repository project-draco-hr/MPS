{
  if (isPrimary) {
    ttrace.push("create roots",false);
    final QueryExecutionContext executionContext=getExecutionContext(null);
    if (executionContext != null) {
      TemplateExecutionEnvironment environment=new TemplateExecutionEnvironmentImpl(this,executionContext,new ReductionContext());
      for (      TemplateCreateRootRule rule : myRuleManager.getCreateRootRules()) {
        checkMonitorCanceled();
        applyCreateRoot(rule,environment);
      }
    }
    ttrace.pop();
  }
  ttrace.push("root mappings",false);
  ArrayList<SNode> rootsConsumed=new ArrayList<SNode>();
  for (  TemplateRootMappingRule rule : myRuleManager.getRoot_MappingRules()) {
    checkMonitorCanceled();
    applyRootRule(rule,rootsConsumed);
  }
  ArrayList<SNode> rootsToCopy=new ArrayList<SNode>();
  for (  SNode root : myInputModel.getRootNodes()) {
    rootsToCopy.add(root);
  }
  rootsToCopy.removeAll(rootsConsumed);
  ttrace.pop();
  if (!isPrimary && !myChanged && rootsConsumed.isEmpty()) {
    if (myWeavingProcessor.hasWeavingRulesToApply()) {
      myLogger.info("Could have had delta builder here, but can't due to active weavings");
    }
 else {
      myDeltaBuilder=new DeltaBuilder();
    }
  }
  checkMonitorCanceled();
  getGeneratorSessionContext().clearCopiedRootsSet();
  for (  SNode rootToCopy : rootsToCopy) {
    QueryExecutionContext context=getExecutionContext(rootToCopy);
    if (context != null) {
      TemplateExecutionEnvironmentImpl rootenv=new TemplateExecutionEnvironmentImpl(this,context,new ReductionContext());
      copyRootInputNode(rootToCopy,rootenv);
    }
  }
}
