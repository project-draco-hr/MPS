{
  if (isInplaceChangeEnabled()) {
    if (myWeavingProcessor.hasWeavingRulesToApply()) {
      getLogger().info("Could have had delta builder here, but can't due to active weavings");
    }
 else {
      getLogger().info("Active in-place model transformation");
      myDeltaBuilder=createDeltaBuilder();
    }
  }
  final IPerformanceTracer ttrace=getGeneratorSessionContext().getPerformanceTracer();
  if (isPrimary) {
    ttrace.push("create roots",false);
    final QueryExecutionContext executionContext=getExecutionContext(null);
    if (executionContext != null) {
      TemplateExecutionEnvironment environment=new TemplateExecutionEnvironmentImpl(myTemplateProcessor,executionContext);
      for (      TemplateCreateRootRule rule : myRuleManager.getCreateRootRules()) {
        checkMonitorCanceled();
        applyCreateRoot(rule,environment);
      }
    }
    ttrace.pop();
  }
  ttrace.push("root mappings",false);
  ArrayList<SNode> rootsConsumed=new ArrayList<SNode>();
  for (  TemplateRootMappingRule rule : myRuleManager.getRoot_MappingRules()) {
    checkMonitorCanceled();
    applyRootRule(rule,rootsConsumed);
  }
  ttrace.pop();
  getGeneratorSessionContext().clearCopiedRootsSet();
  for (  SNode rootToCopy : myInputModel.getRootNodes()) {
    if (rootsConsumed.contains(rootToCopy)) {
      continue;
    }
    QueryExecutionContext context=getExecutionContext(rootToCopy);
    if (context != null) {
      TemplateExecutionEnvironmentImpl rootenv=new TemplateExecutionEnvironmentImpl(myTemplateProcessor,context);
      copyRootInputNode(rootToCopy,rootenv.getReductionTrack());
      checkMonitorCanceled();
    }
  }
}
