{
  if (isPrimary) {
    ttrace.push("create roots",false);
    final QueryExecutionContext executionContext=getExecutionContext(null);
    if (executionContext != null) {
      TemplateExecutionEnvironment environment=new TemplateExecutionEnvironmentImpl(this,executionContext,new ReductionContext());
      for (      TemplateCreateRootRule rule : myRuleManager.getCreateRootRules()) {
        checkMonitorCanceled();
        applyCreateRoot(rule,environment);
      }
    }
    ttrace.pop();
  }
  ttrace.push("root mappings",false);
  ArrayList<SNode> rootsConsumed=new ArrayList<SNode>();
  for (  TemplateRootMappingRule rule : myRuleManager.getRoot_MappingRules()) {
    checkMonitorCanceled();
    applyRootRule(rule,rootsConsumed);
  }
  ttrace.pop();
  if (myInplaceChangeEnabled) {
    if (myWeavingProcessor.hasWeavingRulesToApply()) {
      getLogger().info("Could have had delta builder here, but can't due to active weavings");
    }
 else {
      getLogger().info("Active in-place model transformation");
      myDeltaBuilder=createDeltaBuilder();
    }
  }
  checkMonitorCanceled();
  getGeneratorSessionContext().clearCopiedRootsSet();
  for (  SNode rootToCopy : myInputModel.getRootNodes()) {
    if (rootsConsumed.contains(rootToCopy)) {
      if (myDeltaBuilder != null) {
        myDeltaBuilder.enterInputRoot(rootToCopy);
        myDeltaBuilder.deleteInputRoot(rootToCopy);
        myDeltaBuilder.leaveInputRoot(rootToCopy);
      }
      continue;
    }
    QueryExecutionContext context=getExecutionContext(rootToCopy);
    if (context != null) {
      TemplateExecutionEnvironmentImpl rootenv=new TemplateExecutionEnvironmentImpl(this,context,new ReductionContext());
      copyRootInputNode(rootToCopy,rootenv);
    }
  }
}
