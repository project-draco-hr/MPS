{
  List<SNode> nodes=ModelAccess.instance().runReadAction(new Computable<List<SNode>>(){
    public List<SNode> compute(){
      return getNodes();
    }
  }
);
  if (nodes.size() != 0) {
    EditorComponent editor=editorContext.getNodeEditorComponent();
    SNode node=nodes.get(0);
    EditorCell cell=editor.findNodeCell(node);
    List<Pair<EditorCellKeyMapAction,EditorCell>> actionsInfo=KeyMapUtil.getKeyMapActionsForEvent(cell,keyEvent,editorContext);
    if (actionsInfo.size() == 1) {
      EditorCellKeyMapAction action=actionsInfo.get(0).o1;
      EditorCell contextCell=actionsInfo.get(0).o2;
      KeyMapUtil.executeKeyMapAction(action,keyEvent,contextCell,editorContext);
      return true;
    }
 else     if (actionsInfo.size() > 1) {
      KeyMapUtil.showActionsMenu(actionsInfo,keyEvent,editorContext,cell);
      return true;
    }
  }
  CellActionType actionType=myEditorComponent.getActionType(keyEvent,editorContext);
  if (actionType == null) {
    if (keyEvent.getKeyCode() == KeyEvent.VK_DELETE || keyEvent.getKeyCode() == KeyEvent.VK_BACK_SPACE) {
      actionType=CellActionType.DELETE;
    }
  }
  if (actionType != null) {
    if (actionType == CellActionType.DELETE) {
      doDeleteNodes(editorContext);
      return true;
    }
    if (actionType == CellActionType.COPY) {
      myEditorComponent.executeComponentAction(CellActionType.COPY);
      return true;
    }
    if (actionType == CellActionType.CUT) {
      myEditorComponent.executeComponentAction(CellActionType.CUT);
      return true;
    }
  }
  if (keyEvent.getKeyCode() == KeyEvent.VK_ESCAPE) {
    deactivate();
    return true;
  }
  if (!isSelectionKeystroke(keyEvent)) {
    if (keyEvent.getKeyCode() == KeyEvent.VK_UP || keyEvent.getKeyCode() == KeyEvent.VK_DOWN || keyEvent.getKeyCode() == KeyEvent.VK_LEFT || keyEvent.getKeyCode() == KeyEvent.VK_RIGHT) {
      if (keyEvent.isAltDown()) {
        return false;
      }
      deactivate();
    }
    if (keyEvent.getKeyCode() == KeyEvent.VK_CONTROL || keyEvent.getKeyCode() == KeyEvent.VK_SHIFT) {
      return false;
    }
    SNode nodeToSelect=myFirstNode;
    deactivate();
    myEditorComponent.selectNode(nodeToSelect);
    myEditorComponent.peekKeyboardHandler().processKeyPressed(editorContext,keyEvent);
    return false;
  }
  boolean next=(keyEvent.getKeyCode() == KeyEvent.VK_RIGHT || keyEvent.getKeyCode() == KeyEvent.VK_DOWN);
  SNode newLastNode=null;
  List<SNode> children=ModelAccess.instance().runReadAction(new Computable<List<SNode>>(){
    public List<SNode> compute(){
      return myParentNode.getChildren(myRole);
    }
  }
);
  Iterator<SNode> iterator=children.iterator();
  while (iterator.hasNext()) {
    SNode semanticNode=iterator.next();
    if (semanticNode == myLastNode) {
      if (next) {
        if (iterator.hasNext()) {
          newLastNode=iterator.next();
        }
 else {
          newLastNode=null;
        }
      }
      break;
    }
    newLastNode=semanticNode;
  }
  if (newLastNode != null) {
    myLastNode=newLastNode;
    myEditorComponent.scrollToNode(myLastNode);
    myEditorComponent.repaint();
  }
  return true;
}
