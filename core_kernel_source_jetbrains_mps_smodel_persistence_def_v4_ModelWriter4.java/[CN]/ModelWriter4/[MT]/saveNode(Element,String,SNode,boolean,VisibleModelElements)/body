{
  String theElementName=elementName;
  if (theElementName == null) {
    theElementName=ModelPersistence.NODE;
  }
  int modelVersion=VersionUtil.getNodeLanguageVersion(node);
  Element element=new Element(theElementName);
  final String role=node.getRole();
  DocUtil.setNotNullAttribute(element,ModelPersistence.ROLE,VersionUtil.formVersionedString(role,VersionUtil.getRoleVersion(node)));
  element.setAttribute(ModelPersistence.TYPE,VersionUtil.formVersionedString(node.getConceptFqName(),modelVersion));
  element.setAttribute(ModelPersistence.ID,node.getSNodeId().toString());
  Map<String,String> properties=node.getProperties();
  Set<String> keys=properties.keySet();
  for (  String propertyName : keys) {
    Element propertyElement=new Element(ModelPersistence.PROPERTY);
    element.addContent(propertyElement);
    propertyElement.setAttribute(ModelPersistence.NAME,VersionUtil.formVersionedString(propertyName,modelVersion));
    DocUtil.setNotNullAttribute(propertyElement,ModelPersistence.VALUE,node.getPersistentProperty(propertyName));
  }
  List<SReference> references=(List<SReference>)jetbrains.mps.util.SNodeOperations.getReferences(node);
  IReferencePersister referencePersister=getReferencePersister();
  for (  SReference reference : references) {
    referencePersister.saveReference(element,reference,useUIDs,visibleModelElements);
  }
  List<SNode> children=node.getChildren();
  for (  SNode childNode : children) {
    saveNode(element,null,childNode,useUIDs,visibleModelElements);
  }
  parentElement.addContent(element);
}
