{
  mySolution=null;
  myModelRoot=null;
  myModelPrefix=null;
  final Module module=e.getData(LangDataKeys.MODULE);
  VirtualFile[] vFiles=e.getData(PlatformDataKeys.VIRTUAL_FILE_ARRAY);
  if (module == null || vFiles == null || vFiles.length != 1 || !vFiles[0].isDirectory()) {
    return;
  }
  final MPSModuleFacade mpsFacade=module.getProject().getComponent(MPSModuleFacade.class);
  if (!mpsFacade.isMPSEnabled(module)) {
    return;
  }
  String url=vFiles[0].getUrl();
  if (!LocalFileSystem.PROTOCOL.equals(VirtualFileManager.extractProtocol(url))) {
    return;
  }
  final String path=VirtualFileManager.extractPath(url);
  ProjectHelper.toMPSProject(module.getProject()).getModelAccess().runReadAction(new Runnable(){
    @Override public void run(){
      for (      ModelRoot root : mpsFacade.getSolution(module).getModelRoots()) {
        if (!(root instanceof DefaultModelRoot))         continue;
        DefaultModelRoot modelRoot=(DefaultModelRoot)root;
        for (        String sourceRoot : modelRoot.getFiles(DefaultModelRoot.SOURCE_ROOTS)) {
          if (FileUtil.isSubPath(sourceRoot,path)) {
            mySolution=mpsFacade.getSolution(module);
            myModelRoot=modelRoot;
            mySourceRoot=sourceRoot;
            myModelPrefix=path.substring(sourceRoot.length());
            while (myModelPrefix.startsWith("/") || myModelPrefix.startsWith("\\")) {
              myModelPrefix=myModelPrefix.substring(1);
            }
            while (myModelPrefix.endsWith("/") || myModelPrefix.endsWith("\\")) {
              myModelPrefix=myModelPrefix.substring(0,myModelPrefix.length());
            }
            myModelPrefix=myModelPrefix.replaceAll("/",".");
            myModelPrefix=myModelPrefix.replaceAll("\\\\",".");
            if (!myModelPrefix.isEmpty()) {
              myModelPrefix+=".";
            }
            return;
          }
        }
      }
    }
  }
);
}
