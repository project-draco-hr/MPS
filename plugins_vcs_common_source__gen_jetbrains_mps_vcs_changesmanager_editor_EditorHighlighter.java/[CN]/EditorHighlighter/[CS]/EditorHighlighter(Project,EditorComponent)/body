{
  myEditorComponent=editorComponent;
  CurrentDifferenceRegistry.getInstance(project).getCommandQueue().runTask(new Runnable(){
    public void run(){
      final SRepository repo=editorComponent.getEditorContext().getRepository();
      repo.getModelAccess().runReadAction(new Runnable(){
        public void run(){
synchronized (myDisposedLock) {
            if (myDisposed) {
              return;
            }
            final SNode editedNode=(editorComponent.getEditedNodePointer() == null ? null : editorComponent.getEditedNodePointer().resolve(repo));
            if (editedNode == null) {
              return;
            }
            final SModel model=editedNode.getModel();
            if (model instanceof EditableSModel && !(model.isReadOnly())) {
              myCurrentDifference=CurrentDifferenceRegistry.getInstance(project).getCurrentDifference((EditableSModel)model);
              myListener=new EditorHighlighter.MyCurrentDifferenceListener();
            }
            if (myListener != null) {
              myCurrentDifference.setEnabled(true);
              ChangeSet changeSet=myCurrentDifference.getChangeSet();
              if (changeSet != null) {
                ListSequence.fromList(changeSet.getModelChanges()).where(new IWhereFilter<ModelChange>(){
                  public boolean accept(                  ModelChange c){
                    return editedNode.getNodeId().equals(c.getRootId());
                  }
                }
).visitAll(new IVisitor<ModelChange>(){
                  public void visit(                  ModelChange c){
                    createMessages(c);
                  }
                }
);
              }
synchronized (myChangesMessages) {
                Sequence.fromIterable(MapSequence.fromMap(myChangesMessages).values()).visitAll(new IVisitor<List<ChangeEditorMessage>>(){
                  public void visit(                  List<ChangeEditorMessage> messages){
                    ListSequence.fromList(messages).visitAll(new IVisitor<ChangeEditorMessage>(){
                      public void visit(                      ChangeEditorMessage m){
                        getHighlightManager().mark(m);
                      }
                    }
);
                  }
                }
);
              }
              getHighlightManager().repaintAndRebuildEditorMessages();
              ThreadUtils.runInUIThreadNoWait(new Runnable(){
                public void run(){
                  myStripsPainter=new ChangeStripsPainter(EditorHighlighter.this);
                  myEditorComponent.getLeftEditorHighlighter().addFoldingAreaPainter(myStripsPainter);
                }
              }
);
              myCurrentDifference.addDifferenceListener(myListener);
            }
          }
        }
      }
);
    }
  }
);
}
