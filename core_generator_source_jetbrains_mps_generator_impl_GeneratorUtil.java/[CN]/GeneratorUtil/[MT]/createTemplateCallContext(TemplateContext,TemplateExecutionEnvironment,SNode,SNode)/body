{
  final SNode[] arguments=getArguments(templateCall);
  final IGeneratorLogger log=env.getLogger();
  final String[] parameters=getParameters(templateCall,log);
  if (arguments == null && parameters == null) {
    return outerContext.subContext(newInputNode);
  }
  if (arguments == null || parameters == null || arguments.length != parameters.length) {
    log.error(templateCall.getReference(),"number of arguments doesn't match template",GeneratorUtil.describeInput(outerContext));
    return outerContext.subContext(newInputNode);
  }
  final Map<String,Object> vars=new HashMap<String,Object>(arguments.length);
  for (int i=0; i < arguments.length; i++) {
    SNode exprNode=arguments[i];
    String name=parameters[i];
    Object value=null;
    if (exprNode.getConcept().isSubConceptOf(SConceptRepository.getInstance().getConcept(RuleUtil.concept_TemplateArgumentParameterExpression))) {
      SNode parameter=RuleUtil.getTemplateArgumentParameterExpression_Parameter(exprNode);
      if (parameter == null) {
        log.error(exprNode.getReference(),"cannot evaluate template argument #" + (i + 1) + ": invalid parameter reference",GeneratorUtil.describeInput(outerContext));
      }
 else {
        value=outerContext.getVariable(parameter.getName());
      }
    }
 else     if (exprNode.getConcept().isSubConceptOf(SConceptRepository.getInstance().getConcept(RuleUtil.concept_TemplateArgumentPatternRef))) {
      String patternVar=GeneratorUtilEx.getPatternVariableName(exprNode);
      if (patternVar == null) {
        log.error(exprNode.getReference(),"cannot evaluate template argument #" + (i + 1) + ": invalid pattern reference",GeneratorUtil.describeInput(outerContext));
      }
 else {
        value=outerContext.getPatternVariable(patternVar);
      }
    }
 else {
      if (SNodeUtil.isInstanceOf(exprNode,SNodeOperations.getConcept(RuleUtil.concept_TemplateArgumentQueryExpression))) {
        SNode query=RuleUtil.getTemplateArgumentQueryExpression_Query(exprNode);
        value=env.getQueryExecutor().evaluateArgumentQuery(outerContext.getInput(),query,outerContext);
      }
 else {
        try {
          value=RuleUtil.evaluateBaseLanguageExpression(exprNode);
        }
 catch (        IllegalArgumentException ex) {
          log.error(templateCall.getReference(),String.format("cannot evaluate template argument #%d: %s",i + 1,ex.toString()),GeneratorUtil.describeInput(outerContext));
        }
      }
    }
    vars.put(name,value);
  }
  return outerContext.subContext(vars).subContext(outerContext.getInputName(),newInputNode);
}
