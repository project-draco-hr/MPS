{
  CommandProcessor.instance().executeLightweightCommand(new Runnable(){
    public void run(){
      SModelRepository.getInstance().saveAll();
    }
  }
);
  refactoringContext.setRefactoring(myRefactoring);
  AbstractProjectFrame projectFrame=context.get(AbstractProjectFrame.class);
  IAdaptiveProgressMonitor monitor_=new NullAdaptiveProgressMonitor();
  boolean hasMonitor=projectFrame != null;
  if (hasMonitor) {
    monitor_=projectFrame.createAdaptiveProgressMonitor();
  }
  final IAdaptiveProgressMonitor monitor=monitor_;
  final String refactoringTaskName="refactoring_" + myRefactoring.getClass().getName();
  final long estimatedTime=monitor.getEstimatedTime(refactoringTaskName);
  try {
    monitor.start("refactoring",estimatedTime);
    monitor.startLeafTask(refactoringTaskName,"refactoring",estimatedTime);
    Map<IModule,List<SModel>> calculatedSourceModels=CommandProcessor.instance().executeCommand(new Calculable<Map<IModule,List<SModel>>>(){
      public Map<IModule,List<SModel>> calculate(){
        SModelDescriptor modelDescriptor=context.getModel();
        SModelUID initialModelUID=modelDescriptor.getModelUID();
        myRefactoring.doRefactor(context,refactoringContext);
        SModel model=modelDescriptor.getSModel();
        refactoringContext.computeCaches();
        SearchResults usages=refactoringContext.getUsages();
        Map<IModule,List<SModel>> sourceModels=myRefactoring.getModelsToGenerate(context,refactoringContext);
        if (!refactoringContext.isLocal() || usages == null) {
          if (myRefactoring.doesUpdateModel()) {
            writeIntoLog(model,refactoringContext);
            for (            SModelDescriptor anotherDescriptor : SModelRepository.getInstance().getAllModelDescriptors()) {
              String stereotype=anotherDescriptor.getStereotype();
              if (!stereotype.equals(SModelStereotype.NONE) && !stereotype.equals(SModelStereotype.TEMPLATES)) {
                continue;
              }
              if (!anotherDescriptor.isInitialized())               continue;
              SModel anotherModel=anotherDescriptor.getSModel();
              if ("importsRenamedModel".equals(anotherModel.getShortName())) {
                System.err.println("oy vey!");
              }
              Set<SModelUID> dependenciesModels=anotherModel.getDependenciesModelUIDs();
              if (model != anotherModel && !dependenciesModels.contains(initialModelUID))               continue;
              processModel(anotherModel,model,refactoringContext);
            }
          }
        }
 else {
          if (myRefactoring.doesUpdateModel()) {
            Set<SModel> modelsToProcess=usages.getModelsWithResults();
            for (            List<SModel> sModels : sourceModels.values()) {
              modelsToProcess.addAll(sModels);
            }
            for (            SModel anotherModel : modelsToProcess) {
              processModel(anotherModel,model,refactoringContext);
            }
          }
        }
        return sourceModels;
      }
    }
);
    if (calculatedSourceModels != null && !calculatedSourceModels.isEmpty()) {
      generateModels(context,calculatedSourceModels,refactoringContext);
    }
  }
  finally {
    monitor.finishTask();
    monitor.finish();
  }
}
