{
  FacetManager facetManager=FacetManager.getInstance(module);
  FacetType<MPSFacet,MPSFacetConfiguration> facetType=FacetTypeRegistry.getInstance().findFacetType(MPSFacetType.ID);
  Assert.assertNotNull("MPS facet type is not found",facetType);
  MPSFacet facet=facetManager.createFacet(facetType,"MPS",null);
  final MPSFacetConfiguration configuration=facet.getConfiguration();
  ApplicationManager.getApplication().invokeAndWait(new Runnable(){
    @Override public void run(){
      preConfigureFacet(configuration);
    }
  }
,ModalityState.defaultModalityState());
  final ModifiableFacetModel facetModel=facetManager.createModifiableModel();
  facetModel.addFacet(facet);
  UIUtil.invokeAndWaitIfNeeded(new Runnable(){
    @Override public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          facetModel.commit();
        }
      }
);
    }
  }
);
  return facet;
}
