{
  Set<MPSModuleOwner> rootOwners=new HashSet<MPSModuleOwner>();
  for (  IModule m : myModules) {
    for (    MPSModuleOwner owner : myModuleToOwners.getByFirst(m)) {
      if (owner instanceof IModule)       continue;
      rootOwners.add(owner);
    }
  }
  Set<IModule> visibleModules=new HashSet<IModule>();
  for (  IModule m : myModules) {
    if (m instanceof Solution && ((Solution)m).isStub()) {
      visibleModules.add(m);
      continue;
    }
    for (    MPSModuleOwner r : rootOwners) {
      if (myModuleToOwners.contains(m,r)) {
        visibleModules.add(m);
      }
    }
  }
  Set<IModule> toAdd;
  do {
    toAdd=new HashSet<IModule>();
    for (    IModule m : myModules) {
      if (visibleModules.contains(m))       continue;
      for (      IModule v : visibleModules) {
        if (!(v instanceof MPSModuleOwner))         continue;
        if (!myModuleToOwners.contains(m,(MPSModuleOwner)v))         continue;
        toAdd.add(m);
      }
    }
    visibleModules.addAll(toAdd);
  }
 while (!toAdd.isEmpty());
  Set<IModule> toBeRemoved=new HashSet<IModule>(myModules);
  toBeRemoved.removeAll(visibleModules);
  return toBeRemoved;
}
