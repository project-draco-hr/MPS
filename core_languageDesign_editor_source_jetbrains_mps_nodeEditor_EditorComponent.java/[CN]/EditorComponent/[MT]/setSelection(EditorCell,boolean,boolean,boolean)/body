{
  if (resetLastCaretX) {
    resetLastCaretX();
  }
  EditorCellSelection newSelection;
  if (newSelectedCell instanceof EditorCell_Label) {
    newSelection=new EditorCellLabelSelection((EditorCell_Label)newSelectedCell);
  }
 else   if (newSelectedCell != null) {
    newSelection=new EditorCellSelection(newSelectedCell);
  }
 else {
    newSelection=null;
  }
  if (clearStack) {
    myNodeSubstituteChooser.setVisible(false);
    myNodeRangeSelection.deactivate();
    mySelectionManager.setSelection(newSelection);
  }
 else   if (getSelectedCell() != newSelectedCell) {
    myNodeSubstituteChooser.setVisible(false);
    myNodeRangeSelection.deactivate();
    mySelectionManager.pushSelection(newSelection);
  }
  if (newSelectedCell != null) {
    if (scrollToCell) {
      if (getVisibleRect().isEmpty()) {
        final JViewport viewport=getViewport();
        viewport.addChangeListener(new ChangeListener(){
          @Override public void stateChanged(          ChangeEvent e){
            if (!getVisibleRect().isEmpty()) {
              if (getSelectedCell() != null) {
                scrollToCell(getSelectedCell());
              }
              viewport.removeChangeListener(this);
            }
          }
        }
);
      }
 else {
        scrollToCell(newSelectedCell);
      }
    }
  }
  repaint();
}
