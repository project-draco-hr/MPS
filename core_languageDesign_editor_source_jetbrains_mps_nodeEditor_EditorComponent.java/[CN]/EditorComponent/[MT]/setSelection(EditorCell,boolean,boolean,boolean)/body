{
  if (resetLastCaretX) {
    resetLastCaretX();
  }
  if (clearStack) {
    myNodeSubstituteChooser.setVisible(false);
    myNodeRangeSelection.deactivate();
    mySelectionManager.setSelection(newSelectedCell);
  }
 else   if (getSelectedCell() != newSelectedCell) {
    myNodeSubstituteChooser.setVisible(false);
    myNodeRangeSelection.deactivate();
    mySelectionManager.pushSelection(mySelectionManager.createSelection(newSelectedCell));
  }
  if (newSelectedCell != null) {
    if (scrollToCell) {
      if (getVisibleRect().isEmpty()) {
        final JViewport viewport=getViewport();
        viewport.addChangeListener(new ChangeListener(){
          @Override public void stateChanged(          ChangeEvent e){
            if (!getVisibleRect().isEmpty()) {
              if (getSelectedCell() != null) {
                scrollToCell(getSelectedCell());
              }
              viewport.removeChangeListener(this);
            }
          }
        }
);
      }
 else {
        scrollToCell(newSelectedCell);
      }
    }
  }
  repaint();
}
