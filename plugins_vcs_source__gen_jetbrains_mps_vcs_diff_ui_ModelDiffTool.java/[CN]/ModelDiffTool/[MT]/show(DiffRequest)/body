{
  DiffContent[] contents=request.getContents();
  try {
    final SModel oldModel=ModelDiffTool.readModel(contents[0],ModelDiffTool.getFilePath(request));
    final SModel newModel=ModelDiffTool.readModel(contents[1],ModelDiffTool.getFilePath(request));
    final BaseDialog d=ModelAccess.instance().runReadAction(new Computable<BaseDialog>(){
      public BaseDialog compute(){
        SModelDescriptor modelDescriptor=oldModel.getModelDescriptor();
        if (modelDescriptor == null) {
          modelDescriptor=newModel.getModelDescriptor();
          if (modelDescriptor == null) {
            modelDescriptor=SModelRepository.getInstance().getModelDescriptor(oldModel.getSModelFqName());
          }
        }
        IOperationContext context;
        if (modelDescriptor == null) {
          context=new GlobalOperationContext();
        }
 else {
          context=new ModuleContext(modelDescriptor.getModule(),request.getProject());
        }
        boolean modal=!(request.getHints().contains(DiffTool.HINT_SHOW_FRAME));
        JFrame frame=WindowManager.getInstance().getFrame(request.getProject());
        if (MergeModelsDialog.isNewMergeEnabled()) {
          return new ModelDifferenceDialog(request.getProject(),context,oldModel,newModel,request.getContentTitles());
        }
 else {
          final OldModelDifferenceDialog d=new OldModelDifferenceDialog(context,frame,oldModel,newModel,request.getWindowTitle(),modal,request.getContentTitles());
          d.addAction(new AnAction("View as Text","View as Text",Icons.TEXT_ICON){
            public void actionPerformed(            AnActionEvent e){
              DiffTool ideaDiffTool=DiffManager.getInstance().getIdeaDiffTool();
              if (ideaDiffTool.canShow(request)) {
                d.dispose();
                ideaDiffTool.show(request);
              }
            }
          }
);
          return d;
        }
      }
    }
);
    d.showDialog();
  }
 catch (  ModelDiffTool.ReadException e) {
    LOG.warning("Can't read models. Using text based merge...",e);
    DiffTool ideaDiffTool=DiffManager.getInstance().getIdeaDiffTool();
    if (ideaDiffTool.canShow(request)) {
      ideaDiffTool.show(request);
    }
  }
catch (  IOException e) {
    e.printStackTrace();
  }
}
