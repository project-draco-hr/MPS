{
  Set<SModuleId> ids=new HashSet<SModuleId>();
  for (  SModule module : loadedModules) {
    ids.add(module.getModuleId());
  }
  for (  SModule module : MPSModuleRepository.getInstance().getModules()) {
    if (!(module instanceof AbstractModule))     continue;
    if (myLoadedModules.contains(module.getModuleReference())) {
      boolean hasInvalidRelatedRoots=false;
      for (      ModelRoot modelRoot : module.getModelRoots()) {
        if (modelRoot instanceof SModelRoot) {
          SModelRoot root=(SModelRoot)modelRoot;
          SModuleId modelRootManagerModuleId=ModuleId.fromString(root.getModelRoot().getManager().getModuleId());
          if (root.isInvalid() && ids.contains(modelRootManagerModuleId)) {
            hasInvalidRelatedRoots=true;
            break;
          }
        }
      }
      if (!hasInvalidRelatedRoots) {
        continue;
      }
    }
    myLoadedModules.add(module.getModuleReference());
    ((AbstractModule)module).updateModelsSet();
  }
}
