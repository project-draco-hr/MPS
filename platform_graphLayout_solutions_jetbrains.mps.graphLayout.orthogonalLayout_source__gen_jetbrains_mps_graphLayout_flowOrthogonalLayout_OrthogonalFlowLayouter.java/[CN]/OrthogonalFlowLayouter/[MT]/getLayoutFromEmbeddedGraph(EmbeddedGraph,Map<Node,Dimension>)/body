{
  Graph graph=embeddedGraph.getGraph();
  List<Edge> oldEdges=ListSequence.fromList(new ArrayList<Edge>());
  ListSequence.fromList(oldEdges).addSequence(ListSequence.fromList(graph.getEdges()));
  List<Node> oldNodes=ListSequence.fromList(new ArrayList<Node>());
  ListSequence.fromList(oldNodes).addSequence(SetSequence.fromSet(MapSequence.fromMap(nodeSizes).keySet()));
  Map<Dart,Integer> bends=MapSequence.fromMap(new HashMap<Dart,Integer>());
  Map<Dart,Integer> angles=MapSequence.fromMap(new HashMap<Dart,Integer>());
  QuasiOrthogonalRepresentation.getRepresentation(embeddedGraph,bends,angles);
  QuasiRepresentationModifier quasiModifier=new QuasiRepresentationModifier(embeddedGraph,bends,angles);
  quasiModifier.reduceToOrthogonalRepresentation();
  List<List<Edge>> modifiedEdges=quasiModifier.getModifiedEdges();
  if (SHOW_INFO > 0) {
    System.out.println("merged edges: ");
    for (    List<Edge> list : ListSequence.fromList(modifiedEdges)) {
      System.out.println(list);
    }
  }
  OrthogonalRepresentation.replaceBendsByNodes(embeddedGraph,bends,angles);
  Map<Dart,Direction2D> directions=OrthogonalRepresentation.getDirections(embeddedGraph,angles);
  EmbeddedGraphModifier modifier=new EmbeddedGraphModifier(embeddedGraph);
  modifier.setDartDirections(directions);
  modifier.makeRectangularFaces();
  modifier.connectSpecialNodes(oldNodes);
  if (SHOW_INFO > 0) {
    System.out.println("modified graph: " + embeddedGraph);
  }
  Map<Node,Map<Direction2D,Integer>> nodeDirectionSizes=MapSequence.fromMap(new HashMap<Node,Map<Direction2D,Integer>>());
  for (  Node node : ListSequence.fromList(oldNodes)) {
    Map<Direction2D,Integer> directionSizes=MapSequence.fromMap(new HashMap<Direction2D,Integer>());
    Dimension size=MapSequence.fromMap(nodeSizes).get(node);
    int horSize=size.height;
    MapSequence.fromMap(directionSizes).put(Direction2D.UP,horSize / 2);
    MapSequence.fromMap(directionSizes).put(Direction2D.DOWN,horSize - MapSequence.fromMap(directionSizes).get(Direction2D.UP));
    int verSize=size.width;
    MapSequence.fromMap(directionSizes).put(Direction2D.LEFT,verSize / 2);
    MapSequence.fromMap(directionSizes).put(Direction2D.RIGHT,verSize - MapSequence.fromMap(directionSizes).get(Direction2D.LEFT));
    MapSequence.fromMap(nodeDirectionSizes).put(node,directionSizes);
  }
  Map<Edge,Integer> lenghts=MapSequence.fromMap(new HashMap<Edge,Integer>());
  for (  Edge edge : ListSequence.fromList(graph.getEdges())) {
    int edgeLength=myUnitLength;
    Node source=edge.getSource();
    if (MapSequence.fromMap(nodeDirectionSizes).containsKey(source)) {
      Dart sourceDart=embeddedGraph.getSourceDart(edge,source);
      edgeLength+=MapSequence.fromMap(MapSequence.fromMap(nodeDirectionSizes).get(source)).get(MapSequence.fromMap(directions).get(sourceDart));
    }
    Node target=edge.getTarget();
    if (MapSequence.fromMap(nodeDirectionSizes).containsKey(target)) {
      Dart targetDart=embeddedGraph.getSourceDart(edge,target);
      edgeLength+=MapSequence.fromMap(MapSequence.fromMap(nodeDirectionSizes).get(target)).get(MapSequence.fromMap(directions).get(targetDart));
    }
    MapSequence.fromMap(lenghts).put(edge,edgeLength);
  }
  EdgeLengthComputer lengthComputer=new EdgeLengthComputer();
  Map<Edge,Integer> lengths=lengthComputer.compute(embeddedGraph,directions,lenghts);
  CoordinatePlacer placer=new CoordinatePlacer(embeddedGraph,lengths,directions);
  Map<Node,Point> coordinates=placer.getCoordinates();
  GraphLayout graphLayout=new GraphLayout(graph);
  for (  Node node : ListSequence.fromList(oldNodes)) {
    Point center=MapSequence.fromMap(coordinates).get(node);
    Map<Direction2D,Integer> sizes=MapSequence.fromMap(nodeDirectionSizes).get(node);
    Dimension nodeSize=MapSequence.fromMap(nodeSizes).get(node);
    Rectangle rect=new Rectangle(center.x - MapSequence.fromMap(sizes).get(Direction2D.LEFT),center.y - MapSequence.fromMap(sizes).get(Direction2D.DOWN),nodeSize.width,nodeSize.height);
    graphLayout.setLayoutFor(node,rect);
  }
  for (  Edge edge : ListSequence.fromList(oldEdges)) {
    List<Edge> history=embeddedGraph.findFullHistory(edge);
    List<Point> edgeLayout=ListSequence.fromList(new LinkedList<Point>());
    Node cur=edge.getSource();
    ListSequence.fromList(edgeLayout).addElement(new Point(MapSequence.fromMap(coordinates).get(cur)));
    for (    Edge historyEdge : ListSequence.fromList(history)) {
      Node next=historyEdge.getOpposite(cur);
      ListSequence.fromList(edgeLayout).addElement(new Point(MapSequence.fromMap(coordinates).get(next)));
      cur=next;
    }
    shiftEnd(edge.getSource(),ListSequence.fromList(history).first(),ListSequence.fromList(edgeLayout).first(),nodeDirectionSizes,embeddedGraph,directions);
    shiftEnd(edge.getTarget(),ListSequence.fromList(history).last(),ListSequence.fromList(edgeLayout).last(),nodeDirectionSizes,embeddedGraph,directions);
    graphLayout.setLayoutFor(edge,edgeLayout);
  }
  List<Node> modificationSources=quasiModifier.getModificationSources();
  Iterator<List<Edge>> modifiedEdgesItr=ListSequence.fromList(modifiedEdges).iterator();
  Iterator<Node> sourcesItr=ListSequence.fromList(modificationSources).iterator();
  while (sourcesItr.hasNext()) {
    List<Edge> edges=modifiedEdgesItr.next();
    Node source=sourcesItr.next();
    splitEdges(graphLayout,edges,source);
  }
  return graphLayout;
}
