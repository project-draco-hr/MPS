{
  SNode applyToNode=ListSequence.fromList(SNodeOperations.getAncestors(node,null,true)).where(new IWhereFilter<SNode>(){
    public boolean accept(    SNode it){
      return !(SNodeOperations.isAttribute(it));
    }
  }
).first();
  if (SNodeOperations.getAncestor(applyToNode,"jetbrains.mps.lang.generator.structure.TemplateDeclaration",false,false) != null) {
    if (!(QueriesUtil.isInsideTemplateFragment(applyToNode))) {
      QueriesUtil.createTemplateFragment(applyToNode);
    }
  }
  if (SNodeOperations.getAncestor(node,"jetbrains.mps.lang.generator.structure.TemplateDeclaration",false,false) != null) {
  }
  SNode nodeMacro=SConceptOperations.createNewNode("jetbrains.mps.lang.generator.structure.NodeMacro",null);
  if (SNodeOperations.isInstanceOf(node,"jetbrains.mps.lang.generator.structure.NodeMacro") && ListSequence.fromList(SNodeOperations.getChildren(applyToNode)).contains(node)) {
    SNodeOperations.insertPrevSiblingChild(node,nodeMacro);
  }
 else {
    SLinkOperations.addChild(applyToNode,AttributesRolesUtil.childRoleFromAttributeRole("nodeMacro"),nodeMacro);
  }
  return nodeMacro;
}
