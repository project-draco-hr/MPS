{
  SModelReference reference=model.getSModelReference();
  StructureModificationHistory refactorings=null;
  int version=fromVersion;
  while (version < toVersion) {
    if (++version == 5) {
      refactorings=model.getRefactoringHistory();
      if (refactorings != null && refactorings.getDataList().isEmpty()) {
        refactorings=null;
      }
    }
    model.calculateImplicitImports();
    Document document=saveModel(model,version);
    model.dispose();
    LOG.assertLog(modelReaders.get(version) != null);
    model=modelReaders.get(version).readModel(document,NameUtil.shortNameFromLongName(reference.getLongName()),reference.getStereotype());
  }
  LOG.info("persistence upgraded: " + fromVersion + "->"+ toVersion+ " "+ reference);
  model.setPersistenceVersion(toVersion);
  try {
    Document document=saveModel(model,toVersion);
    JDOMUtil.writeDocument(document,file);
    if (refactorings != null) {
      RefactoringsPersistence.save(file,refactorings);
    }
  }
 catch (  IOException e) {
    LOG.error("error while saving model after persistence upgrade " + model.getSModelReference(),e);
  }
  return model;
}
