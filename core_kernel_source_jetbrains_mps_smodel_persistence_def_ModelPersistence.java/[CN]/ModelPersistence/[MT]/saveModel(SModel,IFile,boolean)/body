{
  LOG.debug("Save model " + model.getSModelReference() + " to file "+ file.getAbsolutePath());
  if (file.isReadOnly()) {
    LOG.error("Can't write to " + file.getAbsolutePath());
    return null;
  }
  SModelDescriptor modelDescriptor=model.getModelDescriptor();
  if (modelDescriptor != null) {
    saveMetadata(modelDescriptor);
  }
  if (canUpgrade) {
    int modelPersistenceVersion=model.getPersistenceVersion();
    if (modelPersistenceVersion != PersistenceSettings.VERSION_UNDEFINED && needsUpgrade(modelPersistenceVersion)) {
      return upgradePersistence(file,model,modelPersistenceVersion,getCurrentPersistenceVersion());
    }
  }
  Document document=saveModel(model,model.getPersistenceVersion());
  try {
    JDOMUtil.writeDocument(document,file);
    SModelRepository.getInstance().markUnchanged(model);
  }
 catch (  IOException e) {
    LOG.error("Error in file " + file,e);
  }
  return null;
}
