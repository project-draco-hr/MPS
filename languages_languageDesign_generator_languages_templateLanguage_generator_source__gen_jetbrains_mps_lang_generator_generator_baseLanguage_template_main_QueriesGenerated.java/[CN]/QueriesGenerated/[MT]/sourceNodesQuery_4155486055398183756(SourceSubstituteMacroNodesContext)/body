{
  List<SNode> result=new ArrayList<SNode>();
  for (  SReference reference : _context.getNode().getReferences()) {
    if (AttributeOperations.getAttribute(_context.getNode(),new IAttributeDescriptor.LinkAttribute(MetaAdapterFactory.getConcept(0xb401a68083254110L,0x8fd384331ff25befL,0xfd7f44d616L,"jetbrains.mps.lang.generator.structure.ReferenceMacro"),reference.getRole())) != null) {
      continue;
    }
    SNode targetNode=jetbrains.mps.util.SNodeOperations.getTargetNodeSilently(reference);
    if (targetNode == null) {
      _context.showErrorMessage(_context.getNode(),"cannot resolve reference in template model; role: " + reference.getRole());
      continue;
    }
    SNode referenceNode;
    if (SNodeOperations.getModel(targetNode) == SNodeOperations.getModel(_context.getNode())) {
      SNode refNode=SModelOperations.createNewNode(_context.getInputModel(),null,SNodeOperations.asInstanceConcept(MetaAdapterFactory.getConcept(0xb401a68083254110L,0x8fd384331ff25befL,0x2073070af8a4bc1bL,"jetbrains.mps.lang.generator.structure.GeneratorInternal_InternalReferenceDescriptor")));
      SPropertyOperations.set(refNode,MetaAdapterFactory.getProperty(0xb401a68083254110L,0x8fd384331ff25befL,0x2073070af8a4bc1bL,0x2073070af8a4e533L,"templateNodeId"),GeneratorUtil.getTemplateNodeId(_context.getOriginalCopiedInputNode(targetNode)));
      String resolveInfo=jetbrains.mps.util.SNodeOperations.getResolveInfo(targetNode);
      if (resolveInfo == null) {
        resolveInfo=((jetbrains.mps.smodel.SReference)reference).getResolveInfo();
      }
      SPropertyOperations.set(refNode,MetaAdapterFactory.getProperty(0xb401a68083254110L,0x8fd384331ff25befL,0x2073070af8a4bc1bL,0x2073070af8a4e535L,"resolveInfo"),resolveInfo);
      referenceNode=refNode;
    }
 else {
      SNode refNode=SModelOperations.createNewNode(_context.getInputModel(),null,SNodeOperations.asInstanceConcept(MetaAdapterFactory.getConcept(0xb401a68083254110L,0x8fd384331ff25befL,0x2073070af8a42ba1L,"jetbrains.mps.lang.generator.structure.GeneratorInternal_ReferenceDescriptor")));
      SPropertyOperations.set(refNode,MetaAdapterFactory.getProperty(0xb401a68083254110L,0x8fd384331ff25befL,0x2073070af8a42ba1L,0x2073070af8a5157eL,"targetModel"),reference.getTargetSModelReference().toString());
      SPropertyOperations.set(refNode,MetaAdapterFactory.getProperty(0xb401a68083254110L,0x8fd384331ff25befL,0x2073070af8a42ba1L,0x2073070af8a51580L,"targetNodeId"),targetNode.getNodeId().toString());
      referenceNode=refNode;
    }
    SLinkOperations.setTarget(referenceNode,MetaAdapterFactory.getReferenceLink(0xb401a68083254110L,0x8fd384331ff25befL,0x2073070af8a4bc2aL,0x2073070af8a4bc2cL,"role"),(SNode)reference.getLink().getDeclarationNode());
    ListSequence.fromList(result).addElement(referenceNode);
  }
  return result;
}
