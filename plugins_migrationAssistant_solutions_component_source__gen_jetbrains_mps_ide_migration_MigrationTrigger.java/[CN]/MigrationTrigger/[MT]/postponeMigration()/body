{
  final com.intellij.openapi.project.Project ideaProject=myProject;
  final Iterable<SModule> allModules=MigrationsUtil.getMigrateableModulesFromProject(myMpsProject);
  final Wrappers._boolean migrationRequired=new Wrappers._boolean();
  myMpsProject.getRepository().getModelAccess().runWriteAction(new Runnable(){
    public void run(){
      MigrationTrigger.updateUsedLanguagesVersions(allModules);
      migrationRequired.value=myMigrationManager.isMigrationRequired();
    }
  }
);
  if (!(migrationRequired.value)) {
    MigrationDialogUtil.showNoMigrationMessage(myProject);
    myMigrationQueued=false;
    return;
  }
  saveAndSetTipsState();
  StartupManager.getInstance(ideaProject).runWhenProjectIsInitialized(new Runnable(){
    public void run(){
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        public void run(){
          boolean migrate=MigrationDialogUtil.showMigrationConfirmation(myProject,allModules,myMigrationManager);
          restoreTipsState();
          if (!(migrate)) {
            return;
          }
          VirtualFileUtils.refreshSynchronouslyRecursively(myProject.getBaseDir());
          VirtualFileManager.getInstance().asyncRefresh(new Runnable(){
            public void run(){
              ApplicationManager.getApplication().invokeLater(new Runnable(){
                public void run(){
                  ReloadManager.getInstance().flush();
                  ProjectManagerEx.getInstanceEx().unblockReloadingProjectOnExternalChanges();
                  myState.migrationRequired=true;
                  ProjectManagerEx.getInstance().reloadProject(ideaProject);
                }
              }
);
            }
          }
);
        }
      }
);
    }
  }
);
  myMigrationQueued=true;
}
