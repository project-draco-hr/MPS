{
  for (  SNode node : model.nodes()) {
    if (RoleIdsComponent.isEnabled()) {
      result.add(RoleIdsComponent.getConceptPointer(node).getModelReference());
      for (      String propname : node.getProperties().keySet()) {
        result.add(RoleIdsComponent.getPropertyNamePointer(node,propname).getModelReference());
      }
      for (      SReference ref : node.getReferences()) {
        if (ref.getTargetSModelReference() != null) {
          result.add(ref.getTargetSModelReference());
        }
        result.add(RoleIdsComponent.getReferenceRolePointer(ref).getModelReference());
      }
      for (      SNode child : node.getChildren()) {
        result.add(RoleIdsComponent.getNodeRolePointer(child).getModelReference());
      }
    }
 else {
      SNode concept=node.getConceptDeclarationNode();
      if (concept == null) {
        LOG.error("concept not found for node " + org.jetbrains.mps.openapi.model.SNodeUtil.getDebugText(node));
      }
 else {
        result.add(concept.getModel().getSModelReference());
      }
      for (      String propname : node.getProperties().keySet()) {
        SNode decl=node.getPropertyDeclaration(propname);
        if (decl == null) {
          LOG.error("undeclared property: '" + propname + "' in node "+ org.jetbrains.mps.openapi.model.SNodeUtil.getDebugText(node));
        }
 else {
          result.add(decl.getModel().getSModelReference());
        }
      }
      for (      SReference ref : node.getReferences()) {
        SModelReference targetModelRef=ref.getTargetSModelReference();
        if (targetModelRef == null) {
          LOG.error("target model of reference '" + ref.getRole() + "' is null in node "+ org.jetbrains.mps.openapi.model.SNodeUtil.getDebugText(node));
        }
 else {
          result.add(targetModelRef);
        }
        SNode decl=node.getLinkDeclaration(ref.getRole());
        if (decl == null) {
          LOG.error("undeclared link role: '" + ref.getRole() + "' in node "+ org.jetbrains.mps.openapi.model.SNodeUtil.getDebugText(node));
        }
 else {
          result.add(decl.getModel().getSModelReference());
        }
      }
      for (      SNode child : node.getChildren()) {
        SNode decl=child.getRoleLink();
        if (decl == null) {
          LOG.error("undeclared child role: '" + child.getRole() + "' in node "+ org.jetbrains.mps.openapi.model.SNodeUtil.getDebugText(node));
        }
 else {
          result.add(decl.getModel().getSModelReference());
        }
      }
    }
  }
  return result;
}
