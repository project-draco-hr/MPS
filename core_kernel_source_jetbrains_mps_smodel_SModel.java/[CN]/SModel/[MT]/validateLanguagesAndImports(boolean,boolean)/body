{
  ModelChange.assertLegalChange(this);
  GlobalScope scope=GlobalScope.getInstance();
  Set<ModuleReference> usedLanguages=getLanguageRefs(scope);
  Set<SModelReference> importedModels=new HashSet<SModelReference>();
  for (  SModelDescriptor sm : allImportedModels(scope)) {
    importedModels.add(sm.getSModelReference());
  }
  List<SNode> nodes=allNodes();
  for (  SNode node : nodes) {
    Language lang=node.getLanguage(scope);
    if (lang == null) {
      LOG.error("Can't find language " + node.getLanguageNamespace());
      continue;
    }
    ModuleReference ref=lang.getModuleReference();
    if (!usedLanguages.contains(ref)) {
      if (respectModulesScopes) {
        IModule module=this.getModelDescriptor().getModule();
        if (!module.getAllUsedLanguages().contains(lang)) {
          module.addUsedLanguage(ref);
        }
      }
      usedLanguages.add(ref);
      addLanguage(ref,firstVersion);
    }
    for (    SReference reference : node.getReferencesIterable()) {
      if (reference.isExternal()) {
        SModelReference targetModelReference=reference.getTargetSModelReference();
        if (targetModelReference != null && !importedModels.contains(targetModelReference)) {
          addImportedModel(targetModelReference,firstVersion);
          importedModels.add(targetModelReference);
        }
      }
    }
  }
  importedModels.clear();
}
