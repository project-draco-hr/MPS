{
  SNode ancessor=node;
  while (ancessor != null && !(SNodeOperations.isInstanceOf(SNodeOperations.getParent(ancessor),MetaAdapterFactory.getConcept(0x8585453e6bfb4d80L,0x98deb16074f1d86cL,0x11e314b20e0L,"jetbrains.mps.lang.test.structure.EditorTestCase")))) {
    ancessor=SNodeOperations.getParent(ancessor);
  }
  for (  SNode oldAnnotation : SNodeOperations.getNodeDescendants(ancessor,MetaAdapterFactory.getConcept(0x8585453e6bfb4d80L,0x98deb16074f1d86cL,0x11e31babe12L,"jetbrains.mps.lang.test.structure.AnonymousCellAnnotation"),false,new SAbstractConcept[]{})) {
    SNodeOperations.deleteNode(oldAnnotation);
  }
  SNode newAnnotation=SNodeFactoryOperations.createNewNode(SNodeFactoryOperations.asInstanceConcept(MetaAdapterFactory.getConcept(0x8585453e6bfb4d80L,0x98deb16074f1d86cL,0x11e31babe12L,"jetbrains.mps.lang.test.structure.AnonymousCellAnnotation")),null);
  EditorCell contextCell=editorContext.getContextCell();
  if (editorContext.getEditorComponent() instanceof InspectorEditorComponent) {
    SPropertyOperations.set(newAnnotation,MetaAdapterFactory.getProperty(0x8585453e6bfb4d80L,0x98deb16074f1d86cL,0x11e31babe12L,0x1b73330fb1241e01L,"isInInspector"),"" + (true));
  }
  if (contextCell instanceof EditorCell_Label) {
    EditorCell_Label label=(EditorCell_Label)contextCell;
    int caretPosition=label.getCaretPosition();
    if (caretPosition == label.getText().length()) {
      SPropertyOperations.set(newAnnotation,MetaAdapterFactory.getProperty(0x8585453e6bfb4d80L,0x98deb16074f1d86cL,0x11e31babe12L,0x11e3fde6f41L,"isLastPosition"),"" + (true));
    }
 else {
      SPropertyOperations.set(newAnnotation,MetaAdapterFactory.getProperty(0x8585453e6bfb4d80L,0x98deb16074f1d86cL,0x11e31babe12L,0x11e31babe14L,"caretPosition"),"" + (caretPosition));
    }
    SPropertyOperations.set(newAnnotation,MetaAdapterFactory.getProperty(0x8585453e6bfb4d80L,0x98deb16074f1d86cL,0x11e31babe12L,0x1ad0cd452e251146L,"useLabelSelection"),"" + (true));
    SPropertyOperations.set(newAnnotation,MetaAdapterFactory.getProperty(0x8585453e6bfb4d80L,0x98deb16074f1d86cL,0x11e31babe12L,0x56ffc0a94fe5fc33L,"selectionStart"),"" + (label.getSelectionStart()));
    SPropertyOperations.set(newAnnotation,MetaAdapterFactory.getProperty(0x8585453e6bfb4d80L,0x98deb16074f1d86cL,0x11e31babe12L,0x56ffc0a94fe5fc35L,"selectionEnd"),"" + (label.getSelectionEnd()));
  }
 else {
    SPropertyOperations.set(newAnnotation,MetaAdapterFactory.getProperty(0x8585453e6bfb4d80L,0x98deb16074f1d86cL,0x11e31babe12L,0x11e31babe14L,"caretPosition"),"" + (0));
  }
  SPropertyOperations.set(newAnnotation,MetaAdapterFactory.getProperty(0x8585453e6bfb4d80L,0x98deb16074f1d86cL,0x11e31babe12L,0x11e31babe13L,"cellId"),contextCell.getCellId());
  Selection selection=((EditorComponent)editorContext.getEditorComponent()).getSelectionManager().getSelection();
  if (selection instanceof NodeRangeSelection) {
    NodeRangeSelection nodeRangeSelection=(NodeRangeSelection)selection;
    SLinkOperations.setTarget(newAnnotation,MetaAdapterFactory.getReferenceLink(0x8585453e6bfb4d80L,0x98deb16074f1d86cL,0x11e31babe12L,0x1ad0cd452e1f9accL,"nodeRangeSelectionStart"),nodeRangeSelection.getFirstNode());
    SLinkOperations.setTarget(newAnnotation,MetaAdapterFactory.getReferenceLink(0x8585453e6bfb4d80L,0x98deb16074f1d86cL,0x11e31babe12L,0x1ad0cd452e1f9acdL,"nodeRangeSelectionEnd"),nodeRangeSelection.getLastNode());
  }
  AttributeOperations.setAttribute(node,new IAttributeDescriptor.NodeAttribute("jetbrains.mps.lang.test.structure.INodeAnnotation"),newAnnotation);
  SelectionUtil.selectNode(editorContext,newAnnotation);
}
