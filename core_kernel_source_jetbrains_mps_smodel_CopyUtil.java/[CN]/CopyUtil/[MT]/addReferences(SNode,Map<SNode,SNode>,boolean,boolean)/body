{
  if (root == null)   return;
  Iterable<SNode> thisAndDesc=IterableUtil.merge(Collections.singleton(root),root.getDescendants());
  Iterator<SNode> it=thisAndDesc.iterator();
  while (it.hasNext()) {
    SNode inputNode=it.next();
    if (!copyAttributes && AttributeOperations.isAttribute(inputNode)) {
      ((TreeIterator)it).skipChildren();
      continue;
    }
    SNode outputNode=mapping.get(inputNode);
    if (outputNode == null) {
      throw new IllegalStateException();
    }
    for (    SReference ref : inputNode.getReferencesIterable()) {
      boolean cloneRefs=forceCloneRefs || MPSCore.getInstance().isMergeDriverMode();
      SNode inputTargetNode=cloneRefs ? null : ref.getTargetNodeSilently();
      if (inputTargetNode == null) {
        if (ref instanceof StaticReference) {
          StaticReference statRef=(StaticReference)ref;
          outputNode.addReference(new StaticReference(statRef.getRole(),outputNode,statRef.getTargetSModelReference(),statRef.getTargetNodeId(),statRef.getResolveInfo()));
        }
 else         if (ref instanceof DynamicReference && cloneRefs) {
          DynamicReference dynRef=(DynamicReference)ref;
          DynamicReference output=new DynamicReference(dynRef.getRole(),outputNode,dynRef.getTargetSModelReference(),dynRef.getResolveInfo());
          output.setOrigin(dynRef.getOrigin());
          outputNode.addReference(output);
        }
      }
 else       if (mapping.containsKey(inputTargetNode)) {
        outputNode.setReferent(ref.getRole(),mapping.get(inputTargetNode),false);
      }
 else {
        outputNode.setReferent(ref.getRole(),inputTargetNode,false);
      }
    }
  }
}
