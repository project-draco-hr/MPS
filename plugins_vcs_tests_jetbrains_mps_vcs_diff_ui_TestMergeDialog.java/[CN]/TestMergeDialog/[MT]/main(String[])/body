{
  IdeMain.setTestMode(TestMode.NO_TEST);
  configureMPS();
  final SModel models[]=new SModel[3];
  String resultFile;
  if (args.length == 2) {
    try {
      final SModel[] zipped=ModelUtils.loadZippedModels(new File(args[0]),VcsMergeVersion.values(),false);
      models[0]=zipped[0];
      models[1]=zipped[1];
      models[2]=zipped[2];
    }
 catch (    ReadException e) {
      return;
    }
    resultFile=args[1];
  }
 else   if (args.length == 4) {
    models[0]=ModelUtils.readModel(args[0]);
    models[1]=ModelUtils.readModel(args[1]);
    models[2]=ModelUtils.readModel(args[2]);
    resultFile=args[3];
  }
 else {
    System.err.println("There must be 2 or 4 parameters");
    return;
  }
  final String finalResultFile=resultFile;
  SwingUtilities.invokeLater(new Runnable(){
    public void run(){
      final MergeModelsDialog dialog=ModelAccess.instance().runReadAction(new Computable<MergeModelsDialog>(){
        public MergeModelsDialog compute(){
          IOperationContext context=new StandaloneMPSContext(){
            @Override public Project getProject(){
              return null;
            }
            public IModule getModule(){
              return null;
            }
            @NotNull public IScope getScope(){
              return GlobalScope.getInstance();
            }
            @Override public <T>T getComponent(            Class<T> clazz){
              if (clazz == EditorManager.class) {
                return (T)ourEditorManager;
              }
              return null;
            }
          }
;
          return new MergeModelsDialog(context,models[0],models[1],models[2]);
        }
      }
);
      dialog.setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);
      dialog.showDialog();
      final SModel result=dialog.getResultModel();
      if (result == null) {
        dialog.dispose();
        System.exit(0);
      }
      ModelAccess.instance().runWriteAction(new Runnable(){
        public void run(){
          IFile iFile=FileSystem.getInstance().getFileByPath(finalResultFile);
          if (!iFile.exists())           iFile.createNewFile();
          ModelPersistence.saveModel(result,iFile,true,result.getPersistenceVersion());
        }
      }
);
      dialog.dispose();
      System.exit(0);
    }
  }
);
}
