{
  if (path == null) {
    return null;
  }
  if (moduleSourceDir != null) {
    for (    String macro : MacrosFactory.descriptors) {
      if (path.startsWith(macro)) {
        String relPath=path.substring(path.indexOf('}') + 1);
        return IFileUtils.getCanonicalPath(moduleSourceDir.getDescendant(relPath));
      }
    }
  }
  if (path.startsWith("${")) {
    int index=path.indexOf("}");
    if (index == -1) {
      reporter.report("invalid macro in `" + path + "'",null,null);
      return path;
    }
    String macroName=path.substring(2,index);
    SNode found=null;
    for (    SNode macro : SLinkOperations.getChildren(SNodeOperations.getNodeAncestor(originalModule,MetaAdapterFactory.getConcept(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x4df58c6f18f84a13L,"jetbrains.mps.build.structure.BuildProject"),false,false),MetaAdapterFactory.getContainmentLink(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x4df58c6f18f84a13L,0x4df58c6f18f84a22L,"macros"))) {
      if (!(SNodeOperations.isInstanceOf(macro,MetaAdapterFactory.getConcept(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x668c6cfbafadd002L,"jetbrains.mps.build.structure.BuildFolderMacro")))) {
        continue;
      }
      if (eq_krgnbt_a0c0f0d0f4(SPropertyOperations.getString(macro,MetaAdapterFactory.getProperty(0xceab519525ea4f22L,0x9b92103b95ca8c0cL,0x110396eaaa4L,0x110396ec041L,"name")),macroName)) {
        found=SNodeOperations.cast(macro,MetaAdapterFactory.getConcept(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x668c6cfbafadd002L,"jetbrains.mps.build.structure.BuildFolderMacro"));
        break;
      }
    }
    if (found == null) {
      reporter.report("macro is not declared in build script: " + path,null,null);
      return path;
    }
    String localPath=BuildSourcePath_BehaviorDescriptor.getLocalPath_id4Kip2_918Y$.invoke(SLinkOperations.getTarget(found,MetaAdapterFactory.getContainmentLink(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x668c6cfbafadd002L,0x668c6cfbafadf0eaL,"defaultPath")),(genContext != null ? Context.defaultContext(genContext) : Context.defaultContext()));
    if (localPath == null) {
      if (genContext != null) {
        genContext.showWarningMessage(found,"cannot resolve local path: " + path + ", macro has no default value");
      }
      return path;
    }
    String relPath=path.substring(index + 1);
    return IFileUtils.getCanonicalPath(FileSystem.getInstance().getFileByPath(localPath).getDescendant(relPath));
  }
  return path;
}
