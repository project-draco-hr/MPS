{
  int rows=1;
  int x=0;
  int y=0;
  for (  Control c : controls) {
    if (exclude == c) {
      continue;
    }
    GridData data=(GridData)c.getLayoutData();
    if (data == null || data.exclude) {
      continue;
    }
    do {
      if (x >= columns) {
        ++y;
        x=0;
        if (++rows > newRows) {
          newRows=rows;
          matrix.setSize(newRows * newColumns);
        }
      }
      while (x < columns && matrix.get(y * newColumns + x) != null) {
        ++x;
      }
    }
 while (x >= columns);
    int hspan=Math.max(1,data.horizontalSpan);
    int vspan=Math.max(1,data.verticalSpan);
    rows=Math.max(rows,y + vspan);
    if (rows > newRows) {
      newRows=rows;
      matrix.setSize(newRows * newColumns);
    }
    for (int i=x; i - x < hspan; i++) {
      for (int j=y; j - y < vspan; j++) {
        matrix.set(j * columns + i,c);
      }
    }
    x+=hspan;
  }
}
