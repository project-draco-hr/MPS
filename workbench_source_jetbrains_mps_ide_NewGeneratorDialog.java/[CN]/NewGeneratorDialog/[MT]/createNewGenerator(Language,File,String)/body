{
  LanguageDescriptor languageDescriptor=sourceLanguage.getLanguageDescriptor();
  SModel model=languageDescriptor.getModel();
  model.setLoading(true);
  GeneratorDescriptor generatorDescriptor=GeneratorDescriptor.newInstance(model);
  generatorDescriptor.setGeneratorUID(Generator.generateGeneratorUID(sourceLanguage));
  generatorDescriptor.setName(name);
  String templateModelNamePrefix=sourceLanguage.getNamespace() + ".generator.template";
  ModelRoot templateModelsRoot=ModelRoot.newInstance(model);
  templateModelsRoot.setPrefix(templateModelNamePrefix);
  templateModelsRoot.setPath(templateModelsDir.getAbsolutePath());
  generatorDescriptor.addModelRoot(templateModelsRoot);
  ModuleReference ref=ModuleReference.newInstance(model);
  ref.setName("jetbrains.mps.baseLanguage");
  generatorDescriptor.addDependency(ref);
  languageDescriptor.addGenerator(generatorDescriptor);
  sourceLanguage.setLanguageDescriptor(languageDescriptor);
  sourceLanguage.save();
  List<Generator> generators=sourceLanguage.getGenerators();
  Generator newGenerator=generators.get(generators.size() - 1);
  boolean alreadyOwnsTemplateModel=false;
  for (  SModelDescriptor modelDescriptor : newGenerator.getOwnModelDescriptors()) {
    if (SModelStereotype.isGeneratorModel(modelDescriptor)) {
      alreadyOwnsTemplateModel=true;
      break;
    }
  }
  if (!alreadyOwnsTemplateModel) {
    SModelDescriptor templateModelDescriptor=newGenerator.createModel(new SModelUID(templateModelNamePrefix,"main",SModelStereotype.GENERATOR),templateModelsRoot);
    SModel templateModel=templateModelDescriptor.getSModel();
    templateModel.addLanguage(BootstrapLanguagesManager.getInstance().getTLBase());
    templateModel.addLanguage("jetbrains.mps.baseLanguage");
    templateModel.addLanguage("jetbrains.mps.bootstrap.smodelLanguage");
    templateModel.addImportedModel(sourceLanguage.getStructureModelDescriptor().getModelUID());
    templateModel.addImportedModel(SModelUID.fromString("java.lang@java_stub"));
    MappingConfiguration mappingConfiguration=MappingConfiguration.newInstance(templateModel);
    mappingConfiguration.setName("main");
    templateModel.addRoot(mappingConfiguration);
    templateModelDescriptor.save();
  }
}
