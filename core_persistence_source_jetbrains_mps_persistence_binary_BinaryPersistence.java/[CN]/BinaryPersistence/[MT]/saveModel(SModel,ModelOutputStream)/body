{
  final MetaModelInfoProvider mmiProvider;
  if (model instanceof DefaultSModel && ((DefaultSModel)model).getSModelHeader().getMetaInfoProvider() != null) {
    mmiProvider=((DefaultSModel)model).getSModelHeader().getMetaInfoProvider();
  }
 else {
    mmiProvider=new RegularMetaModelInfo(model.getReference());
  }
  BinaryPersistence bp=new BinaryPersistence(mmiProvider,model);
  IdInfoRegistry meta=bp.saveModelProperties(os);
  Collection<SNode> roots=IterableUtil.asCollection(model.getRootNodes());
  new NodesWriter(model.getReference(),os,meta).writeNodes(roots);
}
