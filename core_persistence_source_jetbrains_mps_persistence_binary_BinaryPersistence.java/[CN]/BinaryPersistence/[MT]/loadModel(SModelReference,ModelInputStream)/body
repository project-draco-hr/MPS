{
  BinaryModelHeader modelHeader=loadHeader(is);
  if (modelReference == null) {
    modelReference=modelHeader.getReference();
  }
  BinarySModel model=new BinarySModel(modelHeader);
  for (  ModuleReference ref : loadModuleRefList(is))   ((jetbrains.mps.smodel.SModel)model).addLanguage(ref);
  for (  ModuleReference ref : loadModuleRefList(is))   ((jetbrains.mps.smodel.SModel)model).addEngagedOnGenerationLanguage(ref);
  for (  ModuleReference ref : loadModuleRefList(is))   ((jetbrains.mps.smodel.SModel)model).addDevKit(ref);
  for (  ImportElement imp : loadImports(is))   ((jetbrains.mps.smodel.SModel)model).addModelImport(imp);
  for (  ImportElement imp : loadImports(is))   ((jetbrains.mps.smodel.SModel)model).addAdditionalModelVersion(imp);
  if (is.readInt() != 0xbaba) {
    throw new IOException("bad stream, no sync token");
  }
  List<Pair<String,SNode>> roots=new NodesReader(modelReference).readNodes(model,is);
  for (  Pair<String,SNode> r : roots) {
    model.addRootNode(r.o2);
  }
  return model;
}
