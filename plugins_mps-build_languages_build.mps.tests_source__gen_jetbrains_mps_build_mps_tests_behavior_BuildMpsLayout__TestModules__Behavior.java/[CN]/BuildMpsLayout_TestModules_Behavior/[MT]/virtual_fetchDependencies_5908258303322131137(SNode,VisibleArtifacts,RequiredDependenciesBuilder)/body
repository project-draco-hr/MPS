{
  SNode project=artifacts.getProject();
  TemplateQueryContext genContext=artifacts.getGenContext();
  ModulePlugins plugins=new ModulePlugins(project,genContext);
  plugins.collect(new MPSModulesClosure(genContext,ListSequence.fromList(SLinkOperations.getTargets(thisNode,"modules",true)).translate(new ITranslator2<SNode,SNode>(){
    public Iterable<SNode> translate(    SNode it){
      return BehaviorReflection.invokeVirtual((Class<Iterable<SNode>>)((Class)Object.class),it,"virtual_getModules_4560297596904469651",new Object[]{});
    }
  }
)).trackDevkits().runtimeClosure());
  for (  SNode plugin : Sequence.fromIterable(plugins.getDependency())) {
    SNode pluginArtifact;
    if (SNodeOperations.getContainingRoot(thisNode) != SNodeOperations.getContainingRoot(plugin)) {
      pluginArtifact=SNodeOperations.as(artifacts.findArtifact(plugin),"jetbrains.mps.build.structure.BuildLayout_Node");
    }
 else {
      pluginArtifact=SNodeOperations.as(artifacts.findArtifact(plugin),"jetbrains.mps.build.structure.BuildLayout_Node");
    }
    if (pluginArtifact != null) {
      builder.add(pluginArtifact,plugin);
    }
  }
  Iterable<SNode> originalModules=ListSequence.fromList(SLinkOperations.getTargets(thisNode,"modules",true)).translate(new ITranslator2<SNode,SNode>(){
    public Iterable<SNode> translate(    SNode it){
      return BehaviorReflection.invokeVirtual((Class<Iterable<SNode>>)((Class)Object.class),it,"virtual_getModules_4560297596904469651",new Object[]{});
    }
  }
);
  Iterable<SNode> modules=Sequence.fromIterable(new MPSModulesClosure(genContext,originalModules).trackDevkits().runtimeClosure().getAllModules()).union(Sequence.fromIterable(originalModules));
  for (  SNode m : Sequence.fromIterable(modules)) {
    SNode artifact;
    SNode originalModule=DependenciesHelper.getOriginalNode(m,genContext);
    VisibleArtifacts currentArtifacts=artifacts;
    artifact=SNodeOperations.as(currentArtifacts.findArtifact(originalModule),"jetbrains.mps.build.structure.BuildLayout_Node");
    if (artifact != null) {
      builder.add(DependenciesHelper.getOriginalNode(artifact,genContext),originalModule);
    }
 else     if (SNodeOperations.isInstanceOf(originalModule,"jetbrains.mps.build.mps.structure.BuildMps_DevKit")) {
      artifact=SNodeOperations.as(currentArtifacts.findArtifact(SLinkOperations.getTarget(SNodeOperations.cast(originalModule,"jetbrains.mps.build.mps.structure.BuildMps_DevKit"),"path",true)),"jetbrains.mps.build.structure.BuildLayout_Node");
      if (artifact != null) {
        builder.add(DependenciesHelper.getOriginalNode(artifact,artifacts.getGenContext()),originalModule);
      }
    }
  }
}
