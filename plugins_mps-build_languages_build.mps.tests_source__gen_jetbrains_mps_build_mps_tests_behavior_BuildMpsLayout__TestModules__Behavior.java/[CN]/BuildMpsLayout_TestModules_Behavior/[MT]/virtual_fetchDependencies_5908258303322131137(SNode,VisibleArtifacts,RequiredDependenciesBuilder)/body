{
  SNode project=artifacts.getProject();
  TemplateQueryContext genContext=artifacts.getGenContext();
  ModulePlugins plugins=new ModulePlugins(project,genContext);
  plugins.collect(new MPSModulesClosure(ListSequence.fromList(SLinkOperations.getChildren(thisNode,MetaAdapterFactory.getContainmentLink(new UUID(3891333323013573211l,-7392620776726838882l),4560297596904469357l,4560297596904469360l,"modules"))).translate(new ITranslator2<SNode,SNode>(){
    public Iterable<SNode> translate(    SNode it){
      return BehaviorReflection.invokeVirtual((Class<Iterable<SNode>>)((Class)Object.class),it,"virtual_getModules_4560297596904469651",new Object[]{});
    }
  }
)).trackDevkits().runtimeClosure());
  for (  SNode plugin : Sequence.fromIterable(plugins.getDependency())) {
    SNode pluginArtifact;
    if (SNodeOperations.getContainingRoot(thisNode) != SNodeOperations.getContainingRoot(plugin)) {
      pluginArtifact=SNodeOperations.as(artifacts.findArtifact(plugin),MetaAdapterFactory.getConcept(new UUID(8755280088213897754l,-5075149991798053422l),7389400916848036997l,"jetbrains.mps.build.structure.BuildLayout_Node"));
    }
 else {
      pluginArtifact=SNodeOperations.as(artifacts.findArtifact(artifacts.toOriginalNode(plugin)),MetaAdapterFactory.getConcept(new UUID(8755280088213897754l,-5075149991798053422l),7389400916848036997l,"jetbrains.mps.build.structure.BuildLayout_Node"));
    }
    if (pluginArtifact != null) {
      builder.add(pluginArtifact,plugin);
    }
  }
  Iterable<SNode> originalModules=ListSequence.fromList(SLinkOperations.getChildren(thisNode,MetaAdapterFactory.getContainmentLink(new UUID(3891333323013573211l,-7392620776726838882l),4560297596904469357l,4560297596904469360l,"modules"))).translate(new ITranslator2<SNode,SNode>(){
    public Iterable<SNode> translate(    SNode it){
      return BehaviorReflection.invokeVirtual((Class<Iterable<SNode>>)((Class)Object.class),it,"virtual_getModules_4560297596904469651",new Object[]{});
    }
  }
);
  Iterable<SNode> modules=Sequence.fromIterable(new MPSModulesClosure(originalModules).trackDevkits().designtimeClosure().getAllModules()).union(Sequence.fromIterable(originalModules));
  for (  SNode m : Sequence.fromIterable(modules)) {
    SNode artifact;
    SNode originalModule=DependenciesHelper.getOriginalNode(m,genContext);
    VisibleArtifacts currentArtifacts=artifacts;
    artifact=SNodeOperations.as(currentArtifacts.findArtifact(originalModule),MetaAdapterFactory.getConcept(new UUID(8755280088213897754l,-5075149991798053422l),7389400916848036997l,"jetbrains.mps.build.structure.BuildLayout_Node"));
    if (artifact != null) {
      builder.add(SNodeOperations.as(DependenciesHelper.getOriginalNode(artifact,genContext),MetaAdapterFactory.getConcept(new UUID(8755280088213897754l,-5075149991798053422l),7389400916848036997l,"jetbrains.mps.build.structure.BuildLayout_Node")),originalModule);
    }
 else     if (SNodeOperations.isInstanceOf(originalModule,MetaAdapterFactory.getConcept(new UUID(934837630734519964l,-6831122735637083229l),322010710375794190l,"jetbrains.mps.build.mps.structure.BuildMps_DevKit"))) {
      artifact=SNodeOperations.as(currentArtifacts.findArtifact(SLinkOperations.getTarget(SNodeOperations.cast(originalModule,MetaAdapterFactory.getConcept(new UUID(934837630734519964l,-6831122735637083229l),322010710375794190l,"jetbrains.mps.build.mps.structure.BuildMps_DevKit")),MetaAdapterFactory.getContainmentLink(new UUID(934837630734519964l,-6831122735637083229l),322010710375871467l,322010710375956261l,"path"))),MetaAdapterFactory.getConcept(new UUID(8755280088213897754l,-5075149991798053422l),7389400916848036997l,"jetbrains.mps.build.structure.BuildLayout_Node"));
      if (artifact != null) {
        builder.add(SNodeOperations.as(DependenciesHelper.getOriginalNode(artifact,genContext),MetaAdapterFactory.getConcept(new UUID(8755280088213897754l,-5075149991798053422l),7389400916848036997l,"jetbrains.mps.build.structure.BuildLayout_Node")),originalModule);
      }
    }
  }
}
