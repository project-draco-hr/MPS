{
  MultiMap<T,SModel> res=new MultiMap<T,SModel>();
  MultiMap<ModelRoot,SModel> g1=groupModelsByRoot(models);
  for (  Entry<ModelRoot,Collection<SModel>> e : g1.entrySet()) {
    ModelRoot rootType=e.getKey();
    if (rootType != null) {
      T key=mapper.value(rootType.getType());
      if (key == null) {
        res.putValues(null,e.getValue());
        continue;
      }
      for (      SModel model : e.getValue()) {
        if (model instanceof EditableSModel && ((EditableSModel)model).isChanged()) {
          res.putValue(null,model);
        }
 else {
          res.putValue(key,model);
        }
      }
    }
  }
  return res;
}
