{
  ModelChange.assertLegalChange(model);
  GlobalScope scope=GlobalScope.getInstance();
  SModelDescriptor modelDescriptor=model.getModelDescriptor();
  IModule module=modelDescriptor == null ? null : modelDescriptor.getModule();
  Set<ModuleReference> usedLanguages=getAllImportedLanguages(model);
  Set<SModelReference> importedModels=new HashSet<SModelReference>();
  for (  SModelDescriptor sm : allImportedModels(model,scope)) {
    importedModels.add(sm.getSModelReference());
  }
  for (  SNode node : model.nodes()) {
    Language lang=node.getLanguage(scope);
    if (lang == null) {
      LOG.error("Can't find language " + node.getLanguageNamespace());
      continue;
    }
    ModuleReference ref=lang.getModuleReference();
    if (!usedLanguages.contains(ref)) {
      if (module != null) {
        if (respectModulesScopes && !module.getDependenciesManager().getAllUsedLanguages().contains(lang)) {
          module.addUsedLanguage(ref);
        }
      }
      usedLanguages.add(ref);
      model.addLanguage(ref);
    }
    for (    SReference reference : node.getReferencesIterable()) {
      if (reference.isExternal()) {
        SModelReference targetModelReference=reference.getTargetSModelReference();
        if (targetModelReference != null && !importedModels.contains(targetModelReference)) {
          if (respectModulesScopes && module != null) {
            SModelDescriptor targetModelDescriptor=SModelRepository.getInstance().getModelDescriptor(targetModelReference);
            IModule targetModule=targetModelDescriptor == null ? null : targetModelDescriptor.getModule();
            if (targetModule != null && !module.getDependenciesManager().getAllDependOnModules().contains(targetModule)) {
              module.addDependency(targetModule.getModuleReference(),false);
            }
          }
          model.addModelImport(targetModelReference,firstVersion);
          importedModels.add(targetModelReference);
        }
      }
    }
  }
  importedModels.clear();
}
