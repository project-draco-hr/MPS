{
  boolean editorRebuildRequired=editor.getUpdater().setInitialEditorHints(myEnabledHints);
  if (myEditedNodeReference != null) {
    SNode newEditedNode=myEditedNodeReference.resolve(editor.getEditorContext().getRepository());
    if (newEditedNode != null && editor.getEditedNode() != newEditedNode) {
      editor.editNode(newEditedNode);
      editor.getUpdater().flushModelEvents();
      editorRebuildRequired=false;
    }
  }
  if (editorRebuildRequired) {
    editor.rebuildEditorContent();
    editor.getUpdater().flushModelEvents();
  }
  editor.clearBracesEnabledCells();
  editor.getUpdater().flushModelEvents();
  boolean needsRelayout=restoreErrors(editor) | restoreTransactionals(editor);
  needsRelayout=restoreFoldingStates(myFoldableStates,editor) | needsRelayout;
  needsRelayout=restoreFoldingStates(mySaveSessionState ? myInitiallyCollapsedStates : myRestoreAlwaysStates,editor) | needsRelayout;
  editor.getSelectionManager().setSelectionInfoStack(mySelectionStack);
  EditorCell selectedCell=editor.getDeepestSelectedCell();
  if (selectedCell instanceof WithCaret) {
    ((WithCaret)selectedCell).setCaretVisible(false);
  }
  for (  CellInfo collectionInfo : myCollectionsWithEnabledBraces) {
    EditorCell collection=collectionInfo.findCell(editor);
    if (!(collection instanceof jetbrains.mps.nodeEditor.cells.EditorCell_Collection)) {
      continue;
    }
    if (((jetbrains.mps.nodeEditor.cells.EditorCell_Collection)collection).usesBraces()) {
      ((jetbrains.mps.nodeEditor.cells.EditorCell_Collection)collection).enableBraces();
    }
  }
  if (needsRelayout) {
    editor.relayout();
  }
  if (myViewPosition != null) {
    editor.setViewPosition(myViewPosition);
  }
}
