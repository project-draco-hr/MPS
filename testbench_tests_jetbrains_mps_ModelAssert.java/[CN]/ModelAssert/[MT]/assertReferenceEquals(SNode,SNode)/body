{
  Set<String> roles=new HashSet<String>();
  roles.addAll(jetbrains.mps.util.SNodeOperations.getReferenceRoles(expectedNode));
  roles.addAll(jetbrains.mps.util.SNodeOperations.getReferenceRoles(actualNode));
  Map<String,Set<SReference>> expRoleToReferenceMap=createRoleToReferenceMap(expectedNode);
  Map<String,Set<SReference>> actRoleToReferenceMap=createRoleToReferenceMap(actualNode);
  for (  String role : roles) {
    Assert.assertEquals(getErrorString("different number of referents in role " + role,expectedNode,actualNode),expRoleToReferenceMap.get(role).size(),actRoleToReferenceMap.get(role).size());
    SReference expectedReference=expectedNode.getReference(role);
    SReference actualReference=actualNode.getReference(role);
    assertReferenceEquals(getErrorString("reference in role " + role,expectedNode,actualNode),expectedReference,actualReference);
  }
}
