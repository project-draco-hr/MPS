{
  String modelsLongName=inputModel.getLongName();
  SModel currentInputModel=inputModel;
  List<MappingScript> preMappingScripts=mySessionContext.getPreMappingScripts();
  if (!preMappingScripts.isEmpty()) {
    boolean needToCloneInputMode=!myDiscardTransients;
    if (!needToCloneInputMode) {
      for (      MappingScript preMappingScript : preMappingScripts) {
        if (preMappingScript.getScriptKind() == MappingScriptKind.pre_process_input_model) {
          if (preMappingScript.getModifiesModel()) {
            needToCloneInputMode=true;
            break;
          }
        }
      }
    }
    if (needToCloneInputMode) {
      SModel currentInputModel_clone=createTransientModel(modelsLongName);
      addMessage(MessageKind.INFORMATION,"clone model '" + currentInputModel.getSModelFqName() + "' --> '"+ currentInputModel_clone.getSModelFqName()+ "'");
      CloneUtil.cloneModel(currentInputModel,currentInputModel_clone,inputModel == mySessionContext.getOriginalInputModel());
      if (!myDiscardTransients) {
        mySessionContext.getGenerationTracer().registerPreMappingScripts(currentInputModel,currentInputModel_clone,preMappingScripts);
      }
      recycleWasteModel(currentInputModel);
      currentInputModel=currentInputModel_clone;
    }
  }
  for (  MappingScript preMappingScript : preMappingScripts) {
    if (preMappingScript.getScriptKind() != MappingScriptKind.pre_process_input_model) {
      addMessage(MessageKind.WARNING,"skip script '" + preMappingScript + "' ("+ preMappingScript.getModel().getSModelFqName()+ ") - wrong script kind",preMappingScript.getNode());
      continue;
    }
    addMessage(MessageKind.INFORMATION,"pre-process '" + preMappingScript + "' ("+ preMappingScript.getModel().getSModelFqName()+ ")",preMappingScript.getNode());
    GeneratorUtil.executeMappingScript(preMappingScript,currentInputModel,generator);
  }
  SModel currentOutputModel=createTransientModel(modelsLongName);
  mySessionContext.getGenerationTracer().startTracing(currentInputModel,currentOutputModel);
  currentInputModel.setLoading(false);
  boolean somethingHasBeenGenerated=generator.doPrimaryMapping(currentInputModel,currentOutputModel);
  if (!somethingHasBeenGenerated) {
    currentOutputModel.validateLanguagesAndImports();
    recycleWasteModel(currentInputModel);
    return currentOutputModel;
  }
  int secondaryMappingRepeatCount=1;
  while (true) {
    currentOutputModel.validateLanguagesAndImports();
    addMessage(MessageKind.INFORMATION,"generating model '" + currentOutputModel.getSModelFqName() + "'");
    mySessionContext.clearTransientObjects();
    SModel transientModel=createTransientModel(modelsLongName);
    recycleWasteModel(currentInputModel);
    currentInputModel=currentOutputModel;
    currentInputModel.setLoading(false);
    mySessionContext.getGenerationTracer().startTracing(currentInputModel,transientModel);
    if (!generator.doSecondaryMapping(currentInputModel,transientModel)) {
      mySessionContext.getGenerationTracer().discardTracing(currentInputModel,transientModel);
      addMessage(MessageKind.INFORMATION,"remove empty model '" + transientModel.getSModelFqName() + "'");
      SModelRepository.getInstance().removeModelDescriptor(transientModel.getModelDescriptor());
      myTransientModelsCount--;
      break;
    }
    if (++secondaryMappingRepeatCount > 10) {
      generator.showErrorMessage(null,"failed to generate output after 10 repeated mappings");
      if (mySessionContext.getGenerationTracer().isTracing()) {
        LOG.error("last rules applied:");
        List<Pair<SNode,SNode>> pairs=mySessionContext.getGenerationTracer().getAllAppiedRulesWithInputNodes(transientModel.getSModelReference());
        for (        Pair<SNode,SNode> pair : pairs) {
          LOG.error("rule: " + pair.o1.getDebugText(),pair.o1);
          LOG.error("-- input: " + (pair.o2 != null ? pair.o2.getDebugText() : "n/a"),pair.o2);
        }
      }
 else {
        LOG.error("to get more diagnostic generate model with the 'save transient models' option");
      }
      throw new GenerationFailureException("failed to generate output after 10 repeated mappings");
    }
    currentOutputModel=transientModel;
  }
  currentOutputModel.setLoading(true);
  List<MappingScript> postMappingScripts=mySessionContext.getPostMappingScripts();
  if (!postMappingScripts.isEmpty() && !myDiscardTransients) {
    SModel currentOutputModel_clone=createTransientModel(modelsLongName);
    addMessage(MessageKind.INFORMATION,"clone model '" + currentOutputModel.getSModelFqName() + "' --> '"+ currentOutputModel_clone.getSModelFqName()+ "'");
    CloneUtil.cloneModel(currentOutputModel,currentOutputModel_clone,false);
    mySessionContext.getGenerationTracer().registerPostMappingScripts(currentOutputModel,currentOutputModel_clone,postMappingScripts);
    currentOutputModel=currentOutputModel_clone;
  }
  for (  MappingScript postMappingScript : postMappingScripts) {
    if (postMappingScript.getScriptKind() != MappingScriptKind.post_process_output_model) {
      addMessage(MessageKind.WARNING,"skip script '" + postMappingScript + "' ("+ postMappingScript.getModel().getSModelFqName()+ ") - wrong script kind",postMappingScript.getNode());
      continue;
    }
    addMessage(MessageKind.INFORMATION,"post-process '" + postMappingScript + "' ("+ postMappingScript.getModel().getLongName()+ ")",postMappingScript.getNode());
    GeneratorUtil.executeMappingScript(postMappingScript,currentOutputModel,generator);
  }
  return currentOutputModel;
}
