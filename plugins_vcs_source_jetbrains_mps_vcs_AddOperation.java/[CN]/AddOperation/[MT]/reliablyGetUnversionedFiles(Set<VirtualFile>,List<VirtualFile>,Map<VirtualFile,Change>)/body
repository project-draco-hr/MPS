{
  myMpsVcsManager.ensureVcssInitialized();
  Map<AbstractVcs,List<VirtualFile>> vcsToFiles=new HashMap<AbstractVcs,List<VirtualFile>>();
  for (  VirtualFile f : files) {
    AbstractVcs vcs=myManager.getVcsFor(f);
    if (vcs == null)     continue;
    List<VirtualFile> filesList=vcsToFiles.get(vcs);
    if (filesList == null) {
      filesList=new ArrayList<VirtualFile>();
      vcsToFiles.put(vcs,filesList);
    }
    filesList.add(f);
  }
  final List<Change> deletedChange=new ArrayList<Change>();
  for (  AbstractVcs vcs : vcsToFiles.keySet()) {
    VcsDirtyScopeImpl scope=new VcsDirtyScopeImpl(vcs,myProject);
    List<VirtualFile> currentFiles=vcsToFiles.get(vcs);
    for (    VirtualFile f : currentFiles) {
      scope.addDirtyFile(VcsContextFactory.SERVICE.getInstance().createFilePathOn(f));
    }
    ChangeProvider changeProvider=vcs.getChangeProvider();
    if (changeProvider == null) {
      return;
    }
    try {
      changeProvider.getChanges(scope,new EmptyChangelistBuilder(){
        @Override public void processChangeInList(        Change change,        @Nullable ChangeList changeList,        VcsKey vcsKey){
          processChange(change,vcsKey);
        }
        @Override public void processChangeInList(        Change change,        String changeListName,        VcsKey vcsKey){
          processChange(change,vcsKey);
        }
        @Override public void processChange(        Change change,        VcsKey vcsKey){
          if (change.getFileStatus().equals(FileStatus.DELETED)) {
            deletedChange.add(change);
          }
        }
        @Override public void processUnversionedFile(        VirtualFile file){
          if (files.contains(file)) {
            unversioned.add(file);
          }
        }
      }
,new EmptyProgressIndicator(),new StubChangeListManagerGate());
    }
 catch (    VcsException e) {
      LOG.error(e);
    }
  }
  for (  Change change : deletedChange) {
    ContentRevision contentRevision=change.getBeforeRevision();
    if (contentRevision != null) {
      FilePath path=contentRevision.getFile();
      for (      VirtualFile f : files) {
        if (f.getPresentableUrl().equals(path.getPresentableUrl())) {
          deleted.put(f,change);
        }
      }
    }
  }
}
