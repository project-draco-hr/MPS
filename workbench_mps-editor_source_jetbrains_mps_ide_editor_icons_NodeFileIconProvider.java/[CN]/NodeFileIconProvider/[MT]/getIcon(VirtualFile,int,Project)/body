{
  if (file instanceof MPSNodeVirtualFile) {
    final MPSNodeVirtualFile nodeFile=(MPSNodeVirtualFile)file;
    return ModelAccess.instance().runReadAction(new Computable<Icon>(){
      @Override public Icon compute(){
        if (IconDeferrer.getInstance() instanceof DefaultIconDeferrer) {
          SNode node=MPSEditorUtil.getCurrentEditedNode(project,nodeFile);
          if (node != null) {
            return IconManager.getIconWithoutAdditionalPart(node);
          }
        }
        SNode node=nodeFile.getNode();
        if (node != null) {
          return IconManager.getIconWithoutAdditionalPart(node);
        }
        return null;
      }
    }
);
  }
 else   if (file.getFileType().equals(MPSFileTypeFactory.MPS_ROOT_FILE_TYPE)) {
    return ModelAccess.instance().runReadAction(new Computable<Icon>(){
      @Override public Icon compute(){
        SModel descr=SModelFileTracker.getInstance().findModel(VirtualFileUtils.toIFile(file.getParent().findChild(MPSExtentions.DOT_MODEL_HEADER)));
        if (descr == null)         return null;
        for (        SNode node : descr.getRootNodes()) {
          if (node.getName().equals(file.getNameWithoutExtension())) {
            return IconManager.getIconFor(node,true);
          }
        }
        return null;
      }
    }
);
  }
  return null;
}
