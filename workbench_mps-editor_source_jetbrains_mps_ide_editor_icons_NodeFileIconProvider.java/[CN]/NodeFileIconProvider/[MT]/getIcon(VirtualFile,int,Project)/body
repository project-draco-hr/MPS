{
  if (file instanceof MPSNodeVirtualFile) {
    final jetbrains.mps.project.Project mpsProject=ProjectHelper.toMPSProject(project);
    if (mpsProject == null) {
      return null;
    }
    final MPSNodeVirtualFile nodeFile=(MPSNodeVirtualFile)file;
    return new ModelComputeRunnable<Icon>(new Computable<Icon>(){
      @Override public Icon compute(){
        if (IconDeferrer.getInstance() instanceof DefaultIconDeferrer) {
          SNode node=MPSEditorUtil.getCurrentEditedNode(project,nodeFile);
          if (node != null) {
            return IconManager.getIconWithoutAdditionalPart(node);
          }
        }
        SNode node=nodeFile.getNode();
        if (node != null) {
          return IconManager.getIconWithoutAdditionalPart(node);
        }
        return null;
      }
    }
).runRead(mpsProject.getModelAccess());
  }
 else   if (file.getFileType().equals(MPSFileTypeFactory.MPS_ROOT_FILE_TYPE)) {
    final jetbrains.mps.project.Project mpsProject=ProjectHelper.toMPSProject(project);
    if (mpsProject == null) {
      return null;
    }
    return new ModelComputeRunnable<Icon>(new Computable<Icon>(){
      @Override public Icon compute(){
        SModel descr=SModelFileTracker.getInstance(mpsProject.getRepository()).findModel(VirtualFileUtils.toIFile(file.getParent()));
        if (descr == null)         return null;
        for (        SNode node : descr.getRootNodes()) {
          if (node.getName().equals(file.getNameWithoutExtension())) {
            return IconManager.getIconFor(node,true);
          }
        }
        return null;
      }
    }
).runRead(mpsProject.getModelAccess());
  }
  return null;
}
