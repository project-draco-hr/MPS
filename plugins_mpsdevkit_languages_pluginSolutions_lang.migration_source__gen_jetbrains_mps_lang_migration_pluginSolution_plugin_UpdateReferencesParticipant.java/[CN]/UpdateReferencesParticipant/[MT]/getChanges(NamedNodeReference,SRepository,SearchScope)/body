{
{
    final SearchScope scope=CommandUtil.createScope(searchScope);
    QueryExecutionContext context=new QueryExecutionContext(){
      public SearchScope getDefaultSearchScope(){
        return scope;
      }
    }
;
    final SNode movedNode=initialState.reference().resolve(repository);
    Collection<SReference> usages;
    if (movedNode != null) {
      usages=CommandUtil.usages(CommandUtil.createConsoleScope(null,false,context),movedNode);
    }
 else {
      usages=Sequence.fromIterable(CommandUtil.references(CommandUtil.createConsoleScope(null,false,context))).where(new IWhereFilter<SReference>(){
        public boolean accept(        SReference it){
          return eq_k8iioh_a0a0a0a0a0a0a0a4a0a9(it.getTargetNodeReference(),initialState.reference());
        }
      }
).toListSequence();
    }
    return CollectionSequence.fromCollection(usages).select(new ISelector<SReference,RefactoringParticipant.Change<NamedNodeReference,NamedNodeReference>>(){
      public RefactoringParticipant.Change<NamedNodeReference,NamedNodeReference> select(      SReference ref){
        final SNodeReference containingNode=ref.getSourceNode().getReference();
        final SReferenceLink role=ref.getLink();
        final String resolveInfo=SLinkOperations.getResolveInfo(ref);
        final SearchResults searchResults=new SearchResults(SetSequence.fromSetAndArray(new HashSet<SNode>(),movedNode),ListSequence.fromListAndArray(new ArrayList<SearchResult<SNode>>(),new SearchResult<SNode>(ref.getSourceNode(),"reference")));
        RefactoringParticipant.Change<NamedNodeReference,NamedNodeReference> change=new RefactoringParticipant.Change<NamedNodeReference,NamedNodeReference>(){
          public MoveNodeRefactoringParticipant<NamedNodeReference,NamedNodeReference> getParticipant(){
            return UpdateReferencesParticipant.this;
          }
          public SearchResults getSearchResults(){
            return searchResults;
          }
          public boolean needsToPreserveOldNode(){
            return false;
          }
          public void confirm(          final NamedNodeReference finalState,          final SRepository repository,          final RefactoringSession refactoringSession){
            refactoringSession.registerChange(new Runnable(){
              public void run(){
                SNode node=containingNode.resolve(repository);
                MoveNodesDefault.CopyMapObject copyMap=MoveNodesDefault.CopyMapObject.getCopyMap(refactoringSession);
                if (node == null || MapSequence.fromMap(copyMap.getCopyMap()).containsKey(node)) {
                  return;
                }
                node.setReference(role,jetbrains.mps.smodel.SReference.create(role,node,finalState.reference().getModelReference(),finalState.reference().getNodeId(),resolveInfo));
              }
            }
);
          }
        }
;
        return change;
      }
    }
).toListSequence();
  }
}
