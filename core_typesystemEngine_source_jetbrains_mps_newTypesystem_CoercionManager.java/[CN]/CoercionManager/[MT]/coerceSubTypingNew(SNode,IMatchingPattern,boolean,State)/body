{
  if (subtype == null)   return null;
  if (pattern.match(subtype))   return subtype;
  if ("jetbrains.mps.lang.typesystem.structure.MeetType".equals(subtype.getConceptFqName())) {
    List<SNode> children=subtype.getChildren("argument");
    for (    SNode child : children) {
      SNode result=coerceSubTypingNew(child,pattern,isWeak,state);
      if (result != null)       return result;
    }
    return null;
  }
  final TypeCheckingContextNew typeCheckingContext=state == null ? null : state.getTypeCheckingContext();
  if ("jetbrains.mps.lang.typesystem.structure.JoinType".equals(subtype.getConceptFqName())) {
    List<SNode> children=subtype.getChildren("argument");
    SNode lcs=mySubTyping.createLCS(children,typeCheckingContext);
    return coerceSubTypingNew(lcs,pattern,isWeak,state);
  }
  return NodeReadAccessCasterInEditor.runReadTransparentAction(new Computable<SNode>(){
    public SNode compute(){
      SubtypingCache cache=myTypeChecker.getSubtypingCache();
      if (cache != null) {
        Pair<Boolean,SNode> nodePair=cache.getCoerced(subtype,pattern,isWeak);
        if (nodePair.o1) {
          return nodePair.o2;
        }
      }
      cache=myTypeChecker.getGlobalSubtypingCache();
      if (cache != null) {
        Pair<Boolean,SNode> nodePair=cache.getCoerced(subtype,pattern,isWeak);
        if (nodePair.o1) {
          return nodePair.o2;
        }
      }
      CoercionMatcher coercionMatcher=new CoercionMatcher(pattern);
      boolean success=mySubTyping.searchInSuperTypes(subtype,coercionMatcher,null,isWeak,null);
      SNode result=null;
      if (success) {
        List<SNode> nodes=coercionMatcher.getResults();
        if (nodes.size() > 1) {
          nodes=mySubTyping.eliminateSuperTypes(nodes);
        }
        if (!nodes.isEmpty()) {
          result=nodes.get(0);
        }
      }
      SubtypingCache subtypingCache=myTypeChecker.getSubtypingCache();
      if (subtypingCache != null) {
        subtypingCache.addCacheEntry(subtype,pattern,result,isWeak);
      }
      subtypingCache=myTypeChecker.getGlobalSubtypingCache();
      if (subtypingCache != null) {
        subtypingCache.addCacheEntry(subtype,pattern,result,isWeak);
      }
      return result;
    }
  }
);
}
