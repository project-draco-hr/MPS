{
  Map<IFacet.Name,IFacet> facetsView=collectFacets();
  if (ListSequence.fromList(errors).isNotEmpty()) {
    return new InvalidScript(errors);
  }
  final Map<IFacet.Name,ScriptBuilder.FacetRefs> refs=MapSequence.fromMap(new HashMap<IFacet.Name,ScriptBuilder.FacetRefs>());
  this.collectRefs(refs,facetsView);
  if (ListSequence.fromList(errors).isNotEmpty()) {
    return new InvalidScript(errors);
  }
  Iterable<IFacet.Name> sortedFacets=this.toposortByExtended(refs,facetsView);
  if (ListSequence.fromList(errors).isNotEmpty()) {
    return new InvalidScript(errors);
  }
  TargetRange tr=new TargetRange();
  this.collectTargets(sortedFacets,tr,facetsView);
  if (ListSequence.fromList(errors).isNotEmpty()) {
    return new InvalidScript(errors);
  }
  Script sc=new Script(tr,finalTarget);
  sc.validate();
  return sc;
}
