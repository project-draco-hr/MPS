{
  if (node == null) {
    return null;
  }
  if (SNodeOperations.isInstanceOf(node,"jetbrains.mps.lang.generator.structure.InlineTemplate_RuleConsequence") || SNodeOperations.isInstanceOf(node,"jetbrains.mps.lang.generator.structure.InlineTemplateWithContext_RuleConsequence")) {
    SNode parent=SNodeOperations.getParent(node);
    if ((parent == null) || !(SNodeOperations.isInstanceOf(parent,"jetbrains.mps.lang.generator.structure.IfMacro")) || SLinkOperations.getTarget(SNodeOperations.cast(parent,"jetbrains.mps.lang.generator.structure.IfMacro"),"alternativeConsequence",true) != node) {
      return null;
    }
  }
  List<SNode> attributes=SNodeOperations.getAllAttributes(node);
  SNode prevMacro=null;
  for (  SNode attribute : ListSequence.fromList(attributes)) {
    if (attribute == currMacroNode) {
      break;
    }
    if (SNodeOperations.isInstanceOf(attribute,"jetbrains.mps.lang.generator.structure.SourceSubstituteMacro")) {
      if (SNodeOperations.isInstanceOf(attribute,"jetbrains.mps.lang.generator.structure.MapSrcNodeMacro")) {
        if (SLinkOperations.getTarget(SNodeOperations.cast(attribute,"jetbrains.mps.lang.generator.structure.MapSrcNodeMacro"),"sourceNodeQuery",true) == null) {
          continue;
        }
      }
      if (SNodeOperations.isInstanceOf(attribute,"jetbrains.mps.lang.generator.structure.SwitchMacro")) {
        if (SLinkOperations.getTarget(SNodeOperations.cast(attribute,"jetbrains.mps.lang.generator.structure.SwitchMacro"),"sourceNodeQuery",true) == null) {
          continue;
        }
      }
      prevMacro=SNodeOperations.cast(attribute,"jetbrains.mps.lang.generator.structure.SourceSubstituteMacro");
    }
  }
  if (prevMacro != null) {
    return prevMacro;
  }
  return getEnclosing_SourceSubstituteMacro(SNodeOperations.getParent(node),null);
}
