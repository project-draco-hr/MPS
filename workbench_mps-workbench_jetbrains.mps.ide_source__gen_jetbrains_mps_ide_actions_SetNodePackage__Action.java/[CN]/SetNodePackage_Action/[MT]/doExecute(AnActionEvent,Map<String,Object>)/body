{
  final Wrappers._T<List<String>> packages=new Wrappers._T<List<String>>();
  final Wrappers._T<String> oldPackage=new Wrappers._T<String>();
  ModelAccess modelAccess=((MPSProject)MapSequence.fromMap(_params).get("project")).getRepository().getModelAccess();
  modelAccess.runReadAction(new Runnable(){
    public void run(){
      packages.value=SetNodePackage_Action.this.fetchExistingPackages(((List<SNode>)MapSequence.fromMap(_params).get("nodes")),_params);
      oldPackage.value=SPropertyOperations.getString(ListSequence.fromList(((List<SNode>)MapSequence.fromMap(_params).get("nodes"))).first(),MetaAdapterFactory.getProperty(0xceab519525ea4f22L,0x9b92103b95ca8c0cL,0x10802efe25aL,0x115eca8579fL,"virtualPackage"));
    }
  }
);
  final SetNodePackageDialog dialog=new SetNodePackageDialog(((MPSProject)MapSequence.fromMap(_params).get("project")),packages.value);
  dialog.setPackage(oldPackage.value);
  dialog.show();
  if (dialog.isCancelled()) {
    return;
  }
  modelAccess.executeCommandInEDT(new Runnable(){
    public void run(){
      for (      SNode node : ListSequence.fromList(((List<SNode>)MapSequence.fromMap(_params).get("nodes")))) {
        SPropertyOperations.set(node,MetaAdapterFactory.getProperty(0xceab519525ea4f22L,0x9b92103b95ca8c0cL,0x10802efe25aL,0x115eca8579fL,"virtualPackage"),dialog.getPackage());
        if (SNodeOperations.isInstanceOf(node,MetaAdapterFactory.getConcept(0xc72da2b97cce4447L,0x8389f407dc1158b7L,0x1103553c5ffL,"jetbrains.mps.lang.structure.structure.AbstractConceptDeclaration"))) {
          for (          SNode aspect : ListSequence.fromList(SetNodePackage_Action.this.findAllAspects(((Project)MapSequence.fromMap(_params).get("ideaProject")),SNodeOperations.cast(node,MetaAdapterFactory.getConcept(0xc72da2b97cce4447L,0x8389f407dc1158b7L,0x1103553c5ffL,"jetbrains.mps.lang.structure.structure.AbstractConceptDeclaration")),_params))) {
            SPropertyOperations.set(((SNode)aspect),MetaAdapterFactory.getProperty(0xceab519525ea4f22L,0x9b92103b95ca8c0cL,0x10802efe25aL,0x115eca8579fL,"virtualPackage"),dialog.getPackage());
          }
        }
      }
    }
  }
);
}
