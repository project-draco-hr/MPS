{
  INodeReferentSearchScopeProvider scopeProvider=ModelConstraintsManager.getInstance().getNodeReferentSearchScopeProvider(referenceNodeConcept,linkRole);
  ReferentConstraintContext referentConstraintContext=new ReferentConstraintContext(model,enclosingNode,referenceNode,BaseAdapter.fromAdapter(linkTarget));
  if (scopeProvider != null) {
    ISearchScope searchScope=scopeProvider.createNodeReferentSearchScope(context,referentConstraintContext);
    return newOK(searchScope,scopeProvider.hasPresentation() ? new DefaultReferencPresentation(context,referentConstraintContext,scopeProvider) : null,false);
  }
  if (linkTarget == null) {
    LinkDeclaration linkDeclaration=SModelSearchUtil.findLinkDeclaration(referenceNodeConcept,linkRole);
    if (linkDeclaration == null) {
      throw new RuntimeException("couldn't find '" + linkRole + "' link declaration in concept "+ referenceNodeConcept.getDebugText());
    }
    linkTarget=linkDeclaration.getTarget();
  }
  scopeProvider=ModelConstraintsManager.getInstance().getNodeDefaultSearchScopeProvider(linkTarget);
  if (scopeProvider != null) {
    ISearchScope searchScope=scopeProvider.createNodeReferentSearchScope(context,referentConstraintContext);
    return newOK(searchScope,scopeProvider.hasPresentation() ? new DefaultReferencPresentation(context,referentConstraintContext,scopeProvider) : null,false);
  }
  ISearchScope searchScope=SModelSearchUtil.createModelAndImportedModelsScope(model,false,context.getScope());
  return newOK(searchScope,null,true);
}
