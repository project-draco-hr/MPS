{
synchronized (myModelsLock) {
    fireBeforeModelRemoved(md);
    List<ModelOwner> owners=myModelsWithOwners.get(md);
    if (owners != null) {
      for (      ModelOwner owner : owners) {
        Set<SModelDescriptor> ownerModels=myModelsByOwner.get(owner);
        if (!ownerModels.remove(md))         throw new IllegalStateException();
      }
    }
    myModelsWithOwners.remove(md);
    if (md.getSModelReference().getModelId() != null) {
      myIdToModelDescriptorMap.remove(md.getSModelReference().getModelId());
      if (md instanceof BaseSModelDescriptor) {
        ((BaseSModelDescriptor)md).setRegistered(false);
      }
    }
    myFqNameToModelDescriptorMap.remove(md.getSModelReference().getSModelFqName());
    md.removeModelListener(myModelsListener);
    fireModelRemoved(md);
    md.dispose();
  }
}
