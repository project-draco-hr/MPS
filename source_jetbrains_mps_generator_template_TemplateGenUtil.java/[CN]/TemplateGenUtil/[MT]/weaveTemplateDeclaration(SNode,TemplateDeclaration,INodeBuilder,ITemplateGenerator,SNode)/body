{
  List<TemplateFragment> templateFragments=getTemplateFragments(templateDeclaration);
  if (templateFragments.isEmpty()) {
    generator.showErrorMessage(sourceNode,templateDeclaration,ruleNode,"nothing to weave: no template fragments found in template");
    return;
  }
  boolean allFragmentsWhichUseDefaultContextHaveSameParent=true;
  SNode defaultContext=null;
  for (  TemplateFragment templateFragment : templateFragments) {
    if (templateFragment.getContextProviderAspectId() == null) {
      SNode contextNode=templateFragment.getParent().getParent();
      if (defaultContext == null) {
        defaultContext=contextNode;
      }
 else       if (defaultContext != contextNode) {
        allFragmentsWhichUseDefaultContextHaveSameParent=false;
        break;
      }
    }
  }
  if (!allFragmentsWhichUseDefaultContextHaveSameParent) {
    for (    TemplateFragment templateFragment : templateFragments) {
      if (templateFragment.getContextProviderAspectId() == null) {
        generator.showErrorMessage(null,templateFragment,null,"template fragment uses <default context>: conflicts with other fragments which use <default context>");
      }
    }
  }
  for (  TemplateFragment templateFragment : templateFragments) {
    SNode templateFragmentNode=templateFragment.getParent();
    String mappingName=templateFragment.getName();
    List<INodeBuilder> fragmentNodeBuilders=createNodeBuildersForTemplateNode(sourceNode,templateFragmentNode,mappingName,0,generator);
    for (    INodeBuilder fragmentBuilder : fragmentNodeBuilders) {
      fragmentBuilder.setRuleNode(ruleNode);
      INodeBuilder fragmentContextBuilder=getContextBuilderForTemplateFragment(templateFragmentNode,contextBuilder,generator);
      if (fragmentContextBuilder != null) {
        fragmentContextBuilder.addChildBuilder(fragmentBuilder);
      }
 else {
        generator.showErrorMessage(sourceNode,templateFragment,ruleNode,"couldn't define 'context' for template fragment");
      }
    }
  }
}
