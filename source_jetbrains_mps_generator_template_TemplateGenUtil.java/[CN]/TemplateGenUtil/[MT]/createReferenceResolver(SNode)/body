{
  IReferenceResolver referenceResolver=loadReferenceResolver(templateNode);
  if (referenceResolver == null) {
    referenceResolver=new DefaultReferenceResolver();
  }
  SNode mayBeTemplateFragment=templateNode;
  while (mayBeTemplateFragment != null) {
    if (TemplateLanguageUtil.isTemplateFragment(mayBeTemplateFragment)) {
      return new TemplateFragmentReferenceResolver(referenceResolver);
    }
    mayBeTemplateFragment=mayBeTemplateFragment.getParent();
  }
  return referenceResolver;
}
