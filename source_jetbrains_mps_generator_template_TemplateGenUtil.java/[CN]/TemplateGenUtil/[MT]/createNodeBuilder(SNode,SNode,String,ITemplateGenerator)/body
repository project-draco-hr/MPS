{
  INodeBuilder builder=null;
  boolean needCreateChildBuilders=true;
  NodeMacro nodeMacro=(NodeMacro)templateNode.getChild(ITemplateGenerator.ROLE_NODE_MAKRO);
  if (nodeMacro != null) {
    if (nodeMacro instanceof SwitchMacro) {
      TemplateSwitch templateSwitch=((SwitchMacro)nodeMacro).getTemplateSwitch();
      SNode templateNodeFromSwitch=getTemplateNodeFromSwitch(sourceNode,templateSwitch,generator);
      if (templateNodeFromSwitch != null) {
        builder=createNodeBuilder(sourceNode,templateNodeFromSwitch,mappingName,generator);
        if (builder != null) {
          builder.setRoleInParent(templateNode.getRole_());
          needCreateChildBuilders=false;
        }
      }
    }
 else     if (nodeMacro instanceof CopySrcNodeMacro) {
      builder=TemplateGenUtil.createCopyingNodeBuilder(sourceNode,templateNode.getRole_(),generator);
      needCreateChildBuilders=false;
    }
 else     if (nodeMacro instanceof CopySrcListMacro) {
      builder=TemplateGenUtil.createCopyingNodeBuilder(sourceNode,templateNode.getRole_(),generator);
      needCreateChildBuilders=false;
    }
 else {
      String targetBuilderAspectMethodName=nodeMacro.getTargetBuilderAspectMethodName();
      if (targetBuilderAspectMethodName != null) {
        String methodName="templateTargetBuilder_" + targetBuilderAspectMethodName;
        Object[] args=new Object[]{sourceNode,templateNode,mappingName,generator};
        builder=(INodeBuilder)QueryMethod.invoke(methodName,args,nodeMacro.getModel());
      }
    }
  }
  if (builder == null) {
    builder=createDefaultNodeBuilder(sourceNode,templateNode,mappingName,generator);
  }
  if (needCreateChildBuilders) {
    createChildBuilders(builder);
  }
  return builder;
}
