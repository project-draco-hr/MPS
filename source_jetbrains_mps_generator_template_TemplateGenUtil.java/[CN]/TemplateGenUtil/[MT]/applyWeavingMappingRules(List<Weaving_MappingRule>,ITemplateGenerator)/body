{
  if (rules.isEmpty())   return;
  for (  Weaving_MappingRule rule : rules) {
    ConceptDeclaration applicableConcept=rule.getApplicableConcept();
    if (applicableConcept == null) {
      generator.showErrorMessage(null,rule,"rule has no applicable concept defined");
      continue;
    }
    boolean includeInheritors=rule.getApplyToConceptInheritors();
    List<SNode> nodes=generator.getSourceModel().getModelDescriptor().getFastNodeFinder().getNodes(applicableConcept,includeInheritors);
    for (    SNode applicableNode : nodes) {
      if (checkConditionForBaseMappingRule(applicableNode,rule,generator)) {
        INodeBuilder contextBuilder=getContextNodeBuilderForWeavingingRule(applicableNode,rule,generator);
        if (contextBuilder == null) {
          generator.showErrorMessage(applicableNode,rule,"couldn't create context node builder");
          continue;
        }
        TemplateDeclaration template=rule.getTemplate();
        if (template != null) {
          weaveTemplateDeclaration(applicableNode,template,contextBuilder,generator,rule);
        }
 else {
          RuleConsequence ruleConsequence=rule.getRuleConsequence();
          if (ruleConsequence instanceof DismissTopMappingRule) {
            continue;
          }
 else           if (ruleConsequence instanceof TemplateDeclarationReference) {
            template=((TemplateDeclarationReference)ruleConsequence).getTemplate();
            if (template == null) {
              generator.showErrorMessage(applicableNode,rule,"rule has no template");
              break;
            }
            weaveTemplateDeclaration(applicableNode,template,contextBuilder,generator,rule);
          }
 else           if (ruleConsequence instanceof WeaveEach_RuleConsequence) {
            WeaveEach_RuleConsequence weaveEach=(WeaveEach_RuleConsequence)ruleConsequence;
            template=weaveEach.getTemplate();
            if (template == null) {
              generator.showErrorMessage(applicableNode,rule,"rule has no template");
              break;
            }
            SourceSubstituteMacro_SourceNodesQuery nodesQuery=weaveEach.getSourceNodesQuery();
            if (nodesQuery == null) {
              generator.showErrorMessage(applicableNode,rule,"couldn't create list of source nodes");
              break;
            }
            List<SNode> queryNodes=evaluateSourceNodesQuery(applicableNode,nodesQuery,ruleConsequence,generator);
            for (            SNode queryNode : queryNodes) {
              weaveTemplateDeclaration(queryNode,template,contextBuilder,generator,rule);
            }
          }
        }
      }
    }
  }
}
