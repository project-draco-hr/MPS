{
  if (rules.isEmpty())   return;
  for (  Weaving_MappingRule rule : rules) {
    ConceptDeclaration applicableConcept=rule.getApplicableConcept();
    if (applicableConcept == null) {
      generator.showErrorMessage(null,BaseAdapter.fromAdapter(rule),"rule has no applicable concept defined");
      continue;
    }
    boolean includeInheritors=rule.getApplyToConceptInheritors();
    List<SNode> nodes=generator.getSourceModel().getModelDescriptor().getFastNodeFinder().getNodes(applicableConcept,includeInheritors);
    for (    SNode applicableNode : nodes) {
      if (checkConditionForBaseMappingRule(applicableNode,rule,generator)) {
        INodeBuilder contextBuilder=getContextNodeBuilderForWeavingingRule(applicableNode,rule,generator);
        if (contextBuilder == null) {
          generator.showErrorMessage(applicableNode,BaseAdapter.fromAdapter(rule),"couldn't create context node builder");
          continue;
        }
        TemplateDeclaration template=rule.getTemplate();
        if (template != null) {
          weaveTemplateDeclaration(applicableNode,template,contextBuilder,generator,BaseAdapter.fromAdapter(rule));
        }
 else {
          RuleConsequence ruleConsequence=rule.getRuleConsequence();
          if (ruleConsequence instanceof TemplateDeclarationReference) {
            template=((TemplateDeclarationReference)ruleConsequence).getTemplate();
            weaveTemplateDeclaration(applicableNode,template,contextBuilder,generator,BaseAdapter.fromAdapter(rule));
          }
 else           if (ruleConsequence instanceof WeaveEach_RuleConsequence) {
            WeaveEach_RuleConsequence weaveEach=(WeaveEach_RuleConsequence)ruleConsequence;
            SourceSubstituteMacro_SourceNodesQuery nodesQuery=weaveEach.getSourceNodesQuery();
            if (nodesQuery == null) {
              generator.showErrorMessage(applicableNode,BaseAdapter.fromAdapter(rule),"couldn't create list of source nodes");
              break;
            }
            template=weaveEach.getTemplate();
            List<SNode> queryNodes=evaluateSourceNodesQuery(applicableNode,nodesQuery,BaseAdapter.fromAdapter(ruleConsequence),generator);
            for (            SNode queryNode : queryNodes) {
              weaveTemplateDeclaration(queryNode,template,contextBuilder,generator,BaseAdapter.fromAdapter(rule));
            }
          }
 else {
            generator.showErrorMessage(applicableNode,null,BaseAdapter.fromAdapter(ruleConsequence),"unsapported rule consequence");
          }
        }
      }
    }
  }
}
