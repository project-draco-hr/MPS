{
  ITemplateGenerator generator=nodeBuilder.getGenerator();
  for (  SReference templateReference : nodeBuilder.getTemplateReferencesToResolve()) {
    SNode templateReferentNode=templateReference.getTargetNode();
    if (templateReferentNode == null) {
      generator.showErrorMessage(templateNode,"Invalid reference \"" + templateReference.getRole() + "\" in templates model "+ templateNode.getModel().getUID());
      continue;
    }
    if (templateReferentNode instanceof NodeMacro || templateReferentNode instanceof ReferenceMacro || templateReferentNode instanceof PropertyMacro) {
      continue;
    }
    if (ReferenceMacro_AnnotationLink.getReferenceMacro((BaseConcept)templateNode,templateReference.getRole()) != null) {
      continue;
    }
    if (templateReferentNode.getModel() != templateNode.getModel() && templateReferentNode.getModel() != generator.getSourceModel()) {
      targetNode.addReferent(templateReference.getRole(),templateReferentNode);
      continue;
    }
    IScope scope=generator.getScope();
    IReferenceResolver referenceResolver=createReferenceResolver(templateNode,scope);
    SNode targetReferentNode=referenceResolver.resolveTarget(templateReference,nodeBuilder);
    if (targetReferentNode != null) {
      if (checkResolvedReference(nodeBuilder.getSourceNode(),targetNode,templateNode,templateReference.getRole(),targetReferentNode,generator)) {
        targetNode.addReferent(templateReference.getRole(),targetReferentNode);
      }
      continue;
    }
    generator.showErrorMessage(nodeBuilder.getSourceNode(),templateNode,nodeBuilder.getRuleNode(),"Couldn't resolve template reference \"" + templateReference.getRole() + "\"");
    LOG.error("preved! error. set breakpoint here, referenceResolver:" + referenceResolver);
    referenceResolver.resolveTarget(templateReference,nodeBuilder);
  }
}
