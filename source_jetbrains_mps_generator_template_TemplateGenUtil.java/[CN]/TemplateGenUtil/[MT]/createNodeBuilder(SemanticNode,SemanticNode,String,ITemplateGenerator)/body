{
  INodeBuilder builder=null;
  NodeMacro nodeMacro=(NodeMacro)templateNode.getChild(ITemplateGenerator.ROLE_NODE_MAKRO);
  if (nodeMacro != null) {
    if (nodeMacro instanceof SwitchMacro) {
      TemplateSwitch templateSwitch=((SwitchMacro)nodeMacro).getTemplateSwitch();
      SemanticNode templateNodeFromSwitch=getTemplateNodeFromSwitch(sourceNode,templateSwitch,generator);
      if (templateNodeFromSwitch != null) {
        builder=createNodeBuilder(sourceNode,templateNodeFromSwitch,mappingName,generator);
        if (builder != null) {
          builder.setRoleInParent(templateNode.getRole_());
        }
      }
    }
    if (nodeMacro instanceof CopySrcNodeMacro) {
      CopySrcNodeMacro copySrcNodeMacro=((CopySrcNodeMacro)nodeMacro);
      String sourceNodeQueryId=copySrcNodeMacro.getSourceNodeQueryId();
      String methodName="templateSourceNodeQuery_" + sourceNodeQueryId;
      Object[] args=new Object[]{sourceNode,generator};
      SemanticNode srcNodeToCopy=(SemanticNode)AspectMethod.invoke(methodName,args,nodeMacro.getModel());
      if (srcNodeToCopy != null) {
        builder=TemplateGenUtil.createCopyingNodeBuilder(srcNodeToCopy,templateNode.getRole_(),generator);
      }
 else {
        builder=new Void_NodeBuilder(sourceNode,templateNode,mappingName,generator);
      }
    }
 else {
      String targetBuilderAspectMethodName=nodeMacro.getTargetBuilderAspectMethodName();
      if (targetBuilderAspectMethodName != null) {
        String methodName="templateTargetBuilder_" + targetBuilderAspectMethodName;
        Object[] args=new Object[]{sourceNode,templateNode,mappingName,generator};
        builder=(INodeBuilder)AspectMethod.invoke(methodName,args,nodeMacro.getModel());
      }
    }
  }
  if (builder != null) {
    return builder;
  }
  return createDefaultNodeBuilder(sourceNode,templateNode,mappingName,generator);
}
