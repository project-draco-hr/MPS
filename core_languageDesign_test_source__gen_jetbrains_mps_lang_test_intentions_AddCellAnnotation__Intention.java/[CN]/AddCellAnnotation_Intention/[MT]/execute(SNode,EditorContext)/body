{
  SNode ancessor=node;
  while (ancessor != null && !(SNodeOperations.isInstanceOf(SNodeOperations.getParent(ancessor),"jetbrains.mps.lang.test.structure.EditorTestCase"))) {
    ancessor=SNodeOperations.getParent(ancessor);
  }
  for (  SNode oldAnnotation : SNodeOperations.getDescendants(ancessor,"jetbrains.mps.lang.test.structure.AnonymousCellAnnotation",false,new String[]{})) {
    SNodeOperations.deleteNode(oldAnnotation);
  }
  SNode newAnnotation=SNodeFactoryOperations.createNewNode("jetbrains.mps.lang.test.structure.AnonymousCellAnnotation",null);
  EditorCell contextCell=editorContext.getContextCell();
  if (contextCell.getEditor() instanceof InspectorEditorComponent) {
    SPropertyOperations.set(newAnnotation,"isInInspector","" + true);
  }
  if (contextCell instanceof EditorCell_Label) {
    EditorCell_Label label=(EditorCell_Label)contextCell;
    int caretPosition=label.getCaretPosition();
    if (caretPosition == label.getText().length()) {
      SPropertyOperations.set(newAnnotation,"isLastPosition","" + true);
    }
 else {
      SPropertyOperations.set(newAnnotation,"caretPosition","" + caretPosition);
    }
    SPropertyOperations.set(newAnnotation,"useLabelSelection","" + true);
    SPropertyOperations.set(newAnnotation,"selectionStart","" + label.getSelectionStart());
    SPropertyOperations.set(newAnnotation,"selectionEnd","" + label.getSelectionEnd());
  }
 else {
    SPropertyOperations.set(newAnnotation,"caretPosition","" + 0);
  }
  SPropertyOperations.set(newAnnotation,"cellId",contextCell.getCellId());
  NodeRangeSelection nodeRangeSelection=editorContext.getNodeEditorComponent().getNodeRangeSelection();
  if (nodeRangeSelection.isActive()) {
    SLinkOperations.setTarget(newAnnotation,"nodeRangeSelectionStart",nodeRangeSelection.getFirstNode(),false);
    SLinkOperations.setTarget(newAnnotation,"nodeRangeSelectionEnd",nodeRangeSelection.getLastNode(),false);
  }
  SLinkOperations.setTarget(node,AttributesRolesUtil.childRoleFromAttributeRole("testNode"),newAnnotation,true);
  editorContext.select(newAnnotation);
}
