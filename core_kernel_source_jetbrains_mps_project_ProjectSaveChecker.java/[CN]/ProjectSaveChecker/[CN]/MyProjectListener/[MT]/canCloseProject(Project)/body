{
  if (MPSCore.getInstance().isTestMode())   return true;
  if (myIgnoredSaving) {
    myIgnoredSaving=false;
    return true;
  }
  boolean save=true;
  if (!GeneralSettings.getInstance().isSaveOnFrameDeactivation() && !GeneralSettings.getInstance().isAutoSaveIfInactive() && !SModelRepository.getInstance().getChangedModels().isEmpty()) {
    StringBuffer message=new StringBuffer("You have unsaved models:\n\n");
    for (    SModelDescriptor sm : SModelRepository.getInstance().getChangedModels()) {
      message.append(sm.getSModelReference().getSModelFqName().toString()).append("\n");
    }
    message.append("\nDo you want to save them?");
    int saveModelsAnswer=Messages.showYesNoCancelDialog(project,message.toString(),"Save Models",Messages.getQuestionIcon());
    if (saveModelsAnswer == 2) {
      return false;
    }
    save=saveModelsAnswer == 0;
  }
  if (save) {
    ModelAccess.instance().runWriteActionInCommand(new Runnable(){
      public void run(){
        SModelRepository.getInstance().saveAll();
      }
    }
);
  }
 else {
    myIgnoredSaving=true;
  }
  return true;
}
