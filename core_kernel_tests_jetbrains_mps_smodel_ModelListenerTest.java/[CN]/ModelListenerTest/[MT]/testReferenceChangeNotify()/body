{
  SModel m1=new TestModelFactory().createModel(3,2);
  final Iterator<SNode> roots=m1.getRootNodes().iterator();
  final SNode r1=roots.next();
  final SNode r2c1=roots.next().getFirstChild();
  final SNode r3c2=roots.next().getFirstChild().getNextSibling();
  myTestModelAccess.enableWrite();
  ((SModelBase)m1).attach(myTestRepo);
  ChangeListener1 cl1=new ChangeListener1();
  ChangeListener2 cl2=new ChangeListener2();
  attachChangeListeners(m1,cl1,cl2);
  r1.setReferenceTarget(ourRef,r2c1);
  myErrors.checkThat(cl1.myAddedRef.size(),equalTo(1));
  myErrors.checkThat(cl1.myRemovedRef.size(),equalTo(0));
  myErrors.checkThat(cl2.myChangedReferences.size(),equalTo(1));
  myErrors.checkThat(cl2.myChangedReferences.contains(ourRef.getRoleName()),equalTo(true));
  cl1.reset();
  cl2.reset();
  r2c1.setReference(ourRef,jetbrains.mps.smodel.SReference.create(ourRef,r2c1,r3c2));
  myErrors.checkThat(cl1.myAddedRef.size(),equalTo(1));
  myErrors.checkThat(cl1.myRemovedRef.size(),equalTo(0));
  myErrors.checkThat(cl2.myChangedReferences.size(),equalTo(1));
  myErrors.checkThat(cl2.myChangedReferences.contains(ourRef.getRoleName()),equalTo(true));
  cl1.reset();
  cl2.reset();
  r1.setReference(ourRef,jetbrains.mps.smodel.SReference.create(ourRef,r1,r3c2));
  myErrors.checkThat(cl1.myAddedRef.size(),equalTo(1));
  myErrors.checkThat(cl1.myRemovedRef.size(),equalTo(1));
  myErrors.checkThat(cl2.myChangedReferences.size(),equalTo(1));
  myErrors.checkThat(cl2.myChangedReferences.contains(ourRef.getRoleName()),equalTo(true));
  cl1.reset();
  cl2.reset();
  r2c1.setReferenceTarget(ourRef,r1);
  myErrors.checkThat(cl1.myAddedRef.size(),equalTo(1));
  myErrors.checkThat(cl1.myRemovedRef.size(),equalTo(1));
  myErrors.checkThat(cl2.myChangedReferences.size(),equalTo(1));
  myErrors.checkThat(cl2.myChangedReferences.contains(ourRef.getRoleName()),equalTo(true));
  cl1.reset();
  cl2.reset();
  r2c1.setReference(ourRef,null);
  myErrors.checkThat(cl1.myAddedRef.size(),equalTo(0));
  myErrors.checkThat(cl1.myRemovedRef.size(),equalTo(1));
  myErrors.checkThat(cl2.myChangedReferences.size(),equalTo(1));
  myErrors.checkThat(cl2.myChangedReferences.contains(ourRef.getRoleName()),equalTo(true));
  cl1.reset();
  cl2.reset();
  r1.setReferenceTarget(ourRef,null);
  myErrors.checkThat(cl1.myAddedRef.size(),equalTo(0));
  myErrors.checkThat(cl1.myRemovedRef.size(),equalTo(1));
  myErrors.checkThat(cl2.myChangedReferences.size(),equalTo(1));
  myErrors.checkThat(cl2.myChangedReferences.contains(ourRef.getRoleName()),equalTo(true));
  detachChangeListeners(m1,cl1,cl2);
}
