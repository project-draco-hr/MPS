{
  SModel m1=new TestModelFactory().createModel(3,1);
  myModelAccess.enableWrite();
  ((SModelBase)m1).attach(myRepo);
  final jetbrains.mps.smodel.SModel modelData=(jetbrains.mps.smodel.SModel)((SModelBase)m1).getModelData();
  final SNode r1=m1.getRootNodes().iterator().next();
  modelData.setUpdateMode(true);
  r1.addChild(TestModelFactory.ourRole,new TestModelFactory().createNode(3));
  Assert.assertEquals(0,myUndo.actualUndoActionCount());
  myUndo.flushCommand(null);
  Assert.assertEquals(0,myUndo.myUndoStack.size());
  Assert.assertEquals(6 + 4,countTreeNodes(m1.getRootNodes()));
  modelData.setUpdateMode(false);
  r1.addChild(TestModelFactory.ourRole,new TestModelFactory().createNode(3));
  Assert.assertEquals(1,myUndo.actualUndoActionCount());
  myUndo.flushCommand(null);
  Assert.assertEquals(1,myUndo.myUndoStack.size());
  Assert.assertEquals(6 + 4 + 4,countTreeNodes(m1.getRootNodes()));
}
