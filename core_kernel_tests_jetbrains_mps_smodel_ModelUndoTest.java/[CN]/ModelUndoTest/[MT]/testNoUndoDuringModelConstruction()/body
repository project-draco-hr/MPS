{
  final TestModelFactory m1f=new TestModelFactory();
  SModel m1=m1f.createModel(3,1);
  myModelAccess.enableWrite();
  m1f.attachTo(myRepo);
  final jetbrains.mps.smodel.SModel modelData=(jetbrains.mps.smodel.SModel)m1f.getModelData();
  final SNode r1=m1.getRootNodes().iterator().next();
  modelData.enterUpdateMode();
  r1.addChild(ourRole,m1f.createNode(3));
  Assert.assertEquals(0,myUndo.actualUndoActionCount());
  myUndo.flushCommand(null);
  Assert.assertEquals(0,myUndo.myUndoStack.size());
  Assert.assertEquals(6 + 4,countTreeNodes(m1.getRootNodes()));
  modelData.leaveUpdateMode();
  r1.addChild(ourRole,m1f.createNode(3));
  Assert.assertEquals(1,myUndo.actualUndoActionCount());
  myUndo.flushCommand(null);
  Assert.assertEquals(1,myUndo.myUndoStack.size());
  Assert.assertEquals(6 + 4 + 4,countTreeNodes(m1.getRootNodes()));
}
