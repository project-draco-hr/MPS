{
  TargetRange.TargetRefs refs=MapSequence.fromMap(allRefs).get(trg.getName());
  if (refs == null) {
    refs=new TargetRange.TargetRefs();
    MapSequence.fromMap(allRefs).put(trg.getName(),refs);
  }
  ListSequence.fromList(refs.before).addSequence(Sequence.fromIterable(trg.before()).concat(Sequence.fromIterable(trg.notAfter())));
  ListSequence.fromList(refs.after).addSequence(Sequence.fromIterable(trg.after()).concat(Sequence.fromIterable(trg.notBefore())));
  for (  ITarget.Name bf : ListSequence.fromList(refs.before)) {
    if (MapSequence.fromMap(allRefs).containsKey(bf)) {
      ListSequence.fromList(MapSequence.fromMap(allRefs).get(bf).after).addElement(trg.getName());
    }
  }
  for (  ITarget.Name bf : ListSequence.fromList(refs.after)) {
    if (MapSequence.fromMap(allRefs).containsKey(bf)) {
      ListSequence.fromList(MapSequence.fromMap(allRefs).get(bf).before).addElement(trg.getName());
    }
  }
  for (  IMapping<ITarget.Name,TargetRange.TargetRefs> m : MapSequence.fromMap(allRefs)) {
    if (ListSequence.fromList(m.value().before).contains(trg.getName()) && !(ListSequence.fromList(refs.after).contains(m.key()))) {
      ListSequence.fromList(refs.after).addElement(m.key());
    }
    if (ListSequence.fromList(m.value().after).contains(trg.getName()) && !(ListSequence.fromList(refs.before).contains(m.key()))) {
      ListSequence.fromList(refs.before).addElement(m.key());
    }
  }
}
