{
  if (refsToUnload.size() == 0)   return Collections.emptySet();
  final Set<ReloadableModuleBase> modulesToUnload=new LinkedHashSet<ReloadableModuleBase>();
  for (  ReloadableModule loadedModule : myLoadedModules) {
    ReloadableModuleBase loadedModule1=(ReloadableModuleBase)loadedModule;
    SModuleReference mRef=loadedModule1.getModuleReference();
    if (refsToUnload.contains(mRef))     modulesToUnload.add(loadedModule1);
  }
  if (modulesToUnload.size() != refsToUnload.size())   throw new IllegalArgumentException("Loaded modules do not match given refs");
  myLoadedModules.removeAll(modulesToUnload);
  myModelAccess.runWriteAction(new Runnable(){
    @Override public void run(){
      for (      MPSClassesListener listener : myClassesHandlers) {
        try {
          listener.beforeClassesUnloaded(modulesToUnload);
        }
 catch (        LinkageError linkageError) {
          processLinkageErrorInListener(listener,linkageError);
        }
      }
    }
  }
);
  return modulesToUnload;
}
