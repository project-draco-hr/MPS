{
  if (refsToUnload.isEmpty())   return Collections.emptySet();
  myModelAccess.checkWriteAccess();
  final Set<ReloadableModuleBase> modulesToUnload=new LinkedHashSet<ReloadableModuleBase>();
  for (  ReloadableModule loadedModule : myLoadedModules) {
    SModuleReference mRef=loadedModule.getModuleReference();
    if (refsToUnload.contains(mRef)) {
      modulesToUnload.add((ReloadableModuleBase)loadedModule);
    }
  }
  if (modulesToUnload.size() < refsToUnload.size()) {
    LOG.error("",new IllegalArgumentException("Broken contract : some of the passed module references have not been loaded"));
  }
  myLoadedModules.removeAll(modulesToUnload);
  for (  MPSClassesListener listener : myClassesHandlers) {
    try {
      listener.beforeClassesUnloaded(modulesToUnload);
    }
 catch (    Exception e) {
      LOG.error("Caught exception from the listener " + listener + ". Will continue.",e);
    }
  }
  final Set<ReloadableModule> resultingUnload=new LinkedHashSet<ReloadableModule>();
  for (  ReloadableModule module : modulesToUnload)   resultingUnload.add(module);
  return resultingUnload;
}
