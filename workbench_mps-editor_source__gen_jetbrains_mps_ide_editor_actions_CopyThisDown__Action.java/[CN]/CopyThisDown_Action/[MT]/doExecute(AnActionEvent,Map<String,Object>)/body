{
  try {
    FeatureUsageTracker.getInstance().triggerFeatureUsed("editing.duplicateLine");
    if (ListSequence.fromList(((List<SNode>)MapSequence.fromMap(_params).get("inputNodes"))).count() == 1) {
      SNode nodeToCopy=ListSequence.fromList(((List<SNode>)MapSequence.fromMap(_params).get("inputNodes"))).first();
      while (SNodeOperations.getParent(nodeToCopy) != null) {
        SNode parent=SNodeOperations.getParent(nodeToCopy);
        String role=nodeToCopy.getRoleInParent();
        SNode link=BehaviorReflection.invokeNonVirtual((Class<SNode>)((Class)Object.class),SNodeOperations.asNode(SNodeOperations.getConceptDeclaration(parent)),"jetbrains.mps.lang.structure.structure.AbstractConceptDeclaration","call_findLinkDeclaration_1213877394467",new Object[]{role});
        if (link == null) {
          return;
        }
        if (!(BehaviorReflection.invokeNonVirtual(Boolean.TYPE,link,"jetbrains.mps.lang.structure.structure.LinkDeclaration","call_isSingular_1213877254557",new Object[]{}))) {
          SNode copy=SNodeOperations.copyNode(nodeToCopy);
          jetbrains.mps.util.SNodeOperations.insertChild(parent,role,copy,nodeToCopy);
          EditorContext editorContext=((EditorComponent)MapSequence.fromMap(_params).get("editorComponent")).getEditorContext();
          editorContext.selectWRTFocusPolicy(copy);
          ((EditorComponent)MapSequence.fromMap(_params).get("editorComponent")).selectNode(copy);
          return;
        }
        nodeToCopy=parent;
      }
    }
 else {
      SNode firstNode=ListSequence.fromList(((List<SNode>)MapSequence.fromMap(_params).get("inputNodes"))).first();
      SNode lastNode=ListSequence.fromList(((List<SNode>)MapSequence.fromMap(_params).get("inputNodes"))).last();
      String role=firstNode.getRoleInParent();
      SNode parent=SNodeOperations.getParent(firstNode);
      SNode link=BehaviorReflection.invokeNonVirtual((Class<SNode>)((Class)Object.class),SNodeOperations.asNode(SNodeOperations.getConceptDeclaration(parent)),"jetbrains.mps.lang.structure.structure.AbstractConceptDeclaration","call_findLinkDeclaration_1213877394467",new Object[]{role});
      if (link == null) {
        return;
      }
      for (      SNode node : ListSequence.fromList(((List<SNode>)MapSequence.fromMap(_params).get("inputNodes"))).reversedList()) {
        jetbrains.mps.util.SNodeOperations.insertChild(parent,role,SNodeOperations.copyNode(node),lastNode);
      }
      EditorContext editorContext=((EditorComponent)MapSequence.fromMap(_params).get("editorComponent")).getEditorContext();
      editorContext.selectRange(firstNode,lastNode);
    }
  }
 catch (  Throwable t) {
    if (LOG.isEnabledFor(Level.ERROR)) {
      LOG.error("User's action execute method failed. Action:" + "CopyThisDown",t);
    }
  }
}
