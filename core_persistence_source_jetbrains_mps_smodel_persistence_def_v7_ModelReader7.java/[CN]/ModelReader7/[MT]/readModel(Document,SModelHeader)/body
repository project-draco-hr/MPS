{
  Element rootElement=document.getRootElement();
  SModelReference modelReference=jetbrains.mps.smodel.SModelReference.fromString(rootElement.getAttributeValue(ModelPersistence.MODEL_UID));
  DefaultSModel model=new DefaultSModel(modelReference);
  model.setPersistenceVersion(getVersion());
  model.getSModelHeader().updateDefaults(header);
  for (  Object att : rootElement.getAttributes()) {
    String name=((Attribute)att).getQualifiedName();
    String value=((Attribute)att).getValue();
    if (SModelHeader.VERSION.equals(name)) {
      int result;
      try {
        result=value == null ? -1 : Integer.parseInt(value);
      }
 catch (      NumberFormatException e) {
        result=-1;
      }
      model.getSModelHeader().setVersion(result);
    }
 else     if (SModelHeader.DO_NOT_GENERATE.equals(name)) {
      model.getSModelHeader().setDoNotGenerate(Boolean.parseBoolean(value));
    }
 else     if (!ModelPersistence.MODEL_UID.equals(name)) {
      model.getSModelHeader().setOptionalProperty(name,StringUtil.unescapeXml(value));
    }
  }
  myHelper=new ReadHelper(modelReference);
  myLinkMap=new ModelLinkMap(model.getModelDescriptor());
  for (  Element element : (List<Element>)rootElement.getChildren(ModelPersistence.LANGUAGE)) {
    String languageNamespace=element.getAttributeValue(ModelPersistence.NAMESPACE);
    model.addLanguage(jetbrains.mps.project.structure.modules.ModuleReference.fromString(languageNamespace));
  }
  for (  Element element : (List<Element>)rootElement.getChildren(ModelPersistence.LANGUAGE_ENGAGED_ON_GENERATION)) {
    String languageNamespace=element.getAttributeValue(ModelPersistence.NAMESPACE);
    model.addEngagedOnGenerationLanguage(jetbrains.mps.project.structure.modules.ModuleReference.fromString(languageNamespace));
  }
  for (  Element element : (List<Element>)rootElement.getChildren(ModelPersistence.DEVKIT)) {
    String devkitNamespace=element.getAttributeValue(ModelPersistence.NAMESPACE);
    model.addDevKit(jetbrains.mps.project.structure.modules.ModuleReference.fromString(devkitNamespace));
  }
  for (  Element element : (List<Element>)rootElement.getChildren(ModelPersistence.IMPORT_ELEMENT)) {
    String indexValue=element.getAttributeValue(ModelPersistence.MODEL_IMPORT_INDEX);
    int usedModelVersion=Integer.parseInt(element.getAttributeValue(ModelPersistence.VERSION,"-1"));
    String importedModelUIDString=element.getAttributeValue(ModelPersistence.MODEL_UID);
    myHelper.addImportToModel(model,indexValue,importedModelUIDString,usedModelVersion,element.getAttributeValue(ModelPersistence.IMPLICIT) != null);
  }
  Element roots=rootElement.getChild(ModelPersistence.ROOTS);
  for (  Element element : (List<Element>)roots.getChildren(ModelPersistence.NODE)) {
    SNode node=readNode(element,model,true);
    if (node != null) {
      model.addRootNode(node);
    }
  }
  for (  Element root : (List<Element>)rootElement.getChildren(ModelPersistence.ROOT_CONTENT)) {
    SNode node=model.getNode(jetbrains.mps.smodel.SNodeId.fromString(root.getAttributeValue(ModelPersistence.ID)));
    if (node == null) {
      LOG.errorWithTrace("Cannot find root for " + root.getAttributeValue(ModelPersistence.ID));
      continue;
    }
    readChildren(node,root);
  }
  new StructureModificationProcessor(myLinkMap,model).updateModelOnLoad();
  return model;
}
