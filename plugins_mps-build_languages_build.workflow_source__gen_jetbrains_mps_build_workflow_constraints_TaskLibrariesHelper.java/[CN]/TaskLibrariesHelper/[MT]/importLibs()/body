{
  Set<SNode> libsSet=new LinkedHashSet<SNode>();
  for (  SNode tldep : SLinkOperations.getTargets(project,"imports",true)) {
    libsSet.add(SLinkOperations.getTarget(tldep,"target",false));
  }
  closure(libsSet);
  List<SNode> libs=new ArrayList<SNode>(libsSet);
  for (  SNode lib : libs) {
    for (    SNode n : SNodeUtil.getDescendants(lib)) {
      for (      SReference ref : SNodeOperations.getReferences(n)) {
        SNode targetNode=SNodeOperations.getTargetNodeSilently(ref);
        if (targetNode == null) {
          genContext.showErrorMessage(n,"cannot import library `" + SPropertyOperations.getString(lib,"name") + "': unresolved reference");
        }
 else         if (!(libsSet.contains(targetNode.getContainingRoot()))) {
          genContext.showErrorMessage(n,"cannot import library `" + SPropertyOperations.getString(lib,"name") + "': broken reference, target is not imported");
        }
      }
    }
  }
  List<SNode> parts=ListSequence.fromList(libs).translate(new ITranslator2<SNode,SNode>(){
    public Iterable<SNode> translate(    SNode it){
      return SLinkOperations.getTargets(it,"parts",true);
    }
  }
).toListSequence();
  Map<SNode,SNode> map=new HashMap<SNode,SNode>();
  parts=(List<SNode>)CopyUtil.copy((List<SNode>)parts,map);
  ListSequence.fromList(SLinkOperations.getTargets(project,"imports",true)).clear();
  for (  SNode n : SNodeUtil.getDescendants(project)) {
    for (    SReference ref : n.getReferences()) {
      SNode targetNode=SNodeOperations.getTargetNodeSilently(ref);
      if (map.containsKey(targetNode)) {
        SNodeAccessUtil.setReferenceTarget(n,ref.getRole(),map.get(targetNode));
      }
 else {
        SNode containingRoot=targetNode.getContainingRoot();
        if (jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.isInstanceOf(containingRoot,"jetbrains.mps.build.workflow.structure.BwfTaskLibrary")) {
          genContext.showErrorMessage(n,"task library is not imported");
        }
      }
    }
  }
  for (int i=parts.size() - 1; i >= 0; i--) {
    ListSequence.fromList(SLinkOperations.getTargets(project,"parts",true)).insertElement(0,parts.get(i));
  }
}
