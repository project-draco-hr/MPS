{
  VirtualMachine vm=session.getEventsProcessor().getVirtualMachine();
  Tuples._2<ValueWrapperFactory,Type> currentBest=MultiTuple.<ValueWrapperFactory,Type>from(null,null);
  for (  ValueWrapperFactory factory : SetSequence.fromSet(factories)) {
    try {
      if (currentBest._0() == null) {
        currentBest._0(factory);
        currentBest._1(EvaluationUtils.getInstance().findTypeSilently(factory.getWrappedType(),vm));
      }
 else       if (!(EvaluationUtils.getInstance().instanceOf(currentBest._1(),factory.getWrappedType(),vm))) {
        Type newType=EvaluationUtils.getInstance().findTypeSilently(factory.getWrappedType(),vm);
        if (newType instanceof InterfaceType && currentBest._1() instanceof ClassType && !(currentBest._0().getWrappedType().equals(EvaluationUtils.JAVA_LANG_OBJECT))) {
          continue;
        }
        currentBest._0(factory);
        currentBest._1(newType);
      }
    }
 catch (    EvaluationException e) {
      if (LOG.isEnabledFor(Level.ERROR)) {
        LOG.error("Error while trying to select best custom viewer. Current factory is " + factory,e);
      }
    }
  }
  return currentBest._0();
}
