{
  SModel currentInputModel=inputModel;
  IGenerationTracer tracer=mySessionContext.getGenerationTracer();
  ttrace.push("pre-processing",false);
  currentInputModel=preProcessModel(ruleManager,currentInputModel);
  ttrace.pop();
  SModel currentOutputModel=createTransientModel();
  tracer.startTracing(currentInputModel,currentOutputModel);
  currentInputModel.setLoading(false);
  boolean somethingHasBeenGenerated=applyRules(currentInputModel,currentOutputModel,true,ruleManager);
  if (!somethingHasBeenGenerated) {
    currentOutputModel.validateLanguagesAndImports();
    recycleWasteModel(currentInputModel);
    return currentOutputModel;
  }
  int secondaryMappingRepeatCount=1;
  while (true) {
    currentOutputModel.validateLanguagesAndImports();
    if (myLogger.needsInfo()) {
      myLogger.info("generating model '" + currentOutputModel.getSModelFqName() + "'");
    }
    mySessionContext.clearTransientObjects();
    recycleWasteModel(currentInputModel);
    currentInputModel=currentOutputModel;
    currentInputModel.setLoading(false);
    currentInputModel.disposeFastNodeFinder();
    SModel transientModel=createTransientModel();
    tracer.startTracing(currentInputModel,transientModel);
    if (!applyRules(currentInputModel,transientModel,false,ruleManager)) {
      tracer.discardTracing(currentInputModel,transientModel);
      if (myLogger.needsInfo()) {
        myLogger.info("remove empty model '" + transientModel.getSModelFqName() + "'");
      }
      SModelRepository.getInstance().removeModelDescriptor(transientModel.getModelDescriptor());
      myTransientModelsCount--;
      break;
    }
    if (++secondaryMappingRepeatCount > 10) {
      myLogger.error("failed to generate output after 10 repeated mappings");
      if (tracer.isTracing()) {
        myLogger.error("last rules applied:");
        List<Pair<SNode,SNode>> pairs=tracer.getAllAppiedRulesWithInputNodes(transientModel.getSModelReference());
        for (        Pair<SNode,SNode> pair : pairs) {
          myLogger.error(pair.o1,"rule: " + pair.o1.getDebugText());
          myLogger.describeError(pair.o2,"input: " + (pair.o2 != null ? pair.o2.getDebugText() : "n/a"));
        }
      }
 else {
        myLogger.error("to get more diagnostic generate model with the 'save transient models' option");
      }
      throw new GenerationFailureException("failed to generate output after 10 repeated mappings");
    }
    currentOutputModel=transientModel;
  }
  currentOutputModel.setLoading(true);
  ttrace.push("post-processing",false);
  currentOutputModel=postProcessModel(ruleManager,currentOutputModel);
  ttrace.pop();
  return currentOutputModel;
}
