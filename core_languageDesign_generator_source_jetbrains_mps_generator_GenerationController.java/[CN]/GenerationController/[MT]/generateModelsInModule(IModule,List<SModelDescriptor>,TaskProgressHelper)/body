{
  boolean currentGenerationOK=true;
  IOperationContext invocationContext=myModulesToContexts.get(module);
  progressHelper.setText2("module " + module);
  String outputFolder=module != null ? module.getGeneratorOutputPath() : null;
  prepareOutputFolder(outputFolder);
  if (containsTestModels(inputModels)) {
    String testsOutputFolder=module != null ? module.getTestsGeneratorOutputPath() : null;
    prepareOutputFolder(testsOutputFolder);
  }
  info("    target root folder: \"" + outputFolder + "\"");
  String wasLoggingThreshold=null;
  IGenerationSession generationSession=new GenerationSession(invocationContext,mySaveTransientModels,myProgress,myMessages);
  try {
    if (mySettings.isShowErrorsOnly()) {
      wasLoggingThreshold=Logger.setThreshold("ERROR");
    }
    Logger.addLoggingHandler(generationSession.getLoggingHandler());
    for (    SModelDescriptor inputModel : inputModels) {
      TypeChecker.getInstance().setIsGeneration(true);
      try {
        if (!myGenerationHandler.getGenType().isApplicable(inputModel)) {
          LOG.error("Can't apply generation type " + myGenerationHandler.getGenType() + " to "+ inputModel.getSModelFqName());
          continue;
        }
        info("");
        String taskName=ModelsProgressUtil.generationModelTaskName(inputModel);
        progressHelper.setText2("model " + inputModel.getSModelFqName());
        progressHelper.startLeafTask(taskName);
        GenerationStatus status=generationSession.generateModel(inputModel);
        status.setOriginalInputModel(inputModel);
        currentGenerationOK=currentGenerationOK && status.isOk();
        info("handling output...");
        checkMonitorCanceled();
        String targetDir=module.getOutputFor(inputModel);
        if (status.getOutputModel() != null) {
          boolean result=myGenerationHandler.getGenType().handleOutput(status,targetDir,invocationContext,myProgress,myMessages);
          if (!result) {
            info("there were errors.");
            currentGenerationOK=false;
          }
        }
 else         if (!(status.isCanceled() || status.isError())) {
          myGenerationHandler.getGenType().handleEmptyOutput(status,targetDir,invocationContext,myProgress,myMessages);
        }
      }
  finally {
        generationSession.discardTransients();
        CleanupManager.getInstance().cleanup();
        progressHelper.finishTask();
        TypeChecker.getInstance().setIsGeneration(false);
        progressHelper.setText2("");
      }
    }
  }
  finally {
    if (wasLoggingThreshold != null) {
      Logger.setThreshold(wasLoggingThreshold);
    }
    Logger.removeLoggingHandler(generationSession.getLoggingHandler());
  }
  checkMonitorCanceled();
  info("");
  progressHelper.setText2("");
  return currentGenerationOK;
}
