{
  while (!stack.isEmpty()) {
    final Iterator<T> top=stack.peek();
    if (top.hasNext()) {
      final T next=top.next();
      if (next == null || !seen.add(next)) {
        continue;
      }
      Iterator<T> new_=children(next);
      if (new_ != null) {
        stack.push(new_);
        if (onlyLeaves) {
          continue;
        }
      }
      return next;
    }
    stack.pop();
  }
  return null;
}
