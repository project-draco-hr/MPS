{
  MultiMap<SModel,T> result=new SetBasedMultiMap<SModel,T>();
  if (elems.isEmpty()) {
    for (    SModel sm : models) {
      if (sm instanceof JavaClassStubModelDescriptor) {
        processedConsumer.consume(sm);
      }
    }
    return result;
  }
  final ManyToManyMap<SModel,VirtualFile> scopeFiles=new ManyToManyMap<SModel,VirtualFile>();
  Set<FolderSetDataSource> sources=new THashSet<FolderSetDataSource>();
  final Set<VirtualFile> dirs=new THashSet<VirtualFile>();
  for (  final SModel sm : models) {
    if (!(sm instanceof JavaClassStubModelDescriptor)) {
      continue;
    }
    processedConsumer.consume(sm);
    FolderSetDataSource source=((JavaClassStubModelDescriptor)sm).getSource();
    if (!(sources.add(source))) {
      continue;
    }
    Collection<IFile> files=source.getAffectedFiles();
    for (    IFile path : files) {
      final VirtualFile vf=VirtualFileUtils.getVirtualFile(path);
      if (vf == null) {
        if (LOG.isEnabledFor(Level.WARN)) {
          LOG.warn("File " + path + ", which belows to model source of model "+ sm.getReference().toString()+ ", was not found in VFS. Assuming no usages in this file.");
        }
        continue;
      }
      VfsUtilCore.visitChildrenRecursively(vf,new VirtualFileVisitor<Object>(){
        @Override public boolean visitFile(        @NotNull VirtualFile file){
          if (file.isDirectory()) {
            return dirs.add(file);
          }
          scopeFiles.addLink(sm,file);
          return true;
        }
      }
);
    }
  }
  for (  T elem : elems) {
    String nodeId=(id == null ? elem.toString() : id.value(elem));
    ConcreteFilesGlobalSearchScope allFiles=new ConcreteFilesGlobalSearchScope(scopeFiles.getSecond());
    Collection<VirtualFile> matchingFiles;
    try {
      matchingFiles=FileBasedIndex.getInstance().getContainingFiles(IdIndex.NAME,new IdIndexEntry(nodeId,true),allFiles);
    }
 catch (    ProcessCanceledException ce) {
      matchingFiles=Collections.emptyList();
    }
    for (    VirtualFile file : matchingFiles) {
      for (      SModel m : scopeFiles.getBySecond(file)) {
        result.putValue(m,elem);
      }
    }
  }
  return result;
}
