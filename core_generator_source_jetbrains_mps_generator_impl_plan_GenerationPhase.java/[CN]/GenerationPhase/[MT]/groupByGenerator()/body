{
  HashMap<TemplateModule,Group> groupByModule=new HashMap<TemplateModule,Group>();
  HashMap<Group,Set<TemplateModule>> groupsWithFewModules=new HashMap<Group,Set<TemplateModule>>();
  ArrayList<Group> step=new ArrayList<Group>();
  for (  Group g : myPhaseElements) {
    System.out.println(g);
    final Set<TemplateModule> involvedGenerators=getInvolvedGenerators(g);
    if (involvedGenerators.size() == 1) {
      final TemplateModule generator=involvedGenerators.iterator().next();
      Group sameModuleGroup=groupByModule.get(generator);
      groupByModule.put(generator,sameModuleGroup == null ? g : sameModuleGroup.union(g));
    }
 else {
      groupsWithFewModules.put(g,involvedGenerators);
    }
  }
  System.out.println();
  for (  Entry<Group,Set<TemplateModule>> e : groupsWithFewModules.entrySet()) {
    Group compositeGroup=e.getKey();
    for (    TemplateModule tm : e.getValue()) {
      if (groupByModule.containsKey(tm)) {
        compositeGroup=compositeGroup.union(groupByModule.remove(tm));
      }
    }
    step.add(compositeGroup);
  }
  step.addAll(groupByModule.values());
}
