{
  persistenceVersion=actualPersistenceVersion(persistenceVersion);
  SModelHeader modelHeader=null;
  int oldVersion=persistenceVersion;
  if (modelData instanceof DefaultSModel) {
    DefaultSModel dsm=(DefaultSModel)modelData;
    modelHeader=dsm.getSModelHeader();
    oldVersion=modelHeader.getPersistenceVersion();
    if (oldVersion != persistenceVersion) {
      modelHeader.setPersistenceVersion(persistenceVersion);
    }
  }
  if (persistenceVersion < 9) {
    modelData.getImplicitImportsSupport().calculateImplicitImports();
  }
  Map<String,Document> result=ModelPersistence.getModelPersistence(persistenceVersion).getModelWriter(modelHeader).saveModelAsMultiStream(modelData);
  Set<String> toRemove=new HashSet<String>();
  for (  String s : source.getAvailableStreams()) {
    if (!result.containsKey(s))     toRemove.add(s);
  }
  for (  Entry<String,Document> entry : result.entrySet()) {
    JDOMUtil.writeDocument(entry.getValue(),source,entry.getKey());
  }
  for (  String r : toRemove) {
    source.delete(r);
  }
  if (oldVersion != persistenceVersion) {
    LOG.info("persistence upgraded: " + oldVersion + "->"+ persistenceVersion+ " "+ modelData.getReference());
    return true;
  }
  return false;
}
