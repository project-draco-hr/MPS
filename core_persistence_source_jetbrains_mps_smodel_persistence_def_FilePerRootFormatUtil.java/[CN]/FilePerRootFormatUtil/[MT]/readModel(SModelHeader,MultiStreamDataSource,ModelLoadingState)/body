{
  ModelPersistence.checkV8(header.getPersistenceVersion(),header.getModelReference(),dataSource.getLocation());
  IModelPersistence mp=ModelPersistence.getPersistence(header.getPersistenceVersion());
  if (mp == null) {
    throw new ModelReadException("Couldn't read model because of unknown persistence version",null);
  }
  DefaultSModel result;
  XMLSAXHandler<ModelLoadResult> headerHandler=mp.getModelReaderHandler(targetState,header);
  InputStream in=null;
  try {
    in=dataSource.openInputStream(FilePerRootDataSource.HEADER_FILE);
    InputSource source=new InputSource(new InputStreamReader(in,FileUtil.DEFAULT_CHARSET));
    ModelPersistence.parseAndHandleExceptions(source,headerHandler);
    if (headerHandler.getResult().getContentKind() != ContentKind.MODEL_HEADER) {
      throw new ModelReadException("Couldn't read model: .model file is broken",null);
    }
  }
 catch (  Exception e) {
    Throwable th=e.getCause() == null ? e : e.getCause();
    throw new ModelReadException(String.format("Couldn't read .model file: %s",th.getMessage()),e,header);
  }
 finally {
    FileUtil.closeFileSafe(in);
  }
  result=(DefaultSModel)headerHandler.getResult().getModel();
  header=result.getSModelHeader();
  List<String> streams=new ArrayList<String>();
  for (  String s : dataSource.getAvailableStreams()) {
    streams.add(s);
  }
  Collections.sort(streams);
  for (  String stream : streams) {
    if (!(stream.endsWith(FilePerRootDataSource.ROOT_EXTENSION))) {
      continue;
    }
    XMLSAXHandler<ModelLoadResult> rootHandler=mp.getModelReaderHandler(targetState,header);
    in=null;
    try {
      in=dataSource.openInputStream(stream);
      InputSource source=new InputSource(new InputStreamReader(in,FileUtil.DEFAULT_CHARSET));
      ModelPersistence.parseAndHandleExceptions(source,rootHandler);
      if (rootHandler.getResult().getContentKind() != ContentKind.MODEL_ROOT) {
        throw new ModelReadException("Couldn't read model: " + stream + " root file is broken",null);
      }
      if (rootHandler.getResult().getState() == ModelLoadingState.INTERFACE_LOADED) {
        headerHandler.getResult().setState(ModelLoadingState.INTERFACE_LOADED);
      }
      int count=0;
      SModel model=rootHandler.getResult().getModel();
      model.enterUpdateMode();
      for (      SNode rootNode : model.getRootNodes()) {
        if (count != 0) {
          throw new ModelReadException(String.format("Couldn't read model from stream %s: root file is broken - contains more than one roots",stream),null);
        }
        count++;
        model.removeRootNode(rootNode);
        result.addRootNode(rootNode);
      }
      model.leaveUpdateMode();
    }
 catch (    Exception e) {
      Throwable th=e.getCause() == null ? e : e.getCause();
      throw new ModelReadException(String.format("Couldn't read model from stream %s: %s",stream,th.getMessage()),th,header);
    }
 finally {
      FileUtil.closeFileSafe(in);
    }
  }
  return headerHandler.getResult();
}
