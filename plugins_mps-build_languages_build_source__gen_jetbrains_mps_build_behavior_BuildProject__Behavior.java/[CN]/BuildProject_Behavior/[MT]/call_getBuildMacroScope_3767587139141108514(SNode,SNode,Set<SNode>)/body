{
  if (SetSequence.fromSet(visited).contains(__thisNode__)) {
    return new EmptyScope();
  }
  SetSequence.fromSet(visited).addElement(__thisNode__);
  Scope rootScope=ScopeUtil.simpleRoleScope(__thisNode__,MetaAdapterFactory.getContainmentLink(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x4df58c6f18f84a13L,0x4df58c6f18f84a22L,"macros"));
  SNode containingProject=SNodeOperations.getNodeAncestor(child,MetaAdapterFactory.getConcept(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x4df58c6f18f84a13L,"jetbrains.mps.build.structure.BuildProject"),false,false);
  if (neq_save77_a0e0i(containingProject,__thisNode__)) {
    rootScope=ScopeUtil.where(rootScope,new _FunctionTypes._return_P1_E0<Boolean,SNode>(){
      public Boolean invoke(      SNode node){
        return BuildMacro__BehaviorDescriptor.isPublic_id5FtnUVJQZyL.invoke(SNodeOperations.cast(node,MetaAdapterFactory.getConcept(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x4df58c6f18f84a1fL,"jetbrains.mps.build.structure.BuildMacro")));
      }
    }
);
  }
  if ((containingProject != null)) {
    final Wrappers._T<SNode> definedMacro=new Wrappers._T<SNode>();
    if (ListSequence.fromList(SLinkOperations.getChildren(containingProject,MetaAdapterFactory.getContainmentLink(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x4df58c6f18f84a13L,0x4df58c6f18f84a22L,"macros"))).contains(child)) {
      definedMacro.value=SNodeOperations.cast(child,MetaAdapterFactory.getConcept(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x4df58c6f18f84a1fL,"jetbrains.mps.build.structure.BuildMacro"));
    }
 else {
      definedMacro.value=ListSequence.fromList(SLinkOperations.getChildren(containingProject,MetaAdapterFactory.getContainmentLink(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x4df58c6f18f84a13L,0x4df58c6f18f84a22L,"macros"))).findFirst(new IWhereFilter<SNode>(){
        public boolean accept(        SNode it){
          return ListSequence.fromList(SNodeOperations.getNodeDescendants(it,null,false,new SAbstractConcept[]{})).contains(child);
        }
      }
);
    }
    if ((definedMacro.value != null)) {
      rootScope=ScopeUtil.where(rootScope,new _FunctionTypes._return_P1_E0<Boolean,SNode>(){
        public Boolean invoke(        SNode visibleNode){
          return !(ListSequence.fromList(SNodeOperations.getNextSiblings(definedMacro.value,false)).contains(visibleNode)) && !((eq_save77_a0a0a0a0a0b0a1a2a5a8(definedMacro.value,visibleNode)));
        }
      }
);
    }
  }
  List<Scope> scopes=ListSequence.fromList(new ArrayList<Scope>());
  ListSequence.fromList(scopes).addElement(rootScope);
  ListSequence.fromList(scopes).addSequence(ListSequence.fromList(SLinkOperations.getChildren(__thisNode__,MetaAdapterFactory.getContainmentLink(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x4df58c6f18f84a13L,0x4df58c6f18f84a25L,"dependencies"))).where(new IWhereFilter<SNode>(){
    public boolean accept(    SNode it){
      return SNodeOperations.isInstanceOf(it,MetaAdapterFactory.getConcept(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x454b730dd908c220L,"jetbrains.mps.build.structure.BuildProjectDependency"));
    }
  }
).select(new ISelector<SNode,Scope>(){
    public Scope select(    SNode it){
      return BuildProject__BehaviorDescriptor.getBuildMacroScope_id3h9a8EwPwcy.invoke(SLinkOperations.getTarget(SNodeOperations.cast(it,MetaAdapterFactory.getConcept(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x454b730dd908c220L,"jetbrains.mps.build.structure.BuildProjectDependency")),MetaAdapterFactory.getReferenceLink(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x454b730dd908c220L,0x4df58c6f18f84a24L,"script")),child,visited);
    }
  }
));
  ListSequence.fromList(scopes).addSequence(Sequence.fromIterable(ScopeUtil.imported(ListSequence.fromList(SLinkOperations.getChildren(__thisNode__,MetaAdapterFactory.getContainmentLink(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x4df58c6f18f84a13L,0x4df58c6f18f84a25L,"dependencies"))).where(new IWhereFilter<SNode>(){
    public boolean accept(    SNode it){
      return !(SNodeOperations.isInstanceOf(it,MetaAdapterFactory.getConcept(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x454b730dd908c220L,"jetbrains.mps.build.structure.BuildProjectDependency")));
    }
  }
),MetaAdapterFactory.getConcept(0x798100da4f0a421aL,0xb99171f8c50ce5d2L,0x4df58c6f18f84a1fL,"jetbrains.mps.build.structure.BuildMacro").getDeclarationNode(),child)));
  return new CompositeScope(ListSequence.fromList(scopes).toGenericArray(Scope.class)){
    @Override public Iterable<SNode> getAvailableElements(    @Nullable String prefix){
      return Sequence.fromIterable(super.getAvailableElements(prefix)).distinct();
    }
  }
;
}
